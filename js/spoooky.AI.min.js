Spoooky.AI={game:0,MCnode:function(a,b,e,d){var c=this;c.depth=0;c.nodeID=0;"Root Node"!==b?(c.depth=b.depth+1,c.nodeID=(Date.now()+_.random(0,99999)).toString()):c.nodeID="Root";c.move=a;c.parent=b;c.childNodes=[];c.wins=0;c.simulationSteps=0;c.visits=0;c.type="DEFAULT";c.terminal=!1;c.winnerID=!1;c.untriedMoves=[];c.getWinRate=function(){return 0<c.visits?c.wins/c.visits:0};c.hasUntriedMoves=function(){return!1===c.untriedMoves||0===c.untriedMoves.length?!1:!0};c.hasChildNodes=function(){return!1===
c.childNodes||0===c.childNodes.length?!1:!0};c.getRandomMoveIndexFromUntriedMoves=function(){return _.random(0,parseInt(c.untriedMoves.length-1,10))};c.playerToMove=e.getCurrentPlayerID();c.UCTCONSTANT=d;c.getUnvisitedChildNodes=function(){var b=[],e,d,a=c.childNodes;for(d=a.length;d--;)e=a[d],0===e.visits&&b.push(e);return b};c.UCTSelectChild=function(){for(var b="None",e=0,d,a=c.childNodes,f,n=a.length;n--;)d=a[n],f=d.getWinRate()+2*c.UCTCONSTANT*Math.sqrt(2*Math.log(c.visits)/d.visits),f>e&&(b=
d,e=f);return"None"===b?a[_.random(0,a.length-1)]:b};c.addChild=function(b,e,d,a){a=new Spoooky.AI.MCnode(c.untriedMoves[b],c,e,c.UCTCONSTANT);a.moveIndex=b;"END"!==e.models.gameState&&a.depth<d&&(a.untriedMoves=e.getCurrentPlayer().getExecutableMovesByAgentFocus("ALL"));"END"===e.models.gameState&&(a.terminal=!0,a.winnerID=e.models.winnerID);c.untriedMoves.splice(b,1);c.childNodes.push(a);"WAITINGFORDICEROLL"===e.models.gameState&&(a.type="CHANCE NODE");return a};c.update=function(b){c.visits++;
c.wins+=b}},UCTrollout:function(a,b,e,d,c,l,k){if("END"===a.models.gameState)return{finalState:a,steps:1};var h;e=0;var g,f=a.models,n="",p="";for(f.playVirtual=!0;e<=b;){e++;if(Date.now()>k)break;if("WAITINGFORDICEROLL"===f.gameState&&(Spoooky.GameEvents.fireEvent({job:"Roll Backgammon Dices"},a),"WAITINGFORDICEROLL"===f.gameState)){a.loop(!1,null,null);continue}h=a.getCurrentPlayer().getAllEntityMoves();0<h.length&&(l&&(n=a.gameWorld.createBoardSignature()),g=h[_.random(0,h.length-1)],a.executeMove(g),
l&&(p=a.gameWorld.createBoardSignature()));_.isUndefined(g)&&(g={targetX:"x",targetY:"y",moveIndex:"none"});if("END"===f.gameState){b=f.winnerID;l&&(b===d?c.add(n,p,1,a.translateCoordinates(g.targetX,g.targetY),g.moveIndex):!1!==b&&c.add(n,p,-1,a.translateCoordinates(g.targetX,g.targetY),g.moveIndex));break}l&&c.add(n,p,void 0,a.translateCoordinates(g.targetX,g.targetY),g.moveIndex)}return{finalState:a,steps:e}},UCT:function(a,b,e,d,c,l,k){var h,g,f,n=0,p,m=a.getCurrentPlayerID(),r,s,q="";f="";var t=
0;d=Date.now()+d;c&&(s=new Spoooky.QLearner(.8));l=new Spoooky.AI.MCnode({ID:"Root",name:"Root"},"Root Node",a,l);for(l.untriedMoves=a.getCurrentPlayer().getExecutableMovesByAgentFocus(b);Date.now()<d;){g=l;h=a.clone();for(p=h.gameWorld;!1===g.hasUntriedMoves()&&g.hasChildNodes();)g=g.UCTSelectChild(),c&&(q=p.createBoardSignature()),r=g.move,h.executeMove(r),c&&(f=p.createBoardSignature(),s.add(q,f,void 0,h.translateCoordinates(r.targetX,r.targetY),r.moveIndex));g.hasUntriedMoves()&&(f=g.getRandomMoveIndexFromUntriedMoves(),
c&&(q=p.createBoardSignature()),r=g.untriedMoves[f],h.executeMove(r),g.addChild(f,h,9999999,b),c&&(f=p.createBoardSignature(),s.add(q,f,void 0,h.translateCoordinates(r.targetX,r.targetY),r.moveIndex)));f=Spoooky.AI.UCTrollout(h.clone(),e,b,m,s,c,d);g.simulationSteps+=f.steps;t+=f.steps;for(f=f.finalState.evaluateGameState(g.playerToMove);g.parent;)g.update(f),f*=-1,g=g.parent;n++;h.models.length=0;h.length=0}b=[];e=l.childNodes.length;for(a=a.gameWorld.getRows();e--;)c=l.childNodes[e],m=c.move,q=
String.fromCharCode(parseInt(97+m.targetX,10))+(a-m.targetY),"place entity"!==m.name&&("Bear off"===m.name?q=String.fromCharCode(parseInt(97+m.entity.position.x,10))+(a-m.entity.position.y)+"-out":(q=String.fromCharCode(parseInt(97+m.targetX,10))+(a-m.targetY),d=String.fromCharCode(parseInt(97+m.entity.position.x,10))+(a-m.entity.position.y),q=d+"-"+q)),"DICE"===m.type&&(q+="-"+m.diceValue),b.push({wins:c.wins,target:q,visits:c.visits,moveIndex:m.moveIndex,simulationSteps:c.simulationSteps});e=!1;
k&&(e=Spoooky.AI.createMCTSGraph(l,a));return{mctsGraph:e,simCount:n,simSteps:t,results:b,QLearner:s}},createMCTSGraph:function(a,b){var e={ID:"Root",children:[],parent:"null",value:a.visits,name:"Entscheidungsknoten (Spieler ID "+a.playerToMove+", "+a.getWinRate().toFixed(3)+" / "+a.visits+")"},d=[];try{Spoooky.AI.preProcessChildNodes(a.childNodes,b,d)}catch(c){d.length=0}try{e.children=Spoooky.AI.createTree(d,"Root",0,10)}catch(l){e.children.length=0}return e},preProcessChildNodes:function(a,b,
e){for(var d,c,l,k,h=a.length;h--;)d=a[h],k=d.move,c=String.fromCharCode(parseInt(97+k.targetX,10))+(b-k.targetY),"place entity"!==k.name&&("Bear off"===k.name?c=String.fromCharCode(parseInt(97+k.entity.position.x,10))+(b-k.entity.position.y)+"-out":(c=String.fromCharCode(parseInt(97+k.targetX,10))+(b-k.targetY),l=String.fromCharCode(parseInt(97+k.entity.position.x,10))+(b-k.entity.position.y),c=l+"-"+c)),"DICE"===k.type&&(c+="-"+k.diceValue),c=d.terminal?c+" (Terminalknoten - "+(!1!==d.winnerID?
"Spieler ID "+d.winnerID+" gewinnt. ":"unentschieden")+d.getWinRate().toFixed(3)+" / "+d.visits+")":c+" (Spieler ID "+d.playerToMove+", "+d.getWinRate().toFixed(3)+" / "+d.visits+")",e.push({ID:d.nodeID,value:d.visits,parent:d.parent.nodeID,name:c,terminal:d.terminal}),0<d.childNodes.length&&Spoooky.AI.preProcessChildNodes(d.childNodes,b,e)},createTree:function(a,b){for(var e=[],d,c=a.length;c--;)a[c].parent===b&&(d=Spoooky.AI.createTree(a,a[c].ID),d.length&&(a[c].children=d),e.push(a[c]));return e},
max:function(a,b){return a>b?a:b},abNegaMax:function(a,b,e,d,c,l){if("END"===a.models.gameState||e===b)return b=-1E3,!1===a.models.winnerID?b=0:a.models.winnerID===l&&(b=1E3),{score:b+e,move:null,moveIndex:!1};var k="none",h=-99999,g,f,n;g=a.getCurrentPlayer().getAllEntityMoves();for(var p=g.length;p--;)if(n=g[p],f=a.clone(),f.executeMove(n),f=Spoooky.AI.abNegaMax(f,b,e+1,-1*c,-1*Spoooky.AI.max(d,h),l),f=f.score,f*=-1,f>h&&(k=n,h=f,h>=c))return{score:h,move:k,moveIndex:k.moveIndex};return"none"===
k?{score:-1}:{score:h,move:k,moveIndex:k.moveIndex}}};
Spoooky.QLearner=function(a){var b=this;b.alpha=0;b.gamma=a||.8;b.rho=.2;b.nu=0;b.rewards={};b.gameStates={};b.currentState=null;b.add=function(e,a,c,l,k){b.gameStates[e]||b.addState(e);b.gameStates[a]||b.addState(a);b.gameStates[e].addAction(a,c,l,k)};b.addState=function(e){var a=new Spoooky.GameState(e);return b.gameStates[e]=a};b.setState=function(e){b.currentState=b.gameStates[e];return b.currentState};b.getState=function(){return b.currentState&&b.currentState.name};b.randomState=function(){var e=
_.toArray(b.gameStates);return e[_.random(0,e.length-1)]};b.optimalFutureValue=function(e){var a=0,c=b.rewards[e];_.each(c,function(b){c.hasOwnProperty(b)&&(a=Math.max(a,c[b]||0))});return a};b.step=function(){b.currentState||(b.currentState=b.randomState());var a=_.toArray(b.currentState.actions);_.random(0,1);a=a[_.random(0,a.length-1)];if(!a)return null;b.rewards[b.currentState.name]||(b.rewards[b.currentState.name]={});b.rewards[b.currentState.name][a.name]=(a.reward||0)+b.gamma*b.optimalFutureValue(a.nextState);
return b.currentState=b.gameStates[a.nextState]};b.learn=function(a){for(a=Math.max(1,a||0);a--;)b.currentState=b.randomState(),b.step()};b.getBestAction=function(a){a=b.rewards[a]||{};for(var d=null,c,l=_.keys(a),k=l.length,h=0;h<k;++h)if(c=l[h],a.hasOwnProperty(c))d?a[c]===a[d]?d=c:a[c]>a[d]&&(d=c):d=c;else return!1;return d}};Spoooky.GameState=function(a){var b=this;b.name=a;b.actions={};b.addAction=function(a,d,c,l){a={name:void 0===c?a:c,nextState:a,reward:d,moveIndex:l};b.actions[a.name]=a}};

"use strict";var Spoooky=Spoooky||{};Spoooky.Models=function(){var e=this;e.HighlightTable=[],e.JobQueue=[],e.MovableEntities=[],e.MoveTable=[],e.GoalMoves=[],e.MetaAgents=[],e.Entities=[],e.GameRuleAtoms=[],e.GameRules=[],e.GameRuleConsequences=[],e.EntityGoalConsequences=[],e.GameGrid=[],e.CellConnections={},e.SelectRestrictions={entities:"",moves:""},e.OffBoardContent=[],e.DiceBox={isEnabled:!1,dices:[],diceValues:[],attachedMoveIDs:[]},e.Areas={isEnabled:!1,content:[]},e.Blueprints={},e.gameName="",e.recentlyMovedEntity=!1,e.gameState="INGAME",e.moveCounter=0,e.currentPlayerID=-1,e.description="",e.moveID=0,e.lastMoveID=0,e.worldDimensions={rows:0,columns:0},e.winnerID=!1,e.playVirtual=!1,e.playerChange=!0,e.gameMode="MOVING",e.tmpGameMode="",e.gameRounds=0},Spoooky.Game=function(){var e=this;e.initialize=function(t){return e.models=new Spoooky.Models,e.gameWorld=new Spoooky.GridWelt(e),e.setName(t),e.jobQueue=new Spoooky.JobQueue(e),e.diceBox=new Spoooky.DiceBox(e),e.areas=new Spoooky.Areas(e),e.offBoard=new Spoooky.OffBoard(e),e},e.setupGridWorld=function(t,n,o){e.gameWorld.setup2D(t,n),e.gameWorld.setupGameBoard(o)},e.connectGridWeltView=function(t){e.viewScope=t},e.statsScope=null,e.connectStatsView=function(t){e.statsScope=t},e.refreshStatsView=function(t){e.statsScope.update(t)},e.graphScope=null,e.connectGraphView=function(t){e.graphScope=t},e.refreshGraphView=function(t,n){e.graphScope.updateGraphs(t,n)},e.evaluateGameState=function(t){var n=0;return"END"===e.models.gameState&&(n=e.models.winnerID===t?1:e.models.winnerID===!1?.5:0),n},e.stringifyModels=function(){return JSON.stringify(e.models)},e.clone=function(t){var n=new Spoooky.Game;n.initialize("COPY"),t?n.models=JSON.parse(t):n.models=JSON.parse(e.stringifyModels());var o,r,i,a,s,l=n.models,u=n.models.MetaAgents.length;for(o=u;o--;)r=new Spoooky.MetaAgent(n),_.extend(r,l.MetaAgents[o]),l.MetaAgents[o]=r;for(u=l.Entities.length,o=u;o--;)for(r=l.Entities[o],s=r.length;s--;)a=r[s],i=new Spoooky.Entity(a.name,a.ID,a.typeID,n),_.extend(i,a),l.Entities[o][s]=i;return n.models.playVirtual=!0,n.setName("GAME_COPY"),n},e.models=null,e.flush=function(e){e.length=0},e.setWinnerID=function(t){e.models.winnerID=t},e.getWinnerID=function(){return e.models.winnerID},e.jobQueue=null,e.MovableEntities=null,e.areas=null,e.addArea=function(t){null===e.areas&&(e.areas=new Spoooky.Areas),e.areas.addArea(t)},e.getArea=function(t){return e.areas.getArea(t)},e.addBlueprint=function(t,n,o){return e.models.Blueprints[n.entityType]=_.clone(n),t&&t.associateEntity(e.models.Blueprints[n.entityType],o),e.models.Blueprints[n.entityType]},e.extendBlueprint=function(e,t){_.extend(e,t)},e.getBlueprints=function(){return e.models.Blueprints},e.getBlueprint=function(t){return e.getBlueprints()[t]},e.setRecentlyMovedEntity=function(t,n){var o=e.gameWorld.peekCell(t,n),r="default";e.isGoalMove(t,n)&&(r="capture"),o?(e.models.recentlyMovedEntity={entityID:o.ID,playerID:o.getMetaPlayerID()},o.addExecutedMove(t,n,e.models.moveCounter,r)):e.models.recentlyMovedEntity=!1},e.getrecentlyMovedEntity=function(){if(e.models.recentlyMovedEntity){var t=e.models.recentlyMovedEntity;return e.getPlayerWithID(t.playerID).getEntityWithID(t.entityID)}return!1},e.addDice=function(t,n){e.getDiceBox().enable(),e.getDiceBox().createDice(t,n)},e.diceBox=null,e.getDiceBox=function(){return e.diceBox},e.offBoard=null,e.setName=function(t){t?e.models.gameName=t:e.models.gameName=""},e.getName=function(){return e.models.gameName},e.setDescription=function(t){e.models.description=t},e.getDescription=function(){return e.models.description},e.setMoveID=function(t){e.models.moveID=t},e.setLastMoveID=function(){e.models.lastMoveID=e.models.moveID},e.getLastMoveID=function(){return e.models.lastMoveID},e.gameWorld=null,e.getGameWorld=function(){return e.gameWorld},e.loop=function(t,n,o){var r=!1;if("END"!==e.models.gameState){switch(e.models.gameMode){case"MOVING":r=t?e.areas.isMove(t):e.isMove(n,o),r?(t?e.executeJobsForMoveID(e.areas.getMoveID(t)):e.executeJobsForThisMove(n,o),e.executeGameRules()?e.executeJobsForRecentMove():e.proceed()):e.showEntityMoves(n,o);break;case"PLACING":case"FREE CAPTURE":e.showFieldsToPlaceEntity(),r=e.isMove(n,o),r&&(e.executeJobsForThisMove(n,o),e.executeGameRules()?e.executeJobsForRecentMove():e.proceed())}e.executePostMoveJobs()}e.playArtificial()},e.playArtificial=function(){e.models.playVirtual===!1&&"ARTIFICIAL"===e.getCurrentPlayerType()&&"END"!==e.models.gameState&&e.artificialTurn()},e.pseudoLoop=function(){e.loop(!1,null,null)},e.proceed=function(){e.models.playerChange&&(e.setNextPlayer(),e.setGameState("INGAME")),e.resetMoves()},e.setGameMode=function(t){e.models.tmpGameMode=e.models.gameMode,e.models.gameMode=t},e.checkGoalMove=function(t,n){e.isGoalMove(t,n)},e.setGameState=function(t){e.models.gameState=t},e.getGameState=function(){return e.models.gameState},e.addPlayer=function(t){e.models.Entities[t.ID]=[],e.models.MetaAgents.push(t),1===e.models.MetaAgents.length&&e.setPlayer(t)},e.createPlayer=function(t){var n=new Spoooky.MetaAgent(e);return n.setID(e.models.MetaAgents.length),t&&(n.setName(t.name),n.setType(t.type)),"ARTIFICIAL"===n.type&&n.assembleAgents(),e.addPlayer(n),n},e.setCurrentPlayerID=function(t){e.models.currentPlayerID=t},e.setPlayer=function(t){e.setCurrentPlayerID(t.ID)},e.getCurrentPlayerID=function(){return e.models.currentPlayerID},e.getNextPlayerID=function(){var t=e.getCurrentPlayerID();return t<e.models.MetaAgents.length-1?t+1:0},e.getCurrentPlayerName=function(){return e.getCurrentPlayer().getName()},e.getCurrentPlayerType=function(){return e.getPlayerWithID(e.getCurrentPlayerID()).type},e.setNextPlayer=function(){var t=e.getCurrentPlayerID(),n=e.models;t<n.MetaAgents.length-1?e.setCurrentPlayerID(t+1):e.setCurrentPlayerID(0),e.resetMoves(),n.gameRounds++},e.getPlayerWithID=function(t){return e.models.MetaAgents[t]},e.getPlayerWhoOwnsEntity=function(t){for(var n=e.getPlayers(),o=n.length,r=0;o>r;r+=1)if(n[r].hasEntity(t)===!0)return n[r];return!1},e.informArtificialPlayersAboutGameEnd=function(){for(var t=e.getPlayers(),n=t.length,o=n;o--;)"ARTIFICIAL"===t[o].type&&t[o].gameHasEnded()},e.getPlayers=function(){return e.models.MetaAgents},e.getAIPlayers=function(){var t,n=e.models.MetaAgents,o=[];for(t=0;t<n.length;t++)"ARTIFICIAL"===n[t].type&&o.push(n[t]);return o},e.getCurrentPlayer=function(){return e.getPlayerWithID(e.getCurrentPlayerID())},e.assembleGameRule=function(t){e.models.GameRules.push(t)},e.getGameRule=function(t){return t>=0&&t<e.models.GameRules.length?e.models.GameRules[t]:!1},e.countGameRules=function(){return e.models.GameRules.length},e.executeGameRuleByName=function(t){for(var n,o=e.models.GameRules.length,r=!1,i=0,a=0,s=0;o>s;s+=1)if(e.models.GameRules[s].name===t){for(r=!0,i=e.models.GameRules[s].atoms,a=i.length,n=0;a>n;n+=1)if(r=e.executeGameRuleAtomByName(i[n]),r===!1||-1===r)return!1;return r}return!1},e.addGameRuleAtom=function(t){e.models.GameRuleAtoms.push({atomName:t.atomName,atomFunction:t.atomFunction,atomArguments:t.atomArguments,atomCondition:t.atomCondition,atomConnector:t.atomConnector})},e.entityAtomFunctions={"Is Opponent":function(e,t){var n=e.translateDirection(t.atomArguments),o=parseInt(e.position.x+n[0],10),r=parseInt(e.position.y+n[1],10);return e.isOpponent(o,r)},"Is Empty Cell":function(e,t){var n=e.translateDirection(t.atomArguments),o=parseInt(e.position.x+n[0],10),r=parseInt(e.position.y+n[1],10);return e.isEmptyCell(o,r)},"Current Y Position Is":function(e,t){return e.position.y===t.atomArguments},"Current X Position Is":function(e,t){return e.position.x===t.atomArguments},"Entity Is Able To Reach A Specific Row":function(t,n){var o=n.atomArguments[0];"last"===o?o=parseInt(e.gameWorld.getRows()-1,10):"first"===o&&(o=0);var r=t.translateDirection(n.atomArguments[1]),i=parseInt(t.position.x+r[0],10),a=parseInt(t.position.y+r[1],10);return e.gameWorld.isEmpty(i,a)===!1?!1:o===a},"Entity At Cell Is Of Type":function(e,t){var n=e.translateDirection(t.atomArguments),o=parseInt(e.position.x+n[0],10),r=parseInt(e.position.y+n[1],10),i=e.getGame().gameWorld.peekCell(o,r);return i!==!1&&i.type===t.atomArguments[2]?!0:!1},"Entity At Cell Has Been Moved n Times":function(e,t){var n=e.translateDirection(t.atomArguments),o=parseInt(e.position.x+n[0],10),r=parseInt(e.position.y+n[1],10),i=e.getGame().gameWorld.peekCell(o,r);return i!==!1&&i.getMoveCount()===t.atomArguments[2]?!0:!1},"Entity At Cell Has Been Moved In Last Game Round":function(e,t){var n=e.translateDirection(t.atomArguments),o=parseInt(e.position.x+n[0],10),r=parseInt(e.position.y+n[1],10),i=e.getGame().gameWorld.peekCell(o,r);return i!==!1&&i.getLastExecutedMove().round===e.getGame().models.moveCounter?!0:!1},"Is Not Attackable In Next Round":function(e,t){var n=e.translateDirection(t.atomArguments),o=parseInt(e.position.x+n[0],10),r=parseInt(e.position.y+n[1],10);return!e.getGame().opponentEntityCanCaptureAt(o,r,e)},"Number Of Opponents At Destination Field Is":function(e,t,n){var o=0,r=e.position.x,i=e.position.y,a=t.atomArguments[0],s=t.atomArguments[1],l=e.getGame().gameWorld.getFieldID(r,i);return _.isUndefined(e.tmp.fieldID)===!1&&(l=e.tmp.fieldID),"MOVE POSITIVE"===a?o=parseInt(l+n,10):"MOVE NEGATIVE"===a&&(o=parseInt(l-n,10)),e.countOpponentsOnFieldsWithID(o,e)===s},"No Own Entitys On Fields With ID Less Than":function(e,t){var n=t.atomArguments;return!e.getAssociatedPlayer().hasEntitiesOnFieldWithFieldID(n,"<")},"No Own Entitys On Fields With ID More Than":function(e,t){var n=t.atomArguments;return!e.getAssociatedPlayer().hasEntitiesOnFieldWithFieldID(n,">")},"Destination Field ID Is Greater Than":function(e,t,n){var o=0,r=e.position.x,i=e.position.y,a=t.atomArguments[0],s=e.getGame().gameWorld.getFieldID(r,i);return _.isUndefined(e.tmp.fieldID)===!1?!1:("MOVE POSITIVE"===a?o=parseInt(s+n,10):"MOVE NEGATIVE"===a&&(o=parseInt(s-n,10)),o>t.atomArguments[1])},"Destination Field ID Is Less Than":function(e,t,n){if(_.isUndefined(e.tmp.fieldID)===!1)return!1;var o=0,r=e.position.x,i=e.position.y,a=t.atomArguments[0],s=e.getGame().gameWorld.getFieldID(r,i);return"MOVE POSITIVE"===a?o=parseInt(s+n,10):"MOVE NEGATIVE"===a&&(o=parseInt(s-n,10)),o<t.atomArguments[1]}},e.executeEntityGoalAtomByName=function(t,n,o){if(t.enabled===!1)return!1;var r,i,a=t.goalAtoms.length;for(r=0;a>r;r+=1)if(t.goalAtoms[r].atomName===n)return i=t.goalAtoms[r],e.entityAtomFunctions[i.atomFunction](t,i,o);return!1},e.getAssociatedOpponentEntities=function(t){for(var n,o,r,i,a,s,l,u=t,g={},c=e.gameWorld,m=u.length,d=e.getCurrentPlayer().getNextOpponentPlayer().getOnBoardEntities(),f=d.length;f--;)n=d[f],s=n.position,l=c.getFieldID(s.x,s.y),g[l]={ID:n.ID,x:s.x,y:s.y,associated:!1};for(;m--;){for(i=u[m],o=i.length,f=0,a=o;a--;)r=i[a],g[r]&&f++;if(f===o)for(a=o;a--;)r=i[a],g[r].associated=!0}return g},e.gameRuleAtoms={"Last Move Was Capture Move":function(){return e.getrecentlyMovedEntity()?"capture"===e.getrecentlyMovedEntity().getLastExecutedMove().type:void 0},"Recently Moved Entity Can Capture An Opponent Entity":function(){return e.getrecentlyMovedEntity()?e.getrecentlyMovedEntity().canCapture():void 0},"Recently Moved Entity Can Not Capture An Opponent Entity":function(){return e.getrecentlyMovedEntity()?!e.getrecentlyMovedEntity().canCapture():void 0},"Recently Moved Entity Is Owned By Player":function(t){return e.getrecentlyMovedEntity()?e.getrecentlyMovedEntity().getMetaPlayerID()===t.atomArguments:void 0},"Recently Moved Entity Is At YPosition":function(t){var n=t.atomArguments;return"last"===n?n=parseInt(e.gameWorld.getRows()-1,10):"first"===n&&(n=0),e.getrecentlyMovedEntity()!==!1?e.getrecentlyMovedEntity().getPosition().y===n:void 0},"Recently Moved Entity Is At XPosition":function(t){var n=t.atomArguments;return"last"===n&&(n=e.gameWorld.getColumns()-1),e.getrecentlyMovedEntity()!==!1?e.getrecentlyMovedEntity().getPosition().x===n:void 0},"Recently Moved Entity Is Type":function(t){var n,o=t.atomArguments,r=e.getrecentlyMovedEntity(),i=0,a=t.atomConnector,s=0;if(0!==r)switch(i=r.type,a){case"OR":for(n=o.length,s=n;s--;)if(i===o[s])return!0;return!1;case"AND":for(n=o.length,s=n;s--;)if(i!==o[s])return!1;return!0;default:return i===o}},"Player Has Entities":function(t){return 0!==e.getPlayerWithID(t.atomArguments).countEntities()},"All players have placed their entities on the game board":function(){for(var t,n,o=e.getPlayers(),r=o.length;r--;)for(t=o[r].getEntities(),n=t.length;n--;)if(!t[n].onBoard)return!1;return!0},"Game Mode Is Not":function(t){return e.models.gameMode!==t.atomArguments},"Player Has Entities On Nearby Connected Fields After Last Move":function(t){var n=e.getrecentlyMovedEntity().position;if(!n)return!1;for(var o,r,i,a,s,l,u=t.atomArguments,g=e.gameWorld,c=e.models.recentlyMovedEntity.playerID,m=e.models.GameGrid[n.y][n.x].cellID,d=u.length;d--;)for(a=u[d],s=a.length;s--;)if(o=a[s],i=!0,m===o){for(l=a.length;l--;){if(r=g.getFieldsWithFieldID(a[l],!0),!(r.contains.length>0)){i=!1;break}if(r.contains[0].playerID!==c){i=!1;break}}if(i)return!0}return!1},"Non-associated Opponent Entities":function(t){var n,o,r=e.getAssociatedOpponentEntities(t.atomArguments);for(n in r)if(o=r[n],!o.associated)return!0;return!1},"Player Has No Placeable Entities":function(t){var n=e.getPlayerWithID(t.atomArguments);return n.getPlaceableEntities().length>0?!1:!0},"Player Has No Movable Entities":function(t){var n,o=e.getPlayerWithID(t.atomArguments),r=o.countEntities();if(0===r)return!0;for(n=r;n--;)if(e.checkSelectCondition(o.getEntityFromArray(n))===!0&&o.getEntityFromArray(n).canMove())return!1;for(n=r;n--;)if(e.checkSelectCondition(o.getEntityFromArray(n))===!0&&o.getEntityFromArray(n).canReachGoal())return!1;return!0},"Player Has Entities In Off Board Area":function(t){return e.offBoard.entitiesOfPlayerAreOutside(t.atomArguments)},"Player Has No Entities In Off Board Area":function(t){return!e.offBoard.entitiesOfPlayerAreOutside(t.atomArguments)},"Player Has No Entities":function(t){var n=e.getPlayerWithID(t.atomArguments);return 0===n.countEntities()},"Player Has Number Of Entities":function(t){var n=e.getPlayerWithID(t.atomArguments[0]);return n.countEntities()===t.atomArguments[1]},"Player Owns > n Entities":function(t){var n=t.atomArguments;return e.getPlayerWithID(n.playerID).getEntities().length>n.value?!0:!1},"Player Has No Entity Which Satisfies Goals":function(t){var n,o=e.getPlayerWithID(t.atomArguments),r=o.countEntities();if(0===r)return!0;for(n=r;n--;)if(!_.isEmpty(o.getEntityFromArray(n).canReachGoal()))return!1;return!0},"Player Has Number Of Entities In Row":function(t){var n=t.atomArguments.entityID,o=t.atomArguments.number,r=e.gameWorld.createBoardSignature(),i=new RegExp(n+"{"+o+"}");return i.test(r)},"Player Has Number Of Entities In Column":function(t){var n=t.atomArguments.entityID,o=t.atomArguments.number,r=e.gameWorld.createBoardSignatureByVertical(),i=new RegExp(n+"{"+o+"}");return i.test(r)},"Player Has Number Of Entities Diagonally":function(t){var n,o,r,i="",a=e.gameWorld,s=a.getRows(),l=a.getColumns(),u=t.atomArguments.number,g=t.atomArguments.entityID,c=new RegExp(g+"{"+u+"}"),m=e.gameWorld.createBoardSignature();for(n=0;l>n;n++){for(i="",r=n;r<m.length&&"|"!==m[r];r+=l+2)i+=m[r];if(c.test(i)===!0)return!0}for(o=1;s>o;o++){for(i="",r=o*l+o;r<m.length&&"|"!==m[r];r+=l+2)i+=m[r];if(c.test(i)===!0)return!0}for(o=1;s>o;o++){for(i="",r=o*l+o;r>0&&"|"!==m[r];r-=l)i+=m[r];if(c.test(i)===!0)return!0}for(n=3;l>=n;n++){for(i="",r=s*l+s-n;r>0&&"|"!==m[r];r-=l)i+=m[r];if(c.test(i)===!0)return!0}return!1},"No Empty Field On The Game Board":function(){return 0===e.gameWorld.getFreeCells().length},"Current Player Is":function(t){return e.getPlayerWithID(t.atomArguments).ID===e.getCurrentPlayerID()},"Print Debug Message":function(){return!0},"Game State Is":function(t){return t.atomArguments===e.models.gameState},"Dice Box Is Empty":function(){return e.getDiceBox().gotNoDiceValues()},"Entity Is Under Attack":function(t){return e.entityOfSpecificTypeIsUnderAttack(t.atomArguments)},"Got No Protecting Entities":function(t){return!e.identifyProtectingEntities(t.atomArguments.entityType)},"Every Entity Of Player Is In Target Area":function(t){var n,o,r=e.getPlayerWithID(t.atomArguments.player),i=r.countEntities(),a=t.atomArguments.targetArea,s=a.length,l=!1;if(0===i)return!1;for(n=0;s>n;n+=1){for(l=!1,o=0;i>o;o+=1)r.getEntityFromArray(o).position.x===a[n].x&&r.getEntityFromArray(o).position.y===a[n].y&&(l=!0);if(l===!1)return!1}return!0}},e.executeGameRuleAtomByName=function(t){var n,o,r=e.models.GameRuleAtoms.length;for(o=r;o--;)if(e.models.GameRuleAtoms[o].atomName===t)return n=e.models.GameRuleAtoms[o],e.gameRuleAtoms[n.atomFunction](n);return!1},e.connectGameRuleConsequences=function(t){var n,o=t.ruleName,r="",i="",a=t.consequences;n=a.length;for(var s=n;s--;)a[s].execute="immediately";t.entityName&&(r=t.entityName),t.entityType&&(i=t.entityType),e.models.GameRuleConsequences.push({goalName:o,entityName:r,entityType:i,consequences:a})},e.getGameRuleConsequencesWithName=function(t){for(var n,o=[],r=e.models.GameRuleConsequences,i=r.length,a=i;a--;)n=r[a],n.goalName===t&&(n.entityName&&e.getrecentlyMovedEntity()!==!1&&(n.entityName=e.getrecentlyMovedEntity().getName()),n.entityType&&e.getrecentlyMovedEntity()!==!1&&(n.entityType=e.getrecentlyMovedEntity().type),n.consequences.entityLink=e.getrecentlyMovedEntity(),o.push(n));return o.reverse(),o},e.executeGameRuleConsequences=function(t){for(var n=e.getGameRuleConsequencesWithName(t),o=n.length,r=0;o>r;r+=1)e.addJobs(n[r].consequences)},e.executeGameRules=function(){e.resetRestrictions();var t,n,o=e.countGameRules(),r=!1;for(t=0;o>t;t++)n=e.getGameRule(t),e.executeGameRuleByName(n.name)===!0&&(e.executeGameRuleConsequences(n.name),r=!0);return r},e.getUniqueMoveID=function(e,t,n,o){return e+"_"+t+"_"+n+"|"+o},e.moveEntity=function(t,n,o,r,i){e.gameWorld.moveEntity(t,n,o,r,i)},e.deleteEntityAt=function(t,n){e.gameWorld.deleteCellContent(t,n)},e.countFieldsWithID=function(t){return e.gameWorld.getContentOfFieldsWithFieldID(t).length},e.countOwnOnFieldsWithID=function(t,n){var o,r=e.gameWorld.getContentOfFieldsWithFieldID(t),i=0,a=0,s=r.length;for(o=0;s>o;o+=1)a=r[o],a&&a.getMetaPlayerID()===n.getMetaPlayerID()&&(i+=1);return i},e.countOpponentsOnFieldsWithID=function(t,n){var o,r=e.gameWorld.getContentOfFieldsWithFieldID(t),i=0,a=0,s=r.length;for(o=0;s>o;o+=1)a=r[o],a&&a.getMetaPlayerID()!==n.getMetaPlayerID()&&(i+=1);return i},e.resetRestrictions=function(){e.models.SelectRestrictions.entities="",e.models.SelectRestrictions.moves=""},e.checkSelectCondition=function(t){if("Recently Moved Entity"===e.models.SelectRestrictions.entities){var n=e.getrecentlyMovedEntity();return n.getName()===t.getName()}if(!_.isUndefined(t.selectCondition)){if("Only Off Board Entities"===e.models.SelectRestrictions.entities)return null!==t.position.x&&null!==t.position.y?!1:!0;var o=t.selectCondition,r=!1;if(o.neighboursY){var i,a,s=o.neighboursY.length,l=0,u={"<":function(e,t){return t>e},"<=":function(e,t){return t>=e},">":function(e,t){return e>t},">=":function(e,t){return e>=t},"==":function(e,t){return e==t}};for(i=s;i--;)switch(a=o.neighboursY[i],l=a.appliesTo,l.axis){case"y":if(u[l.operator](t.position.y,l.value)){var g=a.count,c=a.direction,m=a.condition,d=0;switch(c){case"NORTH":d=e.gameWorld.countNeighboursNorth(t);break;case"SOUTH":d=e.gameWorld.countNeighboursSouth(t);break;case"BOTH":default:d=e.gameWorld.countNeighboursY(t)}switch(m){case"LESS THAN OR EQUAL TO":case"<=":g>=d&&(r=!0);break;case"LESS THAN":case"<":g>d&&(r=!0);break;case"MORE THAN OR EQUAL TO":case">=":d>=g&&(r=!0);break;case"MORE THAN":case">":d>g&&(r=!0);break;case"EQUAL":case"=":case"==":case"===":d===g&&(r=!0)}}break;case"x":}}return r}return!0},e.showEntityMoves=function(t,n){var o=e.gameWorld.peekCell(t,n);if(o===!1)return!1;if(_.isUndefined(o))return!1;if(e.isHighlighted(o))return e.resetMoves(),!1;if(o.getMetaPlayerID()!==e.getCurrentPlayerID())return!1;if(e.checkSelectCondition(o)===!0){e.resetMoves();var r,i,a=e.models.SelectRestrictions.moves;switch(a){case"Standard Moves":r=o.getMoves();break;case"Capture Moves":i=o.getGoalMoves(r);break;default:r=o.getMoves(),i=o.getGoalMoves(r)}e.performPostMoveChecks(o,r),e.performPostMoveChecks(o,i),_.isEmpty(r)&&_.isEmpty(i)||e.highlightEntityAtPosition(t,n),e.highlightStandardMoves(r),e.highlightGoalMoves(i)}return!0},e.showFieldsToPlaceEntity=function(){"PLACING"===e.models.gameMode?e.highlightStandardMoves(e.getCurrentPlayer().getAllEntityMoves()):"FREE CAPTURE"===e.models.gameMode&&e.highlightGoalMoves(e.getCurrentPlayer().getAllEntityMoves())},e.highlightStandardMoves=function(t){if(!_.isUndefined(t))for(var n,o=t.length;o--;)n=t[o],e.highlightCell(n.targetX,n.targetY,n.moveClass,n.ID),e.models.MoveTable.push({entity:n.entity,xPosition:n.targetX,yPosition:n.targetY,moveClass:n.moveClass,moveID:n.ID})},e.highlightGoalMoves=function(t){if(!_.isUndefined(t))for(var n,o,r=t.length;r--;)switch(n=t[r],n.type){case"DICE":"move_bearoff"===n.moveClass?e.executeGoalConsequences(n.name,n.entity,!1):(o=n.entity,e.setMoveID(e.getDiceBox().getMoveIDForDiceID(n.diceID)),o.setTarget(n.targetX,n.targetY),e.executeGoalConsequences(n.name,o,!1),o.unsetTarget());break;case"FREE CAPTURE":e.addJobForMoveID({jobID:n.ID,jobName:"Highlight Cell",job:"Highlight Cell",jobArguments:[n.targetX,n.targetY,"move_goal","ABSOLUTE"],execute:"immediately"}),e.addJobForMoveID({jobID:n.ID,jobName:"Delete Opponent Entity",job:"Capture Opponent At",jobArguments:[n.targetX,n.targetY,"ABSOLUTE"]}),e.addJobForMoveID({jobID:n.ID,jobName:"Reset Game Mode",job:"Reset Game Mode"});break;default:o=n.entity;var i=[],a=o.position.x,s=o.position.y;i.x=a,i.y=s,e.doVirtualMove(a,s,n.preArrangeX,n.preArrangeY),e.executeGoalConsequences(n.name,o,i),e.undoVirtualMove()}},e.performPostMoveChecks=function(t,n){if(null!==t.postMoveCheck)for(var o,r,i,a=t.postMoveCheck,s=0;s<n.length;s++)for(i=0;i<a.length;i++)o=a[i],"Entity Is Attackable After Move"===o.condition&&(r=n[s].entity,e.doVirtualMove(r.position.x,r.position.y,n[s].targetX,n[s].targetY),e.entityOfTypeIsUnderAttack(o.entity,r.getAssociatedPlayer())&&(n.splice(s,1),s-=1),e.undoVirtualMove())},e.resetMoves=function(){var t,n,o=e.gameWorld,r=e.models,i=r.MoveTable,a=r.HighlightTable;for(n=i.length;n--;)t=i[n],o.setCellClass(t.xPosition,t.yPosition,"");for(r.MoveTable.length=0,r.GoalMoves.length=0,r.MovableEntities.length=0,n=a.length;n--;)t=a[n],o.setCellClass(t.x,t.y,"");e.flush(r.HighlightTable),null!==e.areas&&e.areas.isEnabled()&&e.areas.resetDisplays(),null!==e.getDiceBox()&&e.getDiceBox().flushAttachedMoveIDs()},e.isHighlighted=function(t){var n,o,r=e.models.HighlightTable,i=r.length,a=t.position.x,s=t.position.y;for(n=0;i>n;n+=1)if(o=r[n],o.x===a&&o.y===s)return!0;return!1},e.highlightEntityAtPosition=function(t,n){e.gameWorld.isValidCoordinate(t,n)&&(e.models.HighlightTable.push({x:t,y:n}),e.gameWorld.setCellClass(t,n,"clickedEntity"))},e.highlightCell=function(t,n,o,r){e.gameWorld.setCellClass(t,n,o),e.models.HighlightTable.push({x:t,y:n}),"move_goal"===o&&(e.models.MoveTable.push({entity:null,xPosition:t,yPosition:n,moveClass:o,moveID:r}),e.models.GoalMoves.push({entity:null,xPosition:t,yPosition:n}))},e.virtualMove=[],e.doVirtualMove=function(t,n,o,r){var i=e.gameWorld,a={srcX:t,srcY:n,srcEntity:i.popFromCell(t,n),destX:o,destY:r,destEntity:i.popFromCell(o,r)};if(e.virtualMove.push(a),a.destEntity&&null!==a.destEntity&&a.destEntity.setPosition(null,null),a.srcEntity){var s=a.srcEntity;i.pushToCell({entityID:s.ID,playerID:s.getMetaPlayerID(),typeID:s.getTypeID()},o,r),s.setPosition(o,r,!0)}},e.undoVirtualMove=function(){var t=e.virtualMove.pop();if(!t)return!1;var n=t.srcEntity;n&&null!==n&&(e.gameWorld.popFromCell(t.destX,t.destY),n.setPosition(t.srcX,t.srcY),e.gameWorld.pushToCell({entityID:n.ID,playerID:n.getMetaPlayerID(),typeID:n.getTypeID()},t.srcX,t.srcY));var o=t.destEntity;return o&&null!==o&&(o.setPosition(t.destX,t.destY),e.gameWorld.pushToCell({entityID:o.ID,playerID:o.getMetaPlayerID(),typeID:o.getTypeID()},t.destX,t.destY)),!0},e.moveConditions={"Is Empty":function(t,n){return e.gameWorld.isEmpty(t._destX,t._destY)!==n?!1:!0},"Is Empty At":function(t,n,o){return!e.gameWorld.isEmpty(parseInt(t._curX+t._conditions[o].relativeCoordinate[0],10),parseInt(t._curY+t._conditions[o].relativeCoordinate[1],10))===n?!1:!0},"Is Not The Last Row":function(t){return t._destY===parseInt(e.gameWorld.getRows()-1,10)?!1:!0},"Is Not The First Row":function(e){return 0===e._destY?!1:!0},"Move Count":function(e,t,n){return e._currentEntity.getMoveCount()!==e._conditions[n].value?!1:!0},"Move Count Of Entity":function(t,n,o){var r=e.getCurrentPlayer().getEntityWithName(t._conditions[o].entityName);return r===!1?!1:r.getMoveCount()!==t._conditions[o].value?!1:!0},"Player Owns n Entities":function(t,n,o){return e.getPlayerWithID(t._conditions[o].playerID).getEntities().length===t._conditions[o].value?!0:!1},"Player Owns > n Entities":function(t,n,o){return e.getPlayerWithID(t._conditions[o].playerID).getEntities().length>t._conditions[o].value?!0:!1},"Game State":function(t,n,o){return e.models.gameState===t._conditions[o].value&&n===!0?!0:e.models.gameState!==t._conditions[o].value&&n===!1?!0:!1},"Field Is Attackable By Opponent Entity":function(t,n,o){var r=t._conditions[o],i=parseInt(t._curX+r.relativeCoordinate[0],10),a=parseInt(t._curY+r.relativeCoordinate[1],10);return e.doVirtualMove(t._curX,t._curY,i,a),n===e.opponentEntityCanCaptureAt(i,a,t._currentEntity)?(e.undoVirtualMove(),!0):(e.undoVirtualMove(),!1)},"Target Field Is Reachable By Opponent Entity":function(t,n,o){var r=e.getCurrentPlayer().getNextOpponentPlayer().getEntitiesOfType(t._conditions[o].opponentEntity),i=r.length;if(0===i)return!0;for(var a,s,l,u,g,c,m,d=null,f=i;f--;)for(a=r[f],u=a.position.x,g=a.position.y,s=a.countGoals();s--;)if(l=a.getGoal(s),d=a.translateDirection(l.move),c=parseInt(u+d[0],10),m=parseInt(g+d[1],10),c===t._destX&&m===t._destY)return!1;return!0},yPosition:function(e,t,n){return e._curY===e._conditions[n].value&&t===!0?!0:!1},xPosition:function(e,t,n){return e._curX===e._conditions[n].value&&t===!0?!0:!1}},e.isLegalMove=function(t,n,o,r,i,a){if(e.gameWorld.isValidCoordinate(i,a)===!1)return!1;var s,l,u;for(l=n.length,u={_currentEntity:t,_conditions:n,_curX:o,_curY:r,_destX:i,_destY:a},s=0;l>s;s+=1)if(e.moveConditions[n[s].condition](u,n[s].state,s)===!1)return!1;return!0},e.viewScope=null,e.refreshView=function(){e.models.playVirtual||e.viewScope.$apply()},e.executeRandomMove=function(){var t=e.getCurrentPlayer().getAllEntityMoves(),n=t[_.random(0,parseInt(t.length-1,10))];e.executeMove(n)},e.executeArtificialMove=function(t){if("random"===t)return e.executeRandomMove(),!0;var n=e.getCurrentPlayer().getAllEntityMoves(),o=n[t.moveIndex];return e.executeMove(o),!0},e.executeMove=function(t){if("END"===e.models.gameState)return!1;var n,o,r=!1;if("move_goal"===t.moveClass||"move_bearoff"===t.moveClass)if(n=t.entity,"DICE"===t.type)"move_bearoff"===t.moveClass?(e.executeGoalConsequences(t.name,n,!1),r=t.targetArea):(e.setMoveID(e.getDiceBox().getMoveIDForDiceID(t.diceID)),n.setTarget(t.targetX,t.targetY),e.executeGoalConsequences(t.name,n,!1),n.unsetTarget());else{var i=[];o=n.position,"FREE CAPTURE"===t.type?(t.targetX=e.models.HighlightTable[0].x,t.targetY=e.models.HighlightTable[0].y):(i.x=o.x,i.y=o.y,e.doVirtualMove(o.x,o.y,t.preArrangeX,t.preArrangeY),e.executeGoalConsequences(t.name,n,i),e.undoVirtualMove(),t.targetX=e.models.HighlightTable[0].x,t.targetY=e.models.HighlightTable[0].y)}else{if(e.models.MoveTable.push({entity:t.entity,xPosition:t.targetX,yPosition:t.targetY,moveClass:t.moveClass,moveID:t.ID}),"DICE"===t.type){var a=!1,s=t.targetX,l=t.targetY;n=t.entity,_.isUndefined(n.tmp.fieldID)===!1&&(a=!0),a===!0?(e.addJobForMoveID({jobID:t.ID,jobName:"Put the entity to the destination field",job:"Place Entity",jobArguments:{entity:n,xPosition:s,yPosition:l}}),e.addJobForMoveID({jobID:t.ID,jobName:"Remove the current entity from off board area",job:"Delete Entity from OffBoard",jobArguments:{entity:n}})):e.addJobForMoveID({jobID:t.ID,jobName:"move game entity",job:"Move Entity By Dice Value",jobArguments:{entity:t.entity,destX:t.targetX,destY:t.targetY,diceValue:t.diceValue}}),e.addJobForMoveID({jobID:t.ID,jobName:"Delete Dice Value",job:"Delete Dice Value",jobArguments:t.diceID})}else"PLACING"!==e.models.gameMode&&e.addJobForMoveID({jobID:t.ID,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:t.entity,destX:t.targetX,destY:t.targetY}});t.postMove&&_.each(t.postMove,function(n){e.addJobForMoveID({jobID:t.ID,jobName:n.jobName,job:n.jobFunction,jobArguments:n.jobArguments})})}return e.loop(r,t.targetX,t.targetY),e.refreshView(),!0},e.artificialTurn=function(){return"WAITINGFORDICEROLL"===e.models.gameState&&(Spoooky.GameEvents.fireEvent({job:"Roll Backgammon Dices"},e),"WAITINGFORDICEROLL"===e.models.gameState)?(e.pseudoLoop(),!1):(e.getCurrentPlayer().artificialMove(),!0)},e.addJobs=function(t){for(var n,o,r=0;r<t.length;r++)o=t[r],n={jobID:e.models.moveID,jobName:o.jobName,job:o.jobFunction,jobArguments:o.jobArguments,entityLink:t.entityLink},o.execute?"immediately"===o.execute&&Spoooky.GameEvents.fireEvent(n,e):e.addJobForMoveID(n);return e.models.moveID=0,!0},e.addJobForMoveID=function(t){return t.execute&&"immediately"===t.execute?Spoooky.GameEvents.fireEvent(t,e):e.jobQueue.addJob(t),!0},e.isMove=function(t,n){for(var o,r=e.models.MoveTable,i=r.length,a=i;a--;)if(o=r[a],o.xPosition===t&&o.yPosition===n&&0!==o.moveID)return!0;return e.isGoalMove(t,n)},e.isGoalMove=function(t,n){for(var o=e.models.GoalMoves,r=o.length,i=r;i--;)if(o[i].xPosition===t&&o[i].yPosition===n)return!0;return!1},e.getMoveID=function(t,n){for(var o,r=e.models.MoveTable,i=r.length;i--;)if(o=r[i],o.xPosition===t&&o.yPosition===n&&0!==o.moveID)return o.moveID;return!1},e.executeJobsForThisMove=function(t,n){e.executeJobsForMoveID(e.getMoveID(t,n)),e.setRecentlyMovedEntity(t,n)},e.executeJobsForRecentMove=function(){e.resetMoves(),e.executeJobsForMoveID(e.models.lastMoveID)},e.executeJobsForMoveID=function(t){for(var n=e.jobQueue.getJobsWithMoveID(t),o=n.length,r=0;o>r;r++)Spoooky.GameEvents.fireEvent(n[r],e);e.jobQueue.flush(),e.models.moveID=0},e.executePostMoveJobs=function(){var t=e.models.gameMode;("PLACING"===t||"FREE CAPTURE"===t)&&e.showFieldsToPlaceEntity()},e.getEntityAtCell=function(t,n){return e.gameWorld.peekCell(t,n)},e.getEntityWithName=function(t){for(var n,o=e.getPlayers(),r=o.length;r--;)if(n=o[r].getEntityWithName(t),n!==!1)return n;return!1},e.pushEntityToCell=function(t,n,o){t.setPosition(n,o),e.gameWorld.pushToCell({entityID:t.ID,playerID:t.getMetaPlayerID(),typeID:t.getTypeID()},n,o)},e.identifyProtectingEntities=function(t){for(var n,o,r,i,a,s,l,u=e.getCurrentPlayer(),g=!1,c=u.countEntities();c--;){for(n=u.getEntityFromArray(c),i=n.getMoves(),a=n.getGoalMoves(),e.performPostMoveChecks(n,i),e.performPostMoveChecks(n,a),s=n.position.x,l=n.position.y,o=i.length;o--;)r=i[o],e.doVirtualMove(s,l,r.targetX,r.targetY),e.entityOfTypeIsUnderAttack(t,n.getAssociatedPlayer())||(e.models.MovableEntities.push(n),e.highlightEntityAtPosition(s,l),g=!0),e.undoVirtualMove();var m=a.length;for(o=m;o--;)r=a[o],e.doVirtualMove(s,l,r.targetX,r.targetY),e.entityOfTypeIsUnderAttack(t,n.getAssociatedPlayer())||(e.models.MovableEntities.push(n),e.highlightEntityAtPosition(s,s),g=!0),e.undoVirtualMove()}return g},e.opponentEntityCanCaptureAt=function(t,n,o){var r,i,a=o.getAssociatedPlayer().getNextOpponentPlayer();e.doVirtualMove(o.position.x,o.position.y,t,n);for(var s=a.countEntities();s--;)for(r=a.getEntityFromArray(s).getGoalMoves(),i=r.length;i--;)if("CAPTURE"===r[i].type&&t===r[i].targetX&&n===r[i].targetY)return e.undoVirtualMove(),!0;return e.models.GoalMoves.length=0,e.undoVirtualMove(),!1},e.connectEntityActionsConsequences=function(t){var n=t.goalName,o=t.consequences,r="",i="";
t.entityName&&(r=t.entityName),t.entityType&&(i=t.entityType),e.models.EntityGoalConsequences.push({goalName:n,entityName:r,entityType:i,consequences:o})},e.connectConsequences=function(t){for(var n=_.keys(t),o=n.length,r=0;o>r;++r)e.connectEntityActionsConsequences(t[n[r]])},e.getGoalConsequencesWithName=function(t,n){for(var o,r=[],i=e.models.EntityGoalConsequences,a=i.length;a--;)o=e.models.EntityGoalConsequences[a],o.goalName===t&&(o.entityName===n.getName()?(o.consequences.entityLink=n,r.push(o)):o.entityType===n.type&&(o.entityName=n.getName(),o.consequences.entityLink=n,r.push(o)));return r},e.executeGoalConsequences=function(t,n,o){var r,i=e.getGoalConsequencesWithName(t,n),a=n.position;r=0===e.models.moveID?e.getUniqueMoveID(n.name,t,a.x,a.y):e.models.moveID,e.setMoveID(r),o&&e.addJobForMoveID({jobID:e.models.moveID,jobName:"move game entity",job:"Prearrange Entity",jobArguments:{entity:n,destX:a.x,destY:a.y}});for(var s=0;s<i.length;s++)e.addJobs(i[s].consequences)},e.translateCoordinates=function(t,n){return String.fromCharCode(parseInt(97+t,10))+(e.gameWorld.getRows()-n)},e.addEntitiesToGameBoard=function(t){for(var n,o,r,i,a=0,s=e.gameWorld.getRows(),l=e.gameWorld.getColumns(),u=0;s>u;u++)for(o=0;l>o;o++)i=t[a],0!==i&&(n=e.getPlayerWithID(i.associatedWithMetaAgent),r=n.entityFactory(i),r.onBoard=!0,e.pushEntityToCell(r,o,u)),a++},e.addEntityToGame=function(t,n){if(0===n)return!1;var o=e.getPlayerWithID(t.associatedWithMetaAgent);if(n>0)for(t.unlimitedQuantity=!1;n--;)o.entityFactory(t);else t.unlimitedQuantity=!0,o.entityFactory(t)},e.entityOfTypeIsUnderAttack=function(e,t){for(var n=t.getEntitiesOfType(e),o=n.length,r=o;r--;)if(n[r].canBeCaptured())return!0;return!1},e.entityOfSpecificTypeIsUnderAttack=function(t){var n=e.getPlayerWithID(t.associatedWithMetaAgent);if(0===n.countEntities())return!1;var o=n.getEntitiesOfType(t.entityType);if(0===o.length)return!1;for(var r=o.length,i=r;i--;)if(o[i].canBeCaptured()===!0)return!0;return!1}},Spoooky.DiceBox=function(e){var t=this,n=e;t.enable=function(){n.models.DiceBox.isEnabled=!0},t.isEnabled=function(){return n.models.DiceBox.isEnabled},t.createDice=function(e,t){n.models.DiceBox.dices.push({start:e,end:t})},t.countDices=function(){return n.models.DiceBox.dices.length},t.getDice=function(e){return e>=0&&e<t.countDices()?n.models.DiceBox.dices[e]:!1},t.rollDice=function(e){return t.getDice(e)!==!1?parseInt(_.random(t.getDice(e).start,t.getDice(e).end),10):!1},t.rollAllDices=function(){for(var e=[],o=t.countDices();o--;)e.push(t.rollDice(o));return n.models.DiceBox.diceValues=e,e},t.getMoveIDForDiceID=function(e){for(var t=n.models.DiceBox,o=t.attachedMoveIDs.length;o--;)if(t.attachedMoveIDs[o].diceValueID===e)return t.attachedMoveIDs[o].moveID;return!1},t.connectMoveIDWithDiceValue=function(e,t,o){n.models.DiceBox.attachedMoveIDs.push({diceValueID:t,moveID:e,target:o})},t.getConnectedDiceValue=function(e){for(var t=n.models.DiceBox,o=t.attachedMoveIDs.length;o--;)if(t.attachedMoveIDs[o].moveID===e)return t.attachedMoveIDs[o];return!1},t.flushAttachedMoveIDs=function(){n.models.DiceBox.attachedMoveIDs.length=0},t.getDiceValues=function(){return n.models.DiceBox.diceValues},t.gotNoDiceValues=function(){return!n.models.DiceBox.diceValues[0]},t.deleteDiceValue=function(e){n.models.DiceBox.diceValues.splice(e,1)},t.deleteAllDiceValues=function(){n.models.DiceBox.diceValues.length=0}},Spoooky.GridWelt=function(e){var t=this,n=e;t.getRows=function(){return n.models.worldDimensions.rows},t.getColumns=function(){return n.models.worldDimensions.columns},t.getView=function(e,o){return t.isValidCoordinate(e,o)?n.models.GameGrid[o][e].view:!1},t.setup=function(){return n.models.worldDimensions.fieldsX>0&&n.models.worldDimensions.fieldsY>0?(t.init2DGrid(),!0):(console.log("Invalid Size of GridWelt"),!1)},t.setup2D=function(e,o){return n.models.worldDimensions.rows=o,n.models.worldDimensions.columns=e,t.init2DGrid(),!0},t.setupGameBoard=function(e){for(var o,r,i=0,a=t.getRows(),s=t.getColumns(),l=0;a>l;l+=1)for(o=0;s>o;o+=1)r=e[i],t.setCellBaseClass(o,l,r),-1!==r.indexOf("disabled")&&(n.models.GameGrid[o][l].enabled=!1),i+=1},t.setCellClass=function(e,n,o){t.getView(e,n).cellClass=o},t.setCellBaseClass=function(e,n,o){t.getView(e,n).baseClass=o},t.init2DGrid=function(){var e,o,r,i,a;for(i=t.getRows(),a=t.getColumns(),e=0;i>e;e+=1){for(r=[],o=0;a>o;o+=1)r.push({cellID:null,contains:[],view:{baseClass:"",cellClass:""},position:{x:o,y:e},enabled:!0});n.models.GameGrid.push(r)}return!0},t.enumerateFieldIDsByClass=function(e){var o,r,i,a=1,s=t.getColumns(),l=t.getRows(),u=n.models.GameGrid;for(r=0;l>r;r+=1)for(o=0;s>o;o+=1)i=u[r][o],i.view.baseClass===e&&(i.cellID=a,a++)},t.setFieldIDs=function(e){var o,r,i=0,a=t.getColumns(),s=t.getRows(),l=n.models.GameGrid;for(r=0;s>r;r+=1)for(o=0;a>o;o+=1)l[r][o].cellID=e[i],i+=1;return!0},t.getFieldID=function(e,o){return t.isValidCoordinate(e,o)?n.models.GameGrid[o][e].cellID:!1},t.connectCells=function(e){n.models.CellConnections=e},t.createBoardSignature=function(){var e,t,o=n.models.GameGrid,r=n.gameWorld.getColumns(),i="",a=_.flatten(o),s=a.length;for(t=0;s>t;t++)e=a[t].contains,i+=0===e.length?"0":_.last(e).typeID,(t+1)%r===0&&t+1!==s&&(i+="|");var l=n.models.OffBoardContent;if(l.length>0)for(i+="|",t=l.length;t--;)i+=l[t].typeID;return i},t.createBoardSignatureByVertical=function(){var e,o,r,i=t.getRows(),a=t.getColumns(),s=n.models.GameGrid,l="";for(o=0;a>o;o++){for(r=0;i>r;r++)e=s[r][o].contains,l+=0===e.length?"0":_.last(e).typeID;o+1!==a&&(l+="|")}return l},t.pushToCell=function(e,o,r){return t.isValidCoordinate(o,r)?(n.models.GameGrid[r][o].contains.push(e),!0):!1},t.popFromCell=function(e,o){if(t.isValidCoordinate(e,o)){var r=n.models.GameGrid[o][e].contains.pop();if(r)return n.getPlayerWithID(r.playerID).getEntityWithID(r.entityID)}return!1},t.deleteCellContent=function(e,n){if(t.isValidCoordinate(e,n)){var o=t.popFromCell(e,n);if(o&&0!==o)return o.seppuku(),!0}return!1},t.peekCell=function(e,o){if(t.isValidCoordinate(e,o)){var r=n.models.GameGrid[o][e].contains;return 0!==r.length?(r=_.last(r),n.getPlayerWithID(r.playerID).getEntityWithID(r.entityID)):!1}return!1},t.isValidCoordinate=function(e,n){var o,r=parseInt(e,10);return r<t.getColumns()&&r>=0&&(o=parseInt(n,10),o>=0&&o<t.getRows())?!0:!1},t.isEmpty=function(e,n){return t.peekCell(e,n)===!1},t.moveEntity=function(e,o,r,i,a){if(_.isUndefined(r)||_.isUndefined(i))return!1;if(t.isValidCoordinate(r,i)===!1)return!1;var s=n.models.GameGrid[i][r].contains,l=t.popFromCell(e,o);if(_.isUndefined(a)===!1)a.setPosition(r,i),s.push({entityID:a.ID,playerID:a.getMetaPlayerID(),typeID:a.getTypeID()});else{if(!l)return!1;l.setPosition(r,i),s.push({entityID:l.ID,playerID:l.getMetaPlayerID(),typeID:l.getTypeID()})}return!0},t.getFreeCells=function(){for(var e,o,r=[],i=t.getColumns(),a=t.getRows(),s=n.models.GameGrid,l=i;l--;)for(o=a;o--;)e=s[o][l],e.enabled&&0===e.contains.length&&r.push({x:l,y:o});return r},t.getFreeFieldsWithFieldID=function(e){for(var o,r,i=[],a=t.getColumns(),s=t.getRows(),l=n.models.GameGrid,u=a;u--;)for(o=s;o--;)r=l[o][u],0===r.contains.length&&r.cellID===e&&i.push([u,o]);return i.reverse(),i},t.getFieldsWithFieldID=function(e,t){var o,r,i,a=[],s=n.models,l=s.worldDimensions.columns,u=s.worldDimensions.rows,g=s.GameGrid;for(r=l;r--;)for(i=u;i--;)if(o=g[i][r],o.cellID===e){if(t)return o;a.push(o)}return a.reverse(),a},t.getContentOfFieldsWithFieldID=function(e){var o,r,i,a,s=[],l=t.getColumns(),u=t.getRows(),g=n.models.GameGrid;for(r=l;r--;)for(i=u;i--;)o=g[i][r],o.cellID===e&&(a=t.peekCell(r,i),a&&s.push(a));return s.reverse(),s},t.countNeighboursNorth=function(e){var o=e.position.x,r=e.position.y,i=n.models.GameGrid[r][o].cellID,a=e.getAssociatedPlayer(),s=0,l=t.peekCell(o,parseInt(r-1,10)),u=n.models.GameGrid;return l!==!1&&u[parseInt(r-1,10)][o].cellID===i&&l.getAssociatedPlayer()===a&&(s+=1),s},t.countNeighboursSouth=function(e){var o=e.position.x,r=e.position.y,i=n.models.GameGrid;if(t.isValidCoordinate(o,r)===!1)return!1;var a=null,s=e.getAssociatedPlayer(),l=0,u=t.peekCell(o,parseInt(r+1,10));return i[r][o]&&(a=i[r][o].cellID),u!==!1&&i[parseInt(r+1,10)][o].cellID===a&&u.getAssociatedPlayer()===s&&(l+=1),l},t.countNeighboursY=function(e){return t.countNeighboursNorth(e)+t.countNeighboursSouth(e)}},Spoooky.OffBoard=function(e){var t=this,n=e;t.addEntity=function(e){n.models.OffBoardContent.push({typeID:e.typeID,entityID:e.ID,entityName:e.getName(),playerID:e.getMetaPlayerID()})},t.deleteEntity=function(e){n.models.OffBoardContent.splice(e,1)},t.deleteEntityFromOffBoard=function(e){for(var o=n.models.OffBoardContent.length,r=o;r--;)if(n.models.OffBoardContent[r].entityName===e)return t.deleteEntity(r),!0;return!1},t.entitiesOfPlayerAreOutside=function(e){for(var t=n.models.OffBoardContent.length,o=t;o--;)if(n.models.OffBoardContent[o].playerID===e)return!0;return!1},t.getAllEntities=function(){return n.models.OffBoardContent},t.getEntityWithPlayerID=function(e){for(var t=n.models.OffBoardContent.length,o=t;o--;)if(n.models.OffBoardContent[o].playerID===e){var r=n.models.OffBoardContent[o];return n.getPlayerWithID(r.playerID).getEntityWithID(r.entityID)}return!1},t.getEntitiesWithPlayerID=function(e){for(var t,o=[],r=n.models.OffBoardContent,i=0;i<r.length;i++)t=r[i],t.playerID===e&&o.push(n.getPlayerWithID(t.playerID).getEntityWithID(t.entityID));return o}},Spoooky.GameEvents={events:{"Reset Moves":function(e,t){t.resetMoves()},"Roll Dices":function(e,t){t.getDiceBox().rollAllDices()},"Roll Backgammon Dices":function(e,t){var n,o=-1,r=!0,i=t.getDiceBox();t.setGameState("INGAME"),i.rollAllDices(),n=i.getDiceValues(),_.each(n,function(e){-1!==o&&o!==e&&(r=!1),o=e}),r===!0&&(n.push(n[0]),n.push(n[0])),t.executeGameRules()},"Delete Dice Value":function(e,t){t.getDiceBox().deleteDiceValue(e.jobArguments)},"Delete Assigned Dice Value":function(e,t){return t.getDiceBox().getConnectedDiceValue(e.jobID)===!1?!1:(t.getDiceBox().deleteDiceValue(t.getDiceBox().getConnectedDiceValue(e.jobID).diceValueID),!0)},"Bear Off Entity At Dice Target Cell":function(e,t){var n=t.getDiceBox().getConnectedDiceValue(e.jobID);if(n===!1)return!1;var o=n.target.x,r=n.target.y,i=t.gameWorld.peekCell(o,r);return i===!1?!1:_.isUndefined(i)||null===i?!1:(i.setPosition(null,null),0===t.getCurrentPlayerID()?i.tmp.fieldID=25:1===t.getCurrentPlayerID()&&(i.tmp.fieldID=0),t.offBoard.addEntity(i),t.gameWorld.popFromCell(o,r),!0)},"Show Backgammon Re-entering Moves":function(e,t){var n=e.jobArguments.playerID;if(n===t.getCurrentPlayerID()){var o=t.offBoard.getEntityWithPlayerID(n),r=!1;o.setPosition(-1,-1),0===n?o.tmp.fieldID=0:1===n&&(o.tmp.fieldID=25);var i=o.getMoves(),a=o.getGoalMoves(i);return t.highlightStandardMoves(i),t.highlightGoalMoves(a),r}return!1},"Delete Entity from OffBoard":function(e,t){delete e.jobArguments.entity.tmp.fieldID,t.offBoard.deleteEntityFromOffBoard(e.jobArguments.entity.name)},"Place Entity":function(e,t){var n=e.jobArguments.entity,o=t.getPlayerWithID(n.associatedWithPlayerID).getEntityWithID(n.ID),r=e.jobArguments;o.unlimitedQuantity||(o.onBoard=!0),t.pushEntityToCell(o,r.xPosition,r.yPosition),t.models.moveCounter+=1,t.models.playVirtual===!1&&Spoooky.GameProcess.pushMessage("["+t.models.moveCounter+"] "+t.getCurrentPlayerName()+" setzt Spielfigur auf Feld "+t.translateCoordinates(r.xPosition,r.yPosition)+".")},"Move Entity To Dice Destination Cell":function(e,t){var n=t.getDiceBox().getConnectedDiceValue(e.jobID);if(n===!1)return!1;var o=e.entityLink.position.x,r=e.entityLink.position.y,i=n.target.x,a=n.target.y;if(t.models.moveCounter+=1,t.models.playVirtual===!1){var s=t.translateCoordinates(o,r),l=t.translateCoordinates(i,a);Spoooky.GameProcess.pushMessage("["+t.models.moveCounter+"] "+t.getCurrentPlayerName()+" bewegt Spielfigur von "+s+" nach "+l+".")}return _.isUndefined(e.entityLink.tmp.fieldID)===!1?(t.moveEntity(o,r,i,a,e.entityLink),delete e.entityLink.tmp.fieldID,t.offBoard.deleteEntityFromOffBoard(e.entityLink.getName())):t.moveEntity(o,r,i,a),!0},"Prearrange Entity":function(e,t){var n=e.jobArguments,o=n.entity.position;t.models.moveCounter+=1,t.moveEntity(o.x,o.y,n.destX,n.destY)},"Move Entity":function(e,t){var n=t.models,o=e.jobArguments,r=o.entity.position;if(n.moveCounter+=1,n.playVirtual===!1){var i=t.translateCoordinates(r.x,r.y),a=t.translateCoordinates(o.destX,o.destY);Spoooky.GameProcess.pushMessage("["+n.moveCounter+"] "+t.getCurrentPlayerName()+" bewegt Spielfigur von "+i+" nach "+a+".")}t.moveEntity(r.x,r.y,o.destX,o.destY)},"Move Entity By Dice Value":function(e,t){var n=t.models,o=e.jobArguments,r=o.entity.position;if(n.moveCounter+=1,n.playVirtual===!1){var i=t.translateCoordinates(r.x,r.y),a=t.translateCoordinates(o.destX,o.destY);Spoooky.GameProcess.pushMessage("["+n.moveCounter+"] "+t.getCurrentPlayerName()+" bewegt Spielfigur von "+i+" nach "+a+" mit dem Wuerfelwert "+o.diceValue+".")}t.moveEntity(r.x,r.y,o.destX,o.destY)},"Move Entity Relative To":function(e,t){var n=e.entityLink,o=n.position.x,r=n.position.y;t.moveEntity(o,r,parseInt(o+e.jobArguments[0],10),parseInt(r+e.jobArguments[1],10))},"Move Entity With Name":function(e,t){var n=t.getEntityWithName(e.jobArguments[0]);if(n===!1)return!1;var o,r,i=e.jobArguments,a=n.position.x,s=n.position.y;return"RELATIVE"===i[3]?(o=parseInt(a+i[1],10),r=parseInt(s+i[2],10)):"ABSOLUTE"===i[3]&&(o=i[1],r=i[2]),t.moveEntity(a,s,o,r),t.models.moveCounter+=1,!0},"Prevent Player Change":function(e,t){return t.models.playerChange=!1,!0},"Enable Player Change":function(e,t){t.models.playerChange=!0},"Proceed Game":function(e,t){t.proceed()},"Change Game Mode":function(e,t){t.setGameMode(e.jobArguments.mode)},"Reset Game Mode":function(e,t){t.models.gameMode=t.models.tmpGameMode,t.models.tmpGameMode=""},"Delete Game Rule":function(e,t){for(var n=t.models.GameRules,o=n.length,r=e.jobArguments.ruleName;o--;)if(r===n[o].name)return t.models.GameRules.splice(o,1),!0;return!1},"Capture At":function(e,t){var n=e.jobArguments,o=n.x,r=n.y;if(console.log("here"),t.models.playVirtual===!1){var i=t.translateCoordinates(o,r);Spoooky.GameProcess.pushMessage("["+t.models.moveCounter+"] "+t.getCurrentPlayerName()+" schlaegt gegnerische Spielfigur auf Feld "+i+".")}t.deleteEntityAt(o,r)},"Capture Opponent At":function(e,t){var n,o,r,i=e.jobArguments;if(e.entityLink&&(r=e.entityLink.position),"RELATIVE"===i[2]?(n=parseInt(r.x+i[0],10),o=parseInt(r.y+i[1],10)):"ABSOLUTE"===i[2]&&(n=i[0],o=i[1]),t.models.playVirtual===!1){var a=t.translateCoordinates(n,o);Spoooky.GameProcess.pushMessage("["+t.models.moveCounter+"] "+t.getCurrentPlayerName()+" schlaegt gegnerische Spielfigur auf Feld "+a+".")}t.deleteEntityAt(n,o)},"Highlight Dice Target Cell":function(e,t){t.highlightCell(e.entityLink.targeting.x,e.entityLink.targeting.y,e.jobArguments,e.jobID)},"Highlight Area":function(e,t){t.getArea(e.jobArguments.areaName).display=e.jobArguments.highlightClass},"Highlight Cell":function(e,t){var n=e.jobArguments,o=n[0],r=n[1],i=n[2];"RELATIVE"===n[3]?(o=parseInt(e.entityLink.position.x+n[0],10),r=parseInt(e.entityLink.position.y+n[1],10)):"ABSOLUTE"===n[3]&&(o=n[0],r=n[1]),t.highlightCell(o,r,i,e.jobID)},"Set Game State":function(e,t){t.setGameState(e.jobArguments)},"Restrict Selectable Entities":function(e,t){t.models.SelectRestrictions.entities=e.jobArguments},"Restrict Selectable Entity Moves":function(e,t){t.models.SelectRestrictions.moves=e.jobArguments},"Delete This Entity":function(e,t){t.deleteEntityAt(e.entityLink.position.x,e.entityLink.position.y)},"Increment Off Board Counter":function(e,t){t.areas.incrementElements(e.jobArguments)},"Transform Entity":function(e,t){var n=e.entityLink,o=t.models.MetaAgents[e.entityLink.associatedWithPlayerID],r=n.position.x,i=n.position.y;t.deleteEntityAt(r,i),t.resetMoves();var a=t.getBlueprint(e.jobArguments),s=o.entityFactory(a);s.setName(n.getName()),s.setID(n.ID),s.associatedWithMetaAgent=o.ID,s.executedMoves=n.executedMoves,t.pushEntityToCell(s,r,i)},"Transform Entity If Row Reached":function(e,t){var n=e.entityLink,o=e.jobArguments.row;return"last"===o?o=parseInt(t.gameWorld.getRows()-1,10):"first"===o&&(o=0),n.position.y!==o?!1:(Spoooky.GameEvents.fireEvent({job:"Transform Entity",jobArguments:e.jobArguments.entityType,entityLink:n},t),!0)},"Next Player":function(e,t){t.setNextPlayer()},"Delete All Dice Values":function(e,t){t.getDiceBox().deleteAllDiceValues()},alert:function(e){alert(e.jobArguments)},"Print Game Process":function(e,t){t.models.playVirtual===!1&&Spoooky.GameProcess.pushMessage(e.jobArguments)},"Stop Game":function(e,t){t.setGameState("END"),t.models.playVirtual===!1&&t.informArtificialPlayersAboutGameEnd()},"Set Winner":function(e,t){t.setWinnerID(e.jobArguments),t.models.playVirtual===!1&&Spoooky.GameProcess.pushMessage('<button id="postGameReloadButton"onclick="location.reload();" type="button" class="btn btn-success btn-sm">Spiel neu starten</button>')}},fireEvent:function(e,t){this.events[e.job](e,t)}},Spoooky.JobQueue=function(e){var t=this,n=e;t.addJob=function(e){var t=n.models.JobQueue;_.isUndefined(t[e.jobID])&&(t[e.jobID]=[]),t[e.jobID][e.jobName]=e},t.flush=function(){n.models.JobQueue.length=0},t.getJobsWithMoveID=function(e){var t=[],o=n.models.JobQueue[e];for(var r in o)t.push(o[r]);return t}},Spoooky.Areas=function(e){var t=this,n=e;t.enable=function(){n.models.Areas.isEnabled=!0},t.isEnabled=function(){return n.models.Areas.isEnabled},t.isMove=function(e){return 0!==t.getArea(e).moveID},t.incrementElements=function(e){t.getArea(e).elementCounter++},t.getMoveID=function(e){return t.getArea(e).moveID},t.addArea=function(e){t.enable(),n.models.Areas.content.push({name:e,moveID:0,display:"",elementCounter:0})},t.getArea=function(e){return _.find(n.models.Areas.content,function(t){return t.name===e})},t.resetDisplays=function(){_.each(n.models.Areas.content,function(e){e.display=""})}},Spoooky.Agent=function(e,t){var n=this;n.ID=t,n.metaAgentID=e,n.role="ANALYZE POSSIBLE MOVES",n.focus="ALL",n.fitness=1,n.thinkingTime=1e4,n.maximumSteps=1e4,n.uctConstant=.9,n.proposeBestMove=function(){var e=!1,t=n.ID,o=n.role,r=n.focus,i=n.maximumSteps,a=n.createBrain(),s=n.uctConstant,l=n.thinkingTime,u=Spoooky.AI.game.getPlayerWithID(n.metaAgentID).learningEnabled;switch(localStorage["#mctsgraph"]&&(e=!0),o){case"ANALYZE POSSIBLE MOVES":a.postMessage({agentID:t,agentRole:o,agentFocus:r,maxSteps:i,maxTime:l,learn:u,uctConstant:s,command:"monte carlo tree search with uct",gameModel:Spoooky.AI.game.stringifyModels(),generateMctsGraph:e});break;case"SEARCH FOR IMMEDIATE THREATS":a.postMessage({agentID:t,agentRole:o,agentFocus:r,command:"alpha beta negamax",maxDepth:3,gameModel:Spoooky.AI.game.stringifyModels()});break;default:console.log("Unknown Agent Role.")}},n.createBrain=function(){var e=new Worker("../../js/spoooky.Worker.min.js"),t=Spoooky.AI.game.getPlayerWithID(n.metaAgentID);return e.addEventListener("message",function(e){switch(e.data.type){case"starting":break;case"decision":t.coordinateAgentDecisions(e.data);break;case"random":t.coordinateAgentDecisions(e.data)}}),e}},Spoooky.MetaAgent=function(e){var t=this,n=e;t.name="",t.setName=function(e){t.name=e},t.getName=function(){return t.name},t.getGame=function(){return n},t.ID=0,t.getID=function(){return t.ID},t.setID=function(e){t.ID=e},t.type="HUMAN",t.setType=function(e){return"HUMAN"===e||"ARTIFICIAL"===e?(t.type=e,!0):(console.log("Invalid Player Type. Allowed Player Types: HUMAN or ARTIFICIAL"),!1)},t.learningEnabled=!1,t.enableLearning=function(){t.learningEnabled=!0},t.QLearner={},t.gameHasEnded=function(){if(t.learningEnabled){Spoooky.GameProcess.pushMessage("Meta Agent "+t.ID+" lernt..."),t.QLearner.learn(1e4);var e="{\n";e+='	"game" : "'+t.getGame().getName()+'",\n',e+='	"metaAgentID" : '+t.ID+",\n",e+='	"bestAgentEnsemble" : ',e+=JSON.stringify(t.agents,null,"	"),e+=",\n",e+='	"learnModule" : ',e+=JSON.stringify(t.QLearner,null,"	"),e+="\n}";var n=new Blob([e],{type:"text/plain;charset=utf-8"});saveAs(n,"agentmemory_"+t.ID+".json")}},t.associateEntity=function(e,n){e.associatedWithMetaAgent=t.ID,"PLACE"===e.mode&&t.getGame().addEntityToGame(e,n)},t.entityFactory=function(e){var n,o="",r=0;o=e.entityName?e.entityName:t.ID+"_entity_"+parseInt(t.countEntities()+1,10),r=e.entityID?e.entityID:parseInt(t.countEntities()+1,10),n=new Spoooky.Entity(o,r,e.typeID,t.getGame()),n.setType(e.entityType),n.setRepresentation(e.representation.type,e.representation.texture);var i,a,s=e.moves;if(s)for(i=0;i<s.length;i++)a=s[i],n.addMove({name:a.name,type:a.type,direction:a.direction,frequency:a.frequency,conditions:a.conditions,postMove:a.postMove});if(e.goalAtoms)for(i=0;i<e.goalAtoms.length;i++)a=e.goalAtoms[i],n.addGoalAtom(a.atomName,a.atomFunction,a.atomArguments);if(e.goals)for(i=0;i<e.goals.length;i++)a=e.goals[i],n.assembleGoal({type:a.type,name:a.name,atoms:a.atoms,move:a.move,area:a.area});return n.selectCondition=e.selectCondition,e.postMoveCheck?n.postMoveCheck=e.postMoveCheck:n.postMoveCheck=null,n.setGoalTargets(e.goalTargets),e.unlimitedQuantity&&(n.unlimitedQuantity=!0),e.mode&&(n.mode=e.mode),e.placeTo&&(n.placeTo=e.placeTo),t.addEntity(n),n},t.addEntity=function(e){e.setAssociatedPlayerID(t.ID),n.models.Entities[t.ID].push(e)},t.getEntityFromArray=function(e){return e>=0&&e<t.countEntities()?n.models.Entities[t.ID][e]:!1},t.getEntityWithID=function(e){for(var o,r=t.countEntities(),i=n.models.Entities[t.ID],a=r;a--;)if(o=i[a],o.ID===e)return o;return!1},t.getEntities=function(){return n.models.Entities[t.ID]},t.getOnBoardEntities=function(){for(var e,o=n.models.Entities[t.ID],r=o.length,i=[];r--;)e=o[r],e.onBoard&&i.push(e);return i},t.getOffBoardEntities=function(){for(var e,o=n.models.Entities[t.ID],r=o.length,i=[];r--;)e=o[r],e.onBoard&&i.push(e);return i},t.getEntitiesOfType=function(e){for(var o=[],r=t.countEntities(),i=n.models.Entities[t.ID],a=r;a--;)i[a].type===e&&o.push(i[a]);return o},t.getPlaceableEntities=function(){for(var e,o=[],r=t.countEntities(),i=t.ID;r--;)e=n.models.Entities[i][r],"PLACE"===e.mode&&(e.unlimitedQuantity?o.push(e):e.onBoard||o.push(e));return o},t.getEntityWithName=function(e){for(var o=t.countEntities();o--;)if(n.models.Entities[t.ID][o].name===e)return n.models.Entities[t.ID][o];return!1},t.getNextOpponentPlayer=function(){return t.ID<t.getGame().models.MetaAgents.length-1?t.getGame().getPlayerWithID(parseInt(t.ID+1,10)):t.getGame().getPlayerWithID(parseInt(0,10))},t.getOccupiedFields=function(e){var n,o,r=[],i=t.getGame(),a=i.models.GameGrid,s=_.flatten(a),l=s.length;switch(e){case"OWN ENTITIES":for(n=l;n--;)o=s[n],0!==o.contains.length&&_.last(o.contains).playerID===t.ID&&r.push(o.position);break;case"OPPONENT ENTITIES":for(n=l;n--;)o=s[n],0!==o.contains.length&&_.last(o.contains).playerID!==t.ID&&r.push(o.position);break;default:console.log("Wrong Mode")}return r},t.hasEntity=function(e){for(var o=t.countEntities();o--;)if(n.models.Entities[t.ID][o].name===e)return!0;return!1},t.deleteEntity=function(e){for(var o=t.countEntities(),r=n.models.Entities[t.ID],i=o;i--;)if(r[i].name===e)return r.splice(i,1),!0;return!1},t.countEntities=function(){return n.models.Entities[t.ID].length},t.getAllEntityStdMoves=function(){var e=t.getEntities(),n=e.length;if(0===n)return!1;for(var o,r,i=[],a=t.getGame(),s=e.length;s--;)o=e[s],a.checkSelectCondition(o)===!0&&(r=o.getMoves(),a.performPostMoveChecks(o,r),i.push.apply(i,r));return 0===i.length?!1:i},t.getAllEntityGoalMoves=function(){var e=t.getEntities(),n=e.length;if(0===n)return!1;for(var o,r,i=[],a=t.getGame(),s=e.length;s--;)o=e[s],a.checkSelectCondition(o)===!0&&(r=o.getGoalMoves(),a.performPostMoveChecks(o,r),i.push.apply(i,r));return 0===i.length?!1:i},t.cellConnections,t.setCellConnections=function(e){t.cellConnections=e},t.getAllEntityMoves=function(){var e=t.getGame();if("END"===e.models.gameState)return[];var n,o,r=e.models;switch(r.gameMode){case"MOVING":n=t.getEntities();var i=n.length;if(0===i)return[];var a,s=[],l=[],u=[];for(m=i;m--;)if(o=n[m],"PLACE"!==o.mode&&e.checkSelectCondition(o)===!0){switch(s.length=0,l.length=0,a=r.SelectRestrictions.moves){case"Standard Moves":s=o.getMoves();break;case"Capture Moves":l=o.getGoalMoves(s);break;default:s=o.getMoves(),l=o.getGoalMoves(s)}e.performPostMoveChecks(o,s),e.performPostMoveChecks(o,l),u.push.apply(u,s),u.push.apply(u,l)}return 0===u.length?[]:u;case"PLACING":if(n=t.getPlaceableEntities(),0===n.length)return[];var g,c,m,d=[];switch(o=_.last(n),o.placeTo){case"ANY":var f=e.gameWorld.getFreeCells();for(m=f.length;m--;)g=f[m],c=e.getUniqueMoveID(o.name,"place-entity",g.x,g.y),d.push({type:"PLACE",name:"place entity",entity:o,targetX:g.x,targetY:g.y,moveClass:"move_place",ID:c}),e.addJobForMoveID({jobID:c,jobName:"Put the Entity to the destination field",job:"Place Entity",jobArguments:{entity:o,xPosition:g.x,yPosition:g.y}});return d;case"REACHABLE BY RECENTLY MOVED ENTITY":var y=e.getrecentlyMovedEntity();if(y===!1)return[];var p;for(p=y.getMoves(),m=p.length;m--;)g=p[m],c=e.getUniqueMoveID(o.name,"place-entity",g.targetX,g.targetY),d.push({type:"PLACE",name:"place entity",entity:o,targetX:g.targetX,targetY:g.targetY,moveClass:"move_place",ID:c}),e.addJobForMoveID({jobID:c,jobName:"Put the Entity to the destination field",job:"Place Entity",jobArguments:{entity:o,xPosition:g.targetX,yPosition:g.targetY}}),e.addJobForMoveID({jobID:c,jobName:"Let Players Change",job:"Enable Player Change"}),e.addJobForMoveID({jobID:c,jobName:"Change Back To Move Mode",job:"Change Game Mode",jobArguments:{mode:"MOVING"}});return d;default:console.log("Wrong Placing Mode: ",o.placeTo)}break;case"FREE CAPTURE":var v,I,c,h=[],D=e.getAssociatedOpponentEntities(t.cellConnections);for(I in D)v=D[I],v.associated||(c=e.getUniqueMoveID("free-capture","opponent",v.x,v.y),h.push({ID:c,type:"FREE CAPTURE",entity:!1,name:"Capture Opponent",targetX:v.x,targetY:v.y,moveClass:"move_goal"}));return h;default:console.log("Wrong command in self_MetaAgent.getAllEntityMoves",r.gameMode)}},t.getExecutableMovesByAgentFocus=function(e){if("END"===t.getGame().models.gameState)return[];for(var n,o,r,i,a,s,l,u,g,c,m=t.getAllEntityMoves(),d=[],f=m.length;f--;)m[f].moveIndex=f;switch(e){case"FIRST HALF OF POSSIBLE MOVES":return c=Math.floor(m.length/2),m.splice(c,c),m;case"SECOND HALF OF POSSIBLE MOVES":return c=Math.floor(m.length/2),m.splice(0,c),m;case"MOVES NEAR OPPONENT FIELDS":for(g=t.getOccupiedFields("OPPONENT ENTITIES"),r=m.length;r--;)for(n=m[r].targetX,o=m[r].targetY,s=g.length;s--;)if(i=g[s].x,a=g[s].y,l=Math.abs(i-n),u=Math.abs(a-o),1>=l&&1>=u){d.push(m[r]);break}return d;case"MOVES NEAR OPPONENT OR OWN FIELDS":for(g=t.getOccupiedFields("OPPONENT ENTITIES"),g=g.concat(t.getOccupiedFields("OWN ENTITIES")),r=m.length;r--;)for(n=m[r].targetX,o=m[r].targetY,s=g.length;s--;)if(i=g[s].x,a=g[s].y,l=Math.abs(i-n),u=Math.abs(a-o),1>=l&&1>=u){d.push(m[r]);break}return d;case"ALL MOVES":case"ALL":default:return m}},t.agents=[],t.activeAgents=0,t.finishedAgents=0,t.countAgents=function(){return t.agents.length},t.getAgents=function(){return t.agents},t.getAgentWithID=function(e){var n,o=t.agents;for(n=o.length;n--;)if(o[n].ID===e)return o[n];return!1},t.assembleAgent=function(e,n,o,r,i,a,s){var l,u=t.ID;l=new Spoooky.Agent(u,e),l.role=n,l.fitness=a,l.focus=o,l.thinkingTime=i,l.maximumSteps=r,l.uctConstant=s,t.agents.push(l)},t.addStandardAgent=function(){var e,n,o=0;n=t.getAgents();for(var r=n.length;r--;)e=n[r].ID,e>o&&(o=e);o+=1,t.assembleAgent(o,"ANALYZE POSSIBLE MOVES","ALL MOVES",1e4,1e4,1,.9)},t.deleteAgentWithID=function(e){for(var n=t.agents.length;n--;)t.agents[n].ID===e&&t.agents.splice(n,1)},t.expertKnowledge=!1,t.assembleAgents=function(){var e="agentmemory_"+t.ID+".json",n=!1;return $.ajax({url:e,dataType:"json",async:!1,success:function(e){n=!0,Spoooky.AgentLog.pushMessage("Lade Agentenerinnerungen fuer Meta Agent "+t.ID+"."),Spoooky.AgentLog.pushMessage('<div class="progress progress-striped active"><div class="progress-bar"  role="progressbar" style="width: 100%"><span class="sr-only">Lade</span></div></div>'),t.QLearner=new Spoooky.QLearner,t.QLearner.reward=e.learnModule.rewards,t.QLearner.gameStates=e.learnModule.gameStates,$.each(e.bestAgentEnsemble,function(e,n){t.assembleAgent(n.ID,n.role,n.focus,n.maximumSteps,n.thinkingTime,n.fitness,n.uctConstant)})},complete:function(){if(n){Spoooky.AgentLog.messages.pop();var o=_.keys(t.QLearner.gameStates).length;Spoooky.AgentLog.pushMessage(o+" gelernte Spielzustaende wurden erfolgreich aus der Datei "+e+" geladen.")}},error:function(){if(0===t.agents.length){Spoooky.AgentLog.pushMessage("Keine Erinnerungen fuer Meta Agent "+t.ID+" vorhanden: Datei "+e+" existiert nicht."),t.QLearner=new Spoooky.QLearner;var n=1e4,o=15e3;t.assembleAgent(1,"ANALYZE POSSIBLE MOVES","ALL MOVES",o,n,1,.5),t.assembleAgent(2,"ANALYZE POSSIBLE MOVES","FIRST HALF OF POSSIBLE MOVES",o,n,1,.5),t.assembleAgent(3,"ANALYZE POSSIBLE MOVES","SECOND HALF OF POSSIBLE MOVES",o,n,1,.5)}}}),!0},t.runtimeStart=0,t.findBestMove=function(){Spoooky.AI.game=t.getGame(),t.runtimeStart=Date.now(),t.askAgentsForDecision()},t.askAgentsForDecision=function(){t.activeAgents=t.countAgents(),t.bestMoves.length=0,Spoooky.AgentLog.pushMessage("Meta agent "+t.ID+" ("+t.getName()+") fragt "+t.activeAgents+" assoziierte Agenten nach der besten Zugmoeglichkeit.");for(var e=t.agents.length,n=0;e>n;n++)t.agents[n].proposeBestMove()},t.bestMoves=[],t.prepareAgentsMoveSuggestions=function(e){var t,n,o,r,i,a,s,l,u=[],g=!1,c=[];for(n=e.length;n--;){for(t=e[n],o=u.length;o--;)u[o].moveIndex===t.moveIndex&&(s=parseInt(u[o].wins+t.wins),a=parseInt(u[o].visits+t.visits),l=parseInt(u[o].lost+t.lost),i=parseInt(u[o].simulationSteps+t.simulationSteps),c=u[o].agentID,c.push(t.agentID),r={simulationSteps:t.simulationSteps,moveIndex:t.moveIndex,agentID:c,visits:a,target:t.target,wins:s,lost:l},u[o]=r,g=!0);g===!1&&(r={simulationSteps:t.simulationSteps,moveIndex:t.moveIndex,agentID:[t.agentID],target:t.target,visits:t.visits,wins:t.wins,lost:t.lost},u.push(r)),g=!1}return u},t.updateAgentsFitness=function(e){var n,o,r=.5,i=t.getAgents(),a=!1;for(n=i.length;n--;){for(o=e.length;o--;)if(i[n].ID===e[o]){i[n].fitness+=r,a=!0;break}a===!1&&(i[n].fitness-=r),a=!1}},t.getFittestAgent=function(){var e,n,o,r=t.getAgents(),i=0;for(e=r.length;e--;)o=r[e],o.fitness>=i&&(i=o.fitness,n=o);return n},t.replaceUnfitAgents=function(){var e,n=t.getAgents(),o=t.getFittestAgent();for(e=n.length;e--;)n[e].fitness<.1&&(Spoooky.AgentLog.pushMessage("Agent #"+n[e].ID+" hat eine schlechte Fitness von "+n[e].fitness+" und fokussiert nun den folgenden Spielaspekt: "+o.focus),n[e].role=o.role,n[e].focus=o.focus,n[e].fitness=1);t.getGame().refreshView()},t.updateQLearner=function(e){var n,o,r,i,a,s,l,u=t.QLearner,g=JSON.parse(e),c=g.gameStates,m=u.gameStates,d=_.keys(c),f=d.length;for(r=0;f>r;++r)if(i=c[d[r]],a=i.name,_.has(m,a))for(s=i.actions,d=_.keys(s),f=d.length,r=0;f>r;r++)l=s[d[r]],_.has(m[a].actions,l.name)?(n=0,o=0,_.has(m[a].actions[l.name],"reward")&&(o=m[a].actions[l.name].reward),_.has(l,"reward")&&(n=l.reward),n+=o,m[a].actions[l.name]=l,0!==n&&(m[a].actions[l.name].reward=n)):m[i.name].actions[l.name]=l;else m[i.name]=i},t.mctsData=[],t.processAgentDecision=function(e){t.mctsData.push({agentID:e.agentID,mctsGraph:e.mctsGraph,uctConstant:e.uctConstant}),e.mctsGraph.length=0,t.bestMoves.push(e),Spoooky.AgentLog.pushMessage("Agent #"+e.agentID+" hat "+e.results.length+" Zugmoeglichkeiten anhand von "+e.simCount+" Monte Carlo Ausspielungen mit insgesamt "+e.simSteps+" Simulationsschritten analysiert."),t.getGame().refreshView(),t.finishedAgents++},t.allAgentsHaveFinishedThinking=function(){return t.finishedAgents===t.activeAgents?(t.finishedAgents=0,!0):!1},t.sumUpAgentsWork=function(){var e,n,o,r,i={},a=0,s=0,l=[],u=t.bestMoves;for(o=u.length;o--;){for(n=u[o],a+=n.simCount,s+=n.simSteps,e=n.results,r=e.length;r--;)i=e[r],i.agentID=n.agentID,i.agentRole=n.agentRole,i.agentFocus=n.agentFocus,l.push(i);
t.learningEnabled&&t.updateQLearner(n.QLearner)}return t.bestMoves.length=0,{results:l,simCount:a,simSteps:s}},t.getBestMove=function(e){var t,n,o=Number.MAX_VALUE,r="Random";o=-1*Number.MAX_VALUE;for(var i=e.length;i--;)t=e[i],t.visits>0&&(n=t.visits,n>o&&(o=n,r=t),Spoooky.AgentLog.pushMessage(t.target+" [Agent(en) #"+t.agentID+"]<ul><li>Besuche: "+t.visits+"</li><li>Gewinnhaeufigkeit: "+t.wins+"</li><li>Simulationsschritte: "+t.simulationSteps+"</li><li>Gewinnrate: "+t.wins/t.visits+"</li></ul>"));return r},t.printAgentsFinishedMessage=function(){for(var e=Spoooky.GameProcess.messages.length;e--;)"thinking"===Spoooky.GameProcess.messages[e].type&&Spoooky.GameProcess.messages.splice(e,1);Spoooky.AgentLog.pushMessage("Alle assoziierten Agenten haben ihre Arbeit beendet.")},t.coordinateAgentDecisions=function(e){if(t.processAgentDecision(e),e.length=0,t.allAgentsHaveFinishedThinking()){var n=Date.now(),o=(n-t.runtimeStart)/1e3;t.printAgentsFinishedMessage();var r=t.sumUpAgentsWork(),i=r.simCount,a=r.simSteps,s=t.prepareAgentsMoveSuggestions(r.results);r.length=0,Spoooky.AgentLog.pushMessage("<strong>"+i+" simulierte Spiele  mit insgesamt "+a+" Simulationsschritten (~"+(a/i).toFixed(2)+" Schritte/Simulation) in "+o+" Sekunden.</strong>"),Spoooky.Statistics.logEntry(t.ID,"simCount",t.getGame().models.moveCounter+1,i),Spoooky.Statistics.logEntry(t.ID,"simSteps",t.getGame().models.moveCounter+1,a),s=_.sortBy(s,function(e){return e.visits}),s.reverse();var l=t.getBestMove(s);s.length=0,t.learningEnabled&&t.QLearner.learn(1e4),"Random"===l?(Spoooky.AgentLog.pushMessage("Meta Agent fuehrt einen Zufallszug aus."),t.getGame().executeRandomMove()):(t.updateAgentsFitness(l.agentID),t.replaceUnfitAgents(),Spoooky.AgentLog.pushMessage("<strong>Meta Agent hat sich fuer die folgende Zugmoeglichkeit entschieden: "+l.target+"</strong>"),t.getGame().executeArtificialMove(l)),t.mctsData&&t.getGame().refreshGraphView(t.mctsData,t.ID),t.getGame().refreshStatsView(t.ID),t.mctsData.length=0}},t.artificialMove=function(){Spoooky.GameProcess.pushMessage(t.getName()+' denkt nach...<br><div class="progress progress-striped active"><div class="progress-bar"  role="progressbar" style="width: 100%"><span class="sr-only">Ich denke nach...</span></div></div>',"thinking"),t.findBestMove()},t.hasEntitiesOnFieldWithFieldID=function(e,n){for(var o,r={"<":function(e,t){return t>e},"<=":function(e,t){return t>=e},">":function(e,t){return e>t},">=":function(e,t){return e>=t},"==":function(e,t){return e==t}},i=t.countEntities();i--;)if(o=t.getEntityFromArray(i),r[n](o.getFieldID(),e))return!0;return!1}},Spoooky.Entity=function(e,t,n,o){var r=this,i=o;r.unlimitedQuantity=!1,r.mode="MOVE",r.placeTo=0,r.getGame=function(){return i},r.ID=t,r.getID=function(){return r.ID},r.setID=function(e){r.ID=e},r.typeID=n,r.getTypeID=function(){return r.typeID},r.setTypeID=function(e){r.typeID=e},r.name=e,r.enabled=!0,r.moveCounter=0,r.increaseMoveCounter=function(){r.moveCounter+=1},r.getMoveCount=function(){return r.moveCounter},r.lastExecutedMove=0,r.addExecutedMove=function(e,t,n,o){r.increaseMoveCounter(),r.lastExecutedMove={destX:e,destY:t,round:n,type:o}},r.getLastExecutedMove=function(){return r.lastExecutedMove},r.enable=function(){r.enabled=!0},r.disable=function(){r.enabled=!1},r.setName=function(e){r.name=e},r.type="default",r.getType=function(){return r.type},r.setType=function(e){r.type=e},r.getWorld=function(){return r.getGame().gameWorld},r.isOpponent=function(e,t){var n;return r.getWorld().isValidCoordinate(e,t)?(n=r.getWorld().peekCell(e,t),n!==!1&&n.getMetaPlayerID()!==r.getMetaPlayerID()?!0:!1):!1},r.isEmptyCell=function(e,t){return r.getWorld().isValidCoordinate(e,t)?r.getWorld().peekCell(e,t)===!1:!1},r.visualRepresentation={type:"",colour:"",imageURL:""},r.getView=function(){return r.visualRepresentation.imageURL},r.position={x:-1,y:-1},r.getPosition=function(){return r.position},r.getFieldID=function(){var e=r.position;return r.getWorld().getFieldID(e.x,e.y)},r.setPosition=function(e,t){r.position.x=e,r.position.y=t},r.tmp={},r.targeting={x:null,y:null},r.setTarget=function(e,t){r.targeting.x=e,r.targeting.y=t},r.unsetTarget=function(){r.targeting.x=null,r.targeting.y=null},r.goalTargets=[],r.addGoalTarget=function(e){r.goalTargets.push(e)},r.setGoalTargets=function(e){r.goalTargets=e},r.getGoalTargets=function(){return r.goalTargets},r.setRepresentation=function(e,t){("colour"===e||"image"===e)&&(r.visualRepresentation={type:e,colour:t,imageURL:t})},r.associatedWithPlayerID=null,r.setAssociatedPlayerID=function(e){r.associatedWithPlayerID=e},r.getMetaPlayerID=function(){return r.associatedWithPlayerID},r.getName=function(){return r.name},r.getAssociatedPlayer=function(){return r.getGame().getPlayerWhoOwnsEntity(r.getName())},r.seppuku=function(){r.getAssociatedPlayer()!==!1&&r.getAssociatedPlayer().deleteEntity(r.getName())},r.isOwnedByPlayerID=function(e){return r.associatedWithPlayerID===e},r.translateDirection=function(e){var t=0,n=0;if("object"==typeof e&&e instanceof Array)t=e[0],n=e[1];else switch(e){case"n":case"north":t=0,n=-1;break;case"ne":case"northeast":t=1,n=-1;break;case"e":case"east":case"right":t=1,n=0;break;case"se":case"southeast":t=1,n=1;break;case"s":case"south":t=0,n=1;break;case"sw":case"southwest":t=-1,n=1;break;case"w":case"west":case"left":t=-1,n=0;break;case"nw":case"northwest":t=-1,n=-1}return[t,n]},r.moves=[],r.addMove=function(e){var t=r.translateDirection(e.direction),n=t[0],o=t[1];r.moves.push({name:e.name,type:e.type,direction:e.direction,xDirection:n,yDirection:o,frequency:e.frequency,conditions:e.conditions,postMove:e.postMove})},r.countPossibleMoves=function(){return r.moves.length},r.countFieldsWithID=function(e){return r.getWorld().getContentOfFieldsWithFieldID(e).length},r.countOpponentsOnFieldsWithID=function(e,t){for(var n,o=r.getWorld().getContentOfFieldsWithFieldID(e),i=0,a=o.length;a--;)n=o[a],n&&n.getMetaPlayerID()!==t.getMetaPlayerID()&&(i+=1);return i},r.countOwnOnFieldsWithID=function(e,t){for(var n,o=r.getWorld().getContentOfFieldsWithFieldID(e),i=0,a=o.length;a--;)n=o[a],n&&n.getMetaPlayerID()===t.getMetaPlayerID()&&(i+=1);return i},r.getMove=function(e){return e>=0&&e<r.countPossibleMoves()?r.moves[e]:!1},r.canMove=function(){var e=r.getMoves();return r.getGame().performPostMoveChecks(this,e),!_.isEmpty(e)},r.getMoves=function(){var e=r.countPossibleMoves();if(0>=e)return!1;var t,n,o,i,a,s,l,u,g,c=[],m=r.getGame();l=r.position,i=l.x,a=l.y;for(var d=e;d--;)switch(n=r.getMove(d),n.type){case"Default":if(n.frequency>0||"ANY"===n.frequency)for(o=n.frequency,"ANY"===o&&(o=23),s=1;o>=s&&(u=i+n.xDirection*s,g=a+n.yDirection*s,r.getWorld().isEmpty(u,g)!==!1);s+=1)m.isLegalMove(r,n.conditions,i,a,u,g)&&(t=m.getUniqueMoveID(r.name,n.name,u,g),c.push({type:"MOVE",name:n.name,entity:r,targetX:u,targetY:g,moveClass:"move_standard",freq:o,ID:t,postMove:n.postMove}),m.addJobForMoveID({jobID:t,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:r,destX:u,destY:g}}),n.postMove&&_.each(n.postMove,function(e){m.addJobForMoveID({jobID:t,jobName:e.jobName,job:e.jobFunction,jobArguments:e.jobArguments})}));break;case"By Connected Field IDs":for(var f,y=m.models.CellConnections,p=m.models.GameGrid[a][i].cellID,v=y[p],I=v.length;I--;)f=r.getWorld().getFieldsWithFieldID(v[I],!0),u=f.position.x,g=f.position.y,r.getWorld().isEmpty(u,g)!==!1&&m.isLegalMove(r,n.conditions,i,a,u,g)&&(t=m.getUniqueMoveID(r.name,n.name,u,g),c.push({type:"MOVE",name:n.name,entity:r,targetX:u,targetY:g,moveClass:"move_standard",freq:o,ID:t,postMove:n.postMove}),m.addJobForMoveID({jobID:t,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:r,destX:u,destY:g}}),n.postMove&&_.each(n.postMove,function(e){m.addJobForMoveID({jobID:t,jobName:e.jobName,job:e.jobFunction,jobArguments:e.jobArguments})}));break;case"By Field ID":if("DICE"===n.frequency){var h=m.getDiceBox().getDiceValues(),D=h.length,M=[],E=0,A=-1,C=!1;_.isUndefined(r.tmp.fieldID)===!1?(A=r.tmp.fieldID,C=!0):A=r.getWorld().getFieldID(i,a);for(var b=D;b--;)if("POSITIVE"===n.direction[1]?E=parseInt(A+h[b],10):"NEGATIVE"===n.direction[1]&&(E=parseInt(A-h[b],10)),"By Field ID"===n.type&&0===r.countOpponentsOnFieldsWithID(E,r))if(M=r.getWorld().getFreeFieldsWithFieldID(E),M[0])u=M[0][0],g=12>=E?M[parseInt(M.length-1,10)][1]:M[0][1],t=m.getUniqueMoveID(r.name,n.name,u,g),c.push({type:"DICE",diceID:b,diceValue:h[b],name:n.name,entity:r,targetX:u,targetY:g,moveClass:"move_standard",freq:"DICE",ID:t,postmove:n.postMove}),C===!0?(m.addJobForMoveID({jobID:t,jobName:"Put the entity to the destination field",job:"Place Entity",jobArguments:{entity:r,xPosition:u,yPosition:g}}),m.addJobForMoveID({jobID:t,jobName:"Remove the current entity from off board area",job:"Delete Entity from OffBoard",jobArguments:{entity:r}})):m.addJobForMoveID({jobID:t,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:r,destX:u,destY:g}}),m.addJobForMoveID({jobID:t,jobName:"Delete Dice Value",job:"Delete Dice Value",jobArguments:b}),n.postMove&&_.each(n.postMove,function(e){m.addJobForMoveID({jobID:t,jobName:e.jobName,job:e.jobFunction,jobArguments:e.jobArguments})});else if(r.countOwnOnFieldsWithID(E,r)===r.countFieldsWithID(E)){var S=r.getWorld().getFieldsWithFieldID(E);S[0]&&(u=S[0].position.x,g=12>=E?S[0].position.y:S[parseInt(S.length-1,10)].position.y,t=m.getUniqueMoveID(r.name,n.name,u,g),c.push({type:"DICE",diceValue:h[b],name:n.name,entity:r,targetX:u,targetY:g,moveClass:"move_standard",freq:"DICE",ID:t,postmove:n.postMove}),m.addJobForMoveID({jobID:t,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:r,destX:u,destY:g}}),m.addJobForMoveID({jobID:t,jobName:"Delete Dice Value",job:"Delete Dice Value",jobArguments:b}),n.postMove&&_.each(n.postMove,function(e){m.addJobForMoveID({jobID:t,jobName:e.jobName,job:e.jobFunction,jobArguments:e.jobArguments})}))}}break;case"Jump To Free Field":for(var P=r.getWorld().getFreeCells(),I=P.length;I--;)u=P[I].x,g=P[I].y,m.isLegalMove(r,n.conditions,i,a,u,g)&&(t=m.getUniqueMoveID(r.name,n.name,u,g),c.push({type:"MOVE",name:n.name,entity:r,targetX:u,targetY:g,moveClass:"move_standard",freq:o,ID:t,postMove:n.postMove}),m.addJobForMoveID({jobID:t,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:r,destX:u,destY:g}}),n.postMove&&_.each(n.postMove,function(e){m.addJobForMoveID({jobID:t,jobName:e.jobName,job:e.jobFunction,jobArguments:e.jobArguments})}))}return c},r.canReachGoal=function(){return!_.isEmpty(r.getGoalMoves())},r.canCapture=function(){for(var e=r.getGoalMoves(),t=e.length;t--;)if("CAPTURE"===e[t].type)return!0;return!1},r.canCaptureAt=function(e,t){var n,o,i=r.getGoalMoves();for(n=i.length;n--;)if(o=i[n],"CAPTURE"===o.type&&e===o.targetX&&t===o.targetY)return!0;return!1},r.getGoalMoves=function(e){var t,n,o,i,a,s,l,u,g,c,m,d,f=r.countGoals(),y=null,p=[],v=r.getGame();if(l=e?e:r.getMoves(),a=r.position.x,s=r.position.y,v.models.DiceBox.isEnabled){var I,h,D=v.getDiceBox().getDiceValues(),M=D.length,E=0,A=r.getWorld().getFieldID(a,s);for(_.isUndefined(r.tmp.fieldID)===!1&&(A=r.tmp.fieldID),h=M;h--;)for(m=f;m--;)if(t=r.getGoal(m),I=null,r.executeGoalByName(t.name,D[h])===!0)if("BEAR OFF MOVE"===t.move)c=t.area,n=v.getUniqueMoveID(r.name,t.name,c,"bearoff"),v.setMoveID(n),v.getDiceBox().connectMoveIDWithDiceValue(n,h,c),p.push({ID:n,type:"DICE",entity:r,name:t.name,diceID:h,diceValue:D[h],targetArea:c,moveClass:"move_bearoff"}),v.getArea(c).moveID=v.models.moveID;else{"MOVE POSITIVE"===t.move?E=parseInt(A+D[h],10):"MOVE NEGATIVE"===t.move&&(E=parseInt(A-D[h],10));var C=r.getWorld().getContentOfFieldsWithFieldID(E);I=_.first(C),0===I&&(I=_.last(C)),c={x:I.position.x,y:I.position.y},n=v.getUniqueMoveID(r.name,t.name,c.x,c.y),v.setMoveID(n),v.getDiceBox().connectMoveIDWithDiceValue(n,h,c),p.push({ID:n,name:t.name,entity:r,type:"DICE",diceValue:D[h],diceID:h,targetX:parseInt(c.x,10),targetY:parseInt(c.y,10),moveClass:"move_goal"})}}else{for(m=f;m--;)t=r.getGoal(m),r.executeGoalByName(t.name)===!0&&(y=r.translateDirection(t.move),o=parseInt(a+y[0],10),i=parseInt(s+y[1],10),n=v.getUniqueMoveID(r.name,t.name,o,i),p.push({ID:n,type:t.type,entity:r,name:t.name,preArrangeX:parseInt(a,10),preArrangeY:parseInt(s,10),targetX:o,targetY:i,moveClass:"move_goal"}));for(u=l.length,d=u;d--;)if(g=l[d],g.freq>1){for(v.doVirtualMove(r.position.x,r.position.y,g.targetX,g.targetY),a=g.targetX,s=g.targetY,m=f;m--;)t=r.getGoal(m),t.move===g.name&&r.executeGoalByName(t.name)===!0&&(y=r.translateDirection(t.move),o=parseInt(a+y[0],10),i=parseInt(s+y[1],10),n=v.getUniqueMoveID(r.name,t.name,o,i),p.push({ID:n,type:t.type,entity:r,name:t.name,preArrangeX:parseInt(a,10),preArrangeY:parseInt(s,10),targetX:o,targetY:i,moveClass:"move_goal"}));v.undoVirtualMove()}}return p},r.canBeCaptured=function(){var e,t,n=r.getAssociatedPlayer().getNextOpponentPlayer(),o=n.countEntities(),i=n.getEntities();for(e=o;e--;)if(t=r.position,i[e].canCaptureAt(t.x,t.y)===!0)return!0;return!1},r.goals=[],r.assembleGoal=function(e){r.goals.push(e)},r.getGoal=function(e){return e>=0&&e<r.goals.length?r.goals[e]:!1},r.countGoals=function(){return r.goals.length},r.executeGoalByName=function(e,t){if(r.enabled===!1)return!1;var n,o=r.goals.length,i=r.goals;for(n=0;o>n;n+=1)if(i[n].name===e){var a=!0,s=0,l=i[n].atoms,u=l.length;for(s=0;u>s;s+=1)if(a=r.getGame().executeEntityGoalAtomByName(r,l[s],t),a===!1||-1===a)return!1;return!0}return!1},r.goalAtoms=[],r.addGoalAtom=function(e,t,n){r.goalAtoms.push({atomName:e,atomFunction:t,atomArguments:n})}},Spoooky.AI={game:0,MCnode:function(e,t,n,o){var r=this;r.depth=0,r.nodeID=0,"Root Node"!==t?(r.depth=t.depth+1,r.nodeID=(Date.now()+_.random(0,99999)).toString()):r.nodeID="Root",r.move=e,r.parent=t,r.childNodes=[],r.wins=0,r.simulationSteps=0,r.visits=0,r.moveIndex,r.type="DEFAULT",r.terminal=!1,r.winnerID=!1,r.untriedMoves=[],r.getWinRate=function(){return r.visits>0?r.wins/r.visits:0},r.hasUntriedMoves=function(){return r.untriedMoves===!1||0===r.untriedMoves.length?!1:!0},r.hasChildNodes=function(){return r.childNodes===!1||0===r.childNodes.length?!1:!0},r.getRandomMoveIndexFromUntriedMoves=function(){return _.random(0,parseInt(r.untriedMoves.length-1,10))},r.playerToMove=n.getCurrentPlayerID(),r.UCTCONSTANT=o,r.getUnvisitedChildNodes=function(){var e,t,n=[],o=r.childNodes;for(t=o.length;t--;)e=o[t],0===e.visits&&n.push(e);return n},r.UCTSelectChild=function(){for(var e,t,n="None",o=0,i=r.childNodes,a=i.length;a--;)e=i[a],t=e.getWinRate()+2*r.UCTCONSTANT*Math.sqrt(2*Math.log(r.visits)/e.visits),t>o&&(n=e,o=t);return"None"===n?i[_.random(0,i.length-1)]:n},r.addChild=function(e,t,n,o){var i=new Spoooky.AI.MCnode(r.untriedMoves[e],r,t,r.UCTCONSTANT);return i.moveIndex=e,"END"!==t.models.gameState&&i.depth<n&&(i.untriedMoves=t.getCurrentPlayer().getExecutableMovesByAgentFocus("ALL")),"END"===t.models.gameState&&(i.terminal=!0,i.winnerID=t.models.winnerID),r.untriedMoves.splice(e,1),r.childNodes.push(i),"WAITINGFORDICEROLL"===t.models.gameState&&(i.type="CHANCE NODE"),i},r.update=function(e){r.visits++,r.wins+=e}},UCTrollout:function(e,t,n,o,r,i,a){if("END"===e.models.gameState)return{finalState:e,steps:1};var s,l,u,g=0,c=e.models,m="",d="";for(c.playVirtual=!0;t>=g&&(g++,!(Date.now()>a));)if("WAITINGFORDICEROLL"!==c.gameState||(Spoooky.GameEvents.fireEvent({job:"Roll Backgammon Dices"},e),"WAITINGFORDICEROLL"!==c.gameState)){if(s=e.getCurrentPlayer().getAllEntityMoves(),s.length>0&&(i&&(m=e.gameWorld.createBoardSignature()),l=s[_.random(0,s.length-1)],e.executeMove(l),i&&(d=e.gameWorld.createBoardSignature())),_.isUndefined(l)&&(l={targetX:"x",targetY:"y",moveIndex:"none"}),"END"===c.gameState)return u=c.winnerID,i&&(u===o?r.add(m,d,1,e.translateCoordinates(l.targetX,l.targetY),l.moveIndex):u===!1||r.add(m,d,-1,e.translateCoordinates(l.targetX,l.targetY),l.moveIndex)),{finalState:e,steps:g};i&&r.add(m,d,void 0,e.translateCoordinates(l.targetX,l.targetY),l.moveIndex)}else e.loop(!1,null,null);return{finalState:e,steps:g}},UCT:function(e,t,n,o,r,i,a){var s,l,u,g,c,m,d,f,y,p=0,v=e.getCurrentPlayerID(),I="",h="",D=0,M=Date.now()+o,E=9999999;for(r&&(y=new Spoooky.QLearner(.8)),g=new Spoooky.AI.MCnode({ID:"Root",name:"Root"},"Root Node",e,i),g.untriedMoves=e.getCurrentPlayer().getExecutableMovesByAgentFocus(t);Date.now()<M;){for(l=g,s=e.clone(),d=s.gameWorld;l.hasUntriedMoves()===!1&&l.hasChildNodes();)l=l.UCTSelectChild(),r&&(I=d.createBoardSignature()),f=l.move,s.executeMove(f),r&&(h=d.createBoardSignature(),y.add(I,h,void 0,s.translateCoordinates(f.targetX,f.targetY),f.moveIndex));l.hasUntriedMoves()&&(u=l.getRandomMoveIndexFromUntriedMoves(),r&&(I=d.createBoardSignature()),f=l.untriedMoves[u],s.executeMove(f),l.addChild(u,s,E,t),r&&(h=d.createBoardSignature(),y.add(I,h,void 0,s.translateCoordinates(f.targetX,f.targetY),f.moveIndex))),m=Spoooky.AI.UCTrollout(s.clone(),n,t,v,y,r,M),l.simulationSteps+=m.steps,D+=m.steps;for(var A=m.finalState.evaluateGameState(l.playerToMove);l.parent;)l.update(A),A=-1*A,l=l.parent;p++,s.models.length=0,s.length=0}var C,b,S,P,G,x=[],N=e.gameWorld.getRows();for(c=g.childNodes.length;c--;)C=g.childNodes[c],b=C.move,S=String.fromCharCode(parseInt(97+b.targetX,10))+(N-b.targetY),"place entity"===b.name?G=S:"Bear off"===b.name?G=P=String.fromCharCode(parseInt(97+b.entity.position.x,10))+(N-b.entity.position.y)+"-out":(S=String.fromCharCode(parseInt(97+b.targetX,10))+(N-b.targetY),"FREE CAPTURE"===b.type?G=S:(P=String.fromCharCode(parseInt(97+b.entity.position.x,10))+(N-b.entity.position.y),G=P+"-"+S)),"DICE"===b.type&&(G+="-"+b.diceValue),x.push({wins:C.wins,target:G,visits:C.visits,moveIndex:b.moveIndex,simulationSteps:C.simulationSteps});var F=!1;return a&&(F=Spoooky.AI.createMCTSGraph(g,N)),g=null,e=null,{mctsGraph:F,simCount:p,simSteps:D,results:x,QLearner:y}},createMCTSGraph:function(e,t){var n={ID:"Root",children:[],parent:"null",value:e.visits,name:"Entscheidungsknoten (Spieler ID "+e.playerToMove+", "+e.getWinRate().toFixed(3)+" / "+e.visits+")"},o=[];try{Spoooky.AI.preProcessChildNodes(e.childNodes,t,o)}catch(r){o.length=0}try{n.children=Spoooky.AI.createTree(o,"Root",0,10)}catch(r){n.children.length=0}return n},preProcessChildNodes:function(e,t,n){for(var o,r,i,a,s,l,u=e.length;u--;){if(o=e[u],l=o.move,r=o.move.ID.toString(),i=String.fromCharCode(parseInt(97+l.targetX,10))+(t-l.targetY),"place entity"===l.name?s=i:"Bear off"===l.name?s=String.fromCharCode(parseInt(97+l.entity.position.x,10))+(t-l.entity.position.y)+"-out":"FREE CAPTURE"===l.type?s=i:(i=String.fromCharCode(parseInt(97+l.targetX,10))+(t-l.targetY),a=String.fromCharCode(parseInt(97+l.entity.position.x,10))+(t-l.entity.position.y),s=a+"-"+i),"DICE"===l.type&&(r+="-"+l.diceValue,s+="-"+l.diceValue),o.terminal){var g;g=o.winnerID!==!1?"Spieler ID "+o.winnerID+" gewinnt. ":"unentschieden",s=s+" (Terminalknoten - "+g+o.getWinRate().toFixed(3)+" / "+o.visits+")"}else s=s+" (Spieler ID "+o.playerToMove+", "+o.getWinRate().toFixed(3)+" / "+o.visits+")";n.push({ID:o.nodeID,value:o.visits,parent:o.parent.nodeID,name:s,terminal:o.terminal}),o.childNodes.length>0&&Spoooky.AI.preProcessChildNodes(o.childNodes,t,n)}},createTree:function(e,t){for(var n,o=[],r=e.length;r--;)e[r].parent===t&&(n=Spoooky.AI.createTree(e,e[r].ID),n.length&&(e[r].children=n),o.push(e[r]));return o},max:function(e,t){return e>t?e:t},abNegaMax:function(e,t,n,o,r,i){if("END"===e.models.gameState||n===t){var a=-1e3;return e.models.winnerID===!1?a=0:e.models.winnerID===i&&(a=1e3),{score:a+n,move:null,moveIndex:!1}}var s,l,u,g,c,m,d="none",f=-99999;s=e.getCurrentPlayer().getAllEntityMoves();for(var y=s.length;y--;)if(m=s[y],l=e.clone(),l.executeMove(m),u=Spoooky.AI.abNegaMax(l,t,n+1,-1*r,-1*Spoooky.AI.max(o,f),i),c=u.score,g=-1*c,l=null,g>f&&(d=m,f=g,f>=r))return{score:f,move:d,moveIndex:d.moveIndex};return"none"===d?{score:-1}:{score:f,move:d,moveIndex:d.moveIndex}}},Spoooky.QLearner=function(e){var t=this;t.alpha=0,t.gamma=e||.8,t.rho=.2,t.nu=0,t.rewards={},t.gameStates={},t.currentState=null,t.add=function(e,n,o,r,i){t.gameStates[e]||t.addState(e),t.gameStates[n]||t.addState(n),t.gameStates[e].addAction(n,o,r,i)},t.addState=function(e){var n=new Spoooky.GameState(e);return t.gameStates[e]=n,n},t.setState=function(e){return t.currentState=t.gameStates[e],t.currentState},t.getState=function(){return t.currentState&&t.currentState.name},t.randomState=function(){var e=_.toArray(t.gameStates);return e[_.random(0,e.length-1)]},t.optimalFutureValue=function(e){var n=0,o=t.rewards[e];return _.each(o,function(e){o.hasOwnProperty(e)&&(n=Math.max(n,o[e]||0))}),n},t.step=function(){t.currentState||(t.currentState=t.randomState());var e,n=_.toArray(t.currentState.actions);return(e=_.random(0,1)<t.rho?n[_.random(0,n.length-1)]:n[_.random(0,n.length-1)])?(t.rewards[t.currentState.name]||(t.rewards[t.currentState.name]={}),t.rewards[t.currentState.name][e.name]=(e.reward||0)+t.gamma*t.optimalFutureValue(e.nextState),t.currentState=t.gameStates[e.nextState]):null},t.learn=function(e){for(e=Math.max(1,e||0);e--;)t.currentState=t.randomState(),t.step()},t.getBestAction=function(e){for(var n,o=t.rewards[e]||{},r=null,i=_.keys(o),a=i.length,s=0;a>s;++s){if(n=i[s],!o.hasOwnProperty(n))return!1;r?o[n]===o[r]?r=n:o[n]>o[r]&&(r=n):r=n}return r}},Spoooky.GameState=function(e){var t=this;t.name=e,t.actions={},t.addAction=function(e,n,o,r){var i={name:void 0===o?e:o,nextState:e,reward:n,moveIndex:r};t.actions[i.name]=i}};
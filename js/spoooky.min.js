Spoooky={};
(function(){Spoooky.Models=function(){this.HighlightTable=[];this.JobQueue=[];this.MovableEntities=[];this.MoveTable=[];this.GoalMoves=[];this.MetaAgents=[];this.Entities=[];this.GameRuleAtoms=[];this.GameRules=[];this.GameRuleConsequences=[];this.EntityGoalConsequences=[];this.GameGrid=[];this.SelectRestrictions={entities:"",moves:""};this.OffBoardContent=[];this.DiceBox={isEnabled:!1,dices:[],diceValues:[],attachedMoveIDs:[]};this.Areas={isEnabled:!1,content:[]};this.Blueprints={};this.gameName="";
this.recentlyMovedEntity=!1;this.gameState="INGAME";this.moveCounter=0;this.currentPlayerID=-1;this.description="";this.lastMoveID=this.moveID=0;this.worldDimensions={rows:0,columns:0};this.playVirtual=this.winnerID=!1;this.playerChange=!0;this.gameMode="MOVING";this.gameRounds=0};Spoooky.Game=function(){var b=this;b.initialize=function(a){b.models=new Spoooky.Models;b.gameWorld=new Spoooky.GridWelt(b);b.setName(a);b.jobQueue=new Spoooky.JobQueue(b);b.diceBox=new Spoooky.DiceBox(b);b.areas=new Spoooky.Areas(b);
b.offBoard=new Spoooky.OffBoard(b);return b};b.setupGridWorld=function(a,c,e){b.gameWorld.setup2D(a,c);b.gameWorld.setupGameBoard(e)};b.connectGridWeltView=function(a){b.viewScope=a};b.statsScope=null;b.connectStatsView=function(a){b.statsScope=a};b.refreshStatsView=function(a){b.statsScope.update(a)};b.graphScope=null;b.connectGraphView=function(a){b.graphScope=a};b.refreshGraphView=function(a,c){b.graphScope.updateGraphs(a,c)};b.evaluateGameState=function(a){var c=0;"END"===b.models.gameState&&
(c=b.models.winnerID===a?1:!1===b.models.winnerID?.5:0);return c};b.stringifyModels=function(){return JSON.stringify(b.models)};b.clone=function(a){var c=new Spoooky.Game;c.initialize("COPY");c.models=a?JSON.parse(a):JSON.parse(b.stringifyModels());var e,d;a=c.models;e=c.models.MetaAgents.length;for(var f,g,h;e--;)d=new Spoooky.MetaAgent(c),_.extend(d,a.MetaAgents[e]),a.MetaAgents[e]=d;for(e=a.Entities.length;e--;)for(d=a.Entities[e],h=d.length;h--;)g=d[h],f=new Spoooky.Entity(g.name,g.ID,g.typeID,
c),_.extend(f,g),a.Entities[e][h]=f;c.models.playVirtual=!0;c.setName("GAME_COPY");return c};b.models={};b.flush=function(a){a.length=0};b.setWinnerID=function(a){b.models.winnerID=a};b.getWinnerID=function(){return b.models.winnerID};b.jobQueue=null;b.MovableEntities=null;b.areas=null;b.addArea=function(a){null===b.areas&&(b.areas=new Spoooky.Areas);b.areas.addArea(a)};b.getArea=function(a){return b.areas.getArea(a)};b.addBlueprint=function(a,c,e){b.models.Blueprints[c.entityType]=_.clone(c);a&&
a.associateEntity(b.models.Blueprints[c.entityType],e);return b.models.Blueprints[c.entityType]};b.extendBlueprint=function(a,c){_.extend(a,c)};b.getBlueprints=function(){return b.models.Blueprints};b.getBlueprint=function(a){return b.getBlueprints()[a]};b.setRecentlyMovedEntity=function(a,c){var e=b.gameWorld.peekCell(a,c),d="default";b.isGoalMove(a,c)&&(d="capture");e?(b.models.recentlyMovedEntity={entityID:e.ID,playerID:e.getMetaPlayerID()},e.addExecutedMove(a,c,b.models.moveCounter,d)):b.models.recentlyMovedEntity=
!1};b.getrecentlyMovedEntity=function(){if(b.models.recentlyMovedEntity){var a=b.models.recentlyMovedEntity;return b.getPlayerWithID(a.playerID).getEntityWithID(a.entityID)}return!1};b.addDice=function(a,c){b.getDiceBox().enable();b.getDiceBox().createDice(a,c)};b.diceBox=null;b.getDiceBox=function(){return b.diceBox};b.offBoard=null;b.setName=function(a){b.models.gameName=a?a:""};b.getName=function(){return b.models.gameName};b.setDescription=function(a){b.models.description=a};b.getDescription=
function(){return b.models.description};b.setMoveID=function(a){b.models.moveID=a};b.setLastMoveID=function(){b.models.lastMoveID=b.models.moveID};b.getLastMoveID=function(){return b.models.lastMoveID};b.gameWorld=null;b.getGameWorld=function(){return b.gameWorld};b.loop=function(a,c,e){var d=!1;if("END"!==b.models.gameState)switch(b.models.gameMode){case "MOVING":(d=a?b.areas.isMove(a):b.isMove(c,e))?(a?b.executeJobsForMoveID(b.areas.getMoveID(a)):b.executeJobsForThisMove(c,e),b.executeGameRules()?
b.executeJobsForRecentMove():b.proceed()):b.showEntityMoves(c,e);break;case "PLACING":if(b.showFieldsToPlaceEntity(),d=b.isMove(c,e))b.executeJobsForThisMove(c,e),b.executeGameRules()?b.executeJobsForRecentMove():(b.proceed(),b.showFieldsToPlaceEntity())}b.playArtificial()};b.playArtificial=function(){!1===b.models.playVirtual&&"ARTIFICIAL"===b.getCurrentPlayerType()&&"END"!==b.models.gameState&&b.artificialTurn()};b.pseudoLoop=function(){b.loop(!1,null,null)};b.proceed=function(){!0===b.models.playerChange&&
(b.setNextPlayer(),b.setGameState("INGAME"));b.resetMoves()};b.setGameMode=function(a){b.models.gameMode=a};b.checkGoalMove=function(a,c){b.isGoalMove(a,c)};b.setGameState=function(a){b.models.gameState=a};b.getGameState=function(){return b.models.gameState};b.addPlayer=function(a){b.models.Entities[a.ID]=[];b.models.MetaAgents.push(a);1===b.models.MetaAgents.length&&b.setPlayer(a)};b.createPlayer=function(a){var c=new Spoooky.MetaAgent(b);c.setID(b.models.MetaAgents.length);a&&(c.setName(a.name),
c.setType(a.type));"ARTIFICIAL"===c.type&&c.assembleAgents();b.addPlayer(c);return c};b.setCurrentPlayerID=function(a){b.models.currentPlayerID=a};b.setPlayer=function(a){b.setCurrentPlayerID(a.ID)};b.getCurrentPlayerID=function(){return b.models.currentPlayerID};b.getNextPlayerID=function(){var a=b.getCurrentPlayerID();return a<b.models.MetaAgents.length-1?a+1:0};b.getCurrentPlayerName=function(){return b.getCurrentPlayer().getName()};b.getCurrentPlayerType=function(){return b.getPlayerWithID(b.getCurrentPlayerID()).type};
b.setNextPlayer=function(){var a=b.getCurrentPlayerID();a<b.models.MetaAgents.length-1?b.setCurrentPlayerID(a+1):b.setCurrentPlayerID(0);b.resetMoves();b.models.gameRounds++};b.getPlayerWithID=function(a){return b.models.MetaAgents[a]};b.getPlayerWhoOwnsEntity=function(a){for(var c=b.getPlayers(),e=c.length,d=0;d<e;d+=1)if(!0===c[d].hasEntity(a))return c[d];return!1};b.informArtificialPlayersAboutGameEnd=function(){for(var a=b.getPlayers(),c=a.length;c--;)"ARTIFICIAL"===a[c].type&&a[c].gameHasEnded()};
b.getPlayers=function(){return b.models.MetaAgents};b.getAIPlayers=function(){var a=b.models.MetaAgents,c=[],e;for(e=0;e<a.length;e++)"ARTIFICIAL"===a[e].type&&c.push(a[e]);return c};b.getCurrentPlayer=function(){return b.getPlayerWithID(b.getCurrentPlayerID())};b.assembleGameRule=function(a){b.models.GameRules.push(a)};b.getGameRule=function(a){return 0<=a&&a<b.models.GameRules.length?b.models.GameRules[a]:!1};b.countGameRules=function(){return b.models.GameRules.length};b.executeGameRuleByName=
function(a){for(var c=b.models.GameRules.length,e=!1,d=0,f=0,d=0;d<c;d+=1)if(b.models.GameRules[d].name===a){e=!0;d=b.models.GameRules[d].atoms;f=d.length;for(a=0;a<f;a+=1)if(e=b.executeGameRuleAtomByName(d[a]),!1===e||-1===e)return!1;return e}return!1};b.addGameRuleAtom=function(a){b.models.GameRuleAtoms.push({atomName:a.atomName,atomFunction:a.atomFunction,atomArguments:a.atomArguments,atomCondition:a.atomCondition,atomConnector:a.atomConnector})};b.entityAtomFunctions={"Is Opponent":function(a,
c){var e=a.translateDirection(c.atomArguments),d=parseInt(a.position.x+e[0],10),e=parseInt(a.position.y+e[1],10);return a.isOpponent(d,e)},"Is Empty Cell":function(a,c){var e=a.translateDirection(c.atomArguments),d=parseInt(a.position.x+e[0],10),e=parseInt(a.position.y+e[1],10);return a.isEmptyCell(d,e)},"Current Y Position Is":function(a,c){return a.position.y===c.atomArguments},"Current X Position Is":function(a,c){return a.position.x===c.atomArguments},"Entity Is Able To Reach A Specific Row":function(a,
c){var e=c.atomArguments[0];"last"===e?e=parseInt(b.gameWorld.getRows()-1,10):"first"===e&&(e=0);var d=a.translateDirection(c.atomArguments[1]),f=parseInt(a.position.x+d[0],10),d=parseInt(a.position.y+d[1],10);return!1===b.gameWorld.isEmpty(f,d)?!1:e===d},"Entity At Cell Is Of Type":function(a,c){var e=a.translateDirection(c.atomArguments),d=parseInt(a.position.x+e[0],10),e=parseInt(a.position.y+e[1],10),d=a.getGame().gameWorld.peekCell(d,e);return!1!==d&&d.type===c.atomArguments[2]?!0:!1},"Entity At Cell Has Been Moved n Times":function(a,
c){var e=a.translateDirection(c.atomArguments),d=parseInt(a.position.x+e[0],10),e=parseInt(a.position.y+e[1],10),d=a.getGame().gameWorld.peekCell(d,e);return!1!==d&&d.getMoveCount()===c.atomArguments[2]?!0:!1},"Entity At Cell Has Been Moved In Last Game Round":function(a,c){var e=a.translateDirection(c.atomArguments),d=parseInt(a.position.x+e[0],10),e=parseInt(a.position.y+e[1],10),d=a.getGame().gameWorld.peekCell(d,e);return!1!==d&&d.getLastExecutedMove().round===a.getGame().models.moveCounter?!0:
!1},"Is Not Attackable In Next Round":function(a,c){var e=a.translateDirection(c.atomArguments),d=parseInt(a.position.x+e[0],10),e=parseInt(a.position.y+e[1],10);return!a.getGame().opponentEntityCanCaptureAt(d,e,a)},"Number Of Opponents At Destination Field Is":function(a,c,e){var d=0,b=a.position.x,g=a.position.y,h=c.atomArguments[0];c=c.atomArguments[1];b=a.getGame().gameWorld.getFieldID(b,g);!1===_.isUndefined(a.tmp.fieldID)&&(b=a.tmp.fieldID);"MOVE POSITIVE"===h?d=parseInt(b+e,10):"MOVE NEGATIVE"===
h&&(d=parseInt(b-e,10));return a.countOpponentsOnFieldsWithID(d,a)===c},"No Own Entitys On Fields With ID Less Than":function(a,c){var e=c.atomArguments;return!a.getAssociatedPlayer().hasEntitiesOnFieldWithFieldID(e,"<")},"No Own Entitys On Fields With ID More Than":function(a,c){var e=c.atomArguments;return!a.getAssociatedPlayer().hasEntitiesOnFieldWithFieldID(e,">")},"Destination Field ID Is Greater Than":function(a,c,e){var d=0,b=a.position.x,g=a.position.y,h=c.atomArguments[0],b=a.getGame().gameWorld.getFieldID(b,
g);if(!1===_.isUndefined(a.tmp.fieldID))return!1;"MOVE POSITIVE"===h?d=parseInt(b+e,10):"MOVE NEGATIVE"===h&&(d=parseInt(b-e,10));return d>c.atomArguments[1]},"Destination Field ID Is Less Than":function(a,c,e){var d=0,b=a.position.x,g=a.position.y,h=c.atomArguments[0],b=a.getGame().gameWorld.getFieldID(b,g);if(!1===_.isUndefined(a.tmp.fieldID))return!1;"MOVE POSITIVE"===h?d=parseInt(b+e,10):"MOVE NEGATIVE"===h&&(d=parseInt(b-e,10));return d<c.atomArguments[1]}};b.executeEntityGoalAtomByName=function(a,
c,e){if(!1===a.enabled)return!1;var d=a.goalAtoms.length,f;for(f=0;f<d;f+=1)if(a.goalAtoms[f].atomName===c)return c=a.goalAtoms[f],b.entityAtomFunctions[c.atomFunction](a,c,e);return!1};b.gameRuleAtoms={"Last Move Was Capture Move":function(){if(b.getrecentlyMovedEntity())return"capture"===b.getrecentlyMovedEntity().getLastExecutedMove().type},"Recently Moved Entity Can Capture An Opponent Entity":function(){if(b.getrecentlyMovedEntity())return b.getrecentlyMovedEntity().canCapture()},"Recently Moved Entity Can Not Capture An Opponent Entity":function(){if(b.getrecentlyMovedEntity())return!b.getrecentlyMovedEntity().canCapture()},
"Recently Moved Entity Is Owned By Player":function(a){if(b.getrecentlyMovedEntity())return b.getrecentlyMovedEntity().getMetaPlayerID()===a.atomArguments},"Recently Moved Entity Is At YPosition":function(a){a=a.atomArguments;"last"===a?a=parseInt(b.gameWorld.getRows()-1,10):"first"===a&&(a=0);if(!1!==b.getrecentlyMovedEntity())return b.getrecentlyMovedEntity().getPosition().y===a},"Recently Moved Entity Is At XPosition":function(a){a=a.atomArguments;"last"===a&&(a=b.gameWorld.getColumns()-1);if(!1!==
b.getrecentlyMovedEntity())return b.getrecentlyMovedEntity().getPosition().x===a},"Recently Moved Entity Is Type":function(a){var c=a.atomArguments,e=b.getrecentlyMovedEntity(),d=0;a=a.atomConnector;var f=0;if(0!==e)switch(d=e.type,a){case "OR":for(f=e=c.length;f--;)if(d===c[f])return!0;return!1;case "AND":for(f=e=c.length;f--;)if(d!==c[f])return!1;return!0;default:return d===c}},"Player Has Entities":function(a){return 0!==b.getPlayerWithID(a.atomArguments).countEntities()},"All players have placed their entities on the game board":function(){for(var a=
b.getPlayers(),c,e,d=a.length;d--;)for(c=a[d].getEntities(),e=c.length;e--;)if(!c[e].onBoard)return!1;return!0},"Player Has No Movable Entities":function(a){a=b.getPlayerWithID(a.atomArguments);var c=a.countEntities(),e;if(0===c)return!0;for(e=c;e--;)if(!0===b.checkSelectCondition(a.getEntityFromArray(e))&&a.getEntityFromArray(e).canMove())return!1;for(e=c;e--;)if(!0===b.checkSelectCondition(a.getEntityFromArray(e))&&a.getEntityFromArray(e).canReachGoal())return!1;return!0},"Player Has Entities In Off Board Area":function(a){return b.offBoard.entitiesOfPlayerAreOutside(a.atomArguments)},
"Player Has No Entities In Off Board Area":function(a){return!b.offBoard.entitiesOfPlayerAreOutside(a.atomArguments)},"Player Has No Entities":function(a){return 0===b.getPlayerWithID(a.atomArguments).countEntities()},"Player Has Number Of Entities":function(a){return b.getPlayerWithID(a.atomArguments[0]).countEntities()===a.atomArguments[1]},"Player Has No Entity Which Satisfies Goals":function(a){a=b.getPlayerWithID(a.atomArguments);var c=a.countEntities();if(0===c)return!0;for(;c--;)if(!_.isEmpty(a.getEntityFromArray(c).canReachGoal()))return!1;
return!0},"Player Has Number Of Entities In Row":function(a){var c=a.atomArguments.entityID;a=a.atomArguments.number;var e=b.gameWorld.createBoardSignature();return(new RegExp(c+"{"+a+"}")).test(e)},"Player Has Number Of Entities In Column":function(a){var c=a.atomArguments.entityID;a=a.atomArguments.number;var e=b.gameWorld.createBoardSignatureByVertical();return(new RegExp(c+"{"+a+"}")).test(e)},"Player Has Number Of Entities Diagonally":function(a){var c="",c=b.gameWorld,e=c.getRows(),d=c.getColumns();
a=new RegExp(a.atomArguments.entityID+"{"+a.atomArguments.number+"}");var f=b.gameWorld.createBoardSignature(),g,h;for(g=0;g<d;g++){c="";for(h=g;h<f.length&&"|"!==f[h];h+=d+2)c+=f[h];if(!0===a.test(c))return!0}for(g=1;g<e;g++){c="";for(h=g*d+g;h<f.length&&"|"!==f[h];h+=d+2)c+=f[h];if(!0===a.test(c))return!0}for(g=1;g<e;g++){c="";for(h=g*d+g;0<h&&"|"!==f[h];h-=d)c+=f[h];if(!0===a.test(c))return!0}for(g=3;g<=d;g++){c="";for(h=e*d+e-g;0<h&&"|"!==f[h];h-=d)c+=f[h];if(!0===a.test(c))return!0}return!1},
"No Empty Field On The Game Board":function(){return 0===b.gameWorld.getFreeCells().length},"Current Player Is":function(a){return b.getPlayerWithID(a.atomArguments).ID===b.getCurrentPlayerID()},"Print Debug Message":function(a){return!0},"Game State Is":function(a){return a.atomArguments===b.models.gameState},"Dice Box Is Empty":function(){return b.getDiceBox().gotNoDiceValues()},"Entity Is Under Attack":function(a){return b.entityOfSpecificTypeIsUnderAttack(a.atomArguments)},"Got No Protecting Entities":function(a){return!b.identifyProtectingEntities(a.atomArguments.entityType)},
"Every Entity Of Player Is In Target Area":function(a){var c=b.getPlayerWithID(a.atomArguments.player),e=c.countEntities();a=a.atomArguments.targetArea;var d=a.length,f,g,h=!1;if(0===e)return!1;for(f=0;f<d;f+=1){h=!1;for(g=0;g<e;g+=1)c.getEntityFromArray(g).position.x===a[f].x&&c.getEntityFromArray(g).position.y===a[f].y&&(h=!0);if(!1===h)return!1}return!0}};b.executeGameRuleAtomByName=function(a){var c;for(c=b.models.GameRuleAtoms.length;c--;)if(b.models.GameRuleAtoms[c].atomName===a)return a=b.models.GameRuleAtoms[c],
b.gameRuleAtoms[a.atomFunction](a);return!1};b.connectGameRuleConsequences=function(a){for(var c=a.ruleName,e="",d="",f=a.consequences,g=f.length;g--;)f[g].execute="immediately";a.entityName&&(e=a.entityName);a.entityType&&(d=a.entityType);b.models.GameRuleConsequences.push({goalName:c,entityName:e,entityType:d,consequences:f})};b.getGameRuleConsequencesWithName=function(a){for(var c=[],e,d=b.models.GameRuleConsequences,f=d.length;f--;)e=d[f],e.goalName===a&&(e.entityName&&!1!==b.getrecentlyMovedEntity()&&
(e.entityName=b.getrecentlyMovedEntity().getName()),e.entityType&&!1!==b.getrecentlyMovedEntity()&&(e.entityType=b.getrecentlyMovedEntity().type),e.consequences.entityLink=b.getrecentlyMovedEntity(),c.push(e));c.reverse();return c};b.executeGameRuleConsequences=function(a){a=b.getGameRuleConsequencesWithName(a);for(var c=a.length,e=0;e<c;e+=1)b.addJobs(a[e].consequences)};b.executeGameRules=function(){b.resetRestrictions();var a,c,e=b.countGameRules(),d=!1;for(a=0;a<e;a++)c=b.getGameRule(a),!0===
b.executeGameRuleByName(c.name)&&(b.executeGameRuleConsequences(c.name),d=!0);return d};b.getUniqueMoveID=function(a,c,e,d){return a+"_"+c+"_"+e+"|"+d};b.moveEntity=function(a,c,e,d,f){b.gameWorld.moveEntity(a,c,e,d,f)};b.deleteEntityAt=function(a,c){b.gameWorld.deleteCellContent(a,c)};b.countFieldsWithID=function(a){return b.gameWorld.getContentOfFieldsWithFieldID(a).length};b.countOwnOnFieldsWithID=function(a,c){var e=b.gameWorld.getContentOfFieldsWithFieldID(a),d,f=0,g=0,h=e.length;for(d=0;d<h;d+=
1)(g=e[d])&&g.getMetaPlayerID()===c.getMetaPlayerID()&&(f+=1);return f};b.countOpponentsOnFieldsWithID=function(a,c){var e=b.gameWorld.getContentOfFieldsWithFieldID(a),d,f=0,g=0,h=e.length;for(d=0;d<h;d+=1)(g=e[d])&&g.getMetaPlayerID()!==c.getMetaPlayerID()&&(f+=1);return f};b.resetRestrictions=function(){b.models.SelectRestrictions.entities="";b.models.SelectRestrictions.moves=""};b.checkSelectCondition=function(a){if("Recently Moved Entity"===b.models.SelectRestrictions.entities)return b.getrecentlyMovedEntity().getName()===
a.getName();if(!_.isUndefined(a.selectCondition)){if("Only Off Board Entities"===b.models.SelectRestrictions.entities)return null!==a.position.x&&null!==a.position.y?!1:!0;var c=a.selectCondition,e=!1;if(c.neighboursY){var d,f=0,g={"<":function(a,c){return a<c},"<=":function(a,c){return a<=c},">":function(a,c){return a>c},">=":function(a,c){return a>=c},"==":function(a,c){return a==c}},h;for(d=c.neighboursY.length;d--;)switch(h=c.neighboursY[d],f=h.appliesTo,f.axis){case "y":if(g[f.operator](a.position.y,
f.value)){var f=h.count,l=h.condition,k=0;switch(h.direction){case "NORTH":k=b.gameWorld.countNeighboursNorth(a);break;case "SOUTH":k=b.gameWorld.countNeighboursSouth(a);break;default:k=b.gameWorld.countNeighboursY(a)}switch(l){case "LESS THAN OR EQUAL TO":case "<=":k<=f&&(e=!0);break;case "LESS THAN":case "<":k<f&&(e=!0);break;case "MORE THAN OR EQUAL TO":case ">=":k>=f&&(e=!0);break;case "MORE THAN":case ">":k>f&&(e=!0);break;case "EQUAL":case "=":case "==":case "===":k===f&&(e=!0)}}}}return e}return!0};
b.showEntityMoves=function(a,c){var e=b.gameWorld.peekCell(a,c);if(!1===e||_.isUndefined(e))return!1;if(b.isHighlighted(e))return b.resetMoves(),!1;if(e.getMetaPlayerID()!==b.getCurrentPlayerID())return!1;if(!0===b.checkSelectCondition(e)){b.resetMoves();var d,f;switch(b.models.SelectRestrictions.moves){case "Standard Moves":d=e.getMoves();break;case "Capture Moves":f=e.getGoalMoves(d);break;default:d=e.getMoves(),f=e.getGoalMoves(d)}b.performPostMoveChecks(e,d);b.performPostMoveChecks(e,f);_.isEmpty(d)&&
_.isEmpty(f)||b.highlightEntityAtPosition(a,c);b.highlightStandardMoves(d);b.highlightGoalMoves(f)}return!0};b.showFieldsToPlaceEntity=function(){"PLACING"===b.models.gameMode&&b.highlightStandardMoves(b.getCurrentPlayer().getAllEntityMoves())};b.highlightStandardMoves=function(a){if(!_.isUndefined(a))for(var c,e=a.length;e--;)c=a[e],b.highlightCell(c.targetX,c.targetY,c.moveClass,c.ID),b.models.MoveTable.push({entity:c.entity,xPosition:c.targetX,yPosition:c.targetY,moveClass:c.moveClass,moveID:c.ID})};
b.highlightGoalMoves=function(a){if(!_.isUndefined(a))for(var c,e,d=a.length;d--;)switch(c=a[d],c.type){case "DICE":"move_bearoff"===c.moveClass?b.executeGoalConsequences(c.name,c.entity,!1):(e=c.entity,b.setMoveID(b.getDiceBox().getMoveIDForDiceID(c.diceID)),e.setTarget(c.targetX,c.targetY),b.executeGoalConsequences(c.name,e,!1),e.unsetTarget());break;case "PUT":break;default:e=c.entity;var f=[],g=e.position.x,h=e.position.y;f.x=g;f.y=h;b.doVirtualMove(g,h,c.preArrangeX,c.preArrangeY);b.executeGoalConsequences(c.name,
e,f);b.undoVirtualMove()}};b.performPostMoveChecks=function(a,c){if(null!==a.postMoveCheck)for(var e,d,f,g=a.postMoveCheck,h=0;h<c.length;h++)for(f=0;f<g.length;f++)e=g[f],"Entity Is Attackable After Move"===e.condition&&(d=c[h].entity,b.doVirtualMove(d.position.x,d.position.y,c[h].targetX,c[h].targetY),b.entityOfTypeIsUnderAttack(e.entity,d.getAssociatedPlayer())&&(c.splice(h,1),--h),b.undoVirtualMove())};b.resetMoves=function(){var a=b.gameWorld,c,e,d=b.models.MoveTable,f=b.models.HighlightTable;
for(e=d.length;e--;)c=d[e],a.setCellClass(c.xPosition,c.yPosition,"");b.models.MoveTable.length=0;b.models.GoalMoves.length=0;b.models.MovableEntities.length=0;for(e=f.length;e--;)c=f[e],a.setCellClass(c.x,c.y,"");b.flush(b.models.HighlightTable);null!==b.areas&&b.areas.isEnabled()&&b.areas.resetDisplays();null!==b.getDiceBox()&&b.getDiceBox().flushAttachedMoveIDs()};b.isHighlighted=function(a){var c=b.models.HighlightTable,e=c.length,d,f=a.position.x,g=a.position.y;for(a=0;a<e;a+=1)if(d=c[a],d.x===
f&&d.y===g)return!0;return!1};b.highlightEntityAtPosition=function(a,c){b.gameWorld.isValidCoordinate(a,c)&&(b.models.HighlightTable.push({x:a,y:c}),b.gameWorld.setCellClass(a,c,"clickedEntity"))};b.highlightCell=function(a,c,e,d){b.gameWorld.setCellClass(a,c,e);b.models.HighlightTable.push({x:a,y:c});"move_goal"===e&&(b.models.MoveTable.push({entity:null,xPosition:a,yPosition:c,moveClass:e,moveID:d}),b.models.GoalMoves.push({entity:null,xPosition:a,yPosition:c}))};b.virtualMove=[];b.doVirtualMove=
function(a,c,e,d){var f=b.gameWorld;a={srcX:a,srcY:c,srcEntity:f.popFromCell(a,c),destX:e,destY:d,destEntity:f.popFromCell(e,d)};b.virtualMove.push(a);a.destEntity&&null!==a.destEntity&&a.destEntity.setPosition(null,null);a.srcEntity&&(a=a.srcEntity,f.pushToCell({entityID:a.ID,playerID:a.getMetaPlayerID(),typeID:a.getTypeID()},e,d),a.setPosition(e,d,!0))};b.undoVirtualMove=function(){var a=b.virtualMove.pop();if(!a)return!1;var c=a.srcEntity;c&&null!==c&&(b.gameWorld.popFromCell(a.destX,a.destY),
c.setPosition(a.srcX,a.srcY),b.gameWorld.pushToCell({entityID:c.ID,playerID:c.getMetaPlayerID(),typeID:c.getTypeID()},a.srcX,a.srcY));(c=a.destEntity)&&null!==c&&(c.setPosition(a.destX,a.destY),b.gameWorld.pushToCell({entityID:c.ID,playerID:c.getMetaPlayerID(),typeID:c.getTypeID()},a.destX,a.destY));return!0};b.moveConditions={"Is Empty":function(a,c){return b.gameWorld.isEmpty(a._destX,a._destY)!==c?!1:!0},"Is Empty At":function(a,c,e){return!b.gameWorld.isEmpty(parseInt(a._curX+a._conditions[e].relativeCoordinate[0],
10),parseInt(a._curY+a._conditions[e].relativeCoordinate[1],10))===c?!1:!0},"Is Not The Last Row":function(a){return a._destY===parseInt(b.gameWorld.getRows()-1,10)?!1:!0},"Is Not The First Row":function(a){return 0===a._destY?!1:!0},"Move Count":function(a,c,e){return a._currentEntity.getMoveCount()!==a._conditions[e].value?!1:!0},"Move Count Of Entity":function(a,c,e){c=b.getCurrentPlayer().getEntityWithName(a._conditions[e].entityName);return!1===c||c.getMoveCount()!==a._conditions[e].value?!1:
!0},"Game State":function(a,c,e){return b.models.gameState===a._conditions[e].value&&!0===c?!0:b.models.gameState!==a._conditions[e].value&&!1===c?!0:!1},"Field Is Attackable By Opponent Entity":function(a,c,e){var d=parseInt(a._curX+a._conditions[e].relativeCoordinate[0],10);e=parseInt(a._curY+a._conditions[e].relativeCoordinate[1],10);b.doVirtualMove(a._curX,a._curY,d,e);if(c===b.opponentEntityCanCaptureAt(d,e,a._currentEntity))return b.undoVirtualMove(),!0;b.undoVirtualMove();return!1},"Target Field Is Reachable By Opponent Entity":function(a,
c,e){c=b.getCurrentPlayer().getNextOpponentPlayer().getEntitiesOfType(a._conditions[e].opponentEntity);e=c.length;if(0!==e){var d,f,g,h;f=null;for(var l,k=e;k--;)for(e=c[k],g=e.position.x,h=e.position.y,d=e.countGoals();d--;)if(f=e.getGoal(d),f=e.translateDirection(f.move),l=parseInt(g+f[0],10),f=parseInt(h+f[1],10),l===a._destX&&f===a._destY)return!1}return!0},yPosition:function(a,c,e){return a._curY===a._conditions[e].value&&!0===c?!0:!1},xPosition:function(a,c,e){return a._curX===a._conditions[e].value&&
!0===c?!0:!1}};b.isLegalMove=function(a,c,e,d,f,g){if(!1===b.gameWorld.isValidCoordinate(f,g))return!1;var h;h=c.length;e={_currentEntity:a,_conditions:c,_curX:e,_curY:d,_destX:f,_destY:g};for(a=0;a<h;a+=1)if(!1===b.moveConditions[c[a].condition](e,c[a].state,a))return!1;return!0};b.viewScope=null;b.refreshView=function(){b.models.playVirtual||b.viewScope.$apply()};b.executeRandomMove=function(){var a=b.getCurrentPlayer().getAllEntityMoves(),a=a[_.random(0,parseInt(a.length-1,10))];b.executeMove(a)};
b.executeArtificialMove=function(a){if("random"===a)return b.executeRandomMove(),!0;a=b.getCurrentPlayer().getAllEntityMoves()[a.moveIndex];b.executeMove(a);return!0};b.executeMove=function(a){if("END"===b.models.gameState)return!1;var c=!1,e,d;if("move_goal"===a.moveClass||"move_bearoff"===a.moveClass)if(e=a.entity,"DICE"===a.type)"move_bearoff"===a.moveClass?(b.executeGoalConsequences(a.name,e,!1),c=a.targetArea):(b.setMoveID(b.getDiceBox().getMoveIDForDiceID(a.diceID)),e.setTarget(a.targetX,a.targetY),
b.executeGoalConsequences(a.name,e,!1),e.unsetTarget());else{var f=[];d=e.position;f.x=d.x;f.y=d.y;b.doVirtualMove(d.x,d.y,a.preArrangeX,a.preArrangeY);b.executeGoalConsequences(a.name,e,f);b.undoVirtualMove();a.targetX=b.models.HighlightTable[0].x;a.targetY=b.models.HighlightTable[0].y}else{d=a.entity.position;b.models.MoveTable.push({entity:a.entity,xPosition:a.targetX,yPosition:a.targetY,moveClass:a.moveClass,moveID:a.ID});if("DICE"===a.type){var f=!1,g=a.targetX,h=a.targetY;e=a.entity;d=e.position;
!1===_.isUndefined(e.tmp.fieldID)?f=!0:e.getWorld().getFieldID(d.x,d.y);!0===f?(b.addJobForMoveID({jobID:a.ID,jobName:"Put the entity to the destination field",job:"Place Entity",jobArguments:{entity:e,xPosition:g,yPosition:h}}),b.addJobForMoveID({jobID:a.ID,jobName:"Remove the current entity from off board area",job:"Delete Entity from OffBoard",jobArguments:{entity:e}})):b.addJobForMoveID({jobID:a.ID,jobName:"move game entity",job:"Move Entity By Dice Value",jobArguments:{entity:a.entity,destX:a.targetX,
destY:a.targetY,diceValue:a.diceValue}});b.addJobForMoveID({jobID:a.ID,jobName:"Delete Dice Value",job:"Delete Dice Value",jobArguments:a.diceID})}else"PLACING"!==b.models.gameMode&&b.addJobForMoveID({jobID:a.ID,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:a.entity,destX:a.targetX,destY:a.targetY}});a.postMove&&_.each(a.postMove,function(c){b.addJobForMoveID({jobID:a.ID,jobName:c.jobName,job:c.jobFunction,jobArguments:c.jobArguments})})}b.loop(c,a.targetX,a.targetY);b.refreshView();
return!0};b.artificialTurn=function(){if("WAITINGFORDICEROLL"===b.models.gameState&&(Spoooky.GameEvents.fireEvent({job:"Roll Backgammon Dices"},b),"WAITINGFORDICEROLL"===b.models.gameState))return b.pseudoLoop(),!1;b.getCurrentPlayer().artificialMove();return!0};b.addJobs=function(a){for(var c,e,d=0;d<a.length;d++)e=a[d],c={jobID:b.models.moveID,jobName:e.jobName,job:e.jobFunction,jobArguments:e.jobArguments,entityLink:a.entityLink},e.execute&&"immediately"===e.execute?Spoooky.GameEvents.fireEvent(c,
b):b.addJobForMoveID(c);b.models.moveID=0;return!0};b.addJobForMoveID=function(a){a.execute&&"immediately"===a.execute?Spoooky.GameEvents.fireEvent(a,b):b.jobQueue.addJob(a);return!0};b.isMove=function(a,c){for(var e=b.models.MoveTable,d,f=e.length;f--;)if(d=e[f],d.xPosition===a&&d.yPosition===c&&0!==d.moveID)return!0;return b.isGoalMove(a,c)};b.isGoalMove=function(a,c){for(var e=b.models.GoalMoves,d=e.length;d--;)if(e[d].xPosition===a&&e[d].yPosition===c)return!0;return!1};b.getMoveID=function(a,
c){for(var e=b.models.MoveTable,d,f=e.length;f--;)if(d=e[f],d.xPosition===a&&d.yPosition===c&&0!==d.moveID)return d.moveID;return!1};b.executeJobsForThisMove=function(a,c){b.executeJobsForMoveID(b.getMoveID(a,c));b.setRecentlyMovedEntity(a,c)};b.executeJobsForRecentMove=function(){b.resetMoves();b.executeJobsForMoveID(b.getLastMoveID())};b.executeJobsForMoveID=function(a){a=b.jobQueue.getJobsWithMoveID(a);for(var c=0;c<a.length;c+=1)Spoooky.GameEvents.fireEvent(a[c],b);b.jobQueue.flush();b.models.moveID=
0};b.getEntityAtCell=function(a,c){return b.gameWorld.peekCell(a,c)};b.getEntityWithName=function(a){for(var c=b.getPlayers(),e,d=c.length;d--;)if(e=c[d].getEntityWithName(a),!1!==e)return e;return!1};b.pushEntityToCell=function(a,c,e){a.setPosition(c,e);b.gameWorld.pushToCell({entityID:a.ID,playerID:a.getMetaPlayerID(),typeID:a.getTypeID()},c,e)};b.identifyProtectingEntities=function(a){for(var c=b.getCurrentPlayer(),e,d,f,g=!1,h,l,k,m,n=c.countEntities();n--;){e=c.getEntityFromArray(n);h=e.getMoves();
l=e.getGoalMoves();b.performPostMoveChecks(e,h);b.performPostMoveChecks(e,l);k=e.position.x;m=e.position.y;for(d=h.length;d--;)f=h[d],b.doVirtualMove(k,m,f.targetX,f.targetY),b.entityOfTypeIsUnderAttack(a,e.getAssociatedPlayer())||(b.models.MovableEntities.push(e),b.highlightEntityAtPosition(k,m),g=!0),b.undoVirtualMove();for(d=l.length;d--;)f=l[d],b.doVirtualMove(k,m,f.targetX,f.targetY),b.entityOfTypeIsUnderAttack(a,e.getAssociatedPlayer())||(b.models.MovableEntities.push(e),b.highlightEntityAtPosition(k,
k),g=!0),b.undoVirtualMove()}return g};b.opponentEntityCanCaptureAt=function(a,c,e){var d=e.getAssociatedPlayer().getNextOpponentPlayer(),f;b.doVirtualMove(e.position.x,e.position.y,a,c);for(var g=d.countEntities();g--;)for(e=d.getEntityFromArray(g).getGoalMoves(),f=e.length;f--;)if("CAPTURE"===e[f].type&&a===e[f].targetX&&c===e[f].targetY)return b.undoVirtualMove(),!0;b.models.GoalMoves.length=0;b.undoVirtualMove();return!1};b.connectEntityActionsConsequences=function(a){var c=a.goalName,e=a.consequences,
d="",f="";a.entityName&&(d=a.entityName);a.entityType&&(f=a.entityType);b.models.EntityGoalConsequences.push({goalName:c,entityName:d,entityType:f,consequences:e})};b.connectConsequences=function(a){for(var c=_.keys(a),e=c.length,d=0;d<e;++d)b.connectEntityActionsConsequences(a[c[d]])};b.getGoalConsequencesWithName=function(a,c){for(var e=[],d,f=b.models.EntityGoalConsequences.length;f--;)d=b.models.EntityGoalConsequences[f],d.goalName===a&&(d.entityName===c.getName()?(d.consequences.entityLink=c,
e.push(d)):d.entityType===c.type&&(d.entityName=c.getName(),d.consequences.entityLink=c,e.push(d)));return e};b.executeGoalConsequences=function(a,c,e){var d=b.getGoalConsequencesWithName(a,c),f=c.position;a=0===b.models.moveID?b.getUniqueMoveID(c.name,a,f.x,f.y):b.models.moveID;b.setMoveID(a);e&&b.addJobForMoveID({jobID:b.models.moveID,jobName:"move game entity",job:"Prearrange Entity",jobArguments:{entity:c,destX:f.x,destY:f.y}});for(c=0;c<d.length;c++)b.addJobs(d[c].consequences)};b.translateCoordinates=
function(a,c){return String.fromCharCode(parseInt(97+a,10))+(b.gameWorld.getRows()-c)};b.addEntitiesToGameBoard=function(a){var c=0,e;e=null;for(var d,f=b.gameWorld.getRows(),g=b.gameWorld.getColumns(),h=0;h<f;h+=1)for(var l=0;l<g;l+=1)d=a[c],0!==d&&(e=b.getPlayerWithID(d.associatedWithMetaAgent),e=e.entityFactory(d),b.pushEntityToCell(e,l,h)),c+=1};b.addEntityToGame=function(a,c){var e=b.getPlayerWithID(a.associatedWithMetaAgent);if(c){a.unlimitedQuantity=!1;for(var d=c;d--;)e.entityFactory(a)}else a.unlimitedQuantity=
!0,e.entityFactory(a)};b.entityOfTypeIsUnderAttack=function(a,c){for(var e=c.getEntitiesOfType(a),d=e.length;d--;)if(e[d].canBeCaptured())return!0;return!1};b.entityOfSpecificTypeIsUnderAttack=function(a){var c=b.getPlayerWithID(a.associatedWithMetaAgent);if(0===c.countEntities())return!1;a=c.getEntitiesOfType(a.entityType);if(0===a.length)return!1;for(c=a.length;c--;)if(!0===a[c].canBeCaptured())return!0;return!1}};Spoooky.DiceBox=function(b){var a=this;a.enable=function(){b.models.DiceBox.isEnabled=
!0};a.isEnabled=function(){return b.models.DiceBox.isEnabled};a.createDice=function(a,e){b.models.DiceBox.dices.push({start:a,end:e})};a.countDices=function(){return b.models.DiceBox.dices.length};a.getDice=function(c){return 0<=c&&c<a.countDices()?b.models.DiceBox.dices[c]:!1};a.rollDice=function(c){return!1!==a.getDice(c)?parseInt(_.random(a.getDice(c).start,a.getDice(c).end),10):!1};a.rollAllDices=function(){for(var c=[],e=a.countDices();e--;)c.push(a.rollDice(e));return b.models.DiceBox.diceValues=
c};a.getMoveIDForDiceID=function(a){for(var e=b.models.DiceBox,d=e.attachedMoveIDs.length;d--;)if(e.attachedMoveIDs[d].diceValueID===a)return e.attachedMoveIDs[d].moveID;return!1};a.connectMoveIDWithDiceValue=function(a,e,d){b.models.DiceBox.attachedMoveIDs.push({diceValueID:e,moveID:a,target:d})};a.getConnectedDiceValue=function(a){for(var e=b.models.DiceBox,d=e.attachedMoveIDs.length;d--;)if(e.attachedMoveIDs[d].moveID===a)return e.attachedMoveIDs[d];return!1};a.flushAttachedMoveIDs=function(){b.models.DiceBox.attachedMoveIDs.length=
0};a.getDiceValues=function(){return b.models.DiceBox.diceValues};a.gotNoDiceValues=function(){return!b.models.DiceBox.diceValues[0]};a.deleteDiceValue=function(a){b.models.DiceBox.diceValues.splice(a,1)};a.deleteAllDiceValues=function(){b.models.DiceBox.diceValues.length=0}};Spoooky.GridWelt=function(b){var a=this;a.getRows=function(){return b.models.worldDimensions.rows};a.getColumns=function(){return b.models.worldDimensions.columns};a.getView=function(c,e){return a.isValidCoordinate(c,e)?b.models.GameGrid[e][c].view:
!1};a.setup=function(){if(0<b.models.worldDimensions.fieldsX&&0<b.models.worldDimensions.fieldsY)return a.init2DGrid(),!0;console.log("Invalid Size of GridWelt");return!1};a.setup2D=function(c,e){b.models.worldDimensions.rows=e;b.models.worldDimensions.columns=c;a.init2DGrid();return!0};a.setupGameBoard=function(c){for(var e=0,d=a.getRows(),f=a.getColumns(),g,h,l=0;l<d;l+=1)for(g=0;g<f;g+=1)h=c[e],a.setCellBaseClass(g,l,h),-1!==h.indexOf("disabled")&&(b.models.GameGrid[g][l].enabled=!1),e+=1};a.setCellClass=
function(c,e,d){a.getView(c,e).cellClass=d};a.setCellBaseClass=function(c,e,d){a.getView(c,e).baseClass=d};a.init2DGrid=function(){var c,e,d,f,g;f=a.getRows();g=a.getColumns();for(c=0;c<f;c+=1){d=[];for(e=0;e<g;e+=1)d.push({cellID:null,contains:[],view:{baseClass:"",cellClass:""},position:{x:e,y:c},enabled:!0});b.models.GameGrid.push(d)}return!0};a.setFieldIDs=function(c){var e,d,f=0,g=a.getColumns(),h=a.getRows();for(d=0;d<h;d+=1)for(e=0;e<g;e+=1)b.models.GameGrid[d][e].cellID=c[f],f+=1;return!0};
a.getFieldID=function(c,e){return a.isValidCoordinate(c,e)?b.models.GameGrid[e][c].cellID:!1};a.createBoardSignature=function(){for(var a=b.models.GameGrid,e=b.gameWorld.getColumns(),d="",f=_.flatten(a),g=f.length,h,a=0;a<g;a++)h=f[a].contains,d=0===h.length?d+"0":d+_.last(h).typeID,0===(a+1)%e&&a+1!==g&&(d+="|");e=b.models.OffBoardContent;if(0<e.length)for(d+="|",a=e.length;a--;)d+=e[a].typeID;return d};a.createBoardSignatureByVertical=function(){var c=a.getRows(),e=a.getColumns(),d=b.models.GameGrid,
f,g,h,l="";for(g=0;g<e;g++){for(h=0;h<c;h++)f=d[h][g].contains,l=0===f.length?l+"0":l+_.last(f).typeID;g+1!==e&&(l+="|")}return l};a.pushToCell=function(c,e,d){return a.isValidCoordinate(e,d)?(b.models.GameGrid[d][e].contains.push(c),!0):!1};a.popFromCell=function(c,e){if(a.isValidCoordinate(c,e)){var d=b.models.GameGrid[e][c].contains.pop();if(d)return b.getPlayerWithID(d.playerID).getEntityWithID(d.entityID)}return!1};a.deleteCellContent=function(c,e){if(a.isValidCoordinate(c,e)){var d=a.popFromCell(c,
e);if(d&&0!==d)return d.seppuku(),!0}return!1};a.peekCell=function(c,e){if(a.isValidCoordinate(c,e)){var d=b.models.GameGrid[e][c].contains;if(0!==d.length)return d=_.last(d),b.getPlayerWithID(d.playerID).getEntityWithID(d.entityID)}return!1};a.isValidCoordinate=function(c,e){var d=parseInt(c,10);return d<a.getColumns()&&0<=d&&(d=parseInt(e,10),0<=d&&d<a.getRows())?!0:!1};a.isEmpty=function(c,e){return!1===a.peekCell(c,e)};a.moveEntity=function(c,e,d,f,g){if(_.isUndefined(d)||_.isUndefined(f)||!1===
a.isValidCoordinate(d,f))return!1;var h=b.models.GameGrid[f][d].contains;c=a.popFromCell(c,e);if(!1===_.isUndefined(g))g.setPosition(d,f),h.push({entityID:g.ID,playerID:g.getMetaPlayerID(),typeID:g.getTypeID()});else if(c)c.setPosition(d,f),h.push({entityID:c.ID,playerID:c.getMetaPlayerID(),typeID:c.getTypeID()});else return!1;return!0};a.getFreeCells=function(){for(var c=[],e=a.getColumns(),d=a.getRows(),f=b.models.GameGrid,g,h=e;h--;)for(g=d;g--;)e=f[g][h],e.enabled&&0===e.contains.length&&c.push({x:h,
y:g});return c};a.getFreeFieldsWithFieldID=function(c){for(var e=[],d=a.getColumns(),f=a.getRows(),g=b.models.GameGrid,h,l=d;l--;)for(d=f;d--;)h=g[d][l],0===h.contains.length&&h.cellID===c&&e.push([l,d]);e.reverse();return e};a.getFieldsWithFieldID=function(c){var e=[],d=a.getColumns(),f=a.getRows(),g=b.models.GameGrid,h,l;for(h=d;h--;)for(l=f;l--;)d=g[l][h],d.cellID===c&&e.push(d);e.reverse();return e};a.getContentOfFieldsWithFieldID=function(c){for(var e=[],d=a.getColumns(),f=a.getRows(),g=b.models.GameGrid,
h,l;d--;)for(l=f;l--;)h=g[l][d],h.cellID===c&&(h=a.peekCell(d,l))&&e.push(h);e.reverse();return e};a.countNeighboursNorth=function(c){var e=c.position.x,d=c.position.y,f=b.models.GameGrid[d][e].cellID;c=c.getAssociatedPlayer();var g=0,h=a.peekCell(e,parseInt(d-1,10)),l=b.models.GameGrid;!1!==h&&l[parseInt(d-1,10)][e].cellID===f&&h.getAssociatedPlayer()===c&&(g+=1);return g};a.countNeighboursSouth=function(c){var e=c.position.x,d=c.position.y,f=b.models.GameGrid;if(!1===a.isValidCoordinate(e,d))return!1;
var g=null;c=c.getAssociatedPlayer();var h=0,l=a.peekCell(e,parseInt(d+1,10));f[d][e]&&(g=f[d][e].cellID);!1!==l&&f[parseInt(d+1,10)][e].cellID===g&&l.getAssociatedPlayer()===c&&(h+=1);return h};a.countNeighboursY=function(c){return a.countNeighboursNorth(c)+a.countNeighboursSouth(c)}};Spoooky.OffBoard=function(b){var a=this;a.addEntity=function(a){b.models.OffBoardContent.push({typeID:a.typeID,entityID:a.ID,entityName:a.getName(),playerID:a.getMetaPlayerID()})};a.deleteEntity=function(a){b.models.OffBoardContent.splice(a,
1)};a.deleteEntityFromOffBoard=function(c){for(var e=b.models.OffBoardContent.length;e--;)if(b.models.OffBoardContent[e].entityName===c)return a.deleteEntity(e),!0;return!1};a.entitiesOfPlayerAreOutside=function(a){for(var e=b.models.OffBoardContent.length;e--;)if(b.models.OffBoardContent[e].playerID===a)return!0;return!1};a.getAllEntities=function(){return b.models.OffBoardContent};a.getEntityWithPlayerID=function(a){for(var e=b.models.OffBoardContent.length;e--;)if(b.models.OffBoardContent[e].playerID===
a)return a=b.models.OffBoardContent[e],b.getPlayerWithID(a.playerID).getEntityWithID(a.entityID);return!1};a.getEntitiesWithPlayerID=function(a){for(var e=[],d,f=b.models.OffBoardContent,g=0;g<f.length;g++)d=f[g],d.playerID===a&&e.push(b.getPlayerWithID(d.playerID).getEntityWithID(d.entityID));return e}};Spoooky.GameEvents={events:{"Roll Dices":function(b,a){a.getDiceBox().rollAllDices()},"Roll Backgammon Dices":function(b,a){var c=-1,e,d=!0;e=a.getDiceBox();a.setGameState("INGAME");e.rollAllDices();
e=e.getDiceValues();_.each(e,function(a){-1!==c&&c!==a&&(d=!1);c=a});!0===d&&(e.push(e[0]),e.push(e[0]));a.executeGameRules()},"Delete Dice Value":function(b,a){a.getDiceBox().deleteDiceValue(b.jobArguments)},"Delete Assigned Dice Value":function(b,a){if(!1===a.getDiceBox().getConnectedDiceValue(b.jobID))return!1;a.getDiceBox().deleteDiceValue(a.getDiceBox().getConnectedDiceValue(b.jobID).diceValueID);return!0},"Bear Off Entity At Dice Target Cell":function(b,a){var c=a.getDiceBox().getConnectedDiceValue(b.jobID);
if(!1===c)return!1;var e=c.target.x,c=c.target.y,d=a.gameWorld.peekCell(e,c);if(!1===d||_.isUndefined(d)||null===d)return!1;d.setPosition(null,null);0===a.getCurrentPlayerID()?d.tmp.fieldID=25:1===a.getCurrentPlayerID()&&(d.tmp.fieldID=0);a.offBoard.addEntity(d);a.gameWorld.popFromCell(e,c);return!0},"Show Backgammon Re-entering Moves":function(b,a){var c=b.jobArguments.playerID;if(c===a.getCurrentPlayerID()){var e=a.offBoard.getEntityWithPlayerID(c);e.setPosition(-1,-1);0===c?e.tmp.fieldID=0:1===
c&&(e.tmp.fieldID=25);c=e.getMoves();e=e.getGoalMoves(c);a.highlightStandardMoves(c);a.highlightGoalMoves(e)}return!1},"Delete Entity from OffBoard":function(b,a){delete b.jobArguments.entity.tmp.fieldID;a.offBoard.deleteEntityFromOffBoard(b.jobArguments.entity.name)},"Place Entity":function(b,a){var c=b.jobArguments.entity,c=a.getPlayerWithID(c.associatedWithPlayerID).getEntityWithID(c.ID),e=b.jobArguments;c.unlimitedQuantity||(c.onBoard=!0);a.pushEntityToCell(c,e.xPosition,e.yPosition);a.models.moveCounter+=
1;!1===a.models.playVirtual&&Spoooky.GameProcess.pushMessage("["+a.models.moveCounter+"] "+a.getCurrentPlayerName()+" setzt Spielfigur auf Feld "+a.translateCoordinates(e.xPosition,e.yPosition)+".")},"Move Entity To Dice Destination Cell":function(b,a){var c=a.getDiceBox().getConnectedDiceValue(b.jobID);if(!1===c)return!1;var e=b.entityLink.position.x,d=b.entityLink.position.y,f=c.target.x,c=c.target.y;a.models.moveCounter+=1;if(!1===a.models.playVirtual){var g=a.translateCoordinates(e,d),h=a.translateCoordinates(f,
c);Spoooky.GameProcess.pushMessage("["+a.models.moveCounter+"] "+a.getCurrentPlayerName()+" bewegt Spielfigur von "+g+" nach "+h+".")}!1===_.isUndefined(b.entityLink.tmp.fieldID)?(a.moveEntity(e,d,f,c,b.entityLink),delete b.entityLink.tmp.fieldID,a.offBoard.deleteEntityFromOffBoard(b.entityLink.getName())):a.moveEntity(e,d,f,c);return!0},"Prearrange Entity":function(b,a){var c=b.jobArguments,e=c.entity.position;a.models.moveCounter+=1;a.moveEntity(e.x,e.y,c.destX,c.destY)},"Move Entity":function(b,
a){var c=a.models,e=b.jobArguments,d=e.entity.position;c.moveCounter+=1;if(!1===c.playVirtual){var f=a.translateCoordinates(d.x,d.y),g=a.translateCoordinates(e.destX,e.destY);Spoooky.GameProcess.pushMessage("["+c.moveCounter+"] "+a.getCurrentPlayerName()+" bewegt Spielfigur von "+f+" nach "+g+".")}a.moveEntity(d.x,d.y,e.destX,e.destY)},"Move Entity By Dice Value":function(b,a){var c=a.models,e=b.jobArguments,d=e.entity.position;c.moveCounter+=1;if(!1===c.playVirtual){var f=a.translateCoordinates(d.x,
d.y),g=a.translateCoordinates(e.destX,e.destY);Spoooky.GameProcess.pushMessage("["+c.moveCounter+"] "+a.getCurrentPlayerName()+" bewegt Spielfigur von "+f+" nach "+g+" mit dem Wuerfelwert "+e.diceValue+".")}a.moveEntity(d.x,d.y,e.destX,e.destY)},"Move Entity Relative To":function(b,a){var c=b.entityLink,e=c.position.x,c=c.position.y;a.moveEntity(e,c,parseInt(e+b.jobArguments[0],10),parseInt(c+b.jobArguments[1],10))},"Move Entity With Name":function(b,a){var c=a.getEntityWithName(b.jobArguments[0]);
if(!1===c)return!1;var e=b.jobArguments,d=c.position.x,c=c.position.y,f,g;"RELATIVE"===e[3]?(f=parseInt(d+e[1],10),g=parseInt(c+e[2],10)):"ABSOLUTE"===e[3]&&(f=e[1],g=e[2]);a.moveEntity(d,c,f,g);a.models.moveCounter+=1;return!0},"Prevent Player Change":function(b,a){a.models.playerChange=!1;return!0},"Enable Player Change":function(b,a){a.models.playerChange=!0},"Proceed Game":function(b,a){a.proceed()},"Change Game Mode":function(b,a){var c=b.jobArguments.mode;"PLACING"===c||"MOVING"===c?a.setGameMode(c):
console.log("Error: Wrong Game Mode",c)},"Capture Opponent At":function(b,a){var c,e,d=b.jobArguments,f=b.entityLink.position;"RELATIVE"===d[2]?(c=parseInt(f.x+d[0],10),e=parseInt(f.y+d[1],10)):"ABSOLUTE"===d[2]&&(c=d[0],e=d[1]);!1===a.models.playVirtual&&(d=a.translateCoordinates(c,e),Spoooky.GameProcess.pushMessage("["+a.models.moveCounter+"] "+a.getCurrentPlayerName()+" schlaegt gegnerische Spielfigur auf Feld "+d+"."));a.deleteEntityAt(c,e)},"Highlight Dice Target Cell":function(b,a){a.highlightCell(b.entityLink.targeting.x,
b.entityLink.targeting.y,b.jobArguments,b.jobID)},"Highlight Area":function(b,a){a.getArea(b.jobArguments.areaName).display=b.jobArguments.highlightClass},"Highlight Cell":function(b,a){var c=b.jobArguments,e=c[0],d=c[1],f=c[2];"RELATIVE"===c[3]?(e=parseInt(b.entityLink.position.x+c[0],10),d=parseInt(b.entityLink.position.y+c[1],10)):"ABSOLUTE"===c[3]&&(e=c[0],d=c[1]);a.highlightCell(e,d,f,b.jobID)},"Set Game State":function(b,a){a.setGameState(b.jobArguments)},"Restrict Selectable Entities":function(b,
a){a.models.SelectRestrictions.entities=b.jobArguments},"Restrict Selectable Entity Moves":function(b,a){a.models.SelectRestrictions.moves=b.jobArguments},"Delete This Entity":function(b,a){a.deleteEntityAt(b.entityLink.position.x,b.entityLink.position.y)},"Increment Off Board Counter":function(b,a){a.areas.incrementElements(b.jobArguments)},"Transform Entity":function(b,a){var c=b.entityLink,e=a.models.MetaAgents[b.entityLink.associatedWithPlayerID],d=c.position.x,f=c.position.y;a.deleteEntityAt(d,
f);a.resetMoves();var g=a.getBlueprint(b.jobArguments),g=e.entityFactory(g);g.setName(c.getName());g.setID(c.ID);g.associatedWithMetaAgent=e.ID;g.executedMoves=c.executedMoves;a.pushEntityToCell(g,d,f)},"Transform Entity If Row Reached":function(b,a){var c=b.entityLink,e=b.jobArguments.row;"last"===e?e=parseInt(a.gameWorld.getRows()-1,10):"first"===e&&(e=0);if(c.position.y!==e)return!1;Spoooky.GameEvents.fireEvent({job:"Transform Entity",jobArguments:b.jobArguments.entityType,entityLink:c},a);return!0},
"Next Player":function(b,a){a.setNextPlayer()},"Delete All Dice Values":function(b,a){a.getDiceBox().deleteAllDiceValues()},alert:function(b){alert(b.jobArguments)},"Print Game Process":function(b,a){!1===a.models.playVirtual&&Spoooky.GameProcess.pushMessage(b.jobArguments)},"Stop Game":function(b,a){a.setGameState("END");!1===a.models.playVirtual&&a.informArtificialPlayersAboutGameEnd()},"Set Winner":function(b,a){a.setWinnerID(b.jobArguments);!1===a.models.playVirtual&&Spoooky.GameProcess.pushMessage('<button id="postGameReloadButton"onclick="location.reload();" type="button" class="btn btn-success btn-sm">Spiel neu starten</button>')}},
fireEvent:function(b,a){this.events[b.job](b,a)}};Spoooky.JobQueue=function(b){this.addJob=function(a){var c=b.models.JobQueue;_.isUndefined(c[a.jobID])&&(c[a.jobID]=[]);c[a.jobID][a.jobName]=a};this.flush=function(){b.models.JobQueue.length=0};this.getJobsWithMoveID=function(a){var c=[];a=b.models.JobQueue[a];for(var e in a)c.push(a[e]);return c}};Spoooky.Areas=function(b){var a=this;a.enable=function(){b.models.Areas.isEnabled=!0};a.isEnabled=function(){return b.models.Areas.isEnabled};a.isMove=
function(c){return 0!==a.getArea(c).moveID};a.incrementElements=function(c){a.getArea(c).elementCounter++};a.getMoveID=function(c){return a.getArea(c).moveID};a.addArea=function(c){a.enable();b.models.Areas.content.push({name:c,moveID:0,display:"",elementCounter:0})};a.getArea=function(a){return _.find(b.models.Areas.content,function(e){return e.name===a})};a.resetDisplays=function(){_.each(b.models.Areas.content,function(a){a.display=""})}};Spoooky.Agent=function(b,a){var c=this;c.ID=a;c.metaAgentID=
b;c.role="ANALYZE POSSIBLE MOVES";c.focus="ALL";c.fitness=1;c.thinkingTime=1E4;c.maximumSteps=1E4;c.uctConstant=.9;c.proposeBestMove=function(){var a=!1,d=c.ID,b=c.role,g=c.focus,h=c.maximumSteps,l=c.createBrain(),k=c.uctConstant,m=c.thinkingTime,n=Spoooky.AI.game.getPlayerWithID(c.metaAgentID).learningEnabled;localStorage["#mctsgraph"]&&(a=!0);switch(b){case "ANALYZE POSSIBLE MOVES":l.postMessage({agentID:d,agentRole:b,agentFocus:g,maxSteps:h,maxTime:m,learn:n,uctConstant:k,command:"monte carlo tree search with uct",
gameModel:Spoooky.AI.game.stringifyModels(),generateMctsGraph:a});break;case "SEARCH FOR IMMEDIATE THREATS":l.postMessage({agentID:d,agentRole:b,agentFocus:g,command:"alpha beta negamax",maxDepth:3,gameModel:Spoooky.AI.game.stringifyModels()});break;default:console.log("Unknown Agent Role.")}};c.createBrain=function(){var a=new Worker("../../js/spoooky.Worker.min.js"),d=Spoooky.AI.game.getPlayerWithID(c.metaAgentID);a.addEventListener("message",function(a){switch(a.data.type){case "decision":d.coordinateAgentDecisions(a.data);
break;case "random":d.coordinateAgentDecisions(a.data)}});return a}};Spoooky.MetaAgent=function(b){var a=this;a.name="";a.setName=function(c){a.name=c};a.getName=function(){return a.name};a.getGame=function(){return b};a.ID=0;a.getID=function(){return a.ID};a.setID=function(c){a.ID=c};a.type="HUMAN";a.setType=function(c){if("HUMAN"===c||"ARTIFICIAL"===c)return a.type=c,!0;console.log("Invalid Player Type. Allowed Player Types: HUMAN or ARTIFICIAL");return!1};a.learningEnabled=!1;a.enableLearning=
function(){a.learningEnabled=!0};a.QLearner={};a.gameHasEnded=function(){if(a.learningEnabled){Spoooky.GameProcess.pushMessage("Meta Agent "+a.ID+" lernt...");a.QLearner.learn(1E4);var c;c="{\n"+('\t"game" : "'+a.getGame().getName()+'",\n');c+='\t"metaAgentID" : '+a.ID+",\n";c=c+'\t"bestAgentEnsemble" : '+JSON.stringify(a.agents,null,"\t");c+=",\n";c+='\t"learnModule" : ';c+=JSON.stringify(a.QLearner,null,"\t");c+="\n}";c=new Blob([c],{type:"text/plain;charset=utf-8"});saveAs(c,"agentmemory_"+a.ID+
".json")}};a.associateEntity=function(c,e){c.associatedWithMetaAgent=a.ID;"PLACE"===c.mode&&a.getGame().addEntityToGame(c,e)};a.entityFactory=function(c){var e;e="";var d=0;e=c.entityName?c.entityName:a.ID+"_entity_"+parseInt(a.countEntities()+1,10);d=c.entityID?c.entityID:parseInt(a.countEntities()+1,10);e=new Spoooky.Entity(e,d,c.typeID,a.getGame());e.setType(c.entityType);e.setRepresentation(c.representation.type,c.representation.texture);var b,g=c.moves;if(g)for(d=0;d<g.length;d++)b=g[d],e.addMove({name:b.name,
type:b.type,direction:b.direction,frequency:b.frequency,conditions:b.conditions,postMove:b.postMove});if(c.goalAtoms)for(d=0;d<c.goalAtoms.length;d++)b=c.goalAtoms[d],e.addGoalAtom(b.atomName,b.atomFunction,b.atomArguments);if(c.goals)for(d=0;d<c.goals.length;d++)b=c.goals[d],e.assembleGoal({type:b.type,name:b.name,atoms:b.atoms,move:b.move,area:b.area});e.selectCondition=c.selectCondition;e.postMoveCheck=c.postMoveCheck?c.postMoveCheck:null;e.setGoalTargets(c.goalTargets);c.unlimitedQuantity&&(e.unlimitedQuantity=
!0);c.mode&&(e.mode=c.mode);c.placeTo&&(e.placeTo=c.placeTo);a.addEntity(e);return e};a.addEntity=function(c){c.setAssociatedPlayerID(a.ID);b.models.Entities[a.ID].push(c)};a.getEntityFromArray=function(c){return 0<=c&&c<a.countEntities()?b.models.Entities[a.ID][c]:!1};a.getEntityWithID=function(c){for(var e,d=a.countEntities();d--;)if(e=b.models.Entities[a.ID][d],e.ID===c)return e;return!1};a.getEntities=function(){return b.models.Entities[a.ID]};a.getEntitiesOfType=function(c){for(var e=[],d=a.countEntities();d--;)b.models.Entities[a.ID][d].type===
c&&e.push(b.models.Entities[a.ID][d]);return e};a.getPlaceableEntities=function(){for(var c=[],e,d=a.countEntities(),f=a.ID;d--;)e=b.models.Entities[f][d],"PLACE"===e.mode&&(e.unlimitedQuantity?c.push(e):e.onBoard||c.push(e));return c};a.getEntityWithName=function(c){for(var e=a.countEntities();e--;)if(b.models.Entities[a.ID][e].name===c)return b.models.Entities[a.ID][e];return!1};a.getNextOpponentPlayer=function(){return a.ID<a.getGame().models.MetaAgents.length-1?a.getGame().getPlayerWithID(parseInt(a.ID+
1,10)):a.getGame().getPlayerWithID(0)};a.getOccupiedFields=function(c){var b=[],d=a.getGame().models.GameGrid,d=_.flatten(d),f=d.length;switch(c){case "OWN ENTITIES":for(c=f;c--;)f=d[c],0!==f.contains.length&&_.last(f.contains).playerID===a.ID&&b.push(f.position);break;case "OPPONENT ENTITIES":for(c=f;c--;)f=d[c],0!==f.contains.length&&_.last(f.contains).playerID!==a.ID&&b.push(f.position);break;default:console.log("Wrong Mode")}return b};a.hasEntity=function(c){for(var e=a.countEntities();e--;)if(b.models.Entities[a.ID][e].name===
c)return!0;return!1};a.deleteEntity=function(c){for(var e=a.countEntities();e--;)if(b.models.Entities[a.ID][e].name===c)return b.models.Entities[a.ID].splice(e,1),!0;return!1};a.countEntities=function(){return b.models.Entities[a.ID].length};a.getAllEntityStdMoves=function(){var c=a.getEntities();if(0===c.length)return!1;for(var b,d,f=[],g=a.getGame(),h=c.length;h--;)b=c[h],!0===g.checkSelectCondition(b)&&(d=b.getMoves(),g.performPostMoveChecks(b,d),f.push.apply(f,d));return 0===f.length?!1:f};a.getAllEntityGoalMoves=
function(){var c=a.getEntities();if(0===c.length)return!1;for(var b,d,f=[],g=a.getGame(),h=c.length;h--;)b=c[h],!0===g.checkSelectCondition(b)&&(d=b.getGoalMoves(),g.performPostMoveChecks(b,d),f.push.apply(f,d));return 0===f.length?!1:f};a.getAllEntityMoves=function(){var c=a.getGame();if("END"===c.models.gameState)return[];var b,d;switch(c.models.gameMode){case "MOVING":b=a.getEntities();d=b.length;if(0===d)return[];for(var f=[],g=[],h=[],l,k=d;k--;)if(d=b[k],"PLACE"!==d.mode&&!0===c.checkSelectCondition(d)){f.length=
0;g.length=0;l=c.models.SelectRestrictions.moves;switch(l){case "Standard Moves":f=d.getMoves();break;case "Capture Moves":g=d.getGoalMoves(f);break;default:f=d.getMoves(),g=d.getGoalMoves(f)}c.performPostMoveChecks(d,f);c.performPostMoveChecks(d,g);h.push.apply(h,f);h.push.apply(h,g)}return 0===h.length?[]:h;case "PLACING":b=a.getPlaceableEntities();if(0===b.length)return[];var f=[],k;d=_.last(b);switch(d.placeTo){case "ANY":h=c.gameWorld.getFreeCells();for(k=h.length;k--;)b=h[k],g=c.getUniqueMoveID(d.name,
"place-entity",b.x,b.y),f.push({type:"PLACE",name:"place entity",entity:d,targetX:b.x,targetY:b.y,moveClass:"move_place",ID:g}),c.addJobForMoveID({jobID:g,jobName:"Put the Entity to the destination field",job:"Place Entity",jobArguments:{entity:d,xPosition:b.x,yPosition:b.y}});return f;case "REACHABLE BY RECENTLY MOVED ENTITY":k=c.getrecentlyMovedEntity();if(!1===k)return[];h=k.getMoves();for(k=h.length;k--;)b=h[k],g=c.getUniqueMoveID(d.name,"place-entity",b.targetX,b.targetY),f.push({type:"PLACE",
name:"place entity",entity:d,targetX:b.targetX,targetY:b.targetY,moveClass:"move_place",ID:g}),c.addJobForMoveID({jobID:g,jobName:"Put the Entity to the destination field",job:"Place Entity",jobArguments:{entity:d,xPosition:b.targetX,yPosition:b.targetY}}),c.addJobForMoveID({jobID:g,jobName:"Let Players Change",job:"Enable Player Change"}),c.addJobForMoveID({jobID:g,jobName:"Change Back To Move Mode",job:"Change Game Mode",jobArguments:{mode:"MOVING"}});return f;default:console.log("Wrong Placing Mode: ",
d.placeTo)}break;default:console.log("Wrong command in self_MetaAgent.getAllEntityMoves")}};a.getExecutableMovesByAgentFocus=function(c){if("END"===a.getGame().models.gameState)return[];var b=a.getAllEntityMoves(),d,f,g,h,l,k=[],m;for(d=b.length;d--;)b[d].moveIndex=d;switch(c){case "FIRST HALF OF POSSIBLE MOVES":return k=Math.floor(b.length/2),b.splice(k,k),b;case "SECOND HALF OF POSSIBLE MOVES":return k=Math.floor(b.length/2),b.splice(0,k),b;case "MOVES NEAR OPPONENT FIELDS":m=a.getOccupiedFields("OPPONENT ENTITIES");
for(f=b.length;f--;)for(c=b[f].targetX,d=b[f].targetY,l=m.length;l--;)if(g=m[l].x,h=m[l].y,g=Math.abs(g-c),h=Math.abs(h-d),1>=g&&1>=h){k.push(b[f]);break}return k;case "MOVES NEAR OPPONENT OR OWN FIELDS":m=a.getOccupiedFields("OPPONENT ENTITIES");m=m.concat(a.getOccupiedFields("OWN ENTITIES"));for(f=b.length;f--;)for(c=b[f].targetX,d=b[f].targetY,l=m.length;l--;)if(g=m[l].x,h=m[l].y,g=Math.abs(g-c),h=Math.abs(h-d),1>=g&&1>=h){k.push(b[f]);break}return k;default:return b}};a.agents=[];a.activeAgents=
0;a.finishedAgents=0;a.countAgents=function(){return a.agents.length};a.getAgents=function(){return a.agents};a.getAgentWithID=function(c){var b,d=a.agents;for(b=d.length;b--;)if(d[b].ID===c)return d[b];return!1};a.assembleAgent=function(c,b,d,f,g,h,l){c=new Spoooky.Agent(a.ID,c);c.role=b;c.fitness=h;c.focus=d;c.thinkingTime=g;c.maximumSteps=f;c.uctConstant=l;a.agents.push(c)};a.addStandardAgent=function(){var c,b,d=0;b=a.getAgents();for(var f=b.length;f--;)c=b[f].ID,c>d&&(d=c);a.assembleAgent(d+
1,"ANALYZE POSSIBLE MOVES","ALL MOVES",1E4,1E4,1,.9)};a.deleteAgentWithID=function(c){for(var b=a.agents.length;b--;)a.agents[b].ID===c&&a.agents.splice(b,1)};a.expertKnowledge=!1;a.assembleAgents=function(){var b="agentmemory_"+a.ID+".json",e=!1;$.ajax({url:b,dataType:"json",async:!1,success:function(b){e=!0;Spoooky.AgentLog.pushMessage("Lade Agentenerinnerungen fuer Meta Agent "+a.ID+".");Spoooky.AgentLog.pushMessage('<div class="progress progress-striped active"><div class="progress-bar"  role="progressbar" style="width: 100%"><span class="sr-only">Lade</span></div></div>');
a.QLearner=new Spoooky.QLearner;a.QLearner.reward=b.learnModule.rewards;a.QLearner.gameStates=b.learnModule.gameStates;$.each(b.bestAgentEnsemble,function(b,c){a.assembleAgent(c.ID,c.role,c.focus,c.maximumSteps,c.thinkingTime,c.fitness,c.uctConstant)})},complete:function(){if(e){Spoooky.AgentLog.messages.pop();var d=_.keys(a.QLearner.gameStates).length;Spoooky.AgentLog.pushMessage(d+" gelernte Spielzustaende wurden erfolgreich aus der Datei "+b+" geladen.")}},error:function(){0===a.agents.length&&
(Spoooky.AgentLog.pushMessage("Keine Erinnerungen fuer Meta Agent "+a.ID+" vorhanden: Datei "+b+" existiert nicht."),a.QLearner=new Spoooky.QLearner,a.assembleAgent(1,"ANALYZE POSSIBLE MOVES","ALL MOVES",15E3,1E4,1,.5),a.assembleAgent(2,"ANALYZE POSSIBLE MOVES","FIRST HALF OF POSSIBLE MOVES",15E3,1E4,1,.5),a.assembleAgent(3,"ANALYZE POSSIBLE MOVES","SECOND HALF OF POSSIBLE MOVES",15E3,1E4,1,.5))}});return!0};a.runtimeStart=0;a.findBestMove=function(){Spoooky.AI.game=a.getGame();a.runtimeStart=Date.now();
a.askAgentsForDecision()};a.askAgentsForDecision=function(){a.activeAgents=a.countAgents();a.bestMoves.length=0;Spoooky.AgentLog.pushMessage("Meta agent "+a.ID+" ("+a.getName()+") fragt "+a.activeAgents+" assoziierte Agenten nach der besten Zugmoeglichkeit.");for(var b=0;b<a.agents.length;b++)a.agents[b].proposeBestMove()};a.bestMoves=[];a.prepareAgentsMoveSuggestions=function(a){var b=[],d,f,g,h=!1,l,k,m;l=[];for(f=a.length;f--;){d=a[f];for(g=b.length;g--;)b[g].moveIndex===d.moveIndex&&(k=parseInt(b[g].wins+
d.wins),h=parseInt(b[g].visits+d.visits),m=parseInt(b[g].lost+d.lost),parseInt(b[g].simulationSteps+d.simulationSteps),l=b[g].agentID,l.push(d.agentID),l={simulationSteps:d.simulationSteps,moveIndex:d.moveIndex,agentID:l,visits:h,target:d.target,wins:k,lost:m},b[g]=l,h=!0);!1===h&&(l={simulationSteps:d.simulationSteps,moveIndex:d.moveIndex,agentID:[d.agentID],target:d.target,visits:d.visits,wins:d.wins,lost:d.lost},b.push(l));h=!1}return b};a.updateAgentsFitness=function(b){var e=a.getAgents(),d=
!1,f,g;for(f=e.length;f--;){for(g=b.length;g--;)if(e[f].ID===b[g]){e[f].fitness+=.5;d=!0;break}!1===d&&(e[f].fitness-=.5);d=!1}};a.getFittestAgent=function(){var b=a.getAgents(),e,d=0,f,g;for(e=b.length;e--;)g=b[e],g.fitness>=d&&(d=g.fitness,f=g);return f};a.replaceUnfitAgents=function(){var b=a.getAgents(),e,d=a.getFittestAgent();for(e=b.length;e--;).1>b[e].fitness&&(Spoooky.AgentLog.pushMessage("Agent #"+b[e].ID+" hat eine schlechte Fitness von "+b[e].fitness+" und fokussiert nun den folgenden Spielaspekt: "+
d.focus),b[e].role=d.role,b[e].focus=d.focus,b[e].fitness=1);a.getGame().refreshView()};a.updateQLearner=function(b){var e,d,f;e=a.QLearner;b=JSON.parse(b).gameStates;var g,h,l,k,m=e.gameStates,n=_.keys(b),t=n.length;for(f=0;f<t;++f)if(g=b[n[f]],h=g.name,_.has(m,h))for(l=g.actions,n=_.keys(l),t=n.length,f=0;f<t;f++)k=l[n[f]],_.has(m[h].actions,k.name)?(d=e=0,_.has(m[h].actions[k.name],"reward")&&(d=m[h].actions[k.name].reward),_.has(k,"reward")&&(e=k.reward),e+=d,m[h].actions[k.name]=k,0!==e&&(m[h].actions[k.name].reward=
e)):m[g.name].actions[k.name]=k;else m[g.name]=g};a.mctsData=[];a.processAgentDecision=function(b){a.mctsData.push({agentID:b.agentID,mctsGraph:b.mctsGraph,uctConstant:b.uctConstant});b.mctsGraph.length=0;a.bestMoves.push(b);Spoooky.AgentLog.pushMessage("Agent #"+b.agentID+" hat "+b.results.length+" Zugmoeglichkeiten anhand von "+b.simCount+" Monte Carlo Ausspielungen mit insgesamt "+b.simSteps+" Simulationsschritten analysiert.");a.getGame().refreshView();a.finishedAgents++};a.allAgentsHaveFinishedThinking=
function(){return a.finishedAgents===a.activeAgents?(a.finishedAgents=0,!0):!1};a.sumUpAgentsWork=function(){var b,e,d={},f=0,g=0,h=[],l=a.bestMoves,k,m;for(k=l.length;k--;){e=l[k];f+=e.simCount;g+=e.simSteps;b=e.results;for(m=b.length;m--;)d=b[m],d.agentID=e.agentID,d.agentRole=e.agentRole,d.agentFocus=e.agentFocus,h.push(d);a.learningEnabled&&a.updateQLearner(e.QLearner)}a.bestMoves.length=0;return{results:h,simCount:f,simSteps:g}};a.getBestMove=function(a){for(var b=Number.MAX_VALUE,d,f,g="Random",
b=-1*Number.MAX_VALUE,h=a.length;h--;)d=a[h],0<d.visits&&(f=d.visits,f>b&&(b=f,g=d),Spoooky.AgentLog.pushMessage(d.target+" [Agent(en) #"+d.agentID+"]<ul><li>Besuche: "+d.visits+"</li><li>Gewinnhaeufigkeit: "+d.wins+"</li><li>Simulationsschritte: "+d.simulationSteps+"</li><li>Gewinnrate: "+d.wins/d.visits+"</li></ul>"));return g};a.printAgentsFinishedMessage=function(){for(var a=Spoooky.GameProcess.messages.length;a--;)"thinking"===Spoooky.GameProcess.messages[a].type&&Spoooky.GameProcess.messages.splice(a,
1);Spoooky.AgentLog.pushMessage("Alle assoziierten Agenten haben ihre Arbeit beendet.")};a.coordinateAgentDecisions=function(b){a.processAgentDecision(b);b.length=0;if(a.allAgentsHaveFinishedThinking()){var e=(Date.now()-a.runtimeStart)/1E3;a.printAgentsFinishedMessage();var d=a.sumUpAgentsWork(),f=d.simCount,g=d.simSteps;b=a.prepareAgentsMoveSuggestions(d.results);d.length=0;Spoooky.AgentLog.pushMessage("<strong>"+f+" simulierte Spiele  mit insgesamt "+g+" Simulationsschritten (~"+(g/f).toFixed(2)+
" Schritte/Simulation) in "+e+" Sekunden.</strong>");Spoooky.Statistics.logEntry(a.ID,"simCount",a.getGame().models.moveCounter+1,f);Spoooky.Statistics.logEntry(a.ID,"simSteps",a.getGame().models.moveCounter+1,g);b=_.sortBy(b,function(a){return a.visits});b.reverse();e=a.getBestMove(b);b.length=0;a.learningEnabled&&a.QLearner.learn(1E4);"Random"===e?(Spoooky.AgentLog.pushMessage("Meta Agent fuehrt einen Zufallszug aus."),a.getGame().executeRandomMove()):(a.updateAgentsFitness(e.agentID),a.replaceUnfitAgents(),
Spoooky.AgentLog.pushMessage("<strong>Meta Agent hat sich fuer die folgende Zugmoeglichkeit entschieden: "+e.target+"</strong>"),a.getGame().executeArtificialMove(e));a.mctsData&&a.getGame().refreshGraphView(a.mctsData,a.ID);a.getGame().refreshStatsView(a.ID);a.mctsData.length=0}};a.artificialMove=function(){Spoooky.GameProcess.pushMessage(a.getName()+' denkt nach...<br><div class="progress progress-striped active"><div class="progress-bar"  role="progressbar" style="width: 100%"><span class="sr-only">Ich denke nach...</span></div></div>',
"thinking");a.findBestMove()};a.hasEntitiesOnFieldWithFieldID=function(b,e){for(var d,f={"<":function(a,b){return a<b},"<=":function(a,b){return a<=b},">":function(a,b){return a>b},">=":function(a,b){return a>=b},"==":function(a,b){return a==b}},g=a.countEntities();g--;)if(d=a.getEntityFromArray(g),f[e](d.getFieldID(),b))return!0;return!1}};Spoooky.Entity=function(b,a,c,e){var d=this;d.unlimitedQuantity=!1;d.mode="MOVE";d.placeTo=0;d.getGame=function(){return e};d.ID=a;d.getID=function(){return d.ID};
d.setID=function(a){d.ID=a};d.typeID=c;d.getTypeID=function(){return d.typeID};d.setTypeID=function(a){d.typeID=a};d.name=b;d.enabled=!0;d.moveCounter=0;d.increaseMoveCounter=function(){d.moveCounter+=1};d.getMoveCount=function(){return d.moveCounter};d.lastExecutedMove=0;d.addExecutedMove=function(a,b,c,e){d.increaseMoveCounter();d.lastExecutedMove={destX:a,destY:b,round:c,type:e}};d.getLastExecutedMove=function(){return d.lastExecutedMove};d.enable=function(){d.enabled=!0};d.disable=function(){d.enabled=
!1};d.setName=function(a){d.name=a};d.type="default";d.getType=function(){return d.type};d.setType=function(a){d.type=a};d.getWorld=function(){return d.getGame().gameWorld};d.isOpponent=function(a,b){var c;return d.getWorld().isValidCoordinate(a,b)&&(c=d.getWorld().peekCell(a,b),!1!==c&&c.getMetaPlayerID()!==d.getMetaPlayerID())?!0:!1};d.isEmptyCell=function(a,b){return d.getWorld().isValidCoordinate(a,b)?!1===d.getWorld().peekCell(a,b):!1};d.visualRepresentation={type:"",colour:"",imageURL:""};d.getView=
function(){return d.visualRepresentation.imageURL};d.position={x:-1,y:-1};d.getPosition=function(){return d.position};d.getFieldID=function(){return d.getWorld().getFieldID(d.position.x,d.position.y)};d.setPosition=function(a,b){d.position.x=a;d.position.y=b};d.tmp={};d.targeting={x:null,y:null};d.setTarget=function(a,b){d.targeting.x=a;d.targeting.y=b};d.unsetTarget=function(){d.targeting.x=null;d.targeting.y=null};d.goalTargets=[];d.addGoalTarget=function(a){d.goalTargets.push(a)};d.setGoalTargets=
function(a){d.goalTargets=a};d.getGoalTargets=function(){return d.goalTargets};d.setRepresentation=function(a,b){if("colour"===a||"image"===a)d.visualRepresentation={type:a,colour:b,imageURL:b}};d.associatedWithPlayerID=null;d.setAssociatedPlayerID=function(a){d.associatedWithPlayerID=a};d.getMetaPlayerID=function(){return d.associatedWithPlayerID};d.getName=function(){return d.name};d.getAssociatedPlayer=function(){return d.getGame().getPlayerWhoOwnsEntity(d.getName())};d.seppuku=function(){!1!==
d.getAssociatedPlayer()&&d.getAssociatedPlayer().deleteEntity(d.getName())};d.isOwnedByPlayerID=function(a){return d.associatedWithPlayerID===a};d.translateDirection=function(a){var b=0,d=0;if("object"===typeof a&&a instanceof Array)b=a[0],d=a[1];else switch(a){case "n":case "north":b=0;d=-1;break;case "ne":case "northeast":b=1;d=-1;break;case "e":case "east":case "right":b=1;d=0;break;case "se":case "southeast":d=b=1;break;case "s":case "south":b=0;d=1;break;case "sw":case "southwest":b=-1;d=1;break;
case "w":case "west":case "left":b=-1;d=0;break;case "nw":case "northwest":d=b=-1}return[b,d]};d.moves=[];d.addMove=function(a){var b=d.translateDirection(a.direction);d.moves.push({name:a.name,type:a.type,direction:a.direction,xDirection:b[0],yDirection:b[1],frequency:a.frequency,conditions:a.conditions,postMove:a.postMove})};d.countPossibleMoves=function(){return d.moves.length};d.countFieldsWithID=function(a){return d.getWorld().getContentOfFieldsWithFieldID(a).length};d.countOpponentsOnFieldsWithID=
function(a,b){for(var c=d.getWorld().getContentOfFieldsWithFieldID(a),e=0,k,m=c.length;m--;)(k=c[m])&&k.getMetaPlayerID()!==b.getMetaPlayerID()&&(e+=1);return e};d.countOwnOnFieldsWithID=function(a,b){for(var c=d.getWorld().getContentOfFieldsWithFieldID(a),e=0,k,m=c.length;m--;)(k=c[m])&&k.getMetaPlayerID()===b.getMetaPlayerID()&&(e+=1);return e};d.getMove=function(a){return 0<=a&&a<d.countPossibleMoves()?d.moves[a]:!1};d.canMove=function(){var a=d.getMoves();d.getGame().performPostMoveChecks(this,
a);return!_.isEmpty(a)};d.getMoves=function(){var a=d.countPossibleMoves();if(0>=a)return!1;for(var b,c,e,k,m,n,t=[],p=d.getGame(),r=a;r--;)if(a=d.getMove(r),0<a.frequency||"ANY"===a.frequency){c=a.frequency;e=d.position.x;k=d.position.y;"ANY"===c&&(c=23);for(var q=1;q<=c;q+=1){m=e+a.xDirection*q;n=k+a.yDirection*q;if(!1===d.getWorld().isEmpty(m,n))break;p.isLegalMove(d,a.conditions,e,k,m,n)&&(b=p.getUniqueMoveID(d.name,a.name,m,n),t.push({type:"MOVE",name:a.name,entity:d,targetX:m,targetY:n,moveClass:"move_standard",
freq:c,ID:b,postMove:a.postMove}),p.addJobForMoveID({jobID:b,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:d,destX:m,destY:n}}),a.postMove&&_.each(a.postMove,function(a){p.addJobForMoveID({jobID:b,jobName:a.jobName,job:a.jobFunction,jobArguments:a.jobArguments})}))}}else if("DICE"===a.frequency){c=p.getDiceBox().getDiceValues();m=c.length;n=[];q=0;e=-1;var v=!1;e=d.position.x;k=d.position.y;!1===_.isUndefined(d.tmp.fieldID)?(e=d.tmp.fieldID,v=!0):e=d.getWorld().getFieldID(e,k);
for(k=m;k--;)"POSITIVE"===a.direction[1]?q=parseInt(e+c[k],10):"NEGATIVE"===a.direction[1]&&(q=parseInt(e-c[k],10)),"By Field ID"===a.type&&0===d.countOpponentsOnFieldsWithID(q,d)&&(n=d.getWorld().getFreeFieldsWithFieldID(q),n[0]?(m=n[0][0],n=12>=q?n[parseInt(n.length-1,10)][1]:n[0][1],b=p.getUniqueMoveID(d.name,a.name,m,n),t.push({type:"DICE",diceID:k,diceValue:c[k],name:a.name,entity:d,targetX:m,targetY:n,moveClass:"move_standard",freq:"DICE",ID:b,postmove:a.postMove}),!0===v?(p.addJobForMoveID({jobID:b,
jobName:"Put the entity to the destination field",job:"Place Entity",jobArguments:{entity:d,xPosition:m,yPosition:n}}),p.addJobForMoveID({jobID:b,jobName:"Remove the current entity from off board area",job:"Delete Entity from OffBoard",jobArguments:{entity:d}})):p.addJobForMoveID({jobID:b,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:d,destX:m,destY:n}}),p.addJobForMoveID({jobID:b,jobName:"Delete Dice Value",job:"Delete Dice Value",jobArguments:k}),a.postMove&&_.each(a.postMove,
function(a){p.addJobForMoveID({jobID:b,jobName:a.jobName,job:a.jobFunction,jobArguments:a.jobArguments})})):d.countOwnOnFieldsWithID(q,d)===d.countFieldsWithID(q)&&(n=d.getWorld().getFieldsWithFieldID(q),n[0]&&(m=n[0].position.x,n=12>=q?n[0].position.y:n[parseInt(n.length-1,10)].position.y,b=p.getUniqueMoveID(d.name,a.name,m,n),t.push({type:"DICE",diceValue:c[k],name:a.name,entity:d,targetX:m,targetY:n,moveClass:"move_standard",freq:"DICE",ID:b,postmove:a.postMove}),p.addJobForMoveID({jobID:b,jobName:"move game entity",
job:"Move Entity",jobArguments:{entity:d,destX:m,destY:n}}),p.addJobForMoveID({jobID:b,jobName:"Delete Dice Value",job:"Delete Dice Value",jobArguments:k}),a.postMove&&_.each(a.postMove,function(a){p.addJobForMoveID({jobID:b,jobName:a.jobName,job:a.jobFunction,jobArguments:a.jobArguments})}))))}return t};d.canReachGoal=function(){return!_.isEmpty(d.getGoalMoves())};d.canCapture=function(){for(var a=d.getGoalMoves(),b=a.length;b--;)if("CAPTURE"===a[b].type)return!0;return!1};d.canCaptureAt=function(a,
b){var c=d.getGoalMoves(),e,k;for(e=c.length;e--;)if(k=c[e],"CAPTURE"===k.type&&a===k.targetX&&b===k.targetY)return!0;return!1};d.getGoalMoves=function(a){var b,c,e,k=d.countGoals(),m,n;b=null;var t=[],p,r,q,v,u=d.getGame();p=a?a:d.getMoves();m=d.position.x;n=d.position.y;if(!1===u.models.DiceBox.isEnabled){for(q=k;q--;)a=d.getGoal(q),!0===d.executeGoalByName(a.name)&&(b=d.translateDirection(a.move),c=parseInt(m+b[0],10),e=parseInt(n+b[1],10),b=u.getUniqueMoveID(d.name,a.name,c,e),t.push({ID:b,type:a.type,
entity:d,name:a.name,preArrangeX:parseInt(m,10),preArrangeY:parseInt(n,10),targetX:c,targetY:e,moveClass:"move_goal"}));for(v=a=p.length;v--;)if(r=p[v],1<r.freq){u.doVirtualMove(d.position.x,d.position.y,r.targetX,r.targetY);m=r.targetX;n=r.targetY;for(q=k;q--;)a=d.getGoal(q),a.move===r.name&&!0===d.executeGoalByName(a.name)&&(b=d.translateDirection(a.move),c=parseInt(m+b[0],10),e=parseInt(n+b[1],10),b=u.getUniqueMoveID(d.name,a.name,c,e),t.push({ID:b,type:a.type,entity:d,name:a.name,preArrangeX:parseInt(m,
10),preArrangeY:parseInt(n,10),targetX:c,targetY:e,moveClass:"move_goal"}));u.undoVirtualMove()}}else for(p=u.getDiceBox().getDiceValues(),a=p.length,c=0,m=d.getWorld().getFieldID(m,n),!1===_.isUndefined(d.tmp.fieldID)&&(m=d.tmp.fieldID),n=a;n--;)for(q=k;q--;)a=d.getGoal(q),!0===d.executeGoalByName(a.name,p[n])&&("BEAR OFF MOVE"===a.move?(r=a.area,b=u.getUniqueMoveID(d.name,a.name,r,"bearoff"),u.setMoveID(b),u.getDiceBox().connectMoveIDWithDiceValue(b,n,r),t.push({ID:b,type:"DICE",entity:d,name:a.name,
diceID:n,diceValue:p[n],targetArea:r,moveClass:"move_bearoff"}),u.getArea(r).moveID=u.models.moveID):("MOVE POSITIVE"===a.move?c=parseInt(m+p[n],10):"MOVE NEGATIVE"===a.move&&(c=parseInt(m-p[n],10)),r=d.getWorld().getContentOfFieldsWithFieldID(c),b=_.first(r),0===b&&(b=_.last(r)),r={x:b.position.x,y:b.position.y},b=u.getUniqueMoveID(d.name,a.name,r.x,r.y),u.setMoveID(b),u.getDiceBox().connectMoveIDWithDiceValue(b,n,r),t.push({ID:b,name:a.name,entity:d,type:"DICE",diceValue:p[n],diceID:n,targetX:parseInt(r.x,
10),targetY:parseInt(r.y,10),moveClass:"move_goal"})));return t};d.canBeCaptured=function(){for(var a=d.getAssociatedPlayer().getNextOpponentPlayer(),b=a.countEntities(),a=a.getEntities();b--;)if(!0===a[b].canCaptureAt(d.position.x,d.position.y))return!0;return!1};d.goals=[];d.assembleGoal=function(a){d.goals.push(a)};d.getGoal=function(a){return 0<=a&&a<d.goals.length?d.goals[a]:!1};d.countGoals=function(){return d.goals.length};d.executeGoalByName=function(a,b){if(!1===d.enabled)return!1;var c=
d.goals.length,e;for(e=0;e<c;e+=1)if(d.goals[e].name===a){var c=!0,k=0;e=d.goals[e].atoms;for(var m=e.length,k=0;k<m;k+=1)if(c=d.getGame().executeEntityGoalAtomByName(d,e[k],b),!1===c||-1===c)return!1;return!0}return!1};d.goalAtoms=[];d.addGoalAtom=function(a,b,c){d.goalAtoms.push({atomName:a,atomFunction:b,atomArguments:c})}}})();

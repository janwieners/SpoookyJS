Spoooky={};
(function(){Spoooky.Models=function(){this.HighlightTable=[];this.JobQueue=[];this.MovableEntities=[];this.MoveTable=[];this.GoalMoves=[];this.MetaAgents=[];this.Entities=[];this.GameRuleAtoms=[];this.GameRules=[];this.GameRuleConsequences=[];this.EntityGoalConsequences=[];this.GameGrid=[];this.SelectRestrictions={entities:"",moves:""};this.OffBoardContent=[];this.DiceBox={isEnabled:!1,dices:[],diceValues:[],attachedMoveIDs:[]};this.Areas={isEnabled:!1,content:[]};this.Blueprints={};this.gameName="";
this.recentlyMovedEntity=!1;this.gameState="INGAME";this.moveCounter=0;this.currentPlayerID=-1;this.description="";this.lastMoveID=this.moveID=0;this.worldDimensions={rows:0,columns:0};this.playVirtual=this.winnerID=!1;this.playerChange=!0;this.gameMode="MOVING";this.gameRounds=0};Spoooky.Game=function(){var b=this;b.initialize=function(a){b.models=new Spoooky.Models;b.gameWorld=new Spoooky.GridWelt(b);b.setName(a);b.jobQueue=new Spoooky.JobQueue(b);b.diceBox=new Spoooky.DiceBox(b);b.areas=new Spoooky.Areas(b);
b.offBoard=new Spoooky.OffBoard(b);return b};b.setupGridWorld=function(a,d,e){b.gameWorld.setup2D(a,d);b.gameWorld.setupGameBoard(e)};b.connectGridWeltView=function(a){b.viewScope=a};b.statsScope=null;b.connectStatsView=function(a){b.statsScope=a};b.refreshStatsView=function(a){b.statsScope.update(a)};b.graphScope=null;b.connectGraphView=function(a){b.graphScope=a};b.refreshGraphView=function(a,d){b.graphScope.updateGraphs(a,d)};b.evaluateGameState=function(a){var d=0;"END"===b.models.gameState&&
(d=b.models.winnerID===a?1:!1===b.models.winnerID?.5:0);return d};b.stringifyModels=function(){return JSON.stringify(b.models)};b.clone=function(a){var d=new Spoooky.Game;d.initialize("COPY");d.models=a?JSON.parse(a):JSON.parse(b.stringifyModels());var e,c;a=d.models;e=d.models.MetaAgents.length;for(var f,g,h;e--;)c=new Spoooky.MetaAgent(d),_.extend(c,a.MetaAgents[e]),a.MetaAgents[e]=c;for(e=a.Entities.length;e--;)for(c=a.Entities[e],h=c.length;h--;)g=c[h],f=new Spoooky.Entity(g.name,g.ID,g.typeID,
d),_.extend(f,g),a.Entities[e][h]=f;d.models.playVirtual=!0;d.setName("GAME_COPY");return d};b.flush=function(a){a.length=0};b.setWinnerID=function(a){b.models.winnerID=a};b.getWinnerID=function(){return b.models.winnerID};b.jobQueue=null;b.MovableEntities=null;b.areas=null;b.addArea=function(a){null===b.areas&&(b.areas=new Spoooky.Areas);b.areas.addArea(a)};b.getArea=function(a){return b.areas.getArea(a)};b.addBlueprint=function(a,d,e){b.models.Blueprints[d.entityType]=_.clone(d);a&&a.associateEntity(b.models.Blueprints[d.entityType],
e);return b.models.Blueprints[d.entityType]};b.extendBlueprint=function(a,d){_.extend(a,d)};b.getBlueprints=function(){return b.models.Blueprints};b.getBlueprint=function(a){return b.getBlueprints()[a]};b.setRecentlyMovedEntity=function(a,d){var e=b.gameWorld.peekCell(a,d),c="default";b.isGoalMove(a,d)&&(c="capture");e?(b.models.recentlyMovedEntity={entityID:e.ID,playerID:e.getMetaPlayerID()},e.addExecutedMove(a,d,b.models.moveCounter,c)):b.models.recentlyMovedEntity=!1};b.getrecentlyMovedEntity=
function(){if(b.models.recentlyMovedEntity){var a=b.models.recentlyMovedEntity;return b.getPlayerWithID(a.playerID).getEntityWithID(a.entityID)}return!1};b.addDice=function(a,d){b.getDiceBox().enable();b.getDiceBox().createDice(a,d)};b.diceBox=null;b.getDiceBox=function(){return b.diceBox};b.offBoard=null;b.setName=function(a){b.models.gameName=a?a:""};b.getName=function(){return b.models.gameName};b.setDescription=function(a){b.models.description=a};b.getDescription=function(){return b.models.description};
b.setMoveID=function(a){b.models.moveID=a};b.setLastMoveID=function(){b.models.lastMoveID=b.models.moveID};b.getLastMoveID=function(){return b.models.lastMoveID};b.gameWorld=null;b.getGameWorld=function(){return b.gameWorld};b.loop=function(a,d,e){var c=!1;if("END"!==b.models.gameState)switch(b.models.gameMode){case "MOVING":(c=a?b.areas.isMove(a):b.isMove(d,e))?(a?b.executeJobsForMoveID(b.areas.getMoveID(a)):b.executeJobsForThisMove(d,e),b.executeGameRules()?b.executeJobsForRecentMove():b.proceed()):
b.showEntityMoves(d,e);break;case "PLACING":if(b.showFieldsToPlaceEntity(),c=b.isMove(d,e))b.executeJobsForThisMove(d,e),b.executeGameRules()?b.executeJobsForRecentMove():(b.proceed(),b.showFieldsToPlaceEntity())}b.playArtificial()};b.playArtificial=function(){!1===b.models.playVirtual&&"ARTIFICIAL"===b.getCurrentPlayerType()&&"END"!==b.models.gameState&&b.artificialTurn()};b.pseudoLoop=function(){b.loop(!1,null,null)};b.proceed=function(){!0===b.models.playerChange&&(b.setNextPlayer(),b.setGameState("INGAME"));
b.resetMoves()};b.setGameMode=function(a){b.models.gameMode=a};b.checkGoalMove=function(a,d){b.isGoalMove(a,d)};b.setGameState=function(a){b.models.gameState=a};b.getGameState=function(){return b.models.gameState};b.addPlayer=function(a){b.models.Entities[a.ID]=[];b.models.MetaAgents.push(a);1===b.models.MetaAgents.length&&b.setPlayer(a)};b.createPlayer=function(a){var d=new Spoooky.MetaAgent(b);d.setID(b.models.MetaAgents.length);a&&(d.setName(a.name),d.setType(a.type));"ARTIFICIAL"===d.type&&d.assembleAgents();
b.addPlayer(d);return d};b.setCurrentPlayerID=function(a){b.models.currentPlayerID=a};b.setPlayer=function(a){b.setCurrentPlayerID(a.ID)};b.getCurrentPlayerID=function(){return b.models.currentPlayerID};b.getNextPlayerID=function(){var a=b.getCurrentPlayerID();return a<b.models.MetaAgents.length-1?a+1:0};b.getCurrentPlayerName=function(){return b.getCurrentPlayer().getName()};b.getCurrentPlayerType=function(){return b.getPlayerWithID(b.getCurrentPlayerID()).type};b.setNextPlayer=function(){var a=
b.getCurrentPlayerID();a<b.models.MetaAgents.length-1?b.setCurrentPlayerID(a+1):b.setCurrentPlayerID(0);b.resetMoves();b.models.gameRounds++};b.getPlayerWithID=function(a){return b.models.MetaAgents[a]};b.getPlayerWhoOwnsEntity=function(a){for(var d=b.getPlayers(),e=d.length,c=0;c<e;c+=1)if(!0===d[c].hasEntity(a))return d[c];return!1};b.informArtificialPlayersAboutGameEnd=function(){for(var a=b.getPlayers(),d=a.length;d--;)"ARTIFICIAL"===a[d].type&&a[d].gameHasEnded()};b.getPlayers=function(){return b.models.MetaAgents};
b.getAIPlayers=function(){var a=b.models.MetaAgents,d=[],e;for(e=0;e<a.length;e++)"ARTIFICIAL"===a[e].type&&d.push(a[e]);return d};b.getCurrentPlayer=function(){return b.getPlayerWithID(b.getCurrentPlayerID())};b.assembleGameRule=function(a){b.models.GameRules.push(a)};b.getGameRule=function(a){return 0<=a&&a<b.models.GameRules.length?b.models.GameRules[a]:!1};b.countGameRules=function(){return b.models.GameRules.length};b.executeGameRuleByName=function(a){for(var d=b.models.GameRules.length,e=!1,
c=0,f=0,c=0;c<d;c+=1)if(b.models.GameRules[c].name===a){e=!0;c=b.models.GameRules[c].atoms;f=c.length;for(a=0;a<f;a+=1)if(e=b.executeGameRuleAtomByName(c[a]),!1===e||-1===e)return!1;return e}return!1};b.addGameRuleAtom=function(a){b.models.GameRuleAtoms.push({atomName:a.atomName,atomFunction:a.atomFunction,atomArguments:a.atomArguments,atomCondition:a.atomCondition,atomConnector:a.atomConnector})};b.entityAtomFunctions={"Is Opponent":function(a,d){var e=a.translateDirection(d.atomArguments),c=parseInt(a.position.x+
e[0],10),e=parseInt(a.position.y+e[1],10);return a.isOpponent(c,e)},"Is Empty Cell":function(a,d){var e=a.translateDirection(d.atomArguments),c=parseInt(a.position.x+e[0],10),e=parseInt(a.position.y+e[1],10);return a.isEmptyCell(c,e)},"Current Y Position Is":function(a,d){return a.position.y===d.atomArguments},"Current X Position Is":function(a,d){return a.position.x===d.atomArguments},"Entity Is Able To Reach A Specific Row":function(a,d){var e=d.atomArguments[0];"last"===e?e=parseInt(b.gameWorld.getRows()-
1,10):"first"===e&&(e=0);var c=a.translateDirection(d.atomArguments[1]),f=parseInt(a.position.x+c[0],10),c=parseInt(a.position.y+c[1],10);return!1===b.gameWorld.isEmpty(f,c)?!1:e===c},"Entity At Cell Is Of Type":function(a,d){var e=a.translateDirection(d.atomArguments),c=parseInt(a.position.x+e[0],10),e=parseInt(a.position.y+e[1],10),c=a.getGame().gameWorld.peekCell(c,e);return!1!==c&&c.type===d.atomArguments[2]?!0:!1},"Entity At Cell Has Been Moved n Times":function(a,d){var e=a.translateDirection(d.atomArguments),
c=parseInt(a.position.x+e[0],10),e=parseInt(a.position.y+e[1],10),c=a.getGame().gameWorld.peekCell(c,e);return!1!==c&&c.getMoveCount()===d.atomArguments[2]?!0:!1},"Entity At Cell Has Been Moved In Last Game Round":function(a,d){var e=a.translateDirection(d.atomArguments),c=parseInt(a.position.x+e[0],10),e=parseInt(a.position.y+e[1],10),c=a.getGame().gameWorld.peekCell(c,e);return!1!==c&&c.getLastExecutedMove().round===a.getGame().models.moveCounter?!0:!1},"Is Not Attackable In Next Round":function(a,
d){var e=a.translateDirection(d.atomArguments),c=parseInt(a.position.x+e[0],10),e=parseInt(a.position.y+e[1],10);return!a.getGame().opponentEntityCanCaptureAt(c,e,a)},"Number Of Opponents At Destination Field Is":function(a,d,e){var c=0,b=a.position.x,g=a.position.y,h=d.atomArguments[0];d=d.atomArguments[1];b=a.getGame().gameWorld.getFieldID(b,g);!1===_.isUndefined(a.tmp.fieldID)&&(b=a.tmp.fieldID);"MOVE POSITIVE"===h?c=parseInt(b+e,10):"MOVE NEGATIVE"===h&&(c=parseInt(b-e,10));return a.countOpponentsOnFieldsWithID(c,
a)===d},"No Own Entitys On Fields With ID Less Than":function(a,d){var e=d.atomArguments;return!a.getAssociatedPlayer().hasEntitiesOnFieldWithFieldID(e,"<")},"No Own Entitys On Fields With ID More Than":function(a,d){var e=d.atomArguments;return!a.getAssociatedPlayer().hasEntitiesOnFieldWithFieldID(e,">")},"Destination Field ID Is Greater Than":function(a,d,e){var c=0,b=a.position.x,g=a.position.y,h=d.atomArguments[0],b=a.getGame().gameWorld.getFieldID(b,g);if(!1===_.isUndefined(a.tmp.fieldID))return!1;
"MOVE POSITIVE"===h?c=parseInt(b+e,10):"MOVE NEGATIVE"===h&&(c=parseInt(b-e,10));return c>d.atomArguments[1]},"Destination Field ID Is Less Than":function(a,d,e){if(!1===_.isUndefined(a.tmp.fieldID))return!1;var c=0,b=a.position.x,g=a.position.y,h=d.atomArguments[0];a=a.getGame().gameWorld.getFieldID(b,g);"MOVE POSITIVE"===h?c=parseInt(a+e,10):"MOVE NEGATIVE"===h&&(c=parseInt(a-e,10));return c<d.atomArguments[1]}};b.executeEntityGoalAtomByName=function(a,d,e){if(!1===a.enabled)return!1;var c=a.goalAtoms.length,
f;for(f=0;f<c;f+=1)if(a.goalAtoms[f].atomName===d)return d=a.goalAtoms[f],b.entityAtomFunctions[d.atomFunction](a,d,e);return!1};b.gameRuleAtoms={"Last Move Was Capture Move":function(){if(b.getrecentlyMovedEntity())return"capture"===b.getrecentlyMovedEntity().getLastExecutedMove().type},"Recently Moved Entity Can Capture An Opponent Entity":function(){if(b.getrecentlyMovedEntity())return b.getrecentlyMovedEntity().canCapture()},"Recently Moved Entity Can Not Capture An Opponent Entity":function(){if(b.getrecentlyMovedEntity())return!b.getrecentlyMovedEntity().canCapture()},
"Recently Moved Entity Is Owned By Player":function(a){if(b.getrecentlyMovedEntity())return b.getrecentlyMovedEntity().getMetaPlayerID()===a.atomArguments},"Recently Moved Entity Is At YPosition":function(a){a=a.atomArguments;"last"===a?a=parseInt(b.gameWorld.getRows()-1,10):"first"===a&&(a=0);if(!1!==b.getrecentlyMovedEntity())return b.getrecentlyMovedEntity().getPosition().y===a},"Recently Moved Entity Is At XPosition":function(a){a=a.atomArguments;"last"===a&&(a=b.gameWorld.getColumns()-1);if(!1!==
b.getrecentlyMovedEntity())return b.getrecentlyMovedEntity().getPosition().x===a},"Recently Moved Entity Is Type":function(a){var d=a.atomArguments,e=b.getrecentlyMovedEntity(),c=0;a=a.atomConnector;var f=0;if(0!==e)switch(c=e.type,a){case "OR":for(f=e=d.length;f--;)if(c===d[f])return!0;return!1;case "AND":for(f=e=d.length;f--;)if(c!==d[f])return!1;return!0;default:return c===d}},"Player Has Entities":function(a){return 0!==b.getPlayerWithID(a.atomArguments).countEntities()},"All players have placed their entities on the game board":function(){for(var a=
b.getPlayers(),d,e,c=a.length;c--;)for(d=a[c].getEntities(),e=d.length;e--;)if(!d[e].onBoard)return!1;return!0},"Player Has Entities On Nearby Connected Fields After Last Move":function(a){a=a.atomArguments;for(var d=b.gameWorld,e,c=b.getrecentlyMovedEntity().position,f,g,h,l=b.models.recentlyMovedEntity.playerID,k=b.models.GameGrid[c.y][c.x].cellID,m=a.length;m--;)for(f=a[m],g=f.length;g--;)if(e=f[g],c=!0,k===e){for(h=f.length;h--;)if(e=d.getFieldsWithFieldID(f[h],!0),0<e.contains.length){if(e.contains[0].playerID!==
l){c=!1;break}}else{c=!1;break}if(c)return!0}return!1},"Player Has No Movable Entities":function(a){a=b.getPlayerWithID(a.atomArguments);var d=a.countEntities(),e;if(0===d)return!0;for(e=d;e--;)if(!0===b.checkSelectCondition(a.getEntityFromArray(e))&&a.getEntityFromArray(e).canMove())return!1;for(e=d;e--;)if(!0===b.checkSelectCondition(a.getEntityFromArray(e))&&a.getEntityFromArray(e).canReachGoal())return!1;return!0},"Player Has Entities In Off Board Area":function(a){return b.offBoard.entitiesOfPlayerAreOutside(a.atomArguments)},
"Player Has No Entities In Off Board Area":function(a){return!b.offBoard.entitiesOfPlayerAreOutside(a.atomArguments)},"Player Has No Entities":function(a){return 0===b.getPlayerWithID(a.atomArguments).countEntities()},"Player Has Number Of Entities":function(a){return b.getPlayerWithID(a.atomArguments[0]).countEntities()===a.atomArguments[1]},"Player Has No Entity Which Satisfies Goals":function(a){a=b.getPlayerWithID(a.atomArguments);var d=a.countEntities();if(0===d)return!0;for(;d--;)if(!_.isEmpty(a.getEntityFromArray(d).canReachGoal()))return!1;
return!0},"Player Has Number Of Entities In Row":function(a){var d=a.atomArguments.entityID;a=a.atomArguments.number;var e=b.gameWorld.createBoardSignature();return(new RegExp(d+"{"+a+"}")).test(e)},"Player Has Number Of Entities In Column":function(a){var d=a.atomArguments.entityID;a=a.atomArguments.number;var e=b.gameWorld.createBoardSignatureByVertical();return(new RegExp(d+"{"+a+"}")).test(e)},"Player Has Number Of Entities Diagonally":function(a){var d="",d=b.gameWorld,e=d.getRows(),c=d.getColumns();
a=new RegExp(a.atomArguments.entityID+"{"+a.atomArguments.number+"}");var f=b.gameWorld.createBoardSignature(),g,h;for(g=0;g<c;g++){d="";for(h=g;h<f.length&&"|"!==f[h];h+=c+2)d+=f[h];if(!0===a.test(d))return!0}for(g=1;g<e;g++){d="";for(h=g*c+g;h<f.length&&"|"!==f[h];h+=c+2)d+=f[h];if(!0===a.test(d))return!0}for(g=1;g<e;g++){d="";for(h=g*c+g;0<h&&"|"!==f[h];h-=c)d+=f[h];if(!0===a.test(d))return!0}for(g=3;g<=c;g++){d="";for(h=e*c+e-g;0<h&&"|"!==f[h];h-=c)d+=f[h];if(!0===a.test(d))return!0}return!1},
"No Empty Field On The Game Board":function(){return 0===b.gameWorld.getFreeCells().length},"Current Player Is":function(a){return b.getPlayerWithID(a.atomArguments).ID===b.getCurrentPlayerID()},"Print Debug Message":function(a){return!0},"Game State Is":function(a){return a.atomArguments===b.models.gameState},"Dice Box Is Empty":function(){return b.getDiceBox().gotNoDiceValues()},"Entity Is Under Attack":function(a){return b.entityOfSpecificTypeIsUnderAttack(a.atomArguments)},"Got No Protecting Entities":function(a){return!b.identifyProtectingEntities(a.atomArguments.entityType)},
"Every Entity Of Player Is In Target Area":function(a){var d=b.getPlayerWithID(a.atomArguments.player),e=d.countEntities();a=a.atomArguments.targetArea;var c=a.length,f,g,h=!1;if(0===e)return!1;for(f=0;f<c;f+=1){h=!1;for(g=0;g<e;g+=1)d.getEntityFromArray(g).position.x===a[f].x&&d.getEntityFromArray(g).position.y===a[f].y&&(h=!0);if(!1===h)return!1}return!0}};b.executeGameRuleAtomByName=function(a){var d;for(d=b.models.GameRuleAtoms.length;d--;)if(b.models.GameRuleAtoms[d].atomName===a)return a=b.models.GameRuleAtoms[d],
b.gameRuleAtoms[a.atomFunction](a);return!1};b.connectGameRuleConsequences=function(a){for(var d=a.ruleName,e="",c="",f=a.consequences,g=f.length;g--;)f[g].execute="immediately";a.entityName&&(e=a.entityName);a.entityType&&(c=a.entityType);b.models.GameRuleConsequences.push({goalName:d,entityName:e,entityType:c,consequences:f})};b.getGameRuleConsequencesWithName=function(a){for(var d=[],e,c=b.models.GameRuleConsequences,f=c.length;f--;)e=c[f],e.goalName===a&&(e.entityName&&!1!==b.getrecentlyMovedEntity()&&
(e.entityName=b.getrecentlyMovedEntity().getName()),e.entityType&&!1!==b.getrecentlyMovedEntity()&&(e.entityType=b.getrecentlyMovedEntity().type),e.consequences.entityLink=b.getrecentlyMovedEntity(),d.push(e));d.reverse();return d};b.executeGameRuleConsequences=function(a){a=b.getGameRuleConsequencesWithName(a);for(var d=a.length,e=0;e<d;e+=1)b.addJobs(a[e].consequences)};b.executeGameRules=function(){b.resetRestrictions();var a,d,e=b.countGameRules(),c=!1;for(a=0;a<e;a++)d=b.getGameRule(a),!0===
b.executeGameRuleByName(d.name)&&(b.executeGameRuleConsequences(d.name),c=!0);return c};b.getUniqueMoveID=function(a,d,e,c){return a+"_"+d+"_"+e+"|"+c};b.moveEntity=function(a,d,e,c,f){b.gameWorld.moveEntity(a,d,e,c,f)};b.deleteEntityAt=function(a,d){b.gameWorld.deleteCellContent(a,d)};b.countFieldsWithID=function(a){return b.gameWorld.getContentOfFieldsWithFieldID(a).length};b.countOwnOnFieldsWithID=function(a,d){var e=b.gameWorld.getContentOfFieldsWithFieldID(a),c,f=0,g=0,h=e.length;for(c=0;c<h;c+=
1)(g=e[c])&&g.getMetaPlayerID()===d.getMetaPlayerID()&&(f+=1);return f};b.countOpponentsOnFieldsWithID=function(a,d){var e=b.gameWorld.getContentOfFieldsWithFieldID(a),c,f=0,g=0,h=e.length;for(c=0;c<h;c+=1)(g=e[c])&&g.getMetaPlayerID()!==d.getMetaPlayerID()&&(f+=1);return f};b.resetRestrictions=function(){b.models.SelectRestrictions.entities="";b.models.SelectRestrictions.moves=""};b.checkSelectCondition=function(a){if("Recently Moved Entity"===b.models.SelectRestrictions.entities)return b.getrecentlyMovedEntity().getName()===
a.getName();if(!_.isUndefined(a.selectCondition)){if("Only Off Board Entities"===b.models.SelectRestrictions.entities)return null!==a.position.x&&null!==a.position.y?!1:!0;var d=a.selectCondition,e=!1;if(d.neighboursY){var c,f=0,g={"<":function(a,d){return a<d},"<=":function(a,d){return a<=d},">":function(a,d){return a>d},">=":function(a,d){return a>=d},"==":function(a,d){return a==d}},h;for(c=d.neighboursY.length;c--;)switch(h=d.neighboursY[c],f=h.appliesTo,f.axis){case "y":if(g[f.operator](a.position.y,
f.value)){var f=h.count,l=h.condition,k=0;switch(h.direction){case "NORTH":k=b.gameWorld.countNeighboursNorth(a);break;case "SOUTH":k=b.gameWorld.countNeighboursSouth(a);break;default:k=b.gameWorld.countNeighboursY(a)}switch(l){case "LESS THAN OR EQUAL TO":case "<=":k<=f&&(e=!0);break;case "LESS THAN":case "<":k<f&&(e=!0);break;case "MORE THAN OR EQUAL TO":case ">=":k>=f&&(e=!0);break;case "MORE THAN":case ">":k>f&&(e=!0);break;case "EQUAL":case "=":case "==":case "===":k===f&&(e=!0)}}}}return e}return!0};
b.showEntityMoves=function(a,d){var e=b.gameWorld.peekCell(a,d);if(!1===e||_.isUndefined(e))return!1;if(b.isHighlighted(e))return b.resetMoves(),!1;if(e.getMetaPlayerID()!==b.getCurrentPlayerID())return!1;if(!0===b.checkSelectCondition(e)){b.resetMoves();var c,f;switch(b.models.SelectRestrictions.moves){case "Standard Moves":c=e.getMoves();break;case "Capture Moves":f=e.getGoalMoves(c);break;default:c=e.getMoves(),f=e.getGoalMoves(c)}b.performPostMoveChecks(e,c);b.performPostMoveChecks(e,f);_.isEmpty(c)&&
_.isEmpty(f)||b.highlightEntityAtPosition(a,d);b.highlightStandardMoves(c);b.highlightGoalMoves(f)}return!0};b.showFieldsToPlaceEntity=function(){"PLACING"===b.models.gameMode&&b.highlightStandardMoves(b.getCurrentPlayer().getAllEntityMoves())};b.highlightStandardMoves=function(a){if(!_.isUndefined(a))for(var d,e=a.length;e--;)d=a[e],b.highlightCell(d.targetX,d.targetY,d.moveClass,d.ID),b.models.MoveTable.push({entity:d.entity,xPosition:d.targetX,yPosition:d.targetY,moveClass:d.moveClass,moveID:d.ID})};
b.highlightGoalMoves=function(a){if(!_.isUndefined(a))for(var d,e,c=a.length;c--;)switch(d=a[c],d.type){case "DICE":"move_bearoff"===d.moveClass?b.executeGoalConsequences(d.name,d.entity,!1):(e=d.entity,b.setMoveID(b.getDiceBox().getMoveIDForDiceID(d.diceID)),e.setTarget(d.targetX,d.targetY),b.executeGoalConsequences(d.name,e,!1),e.unsetTarget());break;case "PUT":break;default:e=d.entity;var f=[],g=e.position.x,h=e.position.y;f.x=g;f.y=h;b.doVirtualMove(g,h,d.preArrangeX,d.preArrangeY);b.executeGoalConsequences(d.name,
e,f);b.undoVirtualMove()}};b.performPostMoveChecks=function(a,d){if(null!==a.postMoveCheck)for(var e,c,f,g=a.postMoveCheck,h=0;h<d.length;h++)for(f=0;f<g.length;f++)e=g[f],"Entity Is Attackable After Move"===e.condition&&(c=d[h].entity,b.doVirtualMove(c.position.x,c.position.y,d[h].targetX,d[h].targetY),b.entityOfTypeIsUnderAttack(e.entity,c.getAssociatedPlayer())&&(d.splice(h,1),--h),b.undoVirtualMove())};b.resetMoves=function(){var a=b.gameWorld,d,e,c=b.models.MoveTable,f=b.models.HighlightTable;
for(e=c.length;e--;)d=c[e],a.setCellClass(d.xPosition,d.yPosition,"");b.models.MoveTable.length=0;b.models.GoalMoves.length=0;b.models.MovableEntities.length=0;for(e=f.length;e--;)d=f[e],a.setCellClass(d.x,d.y,"");b.flush(b.models.HighlightTable);null!==b.areas&&b.areas.isEnabled()&&b.areas.resetDisplays();null!==b.getDiceBox()&&b.getDiceBox().flushAttachedMoveIDs()};b.isHighlighted=function(a){var d=b.models.HighlightTable,e=d.length,c,f=a.position.x,g=a.position.y;for(a=0;a<e;a+=1)if(c=d[a],c.x===
f&&c.y===g)return!0;return!1};b.highlightEntityAtPosition=function(a,d){b.gameWorld.isValidCoordinate(a,d)&&(b.models.HighlightTable.push({x:a,y:d}),b.gameWorld.setCellClass(a,d,"clickedEntity"))};b.highlightCell=function(a,d,e,c){b.gameWorld.setCellClass(a,d,e);b.models.HighlightTable.push({x:a,y:d});"move_goal"===e&&(b.models.MoveTable.push({entity:null,xPosition:a,yPosition:d,moveClass:e,moveID:c}),b.models.GoalMoves.push({entity:null,xPosition:a,yPosition:d}))};b.virtualMove=[];b.doVirtualMove=
function(a,d,e,c){var f=b.gameWorld;a={srcX:a,srcY:d,srcEntity:f.popFromCell(a,d),destX:e,destY:c,destEntity:f.popFromCell(e,c)};b.virtualMove.push(a);a.destEntity&&null!==a.destEntity&&a.destEntity.setPosition(null,null);a.srcEntity&&(a=a.srcEntity,f.pushToCell({entityID:a.ID,playerID:a.getMetaPlayerID(),typeID:a.getTypeID()},e,c),a.setPosition(e,c,!0))};b.undoVirtualMove=function(){var a=b.virtualMove.pop();if(!a)return!1;var d=a.srcEntity;d&&null!==d&&(b.gameWorld.popFromCell(a.destX,a.destY),
d.setPosition(a.srcX,a.srcY),b.gameWorld.pushToCell({entityID:d.ID,playerID:d.getMetaPlayerID(),typeID:d.getTypeID()},a.srcX,a.srcY));(d=a.destEntity)&&null!==d&&(d.setPosition(a.destX,a.destY),b.gameWorld.pushToCell({entityID:d.ID,playerID:d.getMetaPlayerID(),typeID:d.getTypeID()},a.destX,a.destY));return!0};b.moveConditions={"Is Empty":function(a,d){return b.gameWorld.isEmpty(a._destX,a._destY)!==d?!1:!0},"Is Empty At":function(a,d,e){return!b.gameWorld.isEmpty(parseInt(a._curX+a._conditions[e].relativeCoordinate[0],
10),parseInt(a._curY+a._conditions[e].relativeCoordinate[1],10))===d?!1:!0},"Is Not The Last Row":function(a){return a._destY===parseInt(b.gameWorld.getRows()-1,10)?!1:!0},"Is Not The First Row":function(a){return 0===a._destY?!1:!0},"Move Count":function(a,d,e){return a._currentEntity.getMoveCount()!==a._conditions[e].value?!1:!0},"Move Count Of Entity":function(a,d,e){d=b.getCurrentPlayer().getEntityWithName(a._conditions[e].entityName);return!1===d||d.getMoveCount()!==a._conditions[e].value?!1:
!0},"Game State":function(a,d,e){return b.models.gameState===a._conditions[e].value&&!0===d?!0:b.models.gameState!==a._conditions[e].value&&!1===d?!0:!1},"Field Is Attackable By Opponent Entity":function(a,d,e){var c=parseInt(a._curX+a._conditions[e].relativeCoordinate[0],10);e=parseInt(a._curY+a._conditions[e].relativeCoordinate[1],10);b.doVirtualMove(a._curX,a._curY,c,e);if(d===b.opponentEntityCanCaptureAt(c,e,a._currentEntity))return b.undoVirtualMove(),!0;b.undoVirtualMove();return!1},"Target Field Is Reachable By Opponent Entity":function(a,
d,e){d=b.getCurrentPlayer().getNextOpponentPlayer().getEntitiesOfType(a._conditions[e].opponentEntity);e=d.length;if(0!==e){var c,f,g,h;f=null;for(var l,k=e;k--;)for(e=d[k],g=e.position.x,h=e.position.y,c=e.countGoals();c--;)if(f=e.getGoal(c),f=e.translateDirection(f.move),l=parseInt(g+f[0],10),f=parseInt(h+f[1],10),l===a._destX&&f===a._destY)return!1}return!0},yPosition:function(a,d,e){return a._curY===a._conditions[e].value&&!0===d?!0:!1},xPosition:function(a,d,e){return a._curX===a._conditions[e].value&&
!0===d?!0:!1}};b.isLegalMove=function(a,d,e,c,f,g){if(!1===b.gameWorld.isValidCoordinate(f,g))return!1;var h;h=d.length;e={_currentEntity:a,_conditions:d,_curX:e,_curY:c,_destX:f,_destY:g};for(a=0;a<h;a+=1)if(!1===b.moveConditions[d[a].condition](e,d[a].state,a))return!1;return!0};b.viewScope=null;b.refreshView=function(){b.models.playVirtual||b.viewScope.$apply()};b.executeRandomMove=function(){var a=b.getCurrentPlayer().getAllEntityMoves(),a=a[_.random(0,parseInt(a.length-1,10))];b.executeMove(a)};
b.executeArtificialMove=function(a){if("random"===a)return b.executeRandomMove(),!0;a=b.getCurrentPlayer().getAllEntityMoves()[a.moveIndex];b.executeMove(a);return!0};b.executeMove=function(a){if("END"===b.models.gameState)return!1;var d=!1,e,c;if("move_goal"===a.moveClass||"move_bearoff"===a.moveClass)if(e=a.entity,"DICE"===a.type)"move_bearoff"===a.moveClass?(b.executeGoalConsequences(a.name,e,!1),d=a.targetArea):(b.setMoveID(b.getDiceBox().getMoveIDForDiceID(a.diceID)),e.setTarget(a.targetX,a.targetY),
b.executeGoalConsequences(a.name,e,!1),e.unsetTarget());else{var f=[];c=e.position;f.x=c.x;f.y=c.y;b.doVirtualMove(c.x,c.y,a.preArrangeX,a.preArrangeY);b.executeGoalConsequences(a.name,e,f);b.undoVirtualMove();a.targetX=b.models.HighlightTable[0].x;a.targetY=b.models.HighlightTable[0].y}else{c=a.entity.position;b.models.MoveTable.push({entity:a.entity,xPosition:a.targetX,yPosition:a.targetY,moveClass:a.moveClass,moveID:a.ID});if("DICE"===a.type){var f=!1,g=a.targetX,h=a.targetY;e=a.entity;c=e.position;
!1===_.isUndefined(e.tmp.fieldID)?f=!0:e.getWorld().getFieldID(c.x,c.y);!0===f?(b.addJobForMoveID({jobID:a.ID,jobName:"Put the entity to the destination field",job:"Place Entity",jobArguments:{entity:e,xPosition:g,yPosition:h}}),b.addJobForMoveID({jobID:a.ID,jobName:"Remove the current entity from off board area",job:"Delete Entity from OffBoard",jobArguments:{entity:e}})):b.addJobForMoveID({jobID:a.ID,jobName:"move game entity",job:"Move Entity By Dice Value",jobArguments:{entity:a.entity,destX:a.targetX,
destY:a.targetY,diceValue:a.diceValue}});b.addJobForMoveID({jobID:a.ID,jobName:"Delete Dice Value",job:"Delete Dice Value",jobArguments:a.diceID})}else"PLACING"!==b.models.gameMode&&b.addJobForMoveID({jobID:a.ID,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:a.entity,destX:a.targetX,destY:a.targetY}});a.postMove&&_.each(a.postMove,function(d){b.addJobForMoveID({jobID:a.ID,jobName:d.jobName,job:d.jobFunction,jobArguments:d.jobArguments})})}b.loop(d,a.targetX,a.targetY);b.refreshView();
return!0};b.artificialTurn=function(){if("WAITINGFORDICEROLL"===b.models.gameState&&(Spoooky.GameEvents.fireEvent({job:"Roll Backgammon Dices"},b),"WAITINGFORDICEROLL"===b.models.gameState))return b.pseudoLoop(),!1;b.getCurrentPlayer().artificialMove();return!0};b.addJobs=function(a){for(var d,e,c=0;c<a.length;c++)e=a[c],d={jobID:b.models.moveID,jobName:e.jobName,job:e.jobFunction,jobArguments:e.jobArguments,entityLink:a.entityLink},e.execute&&"immediately"===e.execute?Spoooky.GameEvents.fireEvent(d,
b):b.addJobForMoveID(d);b.models.moveID=0;return!0};b.addJobForMoveID=function(a){a.execute&&"immediately"===a.execute?Spoooky.GameEvents.fireEvent(a,b):b.jobQueue.addJob(a);return!0};b.isMove=function(a,d){for(var e=b.models.MoveTable,c,f=e.length;f--;)if(c=e[f],c.xPosition===a&&c.yPosition===d&&0!==c.moveID)return!0;return b.isGoalMove(a,d)};b.isGoalMove=function(a,d){for(var e=b.models.GoalMoves,c=e.length;c--;)if(e[c].xPosition===a&&e[c].yPosition===d)return!0;return!1};b.getMoveID=function(a,
d){for(var e=b.models.MoveTable,c,f=e.length;f--;)if(c=e[f],c.xPosition===a&&c.yPosition===d&&0!==c.moveID)return c.moveID;return!1};b.executeJobsForThisMove=function(a,d){b.executeJobsForMoveID(b.getMoveID(a,d));b.setRecentlyMovedEntity(a,d)};b.executeJobsForRecentMove=function(){b.resetMoves();b.executeJobsForMoveID(b.getLastMoveID())};b.executeJobsForMoveID=function(a){a=b.jobQueue.getJobsWithMoveID(a);for(var d=0;d<a.length;d+=1)Spoooky.GameEvents.fireEvent(a[d],b);b.jobQueue.flush();b.models.moveID=
0};b.getEntityAtCell=function(a,d){return b.gameWorld.peekCell(a,d)};b.getEntityWithName=function(a){for(var d=b.getPlayers(),e,c=d.length;c--;)if(e=d[c].getEntityWithName(a),!1!==e)return e;return!1};b.pushEntityToCell=function(a,d,e){a.setPosition(d,e);b.gameWorld.pushToCell({entityID:a.ID,playerID:a.getMetaPlayerID(),typeID:a.getTypeID()},d,e)};b.identifyProtectingEntities=function(a){for(var d=b.getCurrentPlayer(),e,c,f,g=!1,h,l,k,m,n=d.countEntities();n--;){e=d.getEntityFromArray(n);h=e.getMoves();
l=e.getGoalMoves();b.performPostMoveChecks(e,h);b.performPostMoveChecks(e,l);k=e.position.x;m=e.position.y;for(c=h.length;c--;)f=h[c],b.doVirtualMove(k,m,f.targetX,f.targetY),b.entityOfTypeIsUnderAttack(a,e.getAssociatedPlayer())||(b.models.MovableEntities.push(e),b.highlightEntityAtPosition(k,m),g=!0),b.undoVirtualMove();for(c=l.length;c--;)f=l[c],b.doVirtualMove(k,m,f.targetX,f.targetY),b.entityOfTypeIsUnderAttack(a,e.getAssociatedPlayer())||(b.models.MovableEntities.push(e),b.highlightEntityAtPosition(k,
k),g=!0),b.undoVirtualMove()}return g};b.opponentEntityCanCaptureAt=function(a,d,e){var c=e.getAssociatedPlayer().getNextOpponentPlayer(),f;b.doVirtualMove(e.position.x,e.position.y,a,d);for(var g=c.countEntities();g--;)for(e=c.getEntityFromArray(g).getGoalMoves(),f=e.length;f--;)if("CAPTURE"===e[f].type&&a===e[f].targetX&&d===e[f].targetY)return b.undoVirtualMove(),!0;b.models.GoalMoves.length=0;b.undoVirtualMove();return!1};b.connectEntityActionsConsequences=function(a){var d=a.goalName,e=a.consequences,
c="",f="";a.entityName&&(c=a.entityName);a.entityType&&(f=a.entityType);b.models.EntityGoalConsequences.push({goalName:d,entityName:c,entityType:f,consequences:e})};b.connectConsequences=function(a){for(var d=_.keys(a),e=d.length,c=0;c<e;++c)b.connectEntityActionsConsequences(a[d[c]])};b.getGoalConsequencesWithName=function(a,d){for(var e=[],c,f=b.models.EntityGoalConsequences.length;f--;)c=b.models.EntityGoalConsequences[f],c.goalName===a&&(c.entityName===d.getName()?(c.consequences.entityLink=d,
e.push(c)):c.entityType===d.type&&(c.entityName=d.getName(),c.consequences.entityLink=d,e.push(c)));return e};b.executeGoalConsequences=function(a,d,e){var c=b.getGoalConsequencesWithName(a,d),f=d.position;a=0===b.models.moveID?b.getUniqueMoveID(d.name,a,f.x,f.y):b.models.moveID;b.setMoveID(a);e&&b.addJobForMoveID({jobID:b.models.moveID,jobName:"move game entity",job:"Prearrange Entity",jobArguments:{entity:d,destX:f.x,destY:f.y}});for(d=0;d<c.length;d++)b.addJobs(c[d].consequences)};b.translateCoordinates=
function(a,d){return String.fromCharCode(parseInt(97+a,10))+(b.gameWorld.getRows()-d)};b.addEntitiesToGameBoard=function(a){var d=0,e,c;e=null;for(var f,g=b.gameWorld.getRows(),h=b.gameWorld.getColumns(),l=0;l<g;l+=1)for(c=0;c<h;c+=1)f=a[d],0!==f&&(e=b.getPlayerWithID(f.associatedWithMetaAgent),e=e.entityFactory(f),e.unlimitedQuantity||(e.onBoard=!0),b.pushEntityToCell(e,c,l)),d+=1};b.addEntityToGame=function(a,d){var e=b.getPlayerWithID(a.associatedWithMetaAgent);if(d){a.unlimitedQuantity=!1;for(var c=
d;c--;)e.entityFactory(a)}else a.unlimitedQuantity=!0,e.entityFactory(a)};b.entityOfTypeIsUnderAttack=function(a,d){for(var e=d.getEntitiesOfType(a),c=e.length;c--;)if(e[c].canBeCaptured())return!0;return!1};b.entityOfSpecificTypeIsUnderAttack=function(a){var d=b.getPlayerWithID(a.associatedWithMetaAgent);if(0===d.countEntities())return!1;a=d.getEntitiesOfType(a.entityType);if(0===a.length)return!1;for(d=a.length;d--;)if(!0===a[d].canBeCaptured())return!0;return!1}};Spoooky.DiceBox=function(b){var a=
this;a.enable=function(){b.models.DiceBox.isEnabled=!0};a.isEnabled=function(){return b.models.DiceBox.isEnabled};a.createDice=function(a,e){b.models.DiceBox.dices.push({start:a,end:e})};a.countDices=function(){return b.models.DiceBox.dices.length};a.getDice=function(d){return 0<=d&&d<a.countDices()?b.models.DiceBox.dices[d]:!1};a.rollDice=function(d){return!1!==a.getDice(d)?parseInt(_.random(a.getDice(d).start,a.getDice(d).end),10):!1};a.rollAllDices=function(){for(var d=[],e=a.countDices();e--;)d.push(a.rollDice(e));
return b.models.DiceBox.diceValues=d};a.getMoveIDForDiceID=function(a){for(var e=b.models.DiceBox,c=e.attachedMoveIDs.length;c--;)if(e.attachedMoveIDs[c].diceValueID===a)return e.attachedMoveIDs[c].moveID;return!1};a.connectMoveIDWithDiceValue=function(a,e,c){b.models.DiceBox.attachedMoveIDs.push({diceValueID:e,moveID:a,target:c})};a.getConnectedDiceValue=function(a){for(var e=b.models.DiceBox,c=e.attachedMoveIDs.length;c--;)if(e.attachedMoveIDs[c].moveID===a)return e.attachedMoveIDs[c];return!1};
a.flushAttachedMoveIDs=function(){b.models.DiceBox.attachedMoveIDs.length=0};a.getDiceValues=function(){return b.models.DiceBox.diceValues};a.gotNoDiceValues=function(){return!b.models.DiceBox.diceValues[0]};a.deleteDiceValue=function(a){b.models.DiceBox.diceValues.splice(a,1)};a.deleteAllDiceValues=function(){b.models.DiceBox.diceValues.length=0}};Spoooky.GridWelt=function(b){var a=this;a.getRows=function(){return b.models.worldDimensions.rows};a.getColumns=function(){return b.models.worldDimensions.columns};
a.getView=function(d,e){return a.isValidCoordinate(d,e)?b.models.GameGrid[e][d].view:!1};a.setup=function(){if(0<b.models.worldDimensions.fieldsX&&0<b.models.worldDimensions.fieldsY)return a.init2DGrid(),!0;console.log("Invalid Size of GridWelt");return!1};a.setup2D=function(d,e){b.models.worldDimensions.rows=e;b.models.worldDimensions.columns=d;a.init2DGrid();return!0};a.setupGameBoard=function(d){for(var e=0,c=a.getRows(),f=a.getColumns(),g,h,l=0;l<c;l+=1)for(g=0;g<f;g+=1)h=d[e],a.setCellBaseClass(g,
l,h),-1!==h.indexOf("disabled")&&(b.models.GameGrid[g][l].enabled=!1),e+=1};a.setCellClass=function(d,e,c){a.getView(d,e).cellClass=c};a.setCellBaseClass=function(d,e,c){a.getView(d,e).baseClass=c};a.init2DGrid=function(){var d,e,c,f,g;f=a.getRows();g=a.getColumns();for(d=0;d<f;d+=1){c=[];for(e=0;e<g;e+=1)c.push({cellID:null,contains:[],view:{baseClass:"",cellClass:""},position:{x:e,y:d},enabled:!0});b.models.GameGrid.push(c)}return!0};a.enumerateFieldIDsByClass=function(d){var e,c,f,g=1,h=a.getColumns(),
l=a.getRows(),k=b.models.GameGrid;for(c=0;c<l;c+=1)for(e=0;e<h;e+=1)f=k[c][e],f.view.baseClass===d&&(f.cellID=g,g++)};a.setFieldIDs=function(d){var e,c,f=0,g=a.getColumns(),h=a.getRows(),l=b.models.GameGrid;for(c=0;c<h;c+=1)for(e=0;e<g;e+=1)l[c][e].cellID=d[f],f+=1;return!0};a.getFieldID=function(d,e){return a.isValidCoordinate(d,e)?b.models.GameGrid[e][d].cellID:!1};a.connectCells=function(a){b.models.CellConnections=a};a.createBoardSignature=function(){for(var a=b.models.GameGrid,e=b.gameWorld.getColumns(),
c="",f=_.flatten(a),g=f.length,h,a=0;a<g;a++)h=f[a].contains,c=0===h.length?c+"0":c+_.last(h).typeID,0===(a+1)%e&&a+1!==g&&(c+="|");e=b.models.OffBoardContent;if(0<e.length)for(c+="|",a=e.length;a--;)c+=e[a].typeID;return c};a.createBoardSignatureByVertical=function(){var d=a.getRows(),e=a.getColumns(),c=b.models.GameGrid,f,g,h,l="";for(g=0;g<e;g++){for(h=0;h<d;h++)f=c[h][g].contains,l=0===f.length?l+"0":l+_.last(f).typeID;g+1!==e&&(l+="|")}return l};a.pushToCell=function(d,e,c){return a.isValidCoordinate(e,
c)?(b.models.GameGrid[c][e].contains.push(d),!0):!1};a.popFromCell=function(d,e){if(a.isValidCoordinate(d,e)){var c=b.models.GameGrid[e][d].contains.pop();if(c)return b.getPlayerWithID(c.playerID).getEntityWithID(c.entityID)}return!1};a.deleteCellContent=function(d,e){if(a.isValidCoordinate(d,e)){var c=a.popFromCell(d,e);if(c&&0!==c)return c.seppuku(),!0}return!1};a.peekCell=function(d,e){if(a.isValidCoordinate(d,e)){var c=b.models.GameGrid[e][d].contains;if(0!==c.length)return c=_.last(c),b.getPlayerWithID(c.playerID).getEntityWithID(c.entityID)}return!1};
a.isValidCoordinate=function(d,e){var c=parseInt(d,10);return c<a.getColumns()&&0<=c&&(c=parseInt(e,10),0<=c&&c<a.getRows())?!0:!1};a.isEmpty=function(d,e){return!1===a.peekCell(d,e)};a.moveEntity=function(d,e,c,f,g){if(_.isUndefined(c)||_.isUndefined(f)||!1===a.isValidCoordinate(c,f))return!1;var h=b.models.GameGrid[f][c].contains;d=a.popFromCell(d,e);if(!1===_.isUndefined(g))g.setPosition(c,f),h.push({entityID:g.ID,playerID:g.getMetaPlayerID(),typeID:g.getTypeID()});else if(d)d.setPosition(c,f),
h.push({entityID:d.ID,playerID:d.getMetaPlayerID(),typeID:d.getTypeID()});else return!1;return!0};a.getFreeCells=function(){for(var d=[],e=a.getColumns(),c=a.getRows(),f=b.models.GameGrid,g,h=e;h--;)for(g=c;g--;)e=f[g][h],e.enabled&&0===e.contains.length&&d.push({x:h,y:g});return d};a.getFreeFieldsWithFieldID=function(d){for(var e=[],c=a.getColumns(),f=a.getRows(),g=b.models.GameGrid,h,l=c;l--;)for(c=f;c--;)h=g[c][l],0===h.contains.length&&h.cellID===d&&e.push([l,c]);e.reverse();return e};a.getFieldsWithFieldID=
function(a,e){var c=[],f=b.models,g=f.worldDimensions.rows,h=f.GameGrid,l,k;for(l=f.worldDimensions.columns;l--;)for(k=g;k--;)if(f=h[k][l],f.cellID===a){if(e)return f;c.push(f)}c.reverse();return c};a.getContentOfFieldsWithFieldID=function(d){for(var e=[],c=a.getColumns(),f=a.getRows(),g=b.models.GameGrid,h,l;c--;)for(l=f;l--;)h=g[l][c],h.cellID===d&&(h=a.peekCell(c,l))&&e.push(h);e.reverse();return e};a.countNeighboursNorth=function(d){var e=d.position.x,c=d.position.y,f=b.models.GameGrid[c][e].cellID;
d=d.getAssociatedPlayer();var g=0,h=a.peekCell(e,parseInt(c-1,10)),l=b.models.GameGrid;!1!==h&&l[parseInt(c-1,10)][e].cellID===f&&h.getAssociatedPlayer()===d&&(g+=1);return g};a.countNeighboursSouth=function(d){var e=d.position.x,c=d.position.y,f=b.models.GameGrid;if(!1===a.isValidCoordinate(e,c))return!1;var g=null;d=d.getAssociatedPlayer();var h=0,l=a.peekCell(e,parseInt(c+1,10));f[c][e]&&(g=f[c][e].cellID);!1!==l&&f[parseInt(c+1,10)][e].cellID===g&&l.getAssociatedPlayer()===d&&(h+=1);return h};
a.countNeighboursY=function(d){return a.countNeighboursNorth(d)+a.countNeighboursSouth(d)}};Spoooky.OffBoard=function(b){var a=this;a.addEntity=function(a){b.models.OffBoardContent.push({typeID:a.typeID,entityID:a.ID,entityName:a.getName(),playerID:a.getMetaPlayerID()})};a.deleteEntity=function(a){b.models.OffBoardContent.splice(a,1)};a.deleteEntityFromOffBoard=function(d){for(var e=b.models.OffBoardContent.length;e--;)if(b.models.OffBoardContent[e].entityName===d)return a.deleteEntity(e),!0;return!1};
a.entitiesOfPlayerAreOutside=function(a){for(var e=b.models.OffBoardContent.length;e--;)if(b.models.OffBoardContent[e].playerID===a)return!0;return!1};a.getAllEntities=function(){return b.models.OffBoardContent};a.getEntityWithPlayerID=function(a){for(var e=b.models.OffBoardContent.length;e--;)if(b.models.OffBoardContent[e].playerID===a)return a=b.models.OffBoardContent[e],b.getPlayerWithID(a.playerID).getEntityWithID(a.entityID);return!1};a.getEntitiesWithPlayerID=function(a){for(var e=[],c,f=b.models.OffBoardContent,
g=0;g<f.length;g++)c=f[g],c.playerID===a&&e.push(b.getPlayerWithID(c.playerID).getEntityWithID(c.entityID));return e}};Spoooky.GameEvents={events:{"Roll Dices":function(b,a){a.getDiceBox().rollAllDices()},"Roll Backgammon Dices":function(b,a){var d=-1,e,c=!0;e=a.getDiceBox();a.setGameState("INGAME");e.rollAllDices();e=e.getDiceValues();_.each(e,function(a){-1!==d&&d!==a&&(c=!1);d=a});!0===c&&(e.push(e[0]),e.push(e[0]));a.executeGameRules()},"Delete Dice Value":function(b,a){a.getDiceBox().deleteDiceValue(b.jobArguments)},
"Delete Assigned Dice Value":function(b,a){if(!1===a.getDiceBox().getConnectedDiceValue(b.jobID))return!1;a.getDiceBox().deleteDiceValue(a.getDiceBox().getConnectedDiceValue(b.jobID).diceValueID);return!0},"Bear Off Entity At Dice Target Cell":function(b,a){var d=a.getDiceBox().getConnectedDiceValue(b.jobID);if(!1===d)return!1;var e=d.target.x,d=d.target.y,c=a.gameWorld.peekCell(e,d);if(!1===c||_.isUndefined(c)||null===c)return!1;c.setPosition(null,null);0===a.getCurrentPlayerID()?c.tmp.fieldID=25:
1===a.getCurrentPlayerID()&&(c.tmp.fieldID=0);a.offBoard.addEntity(c);a.gameWorld.popFromCell(e,d);return!0},"Show Backgammon Re-entering Moves":function(b,a){var d=b.jobArguments.playerID;if(d===a.getCurrentPlayerID()){var e=a.offBoard.getEntityWithPlayerID(d);e.setPosition(-1,-1);0===d?e.tmp.fieldID=0:1===d&&(e.tmp.fieldID=25);d=e.getMoves();e=e.getGoalMoves(d);a.highlightStandardMoves(d);a.highlightGoalMoves(e)}return!1},"Delete Entity from OffBoard":function(b,a){delete b.jobArguments.entity.tmp.fieldID;
a.offBoard.deleteEntityFromOffBoard(b.jobArguments.entity.name)},"Place Entity":function(b,a){var d=b.jobArguments.entity,d=a.getPlayerWithID(d.associatedWithPlayerID).getEntityWithID(d.ID),e=b.jobArguments;d.unlimitedQuantity||(d.onBoard=!0);a.pushEntityToCell(d,e.xPosition,e.yPosition);a.models.moveCounter+=1;!1===a.models.playVirtual&&Spoooky.GameProcess.pushMessage("["+a.models.moveCounter+"] "+a.getCurrentPlayerName()+" setzt Spielfigur auf Feld "+a.translateCoordinates(e.xPosition,e.yPosition)+
".")},"Move Entity To Dice Destination Cell":function(b,a){var d=a.getDiceBox().getConnectedDiceValue(b.jobID);if(!1===d)return!1;var e=b.entityLink.position.x,c=b.entityLink.position.y,f=d.target.x,d=d.target.y;a.models.moveCounter+=1;if(!1===a.models.playVirtual){var g=a.translateCoordinates(e,c),h=a.translateCoordinates(f,d);Spoooky.GameProcess.pushMessage("["+a.models.moveCounter+"] "+a.getCurrentPlayerName()+" bewegt Spielfigur von "+g+" nach "+h+".")}!1===_.isUndefined(b.entityLink.tmp.fieldID)?
(a.moveEntity(e,c,f,d,b.entityLink),delete b.entityLink.tmp.fieldID,a.offBoard.deleteEntityFromOffBoard(b.entityLink.getName())):a.moveEntity(e,c,f,d);return!0},"Prearrange Entity":function(b,a){var d=b.jobArguments,e=d.entity.position;a.models.moveCounter+=1;a.moveEntity(e.x,e.y,d.destX,d.destY)},"Move Entity":function(b,a){var d=a.models,e=b.jobArguments,c=e.entity.position;d.moveCounter+=1;if(!1===d.playVirtual){var f=a.translateCoordinates(c.x,c.y),g=a.translateCoordinates(e.destX,e.destY);Spoooky.GameProcess.pushMessage("["+
d.moveCounter+"] "+a.getCurrentPlayerName()+" bewegt Spielfigur von "+f+" nach "+g+".")}a.moveEntity(c.x,c.y,e.destX,e.destY)},"Move Entity By Dice Value":function(b,a){var d=a.models,e=b.jobArguments,c=e.entity.position;d.moveCounter+=1;if(!1===d.playVirtual){var f=a.translateCoordinates(c.x,c.y),g=a.translateCoordinates(e.destX,e.destY);Spoooky.GameProcess.pushMessage("["+d.moveCounter+"] "+a.getCurrentPlayerName()+" bewegt Spielfigur von "+f+" nach "+g+" mit dem Wuerfelwert "+e.diceValue+".")}a.moveEntity(c.x,
c.y,e.destX,e.destY)},"Move Entity Relative To":function(b,a){var d=b.entityLink,e=d.position.x,d=d.position.y;a.moveEntity(e,d,parseInt(e+b.jobArguments[0],10),parseInt(d+b.jobArguments[1],10))},"Move Entity With Name":function(b,a){var d=a.getEntityWithName(b.jobArguments[0]);if(!1===d)return!1;var e=b.jobArguments,c=d.position.x,d=d.position.y,f,g;"RELATIVE"===e[3]?(f=parseInt(c+e[1],10),g=parseInt(d+e[2],10)):"ABSOLUTE"===e[3]&&(f=e[1],g=e[2]);a.moveEntity(c,d,f,g);a.models.moveCounter+=1;return!0},
"Prevent Player Change":function(b,a){a.models.playerChange=!1;return!0},"Enable Player Change":function(b,a){a.models.playerChange=!0},"Proceed Game":function(b,a){a.proceed()},"Change Game Mode":function(b,a){var d=b.jobArguments.mode;"PLACING"===d||"MOVING"===d?a.setGameMode(d):console.log("Error: Wrong Game Mode",d)},"Delete Game Rule":function(b,a){for(var d=a.models.GameRules,e=d.length,c=b.jobArguments.ruleName;e--;)if(c===d[e].name)return a.models.GameRules.splice(e,1),!0;return!1},"Capture Opponent At":function(b,
a){var d,e,c=b.jobArguments,f=b.entityLink.position;"RELATIVE"===c[2]?(d=parseInt(f.x+c[0],10),e=parseInt(f.y+c[1],10)):"ABSOLUTE"===c[2]&&(d=c[0],e=c[1]);!1===a.models.playVirtual&&(c=a.translateCoordinates(d,e),Spoooky.GameProcess.pushMessage("["+a.models.moveCounter+"] "+a.getCurrentPlayerName()+" schlaegt gegnerische Spielfigur auf Feld "+c+"."));a.deleteEntityAt(d,e)},"Highlight Dice Target Cell":function(b,a){a.highlightCell(b.entityLink.targeting.x,b.entityLink.targeting.y,b.jobArguments,b.jobID)},
"Highlight Area":function(b,a){a.getArea(b.jobArguments.areaName).display=b.jobArguments.highlightClass},"Highlight Cell":function(b,a){var d=b.jobArguments,e=d[0],c=d[1],f=d[2];"RELATIVE"===d[3]?(e=parseInt(b.entityLink.position.x+d[0],10),c=parseInt(b.entityLink.position.y+d[1],10)):"ABSOLUTE"===d[3]&&(e=d[0],c=d[1]);a.highlightCell(e,c,f,b.jobID)},"Set Game State":function(b,a){a.setGameState(b.jobArguments)},"Restrict Selectable Entities":function(b,a){a.models.SelectRestrictions.entities=b.jobArguments},
"Restrict Selectable Entity Moves":function(b,a){a.models.SelectRestrictions.moves=b.jobArguments},"Delete This Entity":function(b,a){a.deleteEntityAt(b.entityLink.position.x,b.entityLink.position.y)},"Increment Off Board Counter":function(b,a){a.areas.incrementElements(b.jobArguments)},"Transform Entity":function(b,a){var d=b.entityLink,e=a.models.MetaAgents[b.entityLink.associatedWithPlayerID],c=d.position.x,f=d.position.y;a.deleteEntityAt(c,f);a.resetMoves();var g=a.getBlueprint(b.jobArguments),
g=e.entityFactory(g);g.setName(d.getName());g.setID(d.ID);g.associatedWithMetaAgent=e.ID;g.executedMoves=d.executedMoves;a.pushEntityToCell(g,c,f)},"Transform Entity If Row Reached":function(b,a){var d=b.entityLink,e=b.jobArguments.row;"last"===e?e=parseInt(a.gameWorld.getRows()-1,10):"first"===e&&(e=0);if(d.position.y!==e)return!1;Spoooky.GameEvents.fireEvent({job:"Transform Entity",jobArguments:b.jobArguments.entityType,entityLink:d},a);return!0},"Next Player":function(b,a){a.setNextPlayer()},"Delete All Dice Values":function(b,
a){a.getDiceBox().deleteAllDiceValues()},alert:function(b){alert(b.jobArguments)},"Print Game Process":function(b,a){!1===a.models.playVirtual&&Spoooky.GameProcess.pushMessage(b.jobArguments)},"Stop Game":function(b,a){a.setGameState("END");!1===a.models.playVirtual&&a.informArtificialPlayersAboutGameEnd()},"Set Winner":function(b,a){a.setWinnerID(b.jobArguments);!1===a.models.playVirtual&&Spoooky.GameProcess.pushMessage('<button id="postGameReloadButton"onclick="location.reload();" type="button" class="btn btn-success btn-sm">Spiel neu starten</button>')}},
fireEvent:function(b,a){this.events[b.job](b,a)}};Spoooky.JobQueue=function(b){this.addJob=function(a){var d=b.models.JobQueue;_.isUndefined(d[a.jobID])&&(d[a.jobID]=[]);d[a.jobID][a.jobName]=a};this.flush=function(){b.models.JobQueue.length=0};this.getJobsWithMoveID=function(a){var d=[];a=b.models.JobQueue[a];for(var e in a)d.push(a[e]);return d}};Spoooky.Areas=function(b){var a=this;a.enable=function(){b.models.Areas.isEnabled=!0};a.isEnabled=function(){return b.models.Areas.isEnabled};a.isMove=
function(d){return 0!==a.getArea(d).moveID};a.incrementElements=function(d){a.getArea(d).elementCounter++};a.getMoveID=function(d){return a.getArea(d).moveID};a.addArea=function(d){a.enable();b.models.Areas.content.push({name:d,moveID:0,display:"",elementCounter:0})};a.getArea=function(a){return _.find(b.models.Areas.content,function(e){return e.name===a})};a.resetDisplays=function(){_.each(b.models.Areas.content,function(a){a.display=""})}};Spoooky.Agent=function(b,a){var d=this;d.ID=a;d.metaAgentID=
b;d.role="ANALYZE POSSIBLE MOVES";d.focus="ALL";d.fitness=1;d.thinkingTime=1E4;d.maximumSteps=1E4;d.uctConstant=.9;d.proposeBestMove=function(){var a=!1,c=d.ID,b=d.role,g=d.focus,h=d.maximumSteps,l=d.createBrain(),k=d.uctConstant,m=d.thinkingTime,n=Spoooky.AI.game.getPlayerWithID(d.metaAgentID).learningEnabled;localStorage["#mctsgraph"]&&(a=!0);switch(b){case "ANALYZE POSSIBLE MOVES":l.postMessage({agentID:c,agentRole:b,agentFocus:g,maxSteps:h,maxTime:m,learn:n,uctConstant:k,command:"monte carlo tree search with uct",
gameModel:Spoooky.AI.game.stringifyModels(),generateMctsGraph:a});break;case "SEARCH FOR IMMEDIATE THREATS":l.postMessage({agentID:c,agentRole:b,agentFocus:g,command:"alpha beta negamax",maxDepth:3,gameModel:Spoooky.AI.game.stringifyModels()});break;default:console.log("Unknown Agent Role.")}};d.createBrain=function(){var a=new Worker("../../js/spoooky.Worker.min.js"),c=Spoooky.AI.game.getPlayerWithID(d.metaAgentID);a.addEventListener("message",function(a){switch(a.data.type){case "decision":c.coordinateAgentDecisions(a.data);
break;case "random":c.coordinateAgentDecisions(a.data)}});return a}};Spoooky.MetaAgent=function(b){var a=this;a.name="";a.setName=function(d){a.name=d};a.getName=function(){return a.name};a.getGame=function(){return b};a.ID=0;a.getID=function(){return a.ID};a.setID=function(d){a.ID=d};a.type="HUMAN";a.setType=function(d){if("HUMAN"===d||"ARTIFICIAL"===d)return a.type=d,!0;console.log("Invalid Player Type. Allowed Player Types: HUMAN or ARTIFICIAL");return!1};a.learningEnabled=!1;a.enableLearning=
function(){a.learningEnabled=!0};a.QLearner={};a.gameHasEnded=function(){if(a.learningEnabled){Spoooky.GameProcess.pushMessage("Meta Agent "+a.ID+" lernt...");a.QLearner.learn(1E4);var d;d="{\n"+('\t"game" : "'+a.getGame().getName()+'",\n');d+='\t"metaAgentID" : '+a.ID+",\n";d=d+'\t"bestAgentEnsemble" : '+JSON.stringify(a.agents,null,"\t");d+=",\n";d+='\t"learnModule" : ';d+=JSON.stringify(a.QLearner,null,"\t");d+="\n}";d=new Blob([d],{type:"text/plain;charset=utf-8"});saveAs(d,"agentmemory_"+a.ID+
".json")}};a.associateEntity=function(d,e){d.associatedWithMetaAgent=a.ID;"PLACE"===d.mode&&a.getGame().addEntityToGame(d,e)};a.entityFactory=function(d){var e;e="";var c=0;e=d.entityName?d.entityName:a.ID+"_entity_"+parseInt(a.countEntities()+1,10);c=d.entityID?d.entityID:parseInt(a.countEntities()+1,10);e=new Spoooky.Entity(e,c,d.typeID,a.getGame());e.setType(d.entityType);e.setRepresentation(d.representation.type,d.representation.texture);var b,g=d.moves;if(g)for(c=0;c<g.length;c++)b=g[c],e.addMove({name:b.name,
type:b.type,direction:b.direction,frequency:b.frequency,conditions:b.conditions,postMove:b.postMove});if(d.goalAtoms)for(c=0;c<d.goalAtoms.length;c++)b=d.goalAtoms[c],e.addGoalAtom(b.atomName,b.atomFunction,b.atomArguments);if(d.goals)for(c=0;c<d.goals.length;c++)b=d.goals[c],e.assembleGoal({type:b.type,name:b.name,atoms:b.atoms,move:b.move,area:b.area});e.selectCondition=d.selectCondition;e.postMoveCheck=d.postMoveCheck?d.postMoveCheck:null;e.setGoalTargets(d.goalTargets);d.unlimitedQuantity&&(e.unlimitedQuantity=
!0);d.mode&&(e.mode=d.mode);d.placeTo&&(e.placeTo=d.placeTo);a.addEntity(e);return e};a.addEntity=function(d){d.setAssociatedPlayerID(a.ID);b.models.Entities[a.ID].push(d)};a.getEntityFromArray=function(d){return 0<=d&&d<a.countEntities()?b.models.Entities[a.ID][d]:!1};a.getEntityWithID=function(d){for(var e,c=a.countEntities();c--;)if(e=b.models.Entities[a.ID][c],e.ID===d)return e;return!1};a.getEntities=function(){return b.models.Entities[a.ID]};a.getEntitiesOfType=function(d){for(var e=[],c=a.countEntities();c--;)b.models.Entities[a.ID][c].type===
d&&e.push(b.models.Entities[a.ID][c]);return e};a.getPlaceableEntities=function(){for(var d=[],e,c=a.countEntities(),f=a.ID;c--;)e=b.models.Entities[f][c],"PLACE"===e.mode&&(e.unlimitedQuantity?d.push(e):e.onBoard||d.push(e));return d};a.getEntityWithName=function(d){for(var e=a.countEntities();e--;)if(b.models.Entities[a.ID][e].name===d)return b.models.Entities[a.ID][e];return!1};a.getNextOpponentPlayer=function(){return a.ID<a.getGame().models.MetaAgents.length-1?a.getGame().getPlayerWithID(parseInt(a.ID+
1,10)):a.getGame().getPlayerWithID(0)};a.getOccupiedFields=function(d){var e=[],c=a.getGame().models.GameGrid,c=_.flatten(c),b=c.length;switch(d){case "OWN ENTITIES":for(d=b;d--;)b=c[d],0!==b.contains.length&&_.last(b.contains).playerID===a.ID&&e.push(b.position);break;case "OPPONENT ENTITIES":for(d=b;d--;)b=c[d],0!==b.contains.length&&_.last(b.contains).playerID!==a.ID&&e.push(b.position);break;default:console.log("Wrong Mode")}return e};a.hasEntity=function(d){for(var e=a.countEntities();e--;)if(b.models.Entities[a.ID][e].name===
d)return!0;return!1};a.deleteEntity=function(d){for(var e=a.countEntities();e--;)if(b.models.Entities[a.ID][e].name===d)return b.models.Entities[a.ID].splice(e,1),!0;return!1};a.countEntities=function(){return b.models.Entities[a.ID].length};a.getAllEntityStdMoves=function(){var d=a.getEntities();if(0===d.length)return!1;for(var b,c,f=[],g=a.getGame(),h=d.length;h--;)b=d[h],!0===g.checkSelectCondition(b)&&(c=b.getMoves(),g.performPostMoveChecks(b,c),f.push.apply(f,c));return 0===f.length?!1:f};a.getAllEntityGoalMoves=
function(){var d=a.getEntities();if(0===d.length)return!1;for(var b,c,f=[],g=a.getGame(),h=d.length;h--;)b=d[h],!0===g.checkSelectCondition(b)&&(c=b.getGoalMoves(),g.performPostMoveChecks(b,c),f.push.apply(f,c));return 0===f.length?!1:f};a.getAllEntityMoves=function(){var d=a.getGame();if("END"===d.models.gameState)return[];var b,c;switch(d.models.gameMode){case "MOVING":b=a.getEntities();c=b.length;if(0===c)return[];for(var f=[],g=[],h=[],l,k=c;k--;)if(c=b[k],"PLACE"!==c.mode&&!0===d.checkSelectCondition(c)){f.length=
0;g.length=0;l=d.models.SelectRestrictions.moves;switch(l){case "Standard Moves":f=c.getMoves();break;case "Capture Moves":g=c.getGoalMoves(f);break;default:f=c.getMoves(),g=c.getGoalMoves(f)}d.performPostMoveChecks(c,f);d.performPostMoveChecks(c,g);h.push.apply(h,f);h.push.apply(h,g)}return 0===h.length?[]:h;case "PLACING":b=a.getPlaceableEntities();if(0===b.length)return[];var f=[],k;c=_.last(b);switch(c.placeTo){case "ANY":h=d.gameWorld.getFreeCells();for(k=h.length;k--;)b=h[k],g=d.getUniqueMoveID(c.name,
"place-entity",b.x,b.y),f.push({type:"PLACE",name:"place entity",entity:c,targetX:b.x,targetY:b.y,moveClass:"move_place",ID:g}),d.addJobForMoveID({jobID:g,jobName:"Put the Entity to the destination field",job:"Place Entity",jobArguments:{entity:c,xPosition:b.x,yPosition:b.y}});return f;case "REACHABLE BY RECENTLY MOVED ENTITY":k=d.getrecentlyMovedEntity();if(!1===k)return[];h=k.getMoves();for(k=h.length;k--;)b=h[k],g=d.getUniqueMoveID(c.name,"place-entity",b.targetX,b.targetY),f.push({type:"PLACE",
name:"place entity",entity:c,targetX:b.targetX,targetY:b.targetY,moveClass:"move_place",ID:g}),d.addJobForMoveID({jobID:g,jobName:"Put the Entity to the destination field",job:"Place Entity",jobArguments:{entity:c,xPosition:b.targetX,yPosition:b.targetY}}),d.addJobForMoveID({jobID:g,jobName:"Let Players Change",job:"Enable Player Change"}),d.addJobForMoveID({jobID:g,jobName:"Change Back To Move Mode",job:"Change Game Mode",jobArguments:{mode:"MOVING"}});return f;default:console.log("Wrong Placing Mode: ",
c.placeTo)}break;default:console.log("Wrong command in self_MetaAgent.getAllEntityMoves")}};a.getExecutableMovesByAgentFocus=function(d){if("END"===a.getGame().models.gameState)return[];var b=a.getAllEntityMoves(),c,f,g,h,l,k=[],m;for(c=b.length;c--;)b[c].moveIndex=c;switch(d){case "FIRST HALF OF POSSIBLE MOVES":return k=Math.floor(b.length/2),b.splice(k,k),b;case "SECOND HALF OF POSSIBLE MOVES":return k=Math.floor(b.length/2),b.splice(0,k),b;case "MOVES NEAR OPPONENT FIELDS":m=a.getOccupiedFields("OPPONENT ENTITIES");
for(f=b.length;f--;)for(d=b[f].targetX,c=b[f].targetY,l=m.length;l--;)if(g=m[l].x,h=m[l].y,g=Math.abs(g-d),h=Math.abs(h-c),1>=g&&1>=h){k.push(b[f]);break}return k;case "MOVES NEAR OPPONENT OR OWN FIELDS":m=a.getOccupiedFields("OPPONENT ENTITIES");m=m.concat(a.getOccupiedFields("OWN ENTITIES"));for(f=b.length;f--;)for(d=b[f].targetX,c=b[f].targetY,l=m.length;l--;)if(g=m[l].x,h=m[l].y,g=Math.abs(g-d),h=Math.abs(h-c),1>=g&&1>=h){k.push(b[f]);break}return k;default:return b}};a.agents=[];a.activeAgents=
0;a.finishedAgents=0;a.countAgents=function(){return a.agents.length};a.getAgents=function(){return a.agents};a.getAgentWithID=function(d){var b,c=a.agents;for(b=c.length;b--;)if(c[b].ID===d)return c[b];return!1};a.assembleAgent=function(d,b,c,f,g,h,l){d=new Spoooky.Agent(a.ID,d);d.role=b;d.fitness=h;d.focus=c;d.thinkingTime=g;d.maximumSteps=f;d.uctConstant=l;a.agents.push(d)};a.addStandardAgent=function(){var d,b,c=0;b=a.getAgents();for(var f=b.length;f--;)d=b[f].ID,d>c&&(c=d);a.assembleAgent(c+
1,"ANALYZE POSSIBLE MOVES","ALL MOVES",1E4,1E4,1,.9)};a.deleteAgentWithID=function(b){for(var e=a.agents.length;e--;)a.agents[e].ID===b&&a.agents.splice(e,1)};a.expertKnowledge=!1;a.assembleAgents=function(){var b="agentmemory_"+a.ID+".json",e=!1;$.ajax({url:b,dataType:"json",async:!1,success:function(b){e=!0;Spoooky.AgentLog.pushMessage("Lade Agentenerinnerungen fuer Meta Agent "+a.ID+".");Spoooky.AgentLog.pushMessage('<div class="progress progress-striped active"><div class="progress-bar"  role="progressbar" style="width: 100%"><span class="sr-only">Lade</span></div></div>');
a.QLearner=new Spoooky.QLearner;a.QLearner.reward=b.learnModule.rewards;a.QLearner.gameStates=b.learnModule.gameStates;$.each(b.bestAgentEnsemble,function(b,d){a.assembleAgent(d.ID,d.role,d.focus,d.maximumSteps,d.thinkingTime,d.fitness,d.uctConstant)})},complete:function(){if(e){Spoooky.AgentLog.messages.pop();var c=_.keys(a.QLearner.gameStates).length;Spoooky.AgentLog.pushMessage(c+" gelernte Spielzustaende wurden erfolgreich aus der Datei "+b+" geladen.")}},error:function(){0===a.agents.length&&
(Spoooky.AgentLog.pushMessage("Keine Erinnerungen fuer Meta Agent "+a.ID+" vorhanden: Datei "+b+" existiert nicht."),a.QLearner=new Spoooky.QLearner,a.assembleAgent(1,"ANALYZE POSSIBLE MOVES","ALL MOVES",15E3,1E4,1,.5),a.assembleAgent(2,"ANALYZE POSSIBLE MOVES","FIRST HALF OF POSSIBLE MOVES",15E3,1E4,1,.5),a.assembleAgent(3,"ANALYZE POSSIBLE MOVES","SECOND HALF OF POSSIBLE MOVES",15E3,1E4,1,.5))}});return!0};a.runtimeStart=0;a.findBestMove=function(){Spoooky.AI.game=a.getGame();a.runtimeStart=Date.now();
a.askAgentsForDecision()};a.askAgentsForDecision=function(){a.activeAgents=a.countAgents();a.bestMoves.length=0;Spoooky.AgentLog.pushMessage("Meta agent "+a.ID+" ("+a.getName()+") fragt "+a.activeAgents+" assoziierte Agenten nach der besten Zugmoeglichkeit.");for(var b=0;b<a.agents.length;b++)a.agents[b].proposeBestMove()};a.bestMoves=[];a.prepareAgentsMoveSuggestions=function(a){var b=[],c,f,g,h=!1,l,k,m;l=[];for(f=a.length;f--;){c=a[f];for(g=b.length;g--;)b[g].moveIndex===c.moveIndex&&(k=parseInt(b[g].wins+
c.wins),h=parseInt(b[g].visits+c.visits),m=parseInt(b[g].lost+c.lost),parseInt(b[g].simulationSteps+c.simulationSteps),l=b[g].agentID,l.push(c.agentID),l={simulationSteps:c.simulationSteps,moveIndex:c.moveIndex,agentID:l,visits:h,target:c.target,wins:k,lost:m},b[g]=l,h=!0);!1===h&&(l={simulationSteps:c.simulationSteps,moveIndex:c.moveIndex,agentID:[c.agentID],target:c.target,visits:c.visits,wins:c.wins,lost:c.lost},b.push(l));h=!1}return b};a.updateAgentsFitness=function(b){var e=a.getAgents(),c=
!1,f,g;for(f=e.length;f--;){for(g=b.length;g--;)if(e[f].ID===b[g]){e[f].fitness+=.5;c=!0;break}!1===c&&(e[f].fitness-=.5);c=!1}};a.getFittestAgent=function(){var b=a.getAgents(),e,c=0,f,g;for(e=b.length;e--;)g=b[e],g.fitness>=c&&(c=g.fitness,f=g);return f};a.replaceUnfitAgents=function(){var b=a.getAgents(),e,c=a.getFittestAgent();for(e=b.length;e--;).1>b[e].fitness&&(Spoooky.AgentLog.pushMessage("Agent #"+b[e].ID+" hat eine schlechte Fitness von "+b[e].fitness+" und fokussiert nun den folgenden Spielaspekt: "+
c.focus),b[e].role=c.role,b[e].focus=c.focus,b[e].fitness=1);a.getGame().refreshView()};a.updateQLearner=function(b){var e,c,f;e=a.QLearner;b=JSON.parse(b).gameStates;var g,h,l,k,m=e.gameStates,n=_.keys(b),p=n.length;for(f=0;f<p;++f)if(g=b[n[f]],h=g.name,_.has(m,h))for(l=g.actions,n=_.keys(l),p=n.length,f=0;f<p;f++)k=l[n[f]],_.has(m[h].actions,k.name)?(c=e=0,_.has(m[h].actions[k.name],"reward")&&(c=m[h].actions[k.name].reward),_.has(k,"reward")&&(e=k.reward),e+=c,m[h].actions[k.name]=k,0!==e&&(m[h].actions[k.name].reward=
e)):m[g.name].actions[k.name]=k;else m[g.name]=g};a.mctsData=[];a.processAgentDecision=function(b){a.mctsData.push({agentID:b.agentID,mctsGraph:b.mctsGraph,uctConstant:b.uctConstant});b.mctsGraph.length=0;a.bestMoves.push(b);Spoooky.AgentLog.pushMessage("Agent #"+b.agentID+" hat "+b.results.length+" Zugmoeglichkeiten anhand von "+b.simCount+" Monte Carlo Ausspielungen mit insgesamt "+b.simSteps+" Simulationsschritten analysiert.");a.getGame().refreshView();a.finishedAgents++};a.allAgentsHaveFinishedThinking=
function(){return a.finishedAgents===a.activeAgents?(a.finishedAgents=0,!0):!1};a.sumUpAgentsWork=function(){var b,e,c={},f=0,g=0,h=[],l=a.bestMoves,k,m;for(k=l.length;k--;){e=l[k];f+=e.simCount;g+=e.simSteps;b=e.results;for(m=b.length;m--;)c=b[m],c.agentID=e.agentID,c.agentRole=e.agentRole,c.agentFocus=e.agentFocus,h.push(c);a.learningEnabled&&a.updateQLearner(e.QLearner)}a.bestMoves.length=0;return{results:h,simCount:f,simSteps:g}};a.getBestMove=function(a){for(var b=Number.MAX_VALUE,c,f,g="Random",
b=-1*Number.MAX_VALUE,h=a.length;h--;)c=a[h],0<c.visits&&(f=c.visits,f>b&&(b=f,g=c),Spoooky.AgentLog.pushMessage(c.target+" [Agent(en) #"+c.agentID+"]<ul><li>Besuche: "+c.visits+"</li><li>Gewinnhaeufigkeit: "+c.wins+"</li><li>Simulationsschritte: "+c.simulationSteps+"</li><li>Gewinnrate: "+c.wins/c.visits+"</li></ul>"));return g};a.printAgentsFinishedMessage=function(){for(var a=Spoooky.GameProcess.messages.length;a--;)"thinking"===Spoooky.GameProcess.messages[a].type&&Spoooky.GameProcess.messages.splice(a,
1);Spoooky.AgentLog.pushMessage("Alle assoziierten Agenten haben ihre Arbeit beendet.")};a.coordinateAgentDecisions=function(b){a.processAgentDecision(b);b.length=0;if(a.allAgentsHaveFinishedThinking()){var e=(Date.now()-a.runtimeStart)/1E3;a.printAgentsFinishedMessage();var c=a.sumUpAgentsWork(),f=c.simCount,g=c.simSteps;b=a.prepareAgentsMoveSuggestions(c.results);c.length=0;Spoooky.AgentLog.pushMessage("<strong>"+f+" simulierte Spiele  mit insgesamt "+g+" Simulationsschritten (~"+(g/f).toFixed(2)+
" Schritte/Simulation) in "+e+" Sekunden.</strong>");Spoooky.Statistics.logEntry(a.ID,"simCount",a.getGame().models.moveCounter+1,f);Spoooky.Statistics.logEntry(a.ID,"simSteps",a.getGame().models.moveCounter+1,g);b=_.sortBy(b,function(a){return a.visits});b.reverse();e=a.getBestMove(b);b.length=0;a.learningEnabled&&a.QLearner.learn(1E4);"Random"===e?(Spoooky.AgentLog.pushMessage("Meta Agent fuehrt einen Zufallszug aus."),a.getGame().executeRandomMove()):(a.updateAgentsFitness(e.agentID),a.replaceUnfitAgents(),
Spoooky.AgentLog.pushMessage("<strong>Meta Agent hat sich fuer die folgende Zugmoeglichkeit entschieden: "+e.target+"</strong>"),a.getGame().executeArtificialMove(e));a.mctsData&&a.getGame().refreshGraphView(a.mctsData,a.ID);a.getGame().refreshStatsView(a.ID);a.mctsData.length=0}};a.artificialMove=function(){Spoooky.GameProcess.pushMessage(a.getName()+' denkt nach...<br><div class="progress progress-striped active"><div class="progress-bar"  role="progressbar" style="width: 100%"><span class="sr-only">Ich denke nach...</span></div></div>',
"thinking");a.findBestMove()};a.hasEntitiesOnFieldWithFieldID=function(b,e){for(var c,f={"<":function(a,b){return a<b},"<=":function(a,b){return a<=b},">":function(a,b){return a>b},">=":function(a,b){return a>=b},"==":function(a,b){return a==b}},g=a.countEntities();g--;)if(c=a.getEntityFromArray(g),f[e](c.getFieldID(),b))return!0;return!1}};Spoooky.Entity=function(b,a,d,e){var c=this;c.unlimitedQuantity=!1;c.mode="MOVE";c.placeTo=0;c.getGame=function(){return e};c.ID=a;c.getID=function(){return c.ID};
c.setID=function(a){c.ID=a};c.typeID=d;c.getTypeID=function(){return c.typeID};c.setTypeID=function(a){c.typeID=a};c.name=b;c.enabled=!0;c.moveCounter=0;c.increaseMoveCounter=function(){c.moveCounter+=1};c.getMoveCount=function(){return c.moveCounter};c.lastExecutedMove=0;c.addExecutedMove=function(a,b,d,e){c.increaseMoveCounter();c.lastExecutedMove={destX:a,destY:b,round:d,type:e}};c.getLastExecutedMove=function(){return c.lastExecutedMove};c.enable=function(){c.enabled=!0};c.disable=function(){c.enabled=
!1};c.setName=function(a){c.name=a};c.type="default";c.getType=function(){return c.type};c.setType=function(a){c.type=a};c.getWorld=function(){return c.getGame().gameWorld};c.isOpponent=function(a,b){var d;return c.getWorld().isValidCoordinate(a,b)&&(d=c.getWorld().peekCell(a,b),!1!==d&&d.getMetaPlayerID()!==c.getMetaPlayerID())?!0:!1};c.isEmptyCell=function(a,b){return c.getWorld().isValidCoordinate(a,b)?!1===c.getWorld().peekCell(a,b):!1};c.visualRepresentation={type:"",colour:"",imageURL:""};c.getView=
function(){return c.visualRepresentation.imageURL};c.position={x:-1,y:-1};c.getPosition=function(){return c.position};c.getFieldID=function(){return c.getWorld().getFieldID(c.position.x,c.position.y)};c.setPosition=function(a,b){c.position.x=a;c.position.y=b};c.tmp={};c.targeting={x:null,y:null};c.setTarget=function(a,b){c.targeting.x=a;c.targeting.y=b};c.unsetTarget=function(){c.targeting.x=null;c.targeting.y=null};c.goalTargets=[];c.addGoalTarget=function(a){c.goalTargets.push(a)};c.setGoalTargets=
function(a){c.goalTargets=a};c.getGoalTargets=function(){return c.goalTargets};c.setRepresentation=function(a,b){if("colour"===a||"image"===a)c.visualRepresentation={type:a,colour:b,imageURL:b}};c.associatedWithPlayerID=null;c.setAssociatedPlayerID=function(a){c.associatedWithPlayerID=a};c.getMetaPlayerID=function(){return c.associatedWithPlayerID};c.getName=function(){return c.name};c.getAssociatedPlayer=function(){return c.getGame().getPlayerWhoOwnsEntity(c.getName())};c.seppuku=function(){!1!==
c.getAssociatedPlayer()&&c.getAssociatedPlayer().deleteEntity(c.getName())};c.isOwnedByPlayerID=function(a){return c.associatedWithPlayerID===a};c.translateDirection=function(a){var b=0,c=0;if("object"===typeof a&&a instanceof Array)b=a[0],c=a[1];else switch(a){case "n":case "north":b=0;c=-1;break;case "ne":case "northeast":b=1;c=-1;break;case "e":case "east":case "right":b=1;c=0;break;case "se":case "southeast":c=b=1;break;case "s":case "south":b=0;c=1;break;case "sw":case "southwest":b=-1;c=1;break;
case "w":case "west":case "left":b=-1;c=0;break;case "nw":case "northwest":c=b=-1}return[b,c]};c.moves=[];c.addMove=function(a){var b=c.translateDirection(a.direction);c.moves.push({name:a.name,type:a.type,direction:a.direction,xDirection:b[0],yDirection:b[1],frequency:a.frequency,conditions:a.conditions,postMove:a.postMove})};c.countPossibleMoves=function(){return c.moves.length};c.countFieldsWithID=function(a){return c.getWorld().getContentOfFieldsWithFieldID(a).length};c.countOpponentsOnFieldsWithID=
function(a,b){for(var d=c.getWorld().getContentOfFieldsWithFieldID(a),e=0,k,m=d.length;m--;)(k=d[m])&&k.getMetaPlayerID()!==b.getMetaPlayerID()&&(e+=1);return e};c.countOwnOnFieldsWithID=function(a,b){for(var d=c.getWorld().getContentOfFieldsWithFieldID(a),e=0,k,m=d.length;m--;)(k=d[m])&&k.getMetaPlayerID()===b.getMetaPlayerID()&&(e+=1);return e};c.getMove=function(a){return 0<=a&&a<c.countPossibleMoves()?c.moves[a]:!1};c.canMove=function(){var a=c.getMoves();c.getGame().performPostMoveChecks(this,
a);return!_.isEmpty(a)};c.getMoves=function(){var a=c.countPossibleMoves();if(0>=a)return!1;for(var b,d,e,k,m,n,p,t=[],q=c.getGame(),v=a;v--;)switch(a=c.getMove(v),a.type){case "Default":if(0<a.frequency||"ANY"===a.frequency)for(d=a.frequency,e=c.position.x,k=c.position.y,"ANY"===d&&(d=23),m=1;m<=d;m+=1){n=e+a.xDirection*m;p=k+a.yDirection*m;if(!1===c.getWorld().isEmpty(n,p))break;q.isLegalMove(c,a.conditions,e,k,n,p)&&(b=q.getUniqueMoveID(c.name,a.name,n,p),t.push({type:"MOVE",name:a.name,entity:c,
targetX:n,targetY:p,moveClass:"move_standard",freq:d,ID:b,postMove:a.postMove}),q.addJobForMoveID({jobID:b,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:c,destX:n,destY:p}}),a.postMove&&_.each(a.postMove,function(a){q.addJobForMoveID({jobID:b,jobName:a.jobName,job:a.jobFunction,jobArguments:a.jobArguments})}))}break;case "By Connected Field IDs":n=q.models.CellConnections;e=c.position.x;k=c.position.y;m=n[q.models.GameGrid[k][e].cellID];for(var u=m.length;u--;)p=c.getWorld().getFieldsWithFieldID(m[u],
!0),n=p.position.x,p=p.position.y,!1!==c.getWorld().isEmpty(n,p)&&q.isLegalMove(c,a.conditions,e,k,n,p)&&(b=q.getUniqueMoveID(c.name,a.name,n,p),t.push({type:"MOVE",name:a.name,entity:c,targetX:n,targetY:p,moveClass:"move_standard",freq:d,ID:b,postMove:a.postMove}),q.addJobForMoveID({jobID:b,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:c,destX:n,destY:p}}),a.postMove&&_.each(a.postMove,function(a){q.addJobForMoveID({jobID:b,jobName:a.jobName,job:a.jobFunction,jobArguments:a.jobArguments})}));
break;case "By Field ID":if("DICE"===a.frequency){m=q.getDiceBox().getDiceValues();n=m.length;p=[];u=0;e=-1;var r=!1;e=c.position.x;k=c.position.y;!1===_.isUndefined(c.tmp.fieldID)?(e=c.tmp.fieldID,r=!0):e=c.getWorld().getFieldID(e,k);for(k=n;k--;)"POSITIVE"===a.direction[1]?u=parseInt(e+m[k],10):"NEGATIVE"===a.direction[1]&&(u=parseInt(e-m[k],10)),"By Field ID"===a.type&&0===c.countOpponentsOnFieldsWithID(u,c)&&(p=c.getWorld().getFreeFieldsWithFieldID(u),p[0]?(n=p[0][0],p=12>=u?p[parseInt(p.length-
1,10)][1]:p[0][1],b=q.getUniqueMoveID(c.name,a.name,n,p),t.push({type:"DICE",diceID:k,diceValue:m[k],name:a.name,entity:c,targetX:n,targetY:p,moveClass:"move_standard",freq:"DICE",ID:b,postmove:a.postMove}),!0===r?(q.addJobForMoveID({jobID:b,jobName:"Put the entity to the destination field",job:"Place Entity",jobArguments:{entity:c,xPosition:n,yPosition:p}}),q.addJobForMoveID({jobID:b,jobName:"Remove the current entity from off board area",job:"Delete Entity from OffBoard",jobArguments:{entity:c}})):
q.addJobForMoveID({jobID:b,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:c,destX:n,destY:p}}),q.addJobForMoveID({jobID:b,jobName:"Delete Dice Value",job:"Delete Dice Value",jobArguments:k}),a.postMove&&_.each(a.postMove,function(a){q.addJobForMoveID({jobID:b,jobName:a.jobName,job:a.jobFunction,jobArguments:a.jobArguments})})):c.countOwnOnFieldsWithID(u,c)===c.countFieldsWithID(u)&&(p=c.getWorld().getFieldsWithFieldID(u),p[0]&&(n=p[0].position.x,p=12>=u?p[0].position.y:p[parseInt(p.length-
1,10)].position.y,b=q.getUniqueMoveID(c.name,a.name,n,p),t.push({type:"DICE",diceValue:m[k],name:a.name,entity:c,targetX:n,targetY:p,moveClass:"move_standard",freq:"DICE",ID:b,postmove:a.postMove}),q.addJobForMoveID({jobID:b,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:c,destX:n,destY:p}}),q.addJobForMoveID({jobID:b,jobName:"Delete Dice Value",job:"Delete Dice Value",jobArguments:k}),a.postMove&&_.each(a.postMove,function(a){q.addJobForMoveID({jobID:b,jobName:a.jobName,job:a.jobFunction,
jobArguments:a.jobArguments})}))))}}return t};c.canReachGoal=function(){return!_.isEmpty(c.getGoalMoves())};c.canCapture=function(){for(var a=c.getGoalMoves(),b=a.length;b--;)if("CAPTURE"===a[b].type)return!0;return!1};c.canCaptureAt=function(a,b){var d=c.getGoalMoves(),e,k;for(e=d.length;e--;)if(k=d[e],"CAPTURE"===k.type&&a===k.targetX&&b===k.targetY)return!0;return!1};c.getGoalMoves=function(a){var b,d,e,k=c.countGoals(),m,n;b=null;var p=[],t,q,v,u,r=c.getGame();t=a?a:c.getMoves();m=c.position.x;
n=c.position.y;if(!1===r.models.DiceBox.isEnabled){for(v=k;v--;)a=c.getGoal(v),!0===c.executeGoalByName(a.name)&&(b=c.translateDirection(a.move),d=parseInt(m+b[0],10),e=parseInt(n+b[1],10),b=r.getUniqueMoveID(c.name,a.name,d,e),p.push({ID:b,type:a.type,entity:c,name:a.name,preArrangeX:parseInt(m,10),preArrangeY:parseInt(n,10),targetX:d,targetY:e,moveClass:"move_goal"}));for(u=a=t.length;u--;)if(q=t[u],1<q.freq){r.doVirtualMove(c.position.x,c.position.y,q.targetX,q.targetY);m=q.targetX;n=q.targetY;
for(v=k;v--;)a=c.getGoal(v),a.move===q.name&&!0===c.executeGoalByName(a.name)&&(b=c.translateDirection(a.move),d=parseInt(m+b[0],10),e=parseInt(n+b[1],10),b=r.getUniqueMoveID(c.name,a.name,d,e),p.push({ID:b,type:a.type,entity:c,name:a.name,preArrangeX:parseInt(m,10),preArrangeY:parseInt(n,10),targetX:d,targetY:e,moveClass:"move_goal"}));r.undoVirtualMove()}}else for(t=r.getDiceBox().getDiceValues(),a=t.length,d=0,m=c.getWorld().getFieldID(m,n),!1===_.isUndefined(c.tmp.fieldID)&&(m=c.tmp.fieldID),
n=a;n--;)for(v=k;v--;)a=c.getGoal(v),!0===c.executeGoalByName(a.name,t[n])&&("BEAR OFF MOVE"===a.move?(q=a.area,b=r.getUniqueMoveID(c.name,a.name,q,"bearoff"),r.setMoveID(b),r.getDiceBox().connectMoveIDWithDiceValue(b,n,q),p.push({ID:b,type:"DICE",entity:c,name:a.name,diceID:n,diceValue:t[n],targetArea:q,moveClass:"move_bearoff"}),r.getArea(q).moveID=r.models.moveID):("MOVE POSITIVE"===a.move?d=parseInt(m+t[n],10):"MOVE NEGATIVE"===a.move&&(d=parseInt(m-t[n],10)),q=c.getWorld().getContentOfFieldsWithFieldID(d),
b=_.first(q),0===b&&(b=_.last(q)),q={x:b.position.x,y:b.position.y},b=r.getUniqueMoveID(c.name,a.name,q.x,q.y),r.setMoveID(b),r.getDiceBox().connectMoveIDWithDiceValue(b,n,q),p.push({ID:b,name:a.name,entity:c,type:"DICE",diceValue:t[n],diceID:n,targetX:parseInt(q.x,10),targetY:parseInt(q.y,10),moveClass:"move_goal"})));return p};c.canBeCaptured=function(){for(var a=c.getAssociatedPlayer().getNextOpponentPlayer(),b=a.countEntities(),a=a.getEntities();b--;)if(!0===a[b].canCaptureAt(c.position.x,c.position.y))return!0;
return!1};c.goals=[];c.assembleGoal=function(a){c.goals.push(a)};c.getGoal=function(a){return 0<=a&&a<c.goals.length?c.goals[a]:!1};c.countGoals=function(){return c.goals.length};c.executeGoalByName=function(a,b){if(!1===c.enabled)return!1;var d=c.goals.length,e;for(e=0;e<d;e+=1)if(c.goals[e].name===a){var d=!0,k=0;e=c.goals[e].atoms;for(var m=e.length,k=0;k<m;k+=1)if(d=c.getGame().executeEntityGoalAtomByName(c,e[k],b),!1===d||-1===d)return!1;return!0}return!1};c.goalAtoms=[];c.addGoalAtom=function(a,
b,d){c.goalAtoms.push({atomName:a,atomFunction:b,atomArguments:d})}}})();

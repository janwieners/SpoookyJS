"use strict";var Spoooky=Spoooky||{};Spoooky.Models=function(){var e=this;e.HighlightTable=[],e.JobQueue=[],e.MovableEntities=[],e.MoveTable=[],e.GoalMoves=[],e.MetaAgents=[],e.Entities=[],e.GameRuleAtoms=[],e.GameRules=[],e.GameRuleConsequences=[],e.EntityGoalConsequences=[],e.GameGrid=[],e.CellConnections={},e.SelectRestrictions={entities:"",moves:""},e.OffBoardContent=[],e.DiceBox={isEnabled:!1,dices:[],diceValues:[],attachedMoveIDs:[]},e.Areas={isEnabled:!1,content:[]},e.Blueprints={},e.gameName="",e.recentlyMovedEntity=!1,e.gameState="INGAME",e.moveCounter=0,e.currentPlayerID=-1,e.description="",e.moveID=0,e.lastMoveID=0,e.worldDimensions={rows:0,columns:0},e.winnerID=!1,e.playVirtual=!1,e.playerChange=!0,e.gameMode="MOVING",e.tmpGameMode="",e.gameRounds=0},Spoooky.Game=function(){var f=this;f.initialize=function(e){return f.models=new Spoooky.Models,f.gameWorld=new Spoooky.GridWelt(f),f.setName(e),f.jobQueue=new Spoooky.JobQueue(f),f.diceBox=new Spoooky.DiceBox(f),f.areas=new Spoooky.Areas(f),f.offBoard=new Spoooky.OffBoard(f),f},f.setupGridWorld=function(e,t,n){f.gameWorld.setup2D(e,t),f.gameWorld.setupGameBoard(n)},f.connectGridWeltView=function(e){f.viewScope=e},f.statsScope=null,f.connectStatsView=function(e){f.statsScope=e},f.refreshStatsView=function(e){f.statsScope.update(e)},f.graphScope=null,f.connectGraphView=function(e){f.graphScope=e},f.refreshGraphView=function(e,t){f.graphScope.updateGraphs(e,t)},f.evaluateGameState=function(e){var t=0;return"END"===f.models.gameState&&(t=f.models.winnerID===e?1:!1===f.models.winnerID?.5:0),t},f.stringifyModels=function(){return JSON.stringify(f.models)},f.clone=function(e){var t=new Spoooky.Game;t.initialize("COPY"),t.models=e?JSON.parse(e):JSON.parse(f.stringifyModels());var n,o,r,i,a,s=t.models,l=t.models.MetaAgents.length;for(n=l;n--;)o=new Spoooky.MetaAgent(t),_.extend(o,s.MetaAgents[n]),s.MetaAgents[n]=o;for(n=l=s.Entities.length;n--;)for(a=(o=s.Entities[n]).length;a--;)i=o[a],r=new Spoooky.Entity(i.name,i.ID,i.typeID,t),_.extend(r,i),s.Entities[n][a]=r;return t.models.playVirtual=!0,t.setName("GAME_COPY"),t},f.models=null,f.flush=function(e){e.length=0},f.setWinnerID=function(e){f.models.winnerID=e},f.getWinnerID=function(){return f.models.winnerID},f.jobQueue=null,f.MovableEntities=null,f.areas=null,f.addArea=function(e){null===f.areas&&(f.areas=new Spoooky.Areas),f.areas.addArea(e)},f.getArea=function(e){return f.areas.getArea(e)},f.addBlueprint=function(e,t,n){return f.models.Blueprints[t.entityType]=_.clone(t),e&&e.associateEntity(f.models.Blueprints[t.entityType],n),f.models.Blueprints[t.entityType]},f.extendBlueprint=function(e,t){_.extend(e,t)},f.getBlueprints=function(){return f.models.Blueprints},f.getBlueprint=function(e){return f.getBlueprints()[e]},f.setRecentlyMovedEntity=function(e,t){var n=f.gameWorld.peekCell(e,t),o="default";f.isGoalMove(e,t)&&(o="capture"),n?(f.models.recentlyMovedEntity={entityID:n.ID,playerID:n.getMetaPlayerID()},n.addExecutedMove(e,t,f.models.moveCounter,o)):f.models.recentlyMovedEntity=!1},f.getrecentlyMovedEntity=function(){if(f.models.recentlyMovedEntity){var e=f.models.recentlyMovedEntity;return f.getPlayerWithID(e.playerID).getEntityWithID(e.entityID)}return!1},f.addDice=function(e,t){f.getDiceBox().enable(),f.getDiceBox().createDice(e,t)},f.diceBox=null,f.getDiceBox=function(){return f.diceBox},f.offBoard=null,f.setName=function(e){f.models.gameName=e||""},f.getName=function(){return f.models.gameName},f.setDescription=function(e){f.models.description=e},f.getDescription=function(){return f.models.description},f.setMoveID=function(e){f.models.moveID=e},f.setLastMoveID=function(){f.models.lastMoveID=f.models.moveID},f.getLastMoveID=function(){return f.models.lastMoveID},f.gameWorld=null,f.getGameWorld=function(){return f.gameWorld},f.loop=function(e,t,n){if("END"!==f.models.gameState){switch(f.models.gameMode){case"MOVING":(e?f.areas.isMove(e):f.isMove(t,n))?(e?f.executeJobsForMoveID(f.areas.getMoveID(e)):f.executeJobsForThisMove(t,n),f.executeGameRules()?f.executeJobsForRecentMove():f.proceed()):f.showEntityMoves(t,n);break;case"PLACING":case"FREE CAPTURE":f.showFieldsToPlaceEntity(),f.isMove(t,n)&&(f.executeJobsForThisMove(t,n),f.executeGameRules()?f.executeJobsForRecentMove():f.proceed())}f.executePostMoveJobs()}f.playArtificial()},f.playArtificial=function(){!1===f.models.playVirtual&&"ARTIFICIAL"===f.getCurrentPlayerType()&&"END"!==f.models.gameState&&f.artificialTurn()},f.pseudoLoop=function(){f.loop(!1,null,null)},f.proceed=function(){f.models.playerChange&&(f.setNextPlayer(),f.setGameState("INGAME")),f.resetMoves()},f.setGameMode=function(e){f.models.tmpGameMode=f.models.gameMode,f.models.gameMode=e},f.checkGoalMove=function(e,t){f.isGoalMove(e,t)},f.setGameState=function(e){f.models.gameState=e},f.getGameState=function(){return f.models.gameState},f.addPlayer=function(e){f.models.Entities[e.ID]=[],f.models.MetaAgents.push(e),1===f.models.MetaAgents.length&&f.setPlayer(e)},f.createPlayer=function(e){var t=new Spoooky.MetaAgent(f);return t.setID(f.models.MetaAgents.length),e&&(t.setName(e.name),t.setType(e.type)),"ARTIFICIAL"===t.type&&t.assembleAgents(),f.addPlayer(t),t},f.setCurrentPlayerID=function(e){f.models.currentPlayerID=e},f.setPlayer=function(e){f.setCurrentPlayerID(e.ID)},f.getCurrentPlayerID=function(){return f.models.currentPlayerID},f.getNextPlayerID=function(){var e=f.getCurrentPlayerID();return e<f.models.MetaAgents.length-1?e+1:0},f.getCurrentPlayerName=function(){return f.getCurrentPlayer().getName()},f.getCurrentPlayerType=function(){return f.getPlayerWithID(f.getCurrentPlayerID()).type},f.setNextPlayer=function(){var e=f.getCurrentPlayerID(),t=f.models;e<t.MetaAgents.length-1?f.setCurrentPlayerID(e+1):f.setCurrentPlayerID(0),f.resetMoves(),t.gameRounds++},f.getPlayerWithID=function(e){return f.models.MetaAgents[e]},f.getPlayerWhoOwnsEntity=function(e){for(var t=f.getPlayers(),n=t.length,o=0;o<n;o+=1)if(!0===t[o].hasEntity(e))return t[o];return!1},f.informArtificialPlayersAboutGameEnd=function(){for(var e=f.getPlayers(),t=e.length;t--;)"ARTIFICIAL"===e[t].type&&e[t].gameHasEnded()},f.getPlayers=function(){return f.models.MetaAgents},f.getAIPlayers=function(){var e,t=f.models.MetaAgents,n=[];for(e=0;e<t.length;e++)"ARTIFICIAL"===t[e].type&&n.push(t[e]);return n},f.getCurrentPlayer=function(){return f.getPlayerWithID(f.getCurrentPlayerID())},f.assembleGameRule=function(e){f.models.GameRules.push(e)},f.getGameRule=function(e){return 0<=e&&e<f.models.GameRules.length&&f.models.GameRules[e]},f.countGameRules=function(){return f.models.GameRules.length},f.executeGameRuleByName=function(e){for(var t,n=f.models.GameRules.length,o=!1,r=0,i=0,a=0;a<n;a+=1)if(f.models.GameRules[a].name===e){for(o=!0,i=(r=f.models.GameRules[a].atoms).length,t=0;t<i;t+=1)if(!1===(o=f.executeGameRuleAtomByName(r[t]))||-1===o)return!1;return o}return!1},f.addGameRuleAtom=function(e){f.models.GameRuleAtoms.push({atomName:e.atomName,atomFunction:e.atomFunction,atomArguments:e.atomArguments,atomCondition:e.atomCondition,atomConnector:e.atomConnector})},f.entityAtomFunctions={"Is Opponent":function(e,t){var n=e.translateDirection(t.atomArguments),o=parseInt(e.position.x+n[0],10),r=parseInt(e.position.y+n[1],10);return e.isOpponent(o,r)},"Is Empty Cell":function(e,t){var n=e.translateDirection(t.atomArguments),o=parseInt(e.position.x+n[0],10),r=parseInt(e.position.y+n[1],10);return e.isEmptyCell(o,r)},"Current Y Position Is":function(e,t){return e.position.y===t.atomArguments},"Current X Position Is":function(e,t){return e.position.x===t.atomArguments},"Entity Is Able To Reach A Specific Row":function(e,t){var n=t.atomArguments[0];"last"===n?n=parseInt(f.gameWorld.getRows()-1,10):"first"===n&&(n=0);var o=e.translateDirection(t.atomArguments[1]),r=parseInt(e.position.x+o[0],10),i=parseInt(e.position.y+o[1],10);return!1!==f.gameWorld.isEmpty(r,i)&&n===i},"Entity At Cell Is Of Type":function(e,t){var n=e.translateDirection(t.atomArguments),o=parseInt(e.position.x+n[0],10),r=parseInt(e.position.y+n[1],10),i=e.getGame().gameWorld.peekCell(o,r);return!1!==i&&i.type===t.atomArguments[2]},"Entity At Cell Has Been Moved n Times":function(e,t){var n=e.translateDirection(t.atomArguments),o=parseInt(e.position.x+n[0],10),r=parseInt(e.position.y+n[1],10),i=e.getGame().gameWorld.peekCell(o,r);return!1!==i&&i.getMoveCount()===t.atomArguments[2]},"Entity At Cell Has Been Moved In Last Game Round":function(e,t){var n=e.translateDirection(t.atomArguments),o=parseInt(e.position.x+n[0],10),r=parseInt(e.position.y+n[1],10),i=e.getGame().gameWorld.peekCell(o,r);return!1!==i&&i.getLastExecutedMove().round===e.getGame().models.moveCounter},"Is Not Attackable In Next Round":function(e,t){var n=e.translateDirection(t.atomArguments),o=parseInt(e.position.x+n[0],10),r=parseInt(e.position.y+n[1],10);return!e.getGame().opponentEntityCanCaptureAt(o,r,e)},"Number Of Opponents At Destination Field Is":function(e,t,n){var o=0,r=e.position.x,i=e.position.y,a=t.atomArguments[0],s=t.atomArguments[1],l=e.getGame().gameWorld.getFieldID(r,i);return!1===_.isUndefined(e.tmp.fieldID)&&(l=e.tmp.fieldID),"MOVE POSITIVE"===a?o=parseInt(l+n,10):"MOVE NEGATIVE"===a&&(o=parseInt(l-n,10)),e.countOpponentsOnFieldsWithID(o,e)===s},"No Own Entitys On Fields With ID Less Than":function(e,t){var n=t.atomArguments;return!e.getAssociatedPlayer().hasEntitiesOnFieldWithFieldID(n,"<")},"No Own Entitys On Fields With ID More Than":function(e,t){var n=t.atomArguments;return!e.getAssociatedPlayer().hasEntitiesOnFieldWithFieldID(n,">")},"Destination Field ID Is Greater Than":function(e,t,n){var o=0,r=e.position.x,i=e.position.y,a=t.atomArguments[0],s=e.getGame().gameWorld.getFieldID(r,i);return!1!==_.isUndefined(e.tmp.fieldID)&&("MOVE POSITIVE"===a?o=parseInt(s+n,10):"MOVE NEGATIVE"===a&&(o=parseInt(s-n,10)),o>t.atomArguments[1])},"Destination Field ID Is Less Than":function(e,t,n){if(!1===_.isUndefined(e.tmp.fieldID))return!1;var o=0,r=e.position.x,i=e.position.y,a=t.atomArguments[0],s=e.getGame().gameWorld.getFieldID(r,i);return"MOVE POSITIVE"===a?o=parseInt(s+n,10):"MOVE NEGATIVE"===a&&(o=parseInt(s-n,10)),o<t.atomArguments[1]}},f.executeEntityGoalAtomByName=function(e,t,n){if(!1===e.enabled)return!1;var o,r,i=e.goalAtoms.length;for(o=0;o<i;o+=1)if(e.goalAtoms[o].atomName===t)return r=e.goalAtoms[o],f.entityAtomFunctions[r.atomFunction](e,r,n);return!1},f.getAssociatedOpponentEntities=function(e){for(var t,n,o,r,i,a=e,s={},l=f.gameWorld,u=a.length,g=f.getCurrentPlayer().getNextOpponentPlayer().getOnBoardEntities(),c=g.length;c--;)i=(t=g[c]).position,s[l.getFieldID(i.x,i.y)]={ID:t.ID,x:i.x,y:i.y,associated:!1};for(;u--;){for(c=0,r=n=(o=a[u]).length;r--;)s[o[r]]&&c++;if(c===n)for(r=n;r--;)s[o[r]].associated=!0}return s},f.gameRuleAtoms={"Last Move Was Capture Move":function(){if(f.getrecentlyMovedEntity())return"capture"===f.getrecentlyMovedEntity().getLastExecutedMove().type},"Recently Moved Entity Can Capture An Opponent Entity":function(){if(f.getrecentlyMovedEntity())return f.getrecentlyMovedEntity().canCapture()},"Recently Moved Entity Can Not Capture An Opponent Entity":function(){if(f.getrecentlyMovedEntity())return!f.getrecentlyMovedEntity().canCapture()},"Recently Moved Entity Is Owned By Player":function(e){if(f.getrecentlyMovedEntity())return f.getrecentlyMovedEntity().getMetaPlayerID()===e.atomArguments},"Recently Moved Entity Is At YPosition":function(e){var t=e.atomArguments;if("last"===t?t=parseInt(f.gameWorld.getRows()-1,10):"first"===t&&(t=0),!1!==f.getrecentlyMovedEntity())return f.getrecentlyMovedEntity().getPosition().y===t},"Recently Moved Entity Is At XPosition":function(e){var t=e.atomArguments;if("last"===t&&(t=f.gameWorld.getColumns()-1),!1!==f.getrecentlyMovedEntity())return f.getrecentlyMovedEntity().getPosition().x===t},"Recently Moved Entity Is Type":function(e){var t=e.atomArguments,n=f.getrecentlyMovedEntity(),o=0,r=e.atomConnector,i=0;if(0!==n)switch(o=n.type,r){case"OR":for(i=t.length;i--;)if(o===t[i])return!0;return!1;case"AND":for(i=t.length;i--;)if(o!==t[i])return!1;return!0;default:return o===t}},"Player Has Entities":function(e){return 0!==f.getPlayerWithID(e.atomArguments).countEntities()},"All players have placed their entities on the game board":function(){for(var e,t,n=f.getPlayers(),o=n.length;o--;)for(t=(e=n[o].getEntities()).length;t--;)if(!e[t].onBoard)return!1;return!0},"Game Mode Is Not":function(e){return f.models.gameMode!==e.atomArguments},"Player Has Entities On Nearby Connected Fields After Last Move":function(e){var t=f.getrecentlyMovedEntity().position;if(!t)return!1;for(var n,o,r,i,a,s=e.atomArguments,l=f.gameWorld,u=f.models.recentlyMovedEntity.playerID,g=f.models.GameGrid[t.y][t.x].cellID,c=s.length;c--;)for(i=(r=s[c]).length;i--;)if(o=!0,g===r[i]){for(a=r.length;a--;){if(!(0<(n=l.getFieldsWithFieldID(r[a],!0)).contains.length)){o=!1;break}if(n.contains[0].playerID!==u){o=!1;break}}if(o)return!0}return!1},"Non-associated Opponent Entities":function(e){var t,n=f.getAssociatedOpponentEntities(e.atomArguments);for(t in n)if(!n[t].associated)return!0;return!1},"Player Has No Placeable Entities":function(e){return!(0<f.getPlayerWithID(e.atomArguments).getPlaceableEntities().length)},"Player Has No Movable Entities":function(e){var t,n=f.getPlayerWithID(e.atomArguments),o=n.countEntities();if(0===o)return!0;for(t=o;t--;)if(!0===f.checkSelectCondition(n.getEntityFromArray(t))&&n.getEntityFromArray(t).canMove())return!1;for(t=o;t--;)if(!0===f.checkSelectCondition(n.getEntityFromArray(t))&&n.getEntityFromArray(t).canReachGoal())return!1;return!0},"Player Has Entities In Off Board Area":function(e){return f.offBoard.entitiesOfPlayerAreOutside(e.atomArguments)},"Player Has No Entities In Off Board Area":function(e){return!f.offBoard.entitiesOfPlayerAreOutside(e.atomArguments)},"Player Has No Entities":function(e){return 0===f.getPlayerWithID(e.atomArguments).countEntities()},"Player Has Number Of Entities":function(e){return f.getPlayerWithID(e.atomArguments[0]).countEntities()===e.atomArguments[1]},"Player Owns > n Entities":function(e){var t=e.atomArguments;return f.getPlayerWithID(t.playerID).getEntities().length>t.value},"Player Has No Entity Which Satisfies Goals":function(e){var t,n=f.getPlayerWithID(e.atomArguments),o=n.countEntities();if(0===o)return!0;for(t=o;t--;)if(!_.isEmpty(n.getEntityFromArray(t).canReachGoal()))return!1;return!0},"Player Has Number Of Entities In Row":function(e){var t=e.atomArguments.entityID,n=e.atomArguments.number,o=f.gameWorld.createBoardSignature();return new RegExp(t+"{"+n+"}").test(o)},"Player Has Number Of Entities In Column":function(e){var t=e.atomArguments.entityID,n=e.atomArguments.number,o=f.gameWorld.createBoardSignatureByVertical();return new RegExp(t+"{"+n+"}").test(o)},"Player Has Number Of Entities Diagonally":function(e){var t,n,o,r="",i=f.gameWorld,a=i.getRows(),s=i.getColumns(),l=e.atomArguments.number,u=e.atomArguments.entityID,g=new RegExp(u+"{"+l+"}"),c=f.gameWorld.createBoardSignature();for(t=0;t<s;t++){for(r="",o=t;o<c.length&&"|"!==c[o];o+=s+2)r+=c[o];if(!0===g.test(r))return!0}for(n=1;n<a;n++){for(r="",o=n*s+n;o<c.length&&"|"!==c[o];o+=s+2)r+=c[o];if(!0===g.test(r))return!0}for(n=1;n<a;n++){for(r="",o=n*s+n;0<o&&"|"!==c[o];o-=s)r+=c[o];if(!0===g.test(r))return!0}for(t=3;t<=s;t++){for(r="",o=a*s+a-t;0<o&&"|"!==c[o];o-=s)r+=c[o];if(!0===g.test(r))return!0}return!1},"No Empty Field On The Game Board":function(){return 0===f.gameWorld.getFreeCells().length},"Current Player Is":function(e){return f.getPlayerWithID(e.atomArguments).ID===f.getCurrentPlayerID()},"Print Debug Message":function(e){return!0},"Game State Is":function(e){return e.atomArguments===f.models.gameState},"Dice Box Is Empty":function(){return f.getDiceBox().gotNoDiceValues()},"Entity Is Under Attack":function(e){return f.entityOfSpecificTypeIsUnderAttack(e.atomArguments)},"Got No Protecting Entities":function(e){return!f.identifyProtectingEntities(e.atomArguments.entityType)},"Every Entity Of Player Is In Target Area":function(e){var t,n,o=f.getPlayerWithID(e.atomArguments.player),r=o.countEntities(),i=e.atomArguments.targetArea,a=i.length,s=!1;if(0===r)return!1;for(t=0;t<a;t+=1){for(s=!1,n=0;n<r;n+=1)o.getEntityFromArray(n).position.x===i[t].x&&o.getEntityFromArray(n).position.y===i[t].y&&(s=!0);if(!1===s)return!1}return!0}},f.executeGameRuleAtomByName=function(e){var t,n;for(n=f.models.GameRuleAtoms.length;n--;)if(f.models.GameRuleAtoms[n].atomName===e)return t=f.models.GameRuleAtoms[n],f.gameRuleAtoms[t.atomFunction](t);return!1},f.connectGameRuleConsequences=function(e){for(var t=e.ruleName,n="",o="",r=e.consequences,i=r.length;i--;)r[i].execute="immediately";e.entityName&&(n=e.entityName),e.entityType&&(o=e.entityType),f.models.GameRuleConsequences.push({goalName:t,entityName:n,entityType:o,consequences:r})},f.getGameRuleConsequencesWithName=function(e){for(var t,n=[],o=f.models.GameRuleConsequences,r=o.length;r--;)(t=o[r]).goalName===e&&(t.entityName&&!1!==f.getrecentlyMovedEntity()&&(t.entityName=f.getrecentlyMovedEntity().getName()),t.entityType&&!1!==f.getrecentlyMovedEntity()&&(t.entityType=f.getrecentlyMovedEntity().type),t.consequences.entityLink=f.getrecentlyMovedEntity(),n.push(t));return n.reverse(),n},f.executeGameRuleConsequences=function(e){for(var t=f.getGameRuleConsequencesWithName(e),n=t.length,o=0;o<n;o+=1)f.addJobs(t[o].consequences)},f.executeGameRules=function(){f.resetRestrictions();var e,t,n=f.countGameRules(),o=!1;for(e=0;e<n;e++)t=f.getGameRule(e),!0===f.executeGameRuleByName(t.name)&&(f.executeGameRuleConsequences(t.name),o=!0);return o},f.getUniqueMoveID=function(e,t,n,o){return e+"_"+t+"_"+n+"|"+o},f.moveEntity=function(e,t,n,o,r){f.gameWorld.moveEntity(e,t,n,o,r)},f.deleteEntityAt=function(e,t){f.gameWorld.deleteCellContent(e,t)},f.countFieldsWithID=function(e){return f.gameWorld.getContentOfFieldsWithFieldID(e).length},f.countOwnOnFieldsWithID=function(e,t){var n,o=f.gameWorld.getContentOfFieldsWithFieldID(e),r=0,i=0,a=o.length;for(n=0;n<a;n+=1)(i=o[n])&&i.getMetaPlayerID()===t.getMetaPlayerID()&&(r+=1);return r},f.countOpponentsOnFieldsWithID=function(e,t){var n,o=f.gameWorld.getContentOfFieldsWithFieldID(e),r=0,i=0,a=o.length;for(n=0;n<a;n+=1)(i=o[n])&&i.getMetaPlayerID()!==t.getMetaPlayerID()&&(r+=1);return r},f.resetRestrictions=function(){f.models.SelectRestrictions.entities="",f.models.SelectRestrictions.moves=""},f.checkSelectCondition=function(e){if("Recently Moved Entity"===f.models.SelectRestrictions.entities)return f.getrecentlyMovedEntity().getName()===e.getName();if(_.isUndefined(e.selectCondition))return!0;if("Only Off Board Entities"===f.models.SelectRestrictions.entities)return null===e.position.x||null===e.position.y;var t=e.selectCondition,n=!1;if(t.neighboursY){var o,r,i=0,a={"<":function(e,t){return e<t},"<=":function(e,t){return e<=t},">":function(e,t){return t<e},">=":function(e,t){return t<=e},"==":function(e,t){return e==t}};for(o=t.neighboursY.length;o--;)switch((i=(r=t.neighboursY[o]).appliesTo).axis){case"y":if(a[i.operator](e.position.y,i.value)){var s=r.count,l=r.direction,u=r.condition,g=0;switch(l){case"NORTH":g=f.gameWorld.countNeighboursNorth(e);break;case"SOUTH":g=f.gameWorld.countNeighboursSouth(e);break;case"BOTH":default:g=f.gameWorld.countNeighboursY(e)}switch(u){case"LESS THAN OR EQUAL TO":case"<=":g<=s&&(n=!0);break;case"LESS THAN":case"<":g<s&&(n=!0);break;case"MORE THAN OR EQUAL TO":case">=":s<=g&&(n=!0);break;case"MORE THAN":case">":s<g&&(n=!0);break;case"EQUAL":case"=":case"==":case"===":g===s&&(n=!0)}}}}return n},f.showEntityMoves=function(e,t){var n=f.gameWorld.peekCell(e,t);if(!1===n)return!1;if(_.isUndefined(n))return!1;if(f.isHighlighted(n))return f.resetMoves(),!1;if(n.getMetaPlayerID()!==f.getCurrentPlayerID())return!1;if(!0===f.checkSelectCondition(n)){var o,r;switch(f.resetMoves(),f.models.SelectRestrictions.moves){case"Standard Moves":o=n.getMoves();break;case"Capture Moves":r=n.getGoalMoves(o);break;default:o=n.getMoves(),r=n.getGoalMoves(o)}f.performPostMoveChecks(n,o),f.performPostMoveChecks(n,r),_.isEmpty(o)&&_.isEmpty(r)||f.highlightEntityAtPosition(e,t),f.highlightStandardMoves(o),f.highlightGoalMoves(r)}return!0},f.showFieldsToPlaceEntity=function(){"PLACING"===f.models.gameMode?f.highlightStandardMoves(f.getCurrentPlayer().getAllEntityMoves()):"FREE CAPTURE"===f.models.gameMode&&f.highlightGoalMoves(f.getCurrentPlayer().getAllEntityMoves())},f.highlightStandardMoves=function(e){if(!_.isUndefined(e))for(var t,n=e.length;n--;)t=e[n],f.highlightCell(t.targetX,t.targetY,t.moveClass,t.ID),f.models.MoveTable.push({entity:t.entity,xPosition:t.targetX,yPosition:t.targetY,moveClass:t.moveClass,moveID:t.ID})},f.highlightGoalMoves=function(e){if(!_.isUndefined(e))for(var t,n,o=e.length;o--;)switch((t=e[o]).type){case"DICE":"move_bearoff"===t.moveClass?f.executeGoalConsequences(t.name,t.entity,!1):(n=t.entity,f.setMoveID(f.getDiceBox().getMoveIDForDiceID(t.diceID)),n.setTarget(t.targetX,t.targetY),f.executeGoalConsequences(t.name,n,!1),n.unsetTarget());break;case"FREE CAPTURE":f.addJobForMoveID({jobID:t.ID,jobName:"Highlight Cell",job:"Highlight Cell",jobArguments:[t.targetX,t.targetY,"move_goal","ABSOLUTE"],execute:"immediately"}),f.addJobForMoveID({jobID:t.ID,jobName:"Delete Opponent Entity",job:"Capture Opponent At",jobArguments:[t.targetX,t.targetY,"ABSOLUTE"]}),f.addJobForMoveID({jobID:t.ID,jobName:"Reset Game Mode",job:"Reset Game Mode"});break;default:var r=[],i=(n=t.entity).position.x,a=n.position.y;r.x=i,r.y=a,f.doVirtualMove(i,a,t.preArrangeX,t.preArrangeY),f.executeGoalConsequences(t.name,n,r),f.undoVirtualMove()}},f.performPostMoveChecks=function(e,t){if(null!==e.postMoveCheck)for(var n,o,r,i=e.postMoveCheck,a=0;a<t.length;a++)for(r=0;r<i.length;r++)"Entity Is Attackable After Move"===(n=i[r]).condition&&(o=t[a].entity,f.doVirtualMove(o.position.x,o.position.y,t[a].targetX,t[a].targetY),f.entityOfTypeIsUnderAttack(n.entity,o.getAssociatedPlayer())&&(t.splice(a,1),a-=1),f.undoVirtualMove())},f.resetMoves=function(){var e,t,n=f.gameWorld,o=f.models,r=o.MoveTable,i=o.HighlightTable;for(t=r.length;t--;)e=r[t],n.setCellClass(e.xPosition,e.yPosition,"");for(o.MoveTable.length=0,o.GoalMoves.length=0,o.MovableEntities.length=0,t=i.length;t--;)e=i[t],n.setCellClass(e.x,e.y,"");f.flush(o.HighlightTable),null!==f.areas&&f.areas.isEnabled()&&f.areas.resetDisplays(),null!==f.getDiceBox()&&f.getDiceBox().flushAttachedMoveIDs()},f.isHighlighted=function(e){var t,n,o=f.models.HighlightTable,r=o.length,i=e.position.x,a=e.position.y;for(t=0;t<r;t+=1)if((n=o[t]).x===i&&n.y===a)return!0;return!1},f.highlightEntityAtPosition=function(e,t){f.gameWorld.isValidCoordinate(e,t)&&(f.models.HighlightTable.push({x:e,y:t}),f.gameWorld.setCellClass(e,t,"clickedEntity"))},f.highlightCell=function(e,t,n,o){f.gameWorld.setCellClass(e,t,n),f.models.HighlightTable.push({x:e,y:t}),"move_goal"===n&&(f.models.MoveTable.push({entity:null,xPosition:e,yPosition:t,moveClass:n,moveID:o}),f.models.GoalMoves.push({entity:null,xPosition:e,yPosition:t}))},f.virtualMove=[],f.doVirtualMove=function(e,t,n,o){var r=f.gameWorld,i={srcX:e,srcY:t,srcEntity:r.popFromCell(e,t),destX:n,destY:o,destEntity:r.popFromCell(n,o)};if(f.virtualMove.push(i),i.destEntity&&null!==i.destEntity&&i.destEntity.setPosition(null,null),i.srcEntity){var a=i.srcEntity;r.pushToCell({entityID:a.ID,playerID:a.getMetaPlayerID(),typeID:a.getTypeID()},n,o),a.setPosition(n,o,!0)}},f.undoVirtualMove=function(){var e=f.virtualMove.pop();if(!e)return!1;var t=e.srcEntity;t&&null!==t&&(f.gameWorld.popFromCell(e.destX,e.destY),t.setPosition(e.srcX,e.srcY),f.gameWorld.pushToCell({entityID:t.ID,playerID:t.getMetaPlayerID(),typeID:t.getTypeID()},e.srcX,e.srcY));var n=e.destEntity;return n&&null!==n&&(n.setPosition(e.destX,e.destY),f.gameWorld.pushToCell({entityID:n.ID,playerID:n.getMetaPlayerID(),typeID:n.getTypeID()},e.destX,e.destY)),!0},f.moveConditions={"Is Empty":function(e,t){return f.gameWorld.isEmpty(e._destX,e._destY)===t},"Is Empty At":function(e,t,n){return!f.gameWorld.isEmpty(parseInt(e._curX+e._conditions[n].relativeCoordinate[0],10),parseInt(e._curY+e._conditions[n].relativeCoordinate[1],10))!==t},"Is Not The Last Row":function(e){return e._destY!==parseInt(f.gameWorld.getRows()-1,10)},"Is Not The First Row":function(e){return 0!==e._destY},"Move Count":function(e,t,n){return e._currentEntity.getMoveCount()===e._conditions[n].value},"Move Count Of Entity":function(e,t,n){var o=f.getCurrentPlayer().getEntityWithName(e._conditions[n].entityName);return!1!==o&&o.getMoveCount()===e._conditions[n].value},"Player Owns n Entities":function(e,t,n){return f.getPlayerWithID(e._conditions[n].playerID).getEntities().length===e._conditions[n].value},"Player Owns > n Entities":function(e,t,n){return f.getPlayerWithID(e._conditions[n].playerID).getEntities().length>e._conditions[n].value},"Game State":function(e,t,n){return f.models.gameState===e._conditions[n].value&&!0===t||f.models.gameState!==e._conditions[n].value&&!1===t},"Field Is Attackable By Opponent Entity":function(e,t,n){var o=e._conditions[n],r=parseInt(e._curX+o.relativeCoordinate[0],10),i=parseInt(e._curY+o.relativeCoordinate[1],10);return f.doVirtualMove(e._curX,e._curY,r,i),t===f.opponentEntityCanCaptureAt(r,i,e._currentEntity)?(f.undoVirtualMove(),!0):(f.undoVirtualMove(),!1)},"Target Field Is Reachable By Opponent Entity":function(e,t,n){var o=f.getCurrentPlayer().getNextOpponentPlayer().getEntitiesOfType(e._conditions[n].opponentEntity),r=o.length;if(0===r)return!0;for(var i,a,s,l,u,g,c,m=null,d=r;d--;)for(l=(i=o[d]).position.x,u=i.position.y,a=i.countGoals();a--;)if(s=i.getGoal(a),m=i.translateDirection(s.move),g=parseInt(l+m[0],10),c=parseInt(u+m[1],10),g===e._destX&&c===e._destY)return!1;return!0},yPosition:function(e,t,n){return e._curY===e._conditions[n].value&&!0===t},xPosition:function(e,t,n){return e._curX===e._conditions[n].value&&!0===t}},f.isLegalMove=function(e,t,n,o,r,i){if(!1===f.gameWorld.isValidCoordinate(r,i))return!1;var a,s,l;for(s=t.length,l={_currentEntity:e,_conditions:t,_curX:n,_curY:o,_destX:r,_destY:i},a=0;a<s;a+=1)if(!1===f.moveConditions[t[a].condition](l,t[a].state,a))return!1;return!0},f.viewScope=null,f.refreshView=function(){f.models.playVirtual||f.viewScope.$apply()},f.executeRandomMove=function(){var e=f.getCurrentPlayer().getAllEntityMoves(),t=e[_.random(0,parseInt(e.length-1,10))];f.executeMove(t)},f.executeArtificialMove=function(e){if("random"===e)return f.executeRandomMove(),!0;var t=f.getCurrentPlayer().getAllEntityMoves()[e.moveIndex];return f.executeMove(t),!0},f.executeMove=function(t){if("END"===f.models.gameState)return!1;var e,n,o=!1;if("move_goal"===t.moveClass||"move_bearoff"===t.moveClass)if(e=t.entity,"DICE"===t.type)"move_bearoff"===t.moveClass?(f.executeGoalConsequences(t.name,e,!1),o=t.targetArea):(f.setMoveID(f.getDiceBox().getMoveIDForDiceID(t.diceID)),e.setTarget(t.targetX,t.targetY),f.executeGoalConsequences(t.name,e,!1),e.unsetTarget());else{var r=[];n=e.position,"FREE CAPTURE"===t.type||(r.x=n.x,r.y=n.y,f.doVirtualMove(n.x,n.y,t.preArrangeX,t.preArrangeY),f.executeGoalConsequences(t.name,e,r),f.undoVirtualMove()),t.targetX=f.models.HighlightTable[0].x,t.targetY=f.models.HighlightTable[0].y}else{if(f.models.MoveTable.push({entity:t.entity,xPosition:t.targetX,yPosition:t.targetY,moveClass:t.moveClass,moveID:t.ID}),"DICE"===t.type){var i=!1,a=t.targetX,s=t.targetY;e=t.entity,!1===_.isUndefined(e.tmp.fieldID)&&(i=!0),!0===i?(f.addJobForMoveID({jobID:t.ID,jobName:"Put the entity to the destination field",job:"Place Entity",jobArguments:{entity:e,xPosition:a,yPosition:s}}),f.addJobForMoveID({jobID:t.ID,jobName:"Remove the current entity from off board area",job:"Delete Entity from OffBoard",jobArguments:{entity:e}})):f.addJobForMoveID({jobID:t.ID,jobName:"move game entity",job:"Move Entity By Dice Value",jobArguments:{entity:t.entity,destX:t.targetX,destY:t.targetY,diceValue:t.diceValue}}),f.addJobForMoveID({jobID:t.ID,jobName:"Delete Dice Value",job:"Delete Dice Value",jobArguments:t.diceID})}else"PLACING"!==f.models.gameMode&&f.addJobForMoveID({jobID:t.ID,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:t.entity,destX:t.targetX,destY:t.targetY}});t.postMove&&_.each(t.postMove,function(e){f.addJobForMoveID({jobID:t.ID,jobName:e.jobName,job:e.jobFunction,jobArguments:e.jobArguments})})}return f.loop(o,t.targetX,t.targetY),f.refreshView(),!0},f.artificialTurn=function(){return"WAITINGFORDICEROLL"===f.models.gameState&&(Spoooky.GameEvents.fireEvent({job:"Roll Backgammon Dices"},f),"WAITINGFORDICEROLL"===f.models.gameState)?(f.pseudoLoop(),!1):(f.getCurrentPlayer().artificialMove(),!0)},f.addJobs=function(e){for(var t,n,o=0;o<e.length;o++)n=e[o],t={jobID:f.models.moveID,jobName:n.jobName,job:n.jobFunction,jobArguments:n.jobArguments,entityLink:e.entityLink},n.execute?"immediately"===n.execute&&Spoooky.GameEvents.fireEvent(t,f):f.addJobForMoveID(t);return!(f.models.moveID=0)},f.addJobForMoveID=function(e){return e.execute&&"immediately"===e.execute?Spoooky.GameEvents.fireEvent(e,f):f.jobQueue.addJob(e),!0},f.isMove=function(e,t){for(var n,o=f.models.MoveTable,r=o.length;r--;)if((n=o[r]).xPosition===e&&n.yPosition===t&&0!==n.moveID)return!0;return f.isGoalMove(e,t)},f.isGoalMove=function(e,t){for(var n=f.models.GoalMoves,o=n.length;o--;)if(n[o].xPosition===e&&n[o].yPosition===t)return!0;return!1},f.getMoveID=function(e,t){for(var n,o=f.models.MoveTable,r=o.length;r--;)if((n=o[r]).xPosition===e&&n.yPosition===t&&0!==n.moveID)return n.moveID;return!1},f.executeJobsForThisMove=function(e,t){f.executeJobsForMoveID(f.getMoveID(e,t)),f.setRecentlyMovedEntity(e,t)},f.executeJobsForRecentMove=function(){f.resetMoves(),f.executeJobsForMoveID(f.models.lastMoveID)},f.executeJobsForMoveID=function(e){for(var t=f.jobQueue.getJobsWithMoveID(e),n=t.length,o=0;o<n;o++)Spoooky.GameEvents.fireEvent(t[o],f);f.jobQueue.flush(),f.models.moveID=0},f.executePostMoveJobs=function(){var e=f.models.gameMode;"PLACING"!==e&&"FREE CAPTURE"!==e||f.showFieldsToPlaceEntity()},f.getEntityAtCell=function(e,t){return f.gameWorld.peekCell(e,t)},f.getEntityWithName=function(e){for(var t,n=f.getPlayers(),o=n.length;o--;)if(!1!==(t=n[o].getEntityWithName(e)))return t;return!1},f.pushEntityToCell=function(e,t,n){e.setPosition(t,n),f.gameWorld.pushToCell({entityID:e.ID,playerID:e.getMetaPlayerID(),typeID:e.getTypeID()},t,n)},f.identifyProtectingEntities=function(e){for(var t,n,o,r,i,a,s,l=f.getCurrentPlayer(),u=!1,g=l.countEntities();g--;){for(r=(t=l.getEntityFromArray(g)).getMoves(),i=t.getGoalMoves(),f.performPostMoveChecks(t,r),f.performPostMoveChecks(t,i),a=t.position.x,s=t.position.y,n=r.length;n--;)o=r[n],f.doVirtualMove(a,s,o.targetX,o.targetY),f.entityOfTypeIsUnderAttack(e,t.getAssociatedPlayer())||(f.models.MovableEntities.push(t),f.highlightEntityAtPosition(a,s),u=!0),f.undoVirtualMove();for(n=i.length;n--;)o=i[n],f.doVirtualMove(a,s,o.targetX,o.targetY),f.entityOfTypeIsUnderAttack(e,t.getAssociatedPlayer())||(f.models.MovableEntities.push(t),f.highlightEntityAtPosition(a,a),u=!0),f.undoVirtualMove()}return u},f.opponentEntityCanCaptureAt=function(e,t,n){var o,r,i=n.getAssociatedPlayer().getNextOpponentPlayer();f.doVirtualMove(n.position.x,n.position.y,e,t);for(var a=i.countEntities();a--;)for(r=(o=i.getEntityFromArray(a).getGoalMoves()).length;r--;)if("CAPTURE"===o[r].type&&e===o[r].targetX&&t===o[r].targetY)return f.undoVirtualMove(),!0;return f.models.GoalMoves.length=0,f.undoVirtualMove(),!1},f.connectEntityActionsConsequences=function(e){var t=e.goalName,n=e.consequences,o="",r="";e.entityName&&(o=e.entityName),e.entityType&&(r=e.entityType),f.models.EntityGoalConsequences.push({goalName:t,entityName:o,entityType:r,consequences:n})},f.connectConsequences=function(e){for(var t=_.keys(e),n=t.length,o=0;o<n;++o)f.connectEntityActionsConsequences(e[t[o]])},f.getGoalConsequencesWithName=function(e,t){for(var n,o=[],r=f.models.EntityGoalConsequences.length;r--;)(n=f.models.EntityGoalConsequences[r]).goalName===e&&(n.entityName===t.getName()?(n.consequences.entityLink=t,o.push(n)):n.entityType===t.type&&(n.entityName=t.getName(),n.consequences.entityLink=t,o.push(n)));return o},f.executeGoalConsequences=function(e,t,n){var o,r=f.getGoalConsequencesWithName(e,t),i=t.position;o=0===f.models.moveID?f.getUniqueMoveID(t.name,e,i.x,i.y):f.models.moveID,f.setMoveID(o),n&&f.addJobForMoveID({jobID:f.models.moveID,jobName:"move game entity",job:"Prearrange Entity",jobArguments:{entity:t,destX:i.x,destY:i.y}});for(var a=0;a<r.length;a++)f.addJobs(r[a].consequences)},f.translateCoordinates=function(e,t){return String.fromCharCode(parseInt(97+e,10))+(f.gameWorld.getRows()-t)},f.addEntitiesToGameBoard=function(e){for(var t,n,o,r=0,i=f.gameWorld.getRows(),a=f.gameWorld.getColumns(),s=0;s<i;s++)for(t=0;t<a;t++)0!==(o=e[r])&&((n=f.getPlayerWithID(o.associatedWithMetaAgent).entityFactory(o)).onBoard=!0,f.pushEntityToCell(n,t,s)),r++},f.addEntityToGame=function(e,t){if(0===t)return!1;var n=f.getPlayerWithID(e.associatedWithMetaAgent);if(0<t)for(e.unlimitedQuantity=!1;t--;)n.entityFactory(e);else e.unlimitedQuantity=!0,n.entityFactory(e)},f.entityOfTypeIsUnderAttack=function(e,t){for(var n=t.getEntitiesOfType(e),o=n.length;o--;)if(n[o].canBeCaptured())return!0;return!1},f.entityOfSpecificTypeIsUnderAttack=function(e){var t=f.getPlayerWithID(e.associatedWithMetaAgent);if(0===t.countEntities())return!1;var n=t.getEntitiesOfType(e.entityType);if(0===n.length)return!1;for(var o=n.length;o--;)if(!0===n[o].canBeCaptured())return!0;return!1}},Spoooky.DiceBox=function(e){var n=this,o=e;n.enable=function(){o.models.DiceBox.isEnabled=!0},n.isEnabled=function(){return o.models.DiceBox.isEnabled},n.createDice=function(e,t){o.models.DiceBox.dices.push({start:e,end:t})},n.countDices=function(){return o.models.DiceBox.dices.length},n.getDice=function(e){return 0<=e&&e<n.countDices()&&o.models.DiceBox.dices[e]},n.rollDice=function(e){return!1!==n.getDice(e)&&parseInt(_.random(n.getDice(e).start,n.getDice(e).end),10)},n.rollAllDices=function(){for(var e=[],t=n.countDices();t--;)e.push(n.rollDice(t));return o.models.DiceBox.diceValues=e},n.getMoveIDForDiceID=function(e){for(var t=o.models.DiceBox,n=t.attachedMoveIDs.length;n--;)if(t.attachedMoveIDs[n].diceValueID===e)return t.attachedMoveIDs[n].moveID;return!1},n.connectMoveIDWithDiceValue=function(e,t,n){o.models.DiceBox.attachedMoveIDs.push({diceValueID:t,moveID:e,target:n})},n.getConnectedDiceValue=function(e){for(var t=o.models.DiceBox,n=t.attachedMoveIDs.length;n--;)if(t.attachedMoveIDs[n].moveID===e)return t.attachedMoveIDs[n];return!1},n.flushAttachedMoveIDs=function(){o.models.DiceBox.attachedMoveIDs.length=0},n.getDiceValues=function(){return o.models.DiceBox.diceValues},n.gotNoDiceValues=function(){return!o.models.DiceBox.diceValues[0]},n.deleteDiceValue=function(e){o.models.DiceBox.diceValues.splice(e,1)},n.deleteAllDiceValues=function(){o.models.DiceBox.diceValues.length=0}},Spoooky.GridWelt=function(e){var l=this,g=e;l.getRows=function(){return g.models.worldDimensions.rows},l.getColumns=function(){return g.models.worldDimensions.columns},l.getView=function(e,t){return!!l.isValidCoordinate(e,t)&&g.models.GameGrid[t][e].view},l.setup=function(){return 0<g.models.worldDimensions.fieldsX&&0<g.models.worldDimensions.fieldsY?(l.init2DGrid(),!0):(console.log("Invalid Size of GridWelt"),!1)},l.setup2D=function(e,t){return g.models.worldDimensions.rows=t,g.models.worldDimensions.columns=e,l.init2DGrid(),!0},l.setupGameBoard=function(e){for(var t,n,o=0,r=l.getRows(),i=l.getColumns(),a=0;a<r;a+=1)for(t=0;t<i;t+=1)n=e[o],l.setCellBaseClass(t,a,n),-1!==n.indexOf("disabled")&&(g.models.GameGrid[t][a].enabled=!1),o+=1},l.setCellClass=function(e,t,n){l.getView(e,t).cellClass=n},l.setCellBaseClass=function(e,t,n){l.getView(e,t).baseClass=n},l.init2DGrid=function(){var e,t,n,o,r;for(o=l.getRows(),r=l.getColumns(),e=0;e<o;e+=1){for(n=[],t=0;t<r;t+=1)n.push({cellID:null,contains:[],view:{baseClass:"",cellClass:""},position:{x:t,y:e},enabled:!0});g.models.GameGrid.push(n)}return!0},l.enumerateFieldIDsByClass=function(e){var t,n,o,r=1,i=l.getColumns(),a=l.getRows(),s=g.models.GameGrid;for(n=0;n<a;n+=1)for(t=0;t<i;t+=1)(o=s[n][t]).view.baseClass===e&&(o.cellID=r,r++)},l.setFieldIDs=function(e){var t,n,o=0,r=l.getColumns(),i=l.getRows(),a=g.models.GameGrid;for(n=0;n<i;n+=1)for(t=0;t<r;t+=1)a[n][t].cellID=e[o],o+=1;return!0},l.getFieldID=function(e,t){return!!l.isValidCoordinate(e,t)&&g.models.GameGrid[t][e].cellID},l.connectCells=function(e){g.models.CellConnections=e},l.createBoardSignature=function(){var e,t,n=g.models.GameGrid,o=g.gameWorld.getColumns(),r="",i=_.flatten(n),a=i.length;for(t=0;t<a;t++)0===(e=i[t].contains).length?r+="0":r+=_.last(e).typeID,(t+1)%o==0&&t+1!==a&&(r+="|");var s=g.models.OffBoardContent;if(0<s.length)for(r+="|",t=s.length;t--;)r+=s[t].typeID;return r},l.createBoardSignatureByVertical=function(){var e,t,n,o=l.getRows(),r=l.getColumns(),i=g.models.GameGrid,a="";for(t=0;t<r;t++){for(n=0;n<o;n++)0===(e=i[n][t].contains).length?a+="0":a+=_.last(e).typeID;t+1!==r&&(a+="|")}return a},l.pushToCell=function(e,t,n){return!!l.isValidCoordinate(t,n)&&(g.models.GameGrid[n][t].contains.push(e),!0)},l.popFromCell=function(e,t){if(l.isValidCoordinate(e,t)){var n=g.models.GameGrid[t][e].contains.pop();if(n)return g.getPlayerWithID(n.playerID).getEntityWithID(n.entityID)}return!1},l.deleteCellContent=function(e,t){if(l.isValidCoordinate(e,t)){var n=l.popFromCell(e,t);if(n&&0!==n)return n.seppuku(),!0}return!1},l.peekCell=function(e,t){if(l.isValidCoordinate(e,t)){var n=g.models.GameGrid[t][e].contains;return 0!==n.length&&(n=_.last(n),g.getPlayerWithID(n.playerID).getEntityWithID(n.entityID))}return!1},l.isValidCoordinate=function(e,t){var n,o=parseInt(e,10);return o<l.getColumns()&&0<=o&&0<=(n=parseInt(t,10))&&n<l.getRows()},l.isEmpty=function(e,t){return!1===l.peekCell(e,t)},l.moveEntity=function(e,t,n,o,r){if(_.isUndefined(n)||_.isUndefined(o))return!1;if(!1===l.isValidCoordinate(n,o))return!1;var i=g.models.GameGrid[o][n].contains,a=l.popFromCell(e,t);if(!1===_.isUndefined(r))r.setPosition(n,o),i.push({entityID:r.ID,playerID:r.getMetaPlayerID(),typeID:r.getTypeID()});else{if(!a)return!1;a.setPosition(n,o),i.push({entityID:a.ID,playerID:a.getMetaPlayerID(),typeID:a.getTypeID()})}return!0},l.getFreeCells=function(){for(var e,t,n=[],o=l.getColumns(),r=l.getRows(),i=g.models.GameGrid,a=o;a--;)for(t=r;t--;)(e=i[t][a]).enabled&&0===e.contains.length&&n.push({x:a,y:t});return n},l.getFreeFieldsWithFieldID=function(e){for(var t,n,o=[],r=l.getColumns(),i=l.getRows(),a=g.models.GameGrid,s=r;s--;)for(t=i;t--;)0===(n=a[t][s]).contains.length&&n.cellID===e&&o.push([s,t]);return o.reverse(),o},l.getFieldsWithFieldID=function(e,t){var n,o,r,i=[],a=g.models,s=a.worldDimensions.columns,l=a.worldDimensions.rows,u=a.GameGrid;for(o=s;o--;)for(r=l;r--;)if((n=u[r][o]).cellID===e){if(t)return n;i.push(n)}return i.reverse(),i},l.getContentOfFieldsWithFieldID=function(e){var t,n,o,r=[],i=l.getColumns(),a=l.getRows(),s=g.models.GameGrid;for(t=i;t--;)for(n=a;n--;)s[n][t].cellID===e&&(o=l.peekCell(t,n))&&r.push(o);return r.reverse(),r},l.countNeighboursNorth=function(e){var t=e.position.x,n=e.position.y,o=g.models.GameGrid[n][t].cellID,r=e.getAssociatedPlayer(),i=0,a=l.peekCell(t,parseInt(n-1,10)),s=g.models.GameGrid;return!1!==a&&s[parseInt(n-1,10)][t].cellID===o&&a.getAssociatedPlayer()===r&&(i+=1),i},l.countNeighboursSouth=function(e){var t=e.position.x,n=e.position.y,o=g.models.GameGrid;if(!1===l.isValidCoordinate(t,n))return!1;var r=null,i=e.getAssociatedPlayer(),a=0,s=l.peekCell(t,parseInt(n+1,10));return o[n][t]&&(r=o[n][t].cellID),!1!==s&&o[parseInt(n+1,10)][t].cellID===r&&s.getAssociatedPlayer()===i&&(a+=1),a},l.countNeighboursY=function(e){return l.countNeighboursNorth(e)+l.countNeighboursSouth(e)}},Spoooky.OffBoard=function(e){var n=this,i=e;n.addEntity=function(e){i.models.OffBoardContent.push({typeID:e.typeID,entityID:e.ID,entityName:e.getName(),playerID:e.getMetaPlayerID()})},n.deleteEntity=function(e){i.models.OffBoardContent.splice(e,1)},n.deleteEntityFromOffBoard=function(e){for(var t=i.models.OffBoardContent.length;t--;)if(i.models.OffBoardContent[t].entityName===e)return n.deleteEntity(t),!0;return!1},n.entitiesOfPlayerAreOutside=function(e){for(var t=i.models.OffBoardContent.length;t--;)if(i.models.OffBoardContent[t].playerID===e)return!0;return!1},n.getAllEntities=function(){return i.models.OffBoardContent},n.getEntityWithPlayerID=function(e){for(var t=i.models.OffBoardContent.length;t--;)if(i.models.OffBoardContent[t].playerID===e){var n=i.models.OffBoardContent[t];return i.getPlayerWithID(n.playerID).getEntityWithID(n.entityID)}return!1},n.getEntitiesWithPlayerID=function(e){for(var t,n=[],o=i.models.OffBoardContent,r=0;r<o.length;r++)(t=o[r]).playerID===e&&n.push(i.getPlayerWithID(t.playerID).getEntityWithID(t.entityID));return n}},Spoooky.GameEvents={events:{"Reset Moves":function(e,t){t.resetMoves()},"Roll Dices":function(e,t){t.getDiceBox().rollAllDices()},"Roll Backgammon Dices":function(e,t){var n,o=-1,r=!0,i=t.getDiceBox();t.setGameState("INGAME"),i.rollAllDices(),n=i.getDiceValues(),_.each(n,function(e){-1!==o&&o!==e&&(r=!1),o=e}),!0===r&&(n.push(n[0]),n.push(n[0])),t.executeGameRules()},"Delete Dice Value":function(e,t){t.getDiceBox().deleteDiceValue(e.jobArguments)},"Delete Assigned Dice Value":function(e,t){return!1!==t.getDiceBox().getConnectedDiceValue(e.jobID)&&(t.getDiceBox().deleteDiceValue(t.getDiceBox().getConnectedDiceValue(e.jobID).diceValueID),!0)},"Bear Off Entity At Dice Target Cell":function(e,t){var n=t.getDiceBox().getConnectedDiceValue(e.jobID);if(!1===n)return!1;var o=n.target.x,r=n.target.y,i=t.gameWorld.peekCell(o,r);return!1!==i&&(!_.isUndefined(i)&&null!==i&&(i.setPosition(null,null),0===t.getCurrentPlayerID()?i.tmp.fieldID=25:1===t.getCurrentPlayerID()&&(i.tmp.fieldID=0),t.offBoard.addEntity(i),t.gameWorld.popFromCell(o,r),!0))},"Show Backgammon Re-entering Moves":function(e,t){var n=e.jobArguments.playerID;if(n!==t.getCurrentPlayerID())return!1;var o=t.offBoard.getEntityWithPlayerID(n);o.setPosition(-1,-1),0===n?o.tmp.fieldID=0:1===n&&(o.tmp.fieldID=25);var r=o.getMoves(),i=o.getGoalMoves(r);return t.highlightStandardMoves(r),t.highlightGoalMoves(i),!1},"Delete Entity from OffBoard":function(e,t){delete e.jobArguments.entity.tmp.fieldID,t.offBoard.deleteEntityFromOffBoard(e.jobArguments.entity.name)},"Place Entity":function(e,t){var n=e.jobArguments.entity,o=t.getPlayerWithID(n.associatedWithPlayerID).getEntityWithID(n.ID),r=e.jobArguments;o.unlimitedQuantity||(o.onBoard=!0),t.pushEntityToCell(o,r.xPosition,r.yPosition),t.models.moveCounter+=1,!1===t.models.playVirtual&&Spoooky.GameProcess.pushMessage("["+t.models.moveCounter+"] "+t.getCurrentPlayerName()+" setzt Spielfigur auf Feld "+t.translateCoordinates(r.xPosition,r.yPosition)+".")},"Move Entity To Dice Destination Cell":function(e,t){var n=t.getDiceBox().getConnectedDiceValue(e.jobID);if(!1===n)return!1;var o=e.entityLink.position.x,r=e.entityLink.position.y,i=n.target.x,a=n.target.y;if(t.models.moveCounter+=1,!1===t.models.playVirtual){var s=t.translateCoordinates(o,r),l=t.translateCoordinates(i,a);Spoooky.GameProcess.pushMessage("["+t.models.moveCounter+"] "+t.getCurrentPlayerName()+" bewegt Spielfigur von "+s+" nach "+l+".")}return!1===_.isUndefined(e.entityLink.tmp.fieldID)?(t.moveEntity(o,r,i,a,e.entityLink),delete e.entityLink.tmp.fieldID,t.offBoard.deleteEntityFromOffBoard(e.entityLink.getName())):t.moveEntity(o,r,i,a),!0},"Prearrange Entity":function(e,t){var n=e.jobArguments,o=n.entity.position;t.models.moveCounter+=1,t.moveEntity(o.x,o.y,n.destX,n.destY)},"Move Entity":function(e,t){var n=t.models,o=e.jobArguments,r=o.entity.position;if(n.moveCounter+=1,!1===n.playVirtual){var i=t.translateCoordinates(r.x,r.y),a=t.translateCoordinates(o.destX,o.destY);Spoooky.GameProcess.pushMessage("["+n.moveCounter+"] "+t.getCurrentPlayerName()+" bewegt Spielfigur von "+i+" nach "+a+".")}t.moveEntity(r.x,r.y,o.destX,o.destY)},"Move Entity By Dice Value":function(e,t){var n=t.models,o=e.jobArguments,r=o.entity.position;if(n.moveCounter+=1,!1===n.playVirtual){var i=t.translateCoordinates(r.x,r.y),a=t.translateCoordinates(o.destX,o.destY);Spoooky.GameProcess.pushMessage("["+n.moveCounter+"] "+t.getCurrentPlayerName()+" bewegt Spielfigur von "+i+" nach "+a+" mit dem Wuerfelwert "+o.diceValue+".")}t.moveEntity(r.x,r.y,o.destX,o.destY)},"Move Entity Relative To":function(e,t){var n=e.entityLink,o=n.position.x,r=n.position.y;t.moveEntity(o,r,parseInt(o+e.jobArguments[0],10),parseInt(r+e.jobArguments[1],10))},"Move Entity With Name":function(e,t){var n=t.getEntityWithName(e.jobArguments[0]);if(!1===n)return!1;var o,r,i=e.jobArguments,a=n.position.x,s=n.position.y;return"RELATIVE"===i[3]?(o=parseInt(a+i[1],10),r=parseInt(s+i[2],10)):"ABSOLUTE"===i[3]&&(o=i[1],r=i[2]),t.moveEntity(a,s,o,r),t.models.moveCounter+=1,!0},"Prevent Player Change":function(e,t){return!(t.models.playerChange=!1)},"Enable Player Change":function(e,t){t.models.playerChange=!0},"Proceed Game":function(e,t){t.proceed()},"Change Game Mode":function(e,t){t.setGameMode(e.jobArguments.mode)},"Reset Game Mode":function(e,t){t.models.gameMode=t.models.tmpGameMode,t.models.tmpGameMode=""},"Delete Game Rule":function(e,t){for(var n=t.models.GameRules,o=n.length,r=e.jobArguments.ruleName;o--;)if(r===n[o].name)return t.models.GameRules.splice(o,1),!0;return!1},"Capture At":function(e,t){var n=e.jobArguments,o=n.x,r=n.y;if(console.log("here"),!1===t.models.playVirtual){var i=t.translateCoordinates(o,r);Spoooky.GameProcess.pushMessage("["+t.models.moveCounter+"] "+t.getCurrentPlayerName()+" schlaegt gegnerische Spielfigur auf Feld "+i+".")}t.deleteEntityAt(o,r)},"Capture Opponent At":function(e,t){var n,o,r,i=e.jobArguments;if(e.entityLink&&(r=e.entityLink.position),"RELATIVE"===i[2]?(n=parseInt(r.x+i[0],10),o=parseInt(r.y+i[1],10)):"ABSOLUTE"===i[2]&&(n=i[0],o=i[1]),!1===t.models.playVirtual){var a=t.translateCoordinates(n,o);Spoooky.GameProcess.pushMessage("["+t.models.moveCounter+"] "+t.getCurrentPlayerName()+" schlaegt gegnerische Spielfigur auf Feld "+a+".")}t.deleteEntityAt(n,o)},"Highlight Dice Target Cell":function(e,t){t.highlightCell(e.entityLink.targeting.x,e.entityLink.targeting.y,e.jobArguments,e.jobID)},"Highlight Area":function(e,t){t.getArea(e.jobArguments.areaName).display=e.jobArguments.highlightClass},"Highlight Cell":function(e,t){var n=e.jobArguments,o=n[0],r=n[1],i=n[2];"RELATIVE"===n[3]?(o=parseInt(e.entityLink.position.x+n[0],10),r=parseInt(e.entityLink.position.y+n[1],10)):"ABSOLUTE"===n[3]&&(o=n[0],r=n[1]),t.highlightCell(o,r,i,e.jobID)},"Set Game State":function(e,t){t.setGameState(e.jobArguments)},"Restrict Selectable Entities":function(e,t){t.models.SelectRestrictions.entities=e.jobArguments},"Restrict Selectable Entity Moves":function(e,t){t.models.SelectRestrictions.moves=e.jobArguments},"Delete This Entity":function(e,t){t.deleteEntityAt(e.entityLink.position.x,e.entityLink.position.y)},"Increment Off Board Counter":function(e,t){t.areas.incrementElements(e.jobArguments)},"Transform Entity":function(e,t){var n=e.entityLink,o=t.models.MetaAgents[e.entityLink.associatedWithPlayerID],r=n.position.x,i=n.position.y;t.deleteEntityAt(r,i),t.resetMoves();var a=t.getBlueprint(e.jobArguments),s=o.entityFactory(a);s.setName(n.getName()),s.setID(n.ID),s.associatedWithMetaAgent=o.ID,s.executedMoves=n.executedMoves,t.pushEntityToCell(s,r,i)},"Transform Entity If Row Reached":function(e,t){var n=e.entityLink,o=e.jobArguments.row;return"last"===o?o=parseInt(t.gameWorld.getRows()-1,10):"first"===o&&(o=0),n.position.y===o&&(Spoooky.GameEvents.fireEvent({job:"Transform Entity",jobArguments:e.jobArguments.entityType,entityLink:n},t),!0)},"Next Player":function(e,t){t.setNextPlayer()},"Delete All Dice Values":function(e,t){t.getDiceBox().deleteAllDiceValues()},alert:function(e){alert(e.jobArguments)},"Print Game Process":function(e,t){!1===t.models.playVirtual&&Spoooky.GameProcess.pushMessage(e.jobArguments)},"Stop Game":function(e,t){t.setGameState("END"),!1===t.models.playVirtual&&t.informArtificialPlayersAboutGameEnd()},"Set Winner":function(e,t){t.setWinnerID(e.jobArguments),!1===t.models.playVirtual&&Spoooky.GameProcess.pushMessage('<button id="postGameReloadButton"onclick="location.reload();" type="button" class="btn btn-success btn-sm">Spiel neu starten</button>')}},fireEvent:function(e,t){this.events[e.job](e,t)}},Spoooky.JobQueue=function(e){var r=e;this.addJob=function(e){var t=r.models.JobQueue;_.isUndefined(t[e.jobID])&&(t[e.jobID]=[]),t[e.jobID][e.jobName]=e},this.flush=function(){r.models.JobQueue.length=0},this.getJobsWithMoveID=function(e){var t=[],n=r.models.JobQueue[e];for(var o in n)t.push(n[o]);return t}},Spoooky.Areas=function(e){var t=this,n=e;t.enable=function(){n.models.Areas.isEnabled=!0},t.isEnabled=function(){return n.models.Areas.isEnabled},t.isMove=function(e){return 0!==t.getArea(e).moveID},t.incrementElements=function(e){t.getArea(e).elementCounter++},t.getMoveID=function(e){return t.getArea(e).moveID},t.addArea=function(e){t.enable(),n.models.Areas.content.push({name:e,moveID:0,display:"",elementCounter:0})},t.getArea=function(t){return _.find(n.models.Areas.content,function(e){return e.name===t})},t.resetDisplays=function(){_.each(n.models.Areas.content,function(e){e.display=""})}},Spoooky.Agent=function(e,t){var u=this;u.ID=t,u.metaAgentID=e,u.role="ANALYZE POSSIBLE MOVES",u.focus="ALL",u.fitness=1,u.thinkingTime=1e4,u.maximumSteps=1e4,u.uctConstant=.9,u.proposeBestMove=function(){var e=!1,t=u.ID,n=u.role,o=u.focus,r=u.maximumSteps,i=u.createBrain(),a=u.uctConstant,s=u.thinkingTime,l=Spoooky.AI.game.getPlayerWithID(u.metaAgentID).learningEnabled;switch(localStorage["#mctsgraph"]&&(e=!0),n){case"ANALYZE POSSIBLE MOVES":i.postMessage({agentID:t,agentRole:n,agentFocus:o,maxSteps:r,maxTime:s,learn:l,uctConstant:a,command:"monte carlo tree search with uct",gameModel:Spoooky.AI.game.stringifyModels(),generateMctsGraph:e});break;case"SEARCH FOR IMMEDIATE THREATS":i.postMessage({agentID:t,agentRole:n,agentFocus:o,command:"alpha beta negamax",maxDepth:3,gameModel:Spoooky.AI.game.stringifyModels()});break;default:console.log("Unknown Agent Role.")}},u.createBrain=function(){var e=new Worker("../../js/spoooky.Worker.min.js"),t=Spoooky.AI.game.getPlayerWithID(u.metaAgentID);return e.addEventListener("message",function(e){switch(e.data.type){case"starting":break;case"decision":case"random":t.coordinateAgentDecisions(e.data)}}),e}},Spoooky.MetaAgent=function(e){var f=this,i=e;f.name="",f.setName=function(e){f.name=e},f.getName=function(){return f.name},f.getGame=function(){return i},f.ID=0,f.getID=function(){return f.ID},f.setID=function(e){f.ID=e},f.type="HUMAN",f.setType=function(e){return"HUMAN"===e||"ARTIFICIAL"===e?(f.type=e,!0):(console.log("Invalid Player Type. Allowed Player Types: HUMAN or ARTIFICIAL"),!1)},f.learningEnabled=!1,f.enableLearning=function(){f.learningEnabled=!0},f.QLearner={},f.gameHasEnded=function(){if(f.learningEnabled){Spoooky.GameProcess.pushMessage("Meta Agent "+f.ID+" lernt..."),f.QLearner.learn(1e4);var e="{\n";e+='\t"game" : "'+f.getGame().getName()+'",\n',e+='\t"metaAgentID" : '+f.ID+",\n",e+='\t"bestAgentEnsemble" : ',e+=JSON.stringify(f.agents,null,"\t"),e+=",\n",e+='\t"learnModule" : ',e+=JSON.stringify(f.QLearner,null,"\t"),e+="\n}";var t=new Blob([e],{type:"text/plain;charset=utf-8"});saveAs(t,"agentmemory_"+f.ID+".json")}},f.associateEntity=function(e,t){e.associatedWithMetaAgent=f.ID,"PLACE"===e.mode&&f.getGame().addEntityToGame(e,t)},f.entityFactory=function(e){var t,n="",o=0;n=e.entityName?e.entityName:f.ID+"_entity_"+parseInt(f.countEntities()+1,10),o=e.entityID?e.entityID:parseInt(f.countEntities()+1,10),(t=new Spoooky.Entity(n,o,e.typeID,f.getGame())).setType(e.entityType),t.setRepresentation(e.representation.type,e.representation.texture);var r,i,a=e.moves;if(a)for(r=0;r<a.length;r++)i=a[r],t.addMove({name:i.name,type:i.type,direction:i.direction,frequency:i.frequency,conditions:i.conditions,postMove:i.postMove});if(e.goalAtoms)for(r=0;r<e.goalAtoms.length;r++)i=e.goalAtoms[r],t.addGoalAtom(i.atomName,i.atomFunction,i.atomArguments);if(e.goals)for(r=0;r<e.goals.length;r++)i=e.goals[r],t.assembleGoal({type:i.type,name:i.name,atoms:i.atoms,move:i.move,area:i.area});return t.selectCondition=e.selectCondition,e.postMoveCheck?t.postMoveCheck=e.postMoveCheck:t.postMoveCheck=null,t.setGoalTargets(e.goalTargets),e.unlimitedQuantity&&(t.unlimitedQuantity=!0),e.mode&&(t.mode=e.mode),e.placeTo&&(t.placeTo=e.placeTo),f.addEntity(t),t},f.addEntity=function(e){e.setAssociatedPlayerID(f.ID),i.models.Entities[f.ID].push(e)},f.getEntityFromArray=function(e){return 0<=e&&e<f.countEntities()&&i.models.Entities[f.ID][e]},f.getEntityWithID=function(e){for(var t,n=f.countEntities(),o=i.models.Entities[f.ID],r=n;r--;)if((t=o[r]).ID===e)return t;return!1},f.getEntities=function(){return i.models.Entities[f.ID]},f.getOnBoardEntities=function(){for(var e,t=i.models.Entities[f.ID],n=t.length,o=[];n--;)(e=t[n]).onBoard&&o.push(e);return o},f.getOffBoardEntities=function(){for(var e,t=i.models.Entities[f.ID],n=t.length,o=[];n--;)(e=t[n]).onBoard&&o.push(e);return o},f.getEntitiesOfType=function(e){for(var t=[],n=f.countEntities(),o=i.models.Entities[f.ID],r=n;r--;)o[r].type===e&&t.push(o[r]);return t},f.getPlaceableEntities=function(){for(var e,t=[],n=f.countEntities(),o=f.ID;n--;)"PLACE"===(e=i.models.Entities[o][n]).mode&&(e.unlimitedQuantity?t.push(e):e.onBoard||t.push(e));return t},f.getEntityWithName=function(e){for(var t=f.countEntities();t--;)if(i.models.Entities[f.ID][t].name===e)return i.models.Entities[f.ID][t];return!1},f.getNextOpponentPlayer=function(){return f.ID<f.getGame().models.MetaAgents.length-1?f.getGame().getPlayerWithID(parseInt(f.ID+1,10)):f.getGame().getPlayerWithID(parseInt(0,10))},f.getOccupiedFields=function(e){var t,n,o=[],r=f.getGame().models.GameGrid,i=_.flatten(r),a=i.length;switch(e){case"OWN ENTITIES":for(t=a;t--;)0!==(n=i[t]).contains.length&&_.last(n.contains).playerID===f.ID&&o.push(n.position);break;case"OPPONENT ENTITIES":for(t=a;t--;)0!==(n=i[t]).contains.length&&_.last(n.contains).playerID!==f.ID&&o.push(n.position);break;default:console.log("Wrong Mode")}return o},f.hasEntity=function(e){for(var t=f.countEntities();t--;)if(i.models.Entities[f.ID][t].name===e)return!0;return!1},f.deleteEntity=function(e){for(var t=f.countEntities(),n=i.models.Entities[f.ID],o=t;o--;)if(n[o].name===e)return n.splice(o,1),!0;return!1},f.countEntities=function(){return i.models.Entities[f.ID].length},f.getAllEntityStdMoves=function(){var e=f.getEntities();if(0===e.length)return!1;for(var t,n,o=[],r=f.getGame(),i=e.length;i--;)t=e[i],!0===r.checkSelectCondition(t)&&(n=t.getMoves(),r.performPostMoveChecks(t,n),o.push.apply(o,n));return 0!==o.length&&o},f.getAllEntityGoalMoves=function(){var e=f.getEntities();if(0===e.length)return!1;for(var t,n,o=[],r=f.getGame(),i=e.length;i--;)t=e[i],!0===r.checkSelectCondition(t)&&(n=t.getGoalMoves(),r.performPostMoveChecks(t,n),o.push.apply(o,n));return 0!==o.length&&o},f.cellConnections,f.setCellConnections=function(e){f.cellConnections=e},f.getEntityMovesMoving=function(){var e=f.getEntities(),t=e.length;if(0===t)return[];var n,o,r=f.getGame(),i=r.models,a=[],s=[],l=[];for(o=t;o--;)if(n=e[o],!0===r.checkSelectCondition(n)){switch(a.length=0,s.length=0,i.SelectRestrictions.moves){case"Standard Moves":a=n.getMoves();break;case"Capture Moves":s=n.getGoalMoves(a);break;default:a=n.getMoves(),s=n.getGoalMoves(a)}r.performPostMoveChecks(n,a),r.performPostMoveChecks(n,s),a&&l.push.apply(l,a),s&&l.push.apply(l,s)}return 0===l.length?[]:l},f.getEntityMovesPlacing=function(){var e=f.getPlaceableEntities();if(0===e.length)return[];var t,n,o,r,i=[],a=f.getGame();switch((r=_.last(e)).placeTo){case"ANY":var s=a.gameWorld.getFreeCells();for(o=s.length;o--;)t=s[o],n=a.getUniqueMoveID(r.name,"place-entity",t.x,t.y),i.push({type:"PLACE",name:"place entity",entity:r,targetX:t.x,targetY:t.y,moveClass:"move_place",ID:n}),a.addJobForMoveID({jobID:n,jobName:"Put the Entity to the destination field",job:"Place Entity",jobArguments:{entity:r,xPosition:t.x,yPosition:t.y}});return i;case"REACHABLE BY RECENTLY MOVED ENTITY":var l,u=a.getrecentlyMovedEntity();if(!1===u)return[];for(o=(l=u.getMoves()).length;o--;)t=l[o],n=a.getUniqueMoveID(r.name,"place-entity",t.targetX,t.targetY),i.push({type:"PLACE",name:"place entity",entity:r,targetX:t.targetX,targetY:t.targetY,moveClass:"move_place",ID:n}),a.addJobForMoveID({jobID:n,jobName:"Put the Entity to the destination field",job:"Place Entity",jobArguments:{entity:r,xPosition:t.targetX,yPosition:t.targetY}}),a.addJobForMoveID({jobID:n,jobName:"Let Players Change",job:"Enable Player Change"}),a.addJobForMoveID({jobID:n,jobName:"Change Back To Move Mode",job:"Change Game Mode",jobArguments:{mode:"MOVING"}});return i;default:console.log("Wrong Placing Mode: ",r.placeTo)}},f.getEntityMovesFreeCapture=function(){var e,t,n,o=f.getGame(),r=[],i=o.getAssociatedOpponentEntities(f.cellConnections);for(t in i)(e=i[t]).associated||(n=o.getUniqueMoveID("free-capture","opponent",e.x,e.y),r.push({ID:n,type:"FREE CAPTURE",entity:!1,name:"Capture Opponent",targetX:e.x,targetY:e.y,moveClass:"move_goal"}));return r},f.getAllEntityMoves=function(){var e=f.getGame();if("END"===e.models.gameState)return[];var t=e.models.gameMode;return"MOVING"===t?f.getEntityMovesMoving():"PLACING"===t?f.getEntityMovesPlacing():"FREE CAPTURE"===t?f.getEntityMovesFreeCapture():void console.log("Wrong command in self_MetaAgent.getAllEntityMoves",t)},f.getExecutableMovesByAgentFocus=function(e){if("END"===f.getGame().models.gameState)return[];for(var t,n,o,r,i,a,s,l,u,g,c=f.getAllEntityMoves(),m=[],d=c.length;d--;)c[d].moveIndex=d;switch(e){case"FIRST HALF OF POSSIBLE MOVES":return g=Math.floor(c.length/2),c.splice(g,g),c;case"SECOND HALF OF POSSIBLE MOVES":return g=Math.floor(c.length/2),c.splice(0,g),c;case"MOVES NEAR OPPONENT FIELDS":for(u=f.getOccupiedFields("OPPONENT ENTITIES"),o=c.length;o--;)for(t=c[o].targetX,n=c[o].targetY,a=u.length;a--;)if(r=u[a].x,i=u[a].y,s=Math.abs(r-t),l=Math.abs(i-n),s<=1&&l<=1){m.push(c[o]);break}return m;case"MOVES NEAR OPPONENT OR OWN FIELDS":for(u=(u=f.getOccupiedFields("OPPONENT ENTITIES")).concat(f.getOccupiedFields("OWN ENTITIES")),o=c.length;o--;)for(t=c[o].targetX,n=c[o].targetY,a=u.length;a--;)if(r=u[a].x,i=u[a].y,s=Math.abs(r-t),l=Math.abs(i-n),s<=1&&l<=1){m.push(c[o]);break}return m;case"ALL MOVES":case"ALL":default:return c}},f.agents=[],f.activeAgents=0,f.finishedAgents=0,f.countAgents=function(){return f.agents.length},f.getAgents=function(){return f.agents},f.getAgentWithID=function(e){var t,n=f.agents;for(t=n.length;t--;)if(n[t].ID===e)return n[t];return!1},f.assembleAgent=function(e,t,n,o,r,i,a){var s,l=f.ID;(s=new Spoooky.Agent(l,e)).role=t,s.fitness=i,s.focus=n,s.thinkingTime=r,s.maximumSteps=o,s.uctConstant=a,f.agents.push(s)},f.addStandardAgent=function(){for(var e,t,n=0,o=(t=f.getAgents()).length;o--;)n<(e=t[o].ID)&&(n=e);n+=1,f.assembleAgent(n,"ANALYZE POSSIBLE MOVES","ALL MOVES",1e4,1e4,1,.9)},f.deleteAgentWithID=function(e){for(var t=f.agents.length;t--;)f.agents[t].ID===e&&f.agents.splice(t,1)},f.expertKnowledge=!1,f.assembleAgents=function(){var t="agentmemory_"+f.ID+".json",n=!1;return $.ajax({url:t,dataType:"json",async:!1,success:function(e){n=!0,Spoooky.AgentLog.pushMessage("Lade Agentenerinnerungen fuer Meta Agent "+f.ID+"."),Spoooky.AgentLog.pushMessage('<div class="progress progress-striped active"><div class="progress-bar"  role="progressbar" style="width: 100%"><span class="sr-only">Lade</span></div></div>'),f.QLearner=new Spoooky.QLearner,f.QLearner.reward=e.learnModule.rewards,f.QLearner.gameStates=e.learnModule.gameStates,$.each(e.bestAgentEnsemble,function(e,t){f.assembleAgent(t.ID,t.role,t.focus,t.maximumSteps,t.thinkingTime,t.fitness,t.uctConstant)})},complete:function(){if(n){Spoooky.AgentLog.messages.pop();var e=_.keys(f.QLearner.gameStates).length;Spoooky.AgentLog.pushMessage(e+" gelernte Spielzustaende wurden erfolgreich aus der Datei "+t+" geladen.")}},error:function(){if(0===f.agents.length){Spoooky.AgentLog.pushMessage("Keine Erinnerungen fuer Meta Agent "+f.ID+" vorhanden: Datei "+t+" existiert nicht."),f.QLearner=new Spoooky.QLearner;f.assembleAgent(1,"ANALYZE POSSIBLE MOVES","ALL MOVES",15e3,1e4,1,.5),f.assembleAgent(2,"ANALYZE POSSIBLE MOVES","FIRST HALF OF POSSIBLE MOVES",15e3,1e4,1,.5),f.assembleAgent(3,"ANALYZE POSSIBLE MOVES","SECOND HALF OF POSSIBLE MOVES",15e3,1e4,1,.5)}}}),!0},f.runtimeStart=0,f.findBestMove=function(){Spoooky.AI.game=f.getGame(),f.runtimeStart=Date.now(),f.askAgentsForDecision()},f.askAgentsForDecision=function(){f.activeAgents=f.countAgents(),f.bestMoves.length=0,Spoooky.AgentLog.pushMessage("Meta agent "+f.ID+" ("+f.getName()+") fragt "+f.activeAgents+" assoziierte Agenten nach der besten Zugmoeglichkeit.");for(var e=f.agents.length,t=0;t<e;t++)f.agents[t].proposeBestMove()},f.bestMoves=[],f.prepareAgentsMoveSuggestions=function(e){var t,n,o,r,i,a,s,l=[],u=!1,g=[];for(n=e.length;n--;){for(t=e[n],o=l.length;o--;)l[o].moveIndex===t.moveIndex&&(a=parseInt(l[o].wins+t.wins),i=parseInt(l[o].visits+t.visits),s=parseInt(l[o].lost+t.lost),parseInt(l[o].simulationSteps+t.simulationSteps),(g=l[o].agentID).push(t.agentID),r={simulationSteps:t.simulationSteps,moveIndex:t.moveIndex,agentID:g,visits:i,target:t.target,wins:a,lost:s},l[o]=r,u=!0);!1===u&&(r={simulationSteps:t.simulationSteps,moveIndex:t.moveIndex,agentID:[t.agentID],target:t.target,visits:t.visits,wins:t.wins,lost:t.lost},l.push(r)),u=!1}return l},f.updateAgentsFitness=function(e){var t,n,o=f.getAgents(),r=!1;for(t=o.length;t--;){for(n=e.length;n--;)if(o[t].ID===e[n]){o[t].fitness+=.5,r=!0;break}!1===r&&(o[t].fitness-=.5),r=!1}},f.getFittestAgent=function(){var e,t,n,o=f.getAgents(),r=0;for(e=o.length;e--;)(n=o[e]).fitness>=r&&(r=n.fitness,t=n);return t},f.replaceUnfitAgents=function(){var e,t=f.getAgents(),n=f.getFittestAgent();for(e=t.length;e--;)t[e].fitness<.1&&(Spoooky.AgentLog.pushMessage("Agent #"+t[e].ID+" hat eine schlechte Fitness von "+t[e].fitness+" und fokussiert nun den folgenden Spielaspekt: "+n.focus),t[e].role=n.role,t[e].focus=n.focus,t[e].fitness=1);f.getGame().refreshView()},f.updateQLearner=function(e){var t,n,o,r,i,a,s,l=f.QLearner,u=JSON.parse(e).gameStates,g=l.gameStates,c=_.keys(u),m=c.length;for(o=0;o<m;++o)if(i=(r=u[c[o]]).name,_.has(g,i))for(a=r.actions,m=(c=_.keys(a)).length,o=0;o<m;o++)s=a[c[o]],_.has(g[i].actions,s.name)?(n=t=0,_.has(g[i].actions[s.name],"reward")&&(n=g[i].actions[s.name].reward),_.has(s,"reward")&&(t=s.reward),t+=n,g[i].actions[s.name]=s,0!==t&&(g[i].actions[s.name].reward=t)):g[r.name].actions[s.name]=s;else g[r.name]=r},f.mctsData=[],f.processAgentDecision=function(e){f.mctsData.push({agentID:e.agentID,mctsGraph:e.mctsGraph,uctConstant:e.uctConstant}),e.mctsGraph&&(e.mctsGraph.length=0),f.bestMoves.push(e),Spoooky.AgentLog.pushMessage("Agent #"+e.agentID+" hat "+e.results.length+" Zugmoeglichkeiten anhand von "+e.simCount+" Monte Carlo Ausspielungen mit insgesamt "+e.simSteps+" Simulationsschritten analysiert."),f.getGame().refreshView(),f.finishedAgents++},f.allAgentsHaveFinishedThinking=function(){return f.finishedAgents===f.activeAgents&&!(f.finishedAgents=0)},f.sumUpAgentsWork=function(){var e,t,n,o,r={},i=0,a=0,s=[],l=f.bestMoves;for(n=l.length;n--;){for(i+=(t=l[n]).simCount,a+=t.simSteps,o=(e=t.results).length;o--;)(r=e[o]).agentID=t.agentID,r.agentRole=t.agentRole,r.agentFocus=t.agentFocus,s.push(r);f.learningEnabled&&f.updateQLearner(t.QLearner)}return f.bestMoves.length=0,{results:s,simCount:i,simSteps:a}},f.getBestMove=function(e){var t,n,o=Number.MAX_VALUE,r="Random";o=-1*Number.MAX_VALUE;for(var i=e.length;i--;)0<(t=e[i]).visits&&(o<(n=t.visits)&&(o=n,r=t),Spoooky.AgentLog.pushMessage(t.target+" [Agent(en) #"+t.agentID+"]<ul><li>Besuche: "+t.visits+"</li><li>Gewinnhaeufigkeit: "+t.wins+"</li><li>Simulationsschritte: "+t.simulationSteps+"</li><li>Gewinnrate: "+t.wins/t.visits+"</li></ul>"));return r},f.printAgentsFinishedMessage=function(){for(var e=Spoooky.GameProcess.messages.length;e--;)"thinking"===Spoooky.GameProcess.messages[e].type&&Spoooky.GameProcess.messages.splice(e,1);Spoooky.AgentLog.pushMessage("Alle assoziierten Agenten haben ihre Arbeit beendet.")},f.coordinateAgentDecisions=function(e){if(f.processAgentDecision(e),e.length=0,f.allAgentsHaveFinishedThinking()){var t=(Date.now()-f.runtimeStart)/1e3;f.printAgentsFinishedMessage();var n=f.sumUpAgentsWork(),o=n.simCount,r=n.simSteps,i=f.prepareAgentsMoveSuggestions(n.results);n.length=0,Spoooky.AgentLog.pushMessage("<strong>"+o+" simulierte Spiele  mit insgesamt "+r+" Simulationsschritten ("+(r/o).toFixed(2)+" Schritte/Simulation) in "+t+" Sekunden.</strong>"),Spoooky.Statistics.logEntry(f.ID,"simCount",f.getGame().models.moveCounter+1,o),Spoooky.Statistics.logEntry(f.ID,"simSteps",f.getGame().models.moveCounter+1,r),(i=_.sortBy(i,function(e){return e.visits})).reverse();var a=f.getBestMove(i);i.length=0,f.learningEnabled&&f.QLearner.learn(1e4),"Random"===a?(Spoooky.AgentLog.pushMessage("Meta Agent fuehrt einen Zufallszug aus."),f.getGame().executeRandomMove()):(f.updateAgentsFitness(a.agentID),f.replaceUnfitAgents(),Spoooky.AgentLog.pushMessage("<strong>Meta Agent hat sich fuer die folgende Zugmoeglichkeit entschieden: "+a.target+"</strong>"),f.getGame().executeArtificialMove(a)),f.mctsData&&f.getGame().refreshGraphView(f.mctsData,f.ID),f.getGame().refreshStatsView(f.ID),f.mctsData.length=0}},f.artificialMove=function(){Spoooky.GameProcess.pushMessage(f.getName()+' denkt nach...<br><div class="progress progress-striped active"><div class="progress-bar"  role="progressbar" style="width: 100%"><span class="sr-only">Ich denke nach...</span></div></div>',"thinking"),f.findBestMove()},f.hasEntitiesOnFieldWithFieldID=function(e,t){for(var n,o={"<":function(e,t){return e<t},"<=":function(e,t){return e<=t},">":function(e,t){return t<e},">=":function(e,t){return t<=e},"==":function(e,t){return e==t}},r=f.countEntities();r--;)if(n=f.getEntityFromArray(r),o[t](n.getFieldID(),e))return!0;return!1}},Spoooky.Entity=function(e,t,n,o){var b=this,r=o;b.unlimitedQuantity=!1,b.mode="MOVE",b.placeTo=0,b.getGame=function(){return r},b.ID=t,b.getID=function(){return b.ID},b.setID=function(e){b.ID=e},b.typeID=n,b.getTypeID=function(){return b.typeID},b.setTypeID=function(e){b.typeID=e},b.name=e,b.enabled=!0,b.moveCounter=0,b.increaseMoveCounter=function(){b.moveCounter+=1},b.getMoveCount=function(){return b.moveCounter},b.lastExecutedMove=0,b.addExecutedMove=function(e,t,n,o){b.increaseMoveCounter(),b.lastExecutedMove={destX:e,destY:t,round:n,type:o}},b.getLastExecutedMove=function(){return b.lastExecutedMove},b.enable=function(){b.enabled=!0},b.disable=function(){b.enabled=!1},b.setName=function(e){b.name=e},b.type="default",b.getType=function(){return b.type},b.setType=function(e){b.type=e},b.getWorld=function(){return b.getGame().gameWorld},b.isOpponent=function(e,t){var n;return!!b.getWorld().isValidCoordinate(e,t)&&(!1!==(n=b.getWorld().peekCell(e,t))&&n.getMetaPlayerID()!==b.getMetaPlayerID())},b.isEmptyCell=function(e,t){return!!b.getWorld().isValidCoordinate(e,t)&&!1===b.getWorld().peekCell(e,t)},b.visualRepresentation={type:"",colour:"",imageURL:""},b.getView=function(){return b.visualRepresentation.imageURL},b.position={x:-1,y:-1},b.getPosition=function(){return b.position},b.getFieldID=function(){var e=b.position;return b.getWorld().getFieldID(e.x,e.y)},b.setPosition=function(e,t){b.position.x=e,b.position.y=t},b.tmp={},b.targeting={x:null,y:null},b.setTarget=function(e,t){b.targeting.x=e,b.targeting.y=t},b.unsetTarget=function(){b.targeting.x=null,b.targeting.y=null},b.goalTargets=[],b.addGoalTarget=function(e){b.goalTargets.push(e)},b.setGoalTargets=function(e){b.goalTargets=e},b.getGoalTargets=function(){return b.goalTargets},b.setRepresentation=function(e,t){"colour"!==e&&"image"!==e||(b.visualRepresentation={type:e,colour:t,imageURL:t})},b.associatedWithPlayerID=null,b.setAssociatedPlayerID=function(e){b.associatedWithPlayerID=e},b.getMetaPlayerID=function(){return b.associatedWithPlayerID},b.getName=function(){return b.name},b.getAssociatedPlayer=function(){return b.getGame().getPlayerWhoOwnsEntity(b.getName())},b.seppuku=function(){!1!==b.getAssociatedPlayer()&&b.getAssociatedPlayer().deleteEntity(b.getName())},b.isOwnedByPlayerID=function(e){return b.associatedWithPlayerID===e},b.translateDirection=function(e){var t=0,n=0;if("object"==typeof e&&e instanceof Array)t=e[0],n=e[1];else switch(e){case"n":case"north":t=0,n=-1;break;case"ne":case"northeast":n=-(t=1);break;case"e":case"east":case"right":t=1,n=0;break;case"se":case"southeast":n=t=1;break;case"s":case"south":t=0,n=1;break;case"sw":case"southwest":t=-1,n=1;break;case"w":case"west":case"left":t=-1,n=0;break;case"nw":case"northwest":n=t=-1}return[t,n]},b.moves=[],b.addMove=function(e){var t=b.translateDirection(e.direction),n=t[0],o=t[1];b.moves.push({name:e.name,type:e.type,direction:e.direction,xDirection:n,yDirection:o,frequency:e.frequency,conditions:e.conditions,postMove:e.postMove})},b.countPossibleMoves=function(){return b.moves.length},b.countFieldsWithID=function(e){return b.getWorld().getContentOfFieldsWithFieldID(e).length},b.countOpponentsOnFieldsWithID=function(e,t){for(var n,o=b.getWorld().getContentOfFieldsWithFieldID(e),r=0,i=o.length;i--;)(n=o[i])&&n.getMetaPlayerID()!==t.getMetaPlayerID()&&(r+=1);return r},b.countOwnOnFieldsWithID=function(e,t){for(var n,o=b.getWorld().getContentOfFieldsWithFieldID(e),r=0,i=o.length;i--;)(n=o[i])&&n.getMetaPlayerID()===t.getMetaPlayerID()&&(r+=1);return r},b.getMove=function(e){return 0<=e&&e<b.countPossibleMoves()&&b.moves[e]},b.canMove=function(){var e=b.getMoves();return b.getGame().performPostMoveChecks(this,e),!_.isEmpty(e)},b.getMoves=function(){var e=b.countPossibleMoves();if(e<=0)return!1;var t,n,o,r,i,a,s,l,u,g=[],c=b.getGame();r=(s=b.position).x,i=s.y;for(var m=e;m--;)switch((n=b.getMove(m)).type){case"Default":if(0<n.frequency||"ANY"===n.frequency)for("ANY"===(o=n.frequency)&&(o=23),a=1;a<=o&&(l=r+n.xDirection*a,u=i+n.yDirection*a,!1!==b.getWorld().isEmpty(l,u));a+=1)c.isLegalMove(b,n.conditions,r,i,l,u)&&(t=c.getUniqueMoveID(b.name,n.name,l,u),g.push({type:"MOVE",name:n.name,entity:b,targetX:l,targetY:u,moveClass:"move_standard",freq:o,ID:t,postMove:n.postMove}),c.addJobForMoveID({jobID:t,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:b,destX:l,destY:u}}),n.postMove&&_.each(n.postMove,function(e){c.addJobForMoveID({jobID:t,jobName:e.jobName,job:e.jobFunction,jobArguments:e.jobArguments})}));break;case"By Connected Field IDs":for(var d,f=c.models.CellConnections[c.models.GameGrid[i][r].cellID],y=f.length;y--;)l=(d=b.getWorld().getFieldsWithFieldID(f[y],!0)).position.x,u=d.position.y,!1!==b.getWorld().isEmpty(l,u)&&c.isLegalMove(b,n.conditions,r,i,l,u)&&(t=c.getUniqueMoveID(b.name,n.name,l,u),g.push({type:"MOVE",name:n.name,entity:b,targetX:l,targetY:u,moveClass:"move_standard",freq:o,ID:t,postMove:n.postMove}),c.addJobForMoveID({jobID:t,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:b,destX:l,destY:u}}),n.postMove&&_.each(n.postMove,function(e){c.addJobForMoveID({jobID:t,jobName:e.jobName,job:e.jobFunction,jobArguments:e.jobArguments})}));break;case"By Field ID":if("DICE"===n.frequency){var p=c.getDiceBox().getDiceValues(),v=p.length,I=[],h=0,D=-1,M=!1;!1===_.isUndefined(b.tmp.fieldID)?(D=b.tmp.fieldID,M=!0):D=b.getWorld().getFieldID(r,i);for(var E=v;E--;)if("POSITIVE"===n.direction[1]?h=parseInt(D+p[E],10):"NEGATIVE"===n.direction[1]&&(h=parseInt(D-p[E],10)),"By Field ID"===n.type&&0===b.countOpponentsOnFieldsWithID(h,b))if((I=b.getWorld().getFreeFieldsWithFieldID(h))[0])l=I[0][0],u=h<=12?I[parseInt(I.length-1,10)][1]:I[0][1],t=c.getUniqueMoveID(b.name,n.name,l,u),g.push({type:"DICE",diceID:E,diceValue:p[E],name:n.name,entity:b,targetX:l,targetY:u,moveClass:"move_standard",freq:"DICE",ID:t,postmove:n.postMove}),!0===M?(c.addJobForMoveID({jobID:t,jobName:"Put the entity to the destination field",job:"Place Entity",jobArguments:{entity:b,xPosition:l,yPosition:u}}),c.addJobForMoveID({jobID:t,jobName:"Remove the current entity from off board area",job:"Delete Entity from OffBoard",jobArguments:{entity:b}})):c.addJobForMoveID({jobID:t,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:b,destX:l,destY:u}}),c.addJobForMoveID({jobID:t,jobName:"Delete Dice Value",job:"Delete Dice Value",jobArguments:E}),n.postMove&&_.each(n.postMove,function(e){c.addJobForMoveID({jobID:t,jobName:e.jobName,job:e.jobFunction,jobArguments:e.jobArguments})});else if(b.countOwnOnFieldsWithID(h,b)===b.countFieldsWithID(h)){var A=b.getWorld().getFieldsWithFieldID(h);A[0]&&(l=A[0].position.x,u=h<=12?A[0].position.y:A[parseInt(A.length-1,10)].position.y,t=c.getUniqueMoveID(b.name,n.name,l,u),g.push({type:"DICE",diceValue:p[E],name:n.name,entity:b,targetX:l,targetY:u,moveClass:"move_standard",freq:"DICE",ID:t,postmove:n.postMove}),c.addJobForMoveID({jobID:t,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:b,destX:l,destY:u}}),c.addJobForMoveID({jobID:t,jobName:"Delete Dice Value",job:"Delete Dice Value",jobArguments:E}),n.postMove&&_.each(n.postMove,function(e){c.addJobForMoveID({jobID:t,jobName:e.jobName,job:e.jobFunction,jobArguments:e.jobArguments})}))}}break;case"Jump To Free Field":var C=b.getWorld().getFreeCells();for(y=C.length;y--;)l=C[y].x,u=C[y].y,c.isLegalMove(b,n.conditions,r,i,l,u)&&(t=c.getUniqueMoveID(b.name,n.name,l,u),g.push({type:"MOVE",name:n.name,entity:b,targetX:l,targetY:u,moveClass:"move_standard",freq:o,ID:t,postMove:n.postMove}),c.addJobForMoveID({jobID:t,jobName:"move game entity",job:"Move Entity",jobArguments:{entity:b,destX:l,destY:u}}),n.postMove&&_.each(n.postMove,function(e){c.addJobForMoveID({jobID:t,jobName:e.jobName,job:e.jobFunction,jobArguments:e.jobArguments})}))}return g},b.canReachGoal=function(){return!_.isEmpty(b.getGoalMoves())},b.canCapture=function(){for(var e=b.getGoalMoves(),t=e.length;t--;)if("CAPTURE"===e[t].type)return!0;return!1},b.canCaptureAt=function(e,t){var n,o,r=b.getGoalMoves();for(n=r.length;n--;)if("CAPTURE"===(o=r[n]).type&&e===o.targetX&&t===o.targetY)return!0;return!1},b.getGoalMoves=function(e){var t,n,o,r,i,a,s,l,u,g,c,m=b.countGoals(),d=null,f=[],y=b.getGame();if(s=e||b.getMoves(),i=b.position.x,a=b.position.y,y.models.DiceBox.isEnabled){var p,v,I=y.getDiceBox().getDiceValues(),h=I.length,D=0,M=b.getWorld().getFieldID(i,a);for(!1===_.isUndefined(b.tmp.fieldID)&&(M=b.tmp.fieldID),v=h;v--;)for(g=m;g--;)if(t=b.getGoal(g),!(p=null)===b.executeGoalByName(t.name,I[v]))if("BEAR OFF MOVE"===t.move)u=t.area,n=y.getUniqueMoveID(b.name,t.name,u,"bearoff"),y.setMoveID(n),y.getDiceBox().connectMoveIDWithDiceValue(n,v,u),f.push({ID:n,type:"DICE",entity:b,name:t.name,diceID:v,diceValue:I[v],targetArea:u,moveClass:"move_bearoff"}),y.getArea(u).moveID=y.models.moveID;else{"MOVE POSITIVE"===t.move?D=parseInt(M+I[v],10):"MOVE NEGATIVE"===t.move&&(D=parseInt(M-I[v],10));var E=b.getWorld().getContentOfFieldsWithFieldID(D);if(0===(p=_.first(E))&&(p=_.last(E)),null===(u={x:p.position.x,y:p.position.y}).x||null===u.y)continue;n=y.getUniqueMoveID(b.name,t.name,u.x,u.y),y.setMoveID(n),y.getDiceBox().connectMoveIDWithDiceValue(n,v,u),f.push({ID:n,name:t.name,entity:b,type:"DICE",diceValue:I[v],diceID:v,targetX:parseInt(u.x,10),targetY:parseInt(u.y,10),moveClass:"move_goal"})}}else{for(g=m;g--;)t=b.getGoal(g),!0===b.executeGoalByName(t.name)&&(d=b.translateDirection(t.move),o=parseInt(i+d[0],10),r=parseInt(a+d[1],10),n=y.getUniqueMoveID(b.name,t.name,o,r),f.push({ID:n,type:t.type,entity:b,name:t.name,preArrangeX:parseInt(i,10),preArrangeY:parseInt(a,10),targetX:o,targetY:r,moveClass:"move_goal"}));for(c=s.length;c--;)if(1<(l=s[c]).freq){for(y.doVirtualMove(b.position.x,b.position.y,l.targetX,l.targetY),i=l.targetX,a=l.targetY,g=m;g--;)(t=b.getGoal(g)).move===l.name&&!0===b.executeGoalByName(t.name)&&(d=b.translateDirection(t.move),o=parseInt(i+d[0],10),r=parseInt(a+d[1],10),n=y.getUniqueMoveID(b.name,t.name,o,r),f.push({ID:n,type:t.type,entity:b,name:t.name,preArrangeX:parseInt(i,10),preArrangeY:parseInt(a,10),targetX:o,targetY:r,moveClass:"move_goal"}));y.undoVirtualMove()}}return f},b.canBeCaptured=function(){var e,t,n=b.getAssociatedPlayer().getNextOpponentPlayer(),o=n.countEntities(),r=n.getEntities();for(e=o;e--;)if(t=b.position,!0===r[e].canCaptureAt(t.x,t.y))return!0;return!1},b.goals=[],b.assembleGoal=function(e){b.goals.push(e)},b.getGoal=function(e){return 0<=e&&e<b.goals.length&&b.goals[e]},b.countGoals=function(){return b.goals.length},b.executeGoalByName=function(e,t){if(!1===b.enabled)return!1;var n,o=b.goals.length,r=b.goals;for(n=0;n<o;n+=1)if(r[n].name===e){var i=!0,a=0,s=r[n].atoms,l=s.length;for(a=0;a<l;a+=1)if(!1===(i=b.getGame().executeEntityGoalAtomByName(b,s[a],t))||-1===i)return!1;return!0}return!1},b.goalAtoms=[],b.addGoalAtom=function(e,t,n){b.goalAtoms.push({atomName:e,atomFunction:t,atomArguments:n})}},Spoooky.AI={game:0,MCnode:function(e,t,n,o){var a=this;a.depth=0,a.nodeID=0,a.nodeID="Root Node"!==t?(a.depth=t.depth+1,(Date.now()+_.random(0,99999)).toString()):"Root",a.move=e,a.parent=t,a.childNodes=[],a.wins=0,a.simulationSteps=0,a.visits=0,a.moveIndex,a.type="DEFAULT",a.terminal=!1,a.winnerID=!1,a.untriedMoves=[],a.getWinRate=function(){return 0<a.visits?a.wins/a.visits:0},a.hasUntriedMoves=function(){return!1!==a.untriedMoves&&0!==a.untriedMoves.length},a.hasChildNodes=function(){return!1!==a.childNodes&&0!==a.childNodes.length},a.getRandomMoveIndexFromUntriedMoves=function(){return _.random(0,parseInt(a.untriedMoves.length-1,10))},a.playerToMove=n.getCurrentPlayerID(),a.UCTCONSTANT=o,a.getUnvisitedChildNodes=function(){var e,t,n=[],o=a.childNodes;for(t=o.length;t--;)0===(e=o[t]).visits&&n.push(e);return n},a.UCTSelectChild=function(){for(var e,t,n="None",o=0,r=a.childNodes,i=r.length;i--;)o<(t=(e=r[i]).getWinRate()+2*a.UCTCONSTANT*Math.sqrt(2*Math.log(a.visits)/e.visits))&&(n=e,o=t);return"None"===n?r[_.random(0,r.length-1)]:n},a.addChild=function(e,t,n,o){var r=new Spoooky.AI.MCnode(a.untriedMoves[e],a,t,a.UCTCONSTANT);return r.moveIndex=e,"END"!==t.models.gameState&&r.depth<n&&(r.untriedMoves=t.getCurrentPlayer().getExecutableMovesByAgentFocus("ALL")),"END"===t.models.gameState&&(r.terminal=!0,r.winnerID=t.models.winnerID),a.untriedMoves.splice(e,1),a.childNodes.push(r),"WAITINGFORDICEROLL"===t.models.gameState&&(r.type="CHANCE NODE"),r},a.update=function(e){a.visits++,a.wins+=e}},UCTrollout:function(e,t,n,o,r,i,a){if("END"===e.models.gameState)return{finalState:e,steps:1};var s,l,u,g=0,c=e.models,m="",d="";for(c.playVirtual=!0;g<=t&&(g++,!(Date.now()>a));)if("WAITINGFORDICEROLL"!==c.gameState||(Spoooky.GameEvents.fireEvent({job:"Roll Backgammon Dices"},e),"WAITINGFORDICEROLL"!==c.gameState)){if(0<(s=e.getCurrentPlayer().getAllEntityMoves()).length&&(i&&(m=e.gameWorld.createBoardSignature()),l=s[_.random(0,s.length-1)],e.executeMove(l),i&&(d=e.gameWorld.createBoardSignature())),_.isUndefined(l)&&(l={targetX:"x",targetY:"y",moveIndex:"none"}),"END"===c.gameState)return u=c.winnerID,i&&(u===o?r.add(m,d,1,e.translateCoordinates(l.targetX,l.targetY),l.moveIndex):!1===u||r.add(m,d,-1,e.translateCoordinates(l.targetX,l.targetY),l.moveIndex)),{finalState:e,steps:g};i&&r.add(m,d,void 0,e.translateCoordinates(l.targetX,l.targetY),l.moveIndex)}else e.loop(!1,null,null);return{finalState:e,steps:g}},UCT:function(e,t,n,o,r,i,a){var s,l,u,g,c,m,d,f,y,p=0,v=e.getCurrentPlayerID(),I="",h="",D=0,M=Date.now()+o;for(r&&(y=new Spoooky.QLearner(.8)),(g=new Spoooky.AI.MCnode({ID:"Root",name:"Root"},"Root Node",e,i)).untriedMoves=e.getCurrentPlayer().getExecutableMovesByAgentFocus(t);Date.now()<M;){for(l=g,d=(s=e.clone()).gameWorld;!1===l.hasUntriedMoves()&&l.hasChildNodes();)l=l.UCTSelectChild(),r&&(I=d.createBoardSignature()),f=l.move,s.executeMove(f),r&&(h=d.createBoardSignature(),y.add(I,h,void 0,s.translateCoordinates(f.targetX,f.targetY),f.moveIndex));l.hasUntriedMoves()&&(u=l.getRandomMoveIndexFromUntriedMoves(),r&&(I=d.createBoardSignature()),f=l.untriedMoves[u],s.executeMove(f),l.addChild(u,s,9999999,t),r&&(h=d.createBoardSignature(),y.add(I,h,void 0,s.translateCoordinates(f.targetX,f.targetY),f.moveIndex))),m=Spoooky.AI.UCTrollout(s.clone(),n,t,v,y,r,M),l.simulationSteps+=m.steps,D+=m.steps;for(var E=m.finalState.evaluateGameState(l.playerToMove);l.parent;)l.update(E),E*=-1,l=l.parent;p++,s.models.length=0,s.length=0}var A,C,b,S,P=[],G=e.gameWorld.getRows();for(c=g.childNodes.length;c--;)C=(A=g.childNodes[c]).move,b=String.fromCharCode(parseInt(97+C.targetX,10))+(G-C.targetY),S="place entity"===C.name?b:"Bear off"===C.name?String.fromCharCode(parseInt(97+C.entity.position.x,10))+(G-C.entity.position.y)+"-out":(b=String.fromCharCode(parseInt(97+C.targetX,10))+(G-C.targetY),"FREE CAPTURE"===C.type?b:String.fromCharCode(parseInt(97+C.entity.position.x,10))+(G-C.entity.position.y)+"-"+b),"DICE"===C.type&&(S+="-"+C.diceValue),P.push({wins:A.wins,target:S,visits:A.visits,moveIndex:C.moveIndex,simulationSteps:A.simulationSteps});var x=!1;return a&&(x=Spoooky.AI.createMCTSGraph(g,G)),e=g=null,{mctsGraph:x,simCount:p,simSteps:D,results:P,QLearner:y}},createMCTSGraph:function(e,t){var n={ID:"Root",children:[],parent:"null",value:e.visits,name:"Entscheidungsknoten (Spieler ID "+e.playerToMove+", "+e.getWinRate().toFixed(3)+" / "+e.visits+")"},o=[];try{Spoooky.AI.preProcessChildNodes(e.childNodes,t,o)}catch(e){o.length=0}try{n.children=Spoooky.AI.createTree(o,"Root",0,10)}catch(e){n.children.length=0}return n},preProcessChildNodes:function(e,t,n){for(var o,r,i,a,s=e.length;s--;){if(a=(o=e[s]).move,o.move.ID.toString(),r=String.fromCharCode(parseInt(97+a.targetX,10))+(t-a.targetY),i="place entity"===a.name?r:"Bear off"===a.name?String.fromCharCode(parseInt(97+a.entity.position.x,10))+(t-a.entity.position.y)+"-out":"FREE CAPTURE"===a.type?r:(r=String.fromCharCode(parseInt(97+a.targetX,10))+(t-a.targetY),String.fromCharCode(parseInt(97+a.entity.position.x,10))+(t-a.entity.position.y)+"-"+r),"DICE"===a.type&&("-"+a.diceValue,i+="-"+a.diceValue),o.terminal)i=i+" (Terminalknoten - "+(!1!==o.winnerID?"Spieler ID "+o.winnerID+" gewinnt. ":"unentschieden")+o.getWinRate().toFixed(3)+" / "+o.visits+")";else i=i+" (Spieler ID "+o.playerToMove+", "+o.getWinRate().toFixed(3)+" / "+o.visits+")";n.push({ID:o.nodeID,value:o.visits,parent:o.parent.nodeID,name:i,terminal:o.terminal}),0<o.childNodes.length&&Spoooky.AI.preProcessChildNodes(o.childNodes,t,n)}},createTree:function(e,t){for(var n,o=[],r=e.length;r--;)e[r].parent===t&&((n=Spoooky.AI.createTree(e,e[r].ID)).length&&(e[r].children=n),o.push(e[r]));return o},max:function(e,t){return t<e?e:t},abNegaMax:function(e,t,n,o,r,i){if("END"===e.models.gameState||n===t){var a=-1e3;return!1===e.models.winnerID?a=0:e.models.winnerID===i&&(a=1e3),{score:a+n,move:null,moveIndex:!1}}for(var s,l,u,g,c,m="none",d=-99999,f=(s=e.getCurrentPlayer().getAllEntityMoves()).length;f--;)if(c=s[f],(l=e.clone()).executeMove(c),u=Spoooky.AI.abNegaMax(l,t,n+1,-1*r,-1*Spoooky.AI.max(o,d),i),l=null,d<(g=-1*u.score)&&(m=c,r<=(d=g)))return{score:d,move:m,moveIndex:m.moveIndex};return"none"===m?{score:-1}:{score:d,move:m,moveIndex:m.moveIndex}}},Spoooky.QLearner=function(e){var s=this;s.alpha=0,s.gamma=e||.8,s.rho=.2,s.nu=0,s.rewards={},s.gameStates={},s.currentState=null,s.add=function(e,t,n,o,r){s.gameStates[e]||s.addState(e),s.gameStates[t]||s.addState(t),s.gameStates[e].addAction(t,n,o,r)},s.addState=function(e){var t=new Spoooky.GameState(e);return s.gameStates[e]=t},s.setState=function(e){return s.currentState=s.gameStates[e],s.currentState},s.getState=function(){return s.currentState&&s.currentState.name},s.randomState=function(){var e=_.toArray(s.gameStates);return e[_.random(0,e.length-1)]},s.optimalFutureValue=function(e){var t=0,n=s.rewards[e];return _.each(n,function(e){n.hasOwnProperty(e)&&(t=Math.max(t,n[e]||0))}),t},s.step=function(){s.currentState||(s.currentState=s.randomState());var e,t=_.toArray(s.currentState.actions);return(e=(_.random(0,1),s.rho,t[_.random(0,t.length-1)]))?(s.rewards[s.currentState.name]||(s.rewards[s.currentState.name]={}),s.rewards[s.currentState.name][e.name]=(e.reward||0)+s.gamma*s.optimalFutureValue(e.nextState),s.currentState=s.gameStates[e.nextState]):null},s.learn=function(e){for(e=Math.max(1,e||0);e--;)s.currentState=s.randomState(),s.step()},s.getBestAction=function(e){for(var t,n=s.rewards[e]||{},o=null,r=_.keys(n),i=r.length,a=0;a<i;++a){if(t=r[a],!n.hasOwnProperty(t))return!1;o?n[t]===n[o]?o=t:n[t]>n[o]&&(o=t):o=t}return o}},Spoooky.GameState=function(e){var i=this;i.name=e,i.actions={},i.addAction=function(e,t,n,o){var r={name:void 0===n?e:n,nextState:e,reward:t,moveIndex:o};i.actions[r.name]=r}};